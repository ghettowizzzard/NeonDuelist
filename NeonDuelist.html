<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Duelist: TCG Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@400;700;900&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Custom Anime/TCG Styles --- */
        :root {
            --color-primary: #FF0055;
            --color-secondary: #00E5FF;
            --color-accent: #FFD500;
            --card-monster-normal: #FDE68A;
            --card-monster-effect: #FDBA74;
            --card-monster-fusion: #A78BFA;
            --card-spell: #4ADE80;
            --card-trap: #F472B6;
            --card-back: #1E1B4B;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(0, 229, 255, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 0, 85, 0.15) 0%, transparent 25%);
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* Anime Speed Lines Background */
        .speed-lines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-conic-gradient(
                from 0deg,
                transparent 0deg 10deg,
                rgba(255,255,255,0.03) 10deg 20deg
            );
            pointer-events: none;
            z-index: 0;
        }

        /* Skewed UI Elements */
        .anime-skew { transform: skewX(-10deg); }
        .anime-unskew { transform: skewX(10deg); }

        /* Button Styles */
        .anime-btn {
            background: linear-gradient(45deg, var(--color-primary), #990033);
            border: 2px solid white;
            box-shadow: 4px 4px 0px var(--color-secondary);
            transition: all 0.1s ease;
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
        }
        .anime-btn:hover {
            transform: skewX(-10deg) translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--color-secondary);
            filter: brightness(1.2);
        }
        .anime-btn:active {
            transform: skewX(-10deg) translate(2px, 2px);
            box-shadow: 0px 0px 0px var(--color-secondary);
        }

        /* Card Styles */
        .card-container {
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .card-container:hover {
            z-index: 50;
            transform: scale(1.05) translateY(-5px);
        }
        
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 2, 0.5, 1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border-radius: 8px;
        }

        .card.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #444;
        }

        .card-front {
            background: #222;
            transform: rotateY(0deg); 
            display: flex;
            flex-direction: column;
            z-index: 2;
        }

        .card-back {
            background: var(--card-back-gradient, repeating-linear-gradient(45deg,#1e1b4b,#1e1b4b 10px,#312e81 10px,#312e81 20px));
            border: 4px solid var(--card-back-border, #00e5ff);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotateY(180deg);
        }
        
        .card-back-design {
            width: 58%;
            height: 58%;
            border: 2.5px solid var(--card-back-border, rgba(0,229,255,0.6));
            transform: rotate(45deg);
            background: radial-gradient(circle, var(--color-primary) 10%, transparent 10.5%);
            background-size: 18px 18px;
            box-shadow: 0 0 18px var(--card-back-border, var(--color-secondary));
        }

        /* Card Art Simulation */
        .card-art-box {
            background: #333;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(0,0,0,0.3);
        }
        
        .pattern-grid { background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px; }
        .pattern-lines { background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px); }
        .pattern-circle { background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); }
        .pattern-hex { 
            background-color: #333;
            background-image: radial-gradient(transparent 90%, #000 90%);
            background-size: 20px 20px;
        }

        /* --- HOLOGRAPHIC EFFECTS --- */
        
        /* Rare: Subtle Shine */
        .rarity-R {
            position: absolute; inset: 0;
            background: linear-gradient(115deg, transparent 40%, rgba(255,255,255,0.3) 45%, transparent 50%);
            background-size: 200% 100%;
            animation: foil-shine 3s infinite linear;
            pointer-events: none;
            z-index: 15;
            mix-blend-mode: overlay;
        }

        /* Super Rare: Gold Pulse */
        .rarity-SR {
            position: absolute; inset: 0;
            background: linear-gradient(115deg, transparent 30%, rgba(255,215,0,0.2) 45%, rgba(255,255,255,0.5) 50%, rgba(255,215,0,0.2) 55%, transparent 70%);
            background-size: 200% 200%;
            mix-blend-mode: overlay;
            animation: foil-shine 4s infinite linear;
            pointer-events: none;
            z-index: 15;
        }

        /* Ultra Rare: Rainbow Prism */
        .rarity-UR {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, 
                rgba(255,0,0,0.25), 
                rgba(255,255,0,0.25), 
                rgba(0,255,0,0.25), 
                rgba(0,255,255,0.25), 
                rgba(0,0,255,0.25), 
                rgba(255,0,255,0.25)
            );
            background-size: 300% 300%;
            mix-blend-mode: color-dodge;
            animation: rainbow-shift 4s infinite alternate;
            pointer-events: none;
            z-index: 15;
            border-radius: 4px;
        }

        @keyframes foil-shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes rainbow-shift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

/* Sparkle Rare: Holographic Star Burst */
        .rarity-SP {
            position: absolute; inset: 0;
            background: 
                radial-gradient(ellipse 2px 9px at 18% 14%, rgba(255,255,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 18% 14%, rgba(255,255,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 72% 8%, rgba(255,215,0,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 72% 8%, rgba(255,215,0,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 44% 48%, rgba(255,140,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 44% 48%, rgba(255,140,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 88% 38%, rgba(100,220,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 88% 38%, rgba(100,220,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 10% 68%, rgba(255,255,100,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 10% 68%, rgba(255,255,100,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 56% 74%, rgba(255,255,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 56% 74%, rgba(255,255,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 92% 82%, rgba(255,215,0,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 92% 82%, rgba(255,215,0,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 30% 92%, rgba(180,100,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 30% 92%, rgba(180,100,255,0.98) 0%, transparent 100%),
                radial-gradient(ellipse 2px 9px at 65% 25%, rgba(100,255,200,0.9) 0%, transparent 100%),
                radial-gradient(ellipse 9px 2px at 65% 25%, rgba(100,255,200,0.9) 0%, transparent 100%),
                linear-gradient(135deg, rgba(255,0,0,0.2), rgba(255,165,0,0.2), rgba(255,255,0,0.2), rgba(0,255,100,0.2), rgba(0,100,255,0.2), rgba(200,0,255,0.2));
            mix-blend-mode: screen;
            animation: sparkle-pulse 0.9s ease-in-out infinite alternate, rainbow-shift 3s infinite alternate;
            pointer-events: none;
            z-index: 15;
            border-radius: 4px;
        }

        @keyframes sparkle-pulse {
            0%   { opacity: 0.25; }
            50%  { opacity: 1; }
            100% { opacity: 0.35; }
        }


        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: var(--color-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: white; }

        /* Animations */
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .shine-effect { position: relative; overflow: hidden; }
        .shine-effect::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg);
            animation: shine 3s infinite;
        }

              .text-shadow-anime { text-shadow: 2px 2px 0px #000, -1px -1px 0 #000; }

        /* --- DUEL SCREEN STYLES --- */
        @keyframes radar-ping {
            0%   { transform: scale(1);   opacity: 0.9; }
            70%  { transform: scale(2.4); opacity: 0; }
            100% { transform: scale(2.4); opacity: 0; }
        }
        .duelist-ping { animation: radar-ping 1.8s ease-out infinite; }

        @keyframes rare-glow {
            0%, 100% { filter: drop-shadow(0 0 6px currentColor); }
            50%       { filter: drop-shadow(0 0 18px currentColor) drop-shadow(0 0 30px currentColor); }
        }
        .rare-glow { animation: rare-glow 2s ease-in-out infinite; }

           /* === FORTUNE WHEEL === */
        @keyframes mini-wheel-spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }
        .mini-wheel-spin { animation: mini-wheel-spin 5s linear infinite; }

        @keyframes wheel-claim-pulse {
            0%, 100% { box-shadow: 0 0 16px rgba(192,132,252,0.5); }
            50%       { box-shadow: 0 0 40px rgba(192,132,252,1), 0 0 70px rgba(192,132,252,0.4); }
        }
        .wheel-claim-pulse { animation: wheel-claim-pulse 1s ease-in-out infinite; }

        @keyframes scan-line {
            0%   { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        .world-scan-line {
            position: absolute; left: 0; right: 0; height: 2px;
            background: linear-gradient(to right, transparent, rgba(0,229,255,0.3), transparent);
            animation: scan-line 5s linear infinite;
            pointer-events: none; z-index: 1;
        }

        @keyframes daily-pop {
            0%  { transform: scale(0.6) translateY(20px); opacity: 0; }
            100%{ transform: scale(1)   translateY(0);    opacity: 1; }
        }
        .daily-pop { animation: daily-pop 0.25s cubic-bezier(0.34,1.56,0.64,1) forwards; }

        .duelist-marker {
            position: absolute; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 10;
            transition: transform 0.15s ease;
        }
        .duelist-marker:hover { transform: translate(-50%,-50%) scale(1.18); }

        /* Story Event Spots */
        .story-marker {
            position: absolute; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 10;
            transition: transform 0.15s ease;
        }
        .story-marker:hover { transform: translate(-50%,-50%) scale(1.2); }

        @keyframes story-pulse {
            0%, 100% { filter: drop-shadow(0 0 4px currentColor); opacity: 0.8; }
            50%       { filter: drop-shadow(0 0 18px currentColor) drop-shadow(0 0 8px currentColor); opacity: 1; }
        }
        .story-pulse { animation: story-pulse 2.8s ease-in-out infinite; }

        .world-grid-bg {
            background: radial-gradient(ellipse at 50% 48%, #0a1e3a 0%, #040d18 70%);
        }

        /* --- DUEL FIELD STYLES --- */
        @keyframes shuffleCard {
            from { transform: rotate(-8deg) translateY(-6px); }
            to   { transform: rotate(8deg)  translateY(6px); }
        }
        .duel-log-scroll { overflow-y: auto; }
        .duel-log-scroll::-webkit-scrollbar { width: 4px; }
        .duel-log-scroll::-webkit-scrollbar-thumb { background: #0f3050; border-radius: 2px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div class="speed-lines"></div>
    <div id="game-root" class="relative z-10 w-full h-full flex flex-col"></div>

    <script>
        // --- 0. ASSETS (Inline SVGs) ---
        const ICONS = {
            SWORD: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/></svg>`,
            SHIELD: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
            FIRE: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`,
            WATER: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
            WIND: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>`,
            EARTH: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.41 16.59-4.32-4.32a6.45 6.45 0 0 0-3.3-1.63L11 9.5 5.66 14.83a6.5 6.5 0 0 0 0 9.17l.08.08a6.5 6.5 0 0 0 9.17 0l5.34-5.34.42-1.74a6.45 6.45 0 0 0 1.63-3.31L22 14z"/><path d="M16 16l4 4"/><path d="M12 12l4 4"/><path d="M8 16l4 4"/><path d="M10.11 5.89l-4.32 4.32"/><path d="M16 8l4-4"/></svg>`,
            LIGHT: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            DARK: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            SPELL: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>`,
            TRAP: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            STAR: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="gold" stroke="orange" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
            MONEY: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>`,
            BACK: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            ROBOT: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>`,
            DRAGON: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M2 12h5"/><path d="M9 12a3 3 0 0 1 3 3v2a3 3 0 0 1-3 3H5"/><path d="M12 8a3 3 0 0 1 3-3h4"/><path d="M12 8v4"/><path d="M19 5v4"/></svg>`,
            SKULL: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>`,
            SCROLL: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h11a5 5 0 0 1 5 5v7a4 4 0 0 1-4 4Z"/></svg>`,
            BOLT: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></svg>`,
            EYE: `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`
        };

        // --- 1. GAME DATA & CONSTANTS ---

        const CARD_TYPES = {
            NORMAL: { color: 'bg-yellow-200', border: 'border-yellow-600', label: 'Normal' },
            EFFECT: { color: 'bg-orange-300', border: 'border-orange-600', label: 'Effect' },
            FUSION: { color: 'bg-purple-300', border: 'border-purple-600', label: 'Fusion' },
            SPELL: { color: 'bg-emerald-300', border: 'border-emerald-600', label: 'Spell' },
            TRAP: { color: 'bg-pink-300', border: 'border-pink-600', label: 'Trap' }
        };

        const ATTRIBUTES = {
            LIGHT: { icon: ICONS.LIGHT, color: 'text-yellow-500', bg: 'bg-yellow-500' },
            DARK: { icon: ICONS.DARK, color: 'text-purple-800', bg: 'bg-purple-900' },
            FIRE: { icon: ICONS.FIRE, color: 'text-red-600', bg: 'bg-red-600' },
            WATER: { icon: ICONS.WATER, color: 'text-blue-500', bg: 'bg-blue-600' },
            EARTH: { icon: ICONS.EARTH, color: 'text-amber-700', bg: 'bg-amber-800' },
            WIND: { icon: ICONS.WIND, color: 'text-green-500', bg: 'bg-teal-500' },
            SPELL: { icon: ICONS.SPELL, color: 'text-emerald-700', bg: 'bg-emerald-600' },
            TRAP: { icon: ICONS.TRAP, color: 'text-pink-700', bg: 'bg-pink-600' }
        };

        // EXPANDED DATABASE OF CARDS (Added Rarity Field: C, R, SR, UR)
const CARD_DB = [
            { id: 1, name: "Neon Knight", type: "NORMAL", attribute: "LIGHT", level: 4, atk: 1800, def: 1000, desc: "A cybernetic warrior who defends the neon city.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,6 50,19 50,34 35,38 20,34 20,19" fill="#0a2050" stroke="#00e5ff" stroke-width="2"/>
                <rect x="27" y="9" width="16" height="12" rx="8" fill="#0a2050" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="29" y="13" width="12" height="5" rx="2" fill="#00e5ff" opacity="0.7"/>
                <rect x="21" y="37" width="28" height="20" rx="3" fill="#0a2050" stroke="#00e5ff" stroke-width="1.5"/>
                <polygon points="35,41 40,46 38,52 32,52 30,46" fill="#00e5ff" opacity="0.45"/>
                <polygon points="10,36 21,36 19,47 8,44" fill="#0a2050" stroke="#00e5ff" stroke-width="1"/>
                <polygon points="60,36 49,36 51,47 62,44" fill="#0a2050" stroke="#00e5ff" stroke-width="1"/>
                <line x1="7" y1="40" x2="3" y2="19" stroke="#aaeeff" stroke-width="2.5"/>
                <polygon points="3,13 0,21 6,21" fill="#ffd700"/>
                <rect x="22" y="55" width="11" height="12" rx="2" fill="#0a2050" stroke="#00e5ff" stroke-width="1"/>
                <rect x="37" y="55" width="11" height="12" rx="2" fill="#0a2050" stroke="#00e5ff" stroke-width="1"/>
                <circle cx="29" cy="22" r="2" fill="#00e5ff"/>
                <circle cx="41" cy="22" r="2" fill="#00e5ff"/>
                <line x1="21" y1="43" x2="49" y2="43" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
              </svg>`},

            { id: 2, name: "Data Goblin", type: "NORMAL", attribute: "EARTH", level: 2, atk: 500, def: 500, desc: "Steals small packets of data.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="45" rx="16" ry="18" fill="#4a3520" stroke="#a07040" stroke-width="1.5"/>
                <ellipse cx="35" cy="24" rx="14" ry="13" fill="#5a4530" stroke="#a07040" stroke-width="1.5"/>
                <circle cx="28" cy="22" r="5" fill="#001100" stroke="#44ff44" stroke-width="1.5"/>
                <circle cx="42" cy="22" r="5" fill="#001100" stroke="#44ff44" stroke-width="1.5"/>
                <circle cx="28" cy="22" r="2.5" fill="#00ff44"/>
                <circle cx="42" cy="22" r="2.5" fill="#00ff44"/>
                <polygon points="21,14 17,4 25,12" fill="#5a4530" stroke="#a07040" stroke-width="1"/>
                <polygon points="49,14 53,4 45,12" fill="#5a4530" stroke="#a07040" stroke-width="1"/>
                <line x1="25" y1="42" x2="45" y2="42" stroke="#44ff44" stroke-width="0.8" opacity="0.6"/>
                <line x1="22" y1="48" x2="35" y2="48" stroke="#44ff44" stroke-width="0.8" opacity="0.6"/>
                <line x1="35" y1="48" x2="35" y2="55" stroke="#44ff44" stroke-width="0.8" opacity="0.6"/>
                <circle cx="35" cy="56" r="2" fill="#44ff44" opacity="0.6"/>
                <ellipse cx="18" cy="48" rx="5" ry="9" fill="#4a3520" stroke="#a07040" stroke-width="1" transform="rotate(-15 18 48)"/>
                <ellipse cx="52" cy="48" rx="5" ry="9" fill="#4a3520" stroke="#a07040" stroke-width="1" transform="rotate(15 52 48)"/>
                <polygon points="30,31 32,36 34,31" fill="#ffffff" opacity="0.8"/>
                <polygon points="36,31 38,36 40,31" fill="#ffffff" opacity="0.8"/>
              </svg>`},

            { id: 3, name: "Plasma Dragon", type: "NORMAL", attribute: "FIRE", level: 7, atk: 2500, def: 2000, desc: "A dragon made of pure plasma energy.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="5,20 20,35 15,55 2,45" fill="#ff4400" opacity="0.7" stroke="#ff8800" stroke-width="1"/>
                <polygon points="8,15 18,30 12,20" fill="#ffaa00" opacity="0.5"/>
                <polygon points="65,20 50,35 55,55 68,45" fill="#ff4400" opacity="0.7" stroke="#ff8800" stroke-width="1"/>
                <polygon points="62,15 52,30 58,20" fill="#ffaa00" opacity="0.5"/>
                <ellipse cx="35" cy="45" rx="14" ry="18" fill="#8b0000" stroke="#ff4400" stroke-width="2"/>
                <polygon points="29,30 41,30 39,45 31,45" fill="#8b0000" stroke="#ff4400" stroke-width="1.5"/>
                <polygon points="35,6 48,18 44,28 35,26 26,28 22,18" fill="#8b0000" stroke="#ff4400" stroke-width="2"/>
                <polygon points="35,22 43,26 35,32 27,26" fill="#aa0000" stroke="#ff4400" stroke-width="1"/>
                <ellipse cx="29" cy="17" rx="3" ry="3.5" fill="#ffff00"/>
                <ellipse cx="41" cy="17" rx="3" ry="3.5" fill="#ffff00"/>
                <ellipse cx="29" cy="17" rx="1.5" ry="2" fill="#ff4400"/>
                <ellipse cx="41" cy="17" rx="1.5" ry="2" fill="#ff4400"/>
                <polygon points="28,10 24,2 31,12" fill="#660000" stroke="#ff4400" stroke-width="1"/>
                <polygon points="42,10 46,2 39,12" fill="#660000" stroke="#ff4400" stroke-width="1"/>
                <polygon points="35,28 33,35 37,35" fill="#660000"/>
                <polygon points="30,32 28,39 32,39" fill="#660000"/>
                <polygon points="40,32 38,39 42,39" fill="#660000"/>
                <path d="M42,58 Q55,65 62,58 Q68,52 65,62" fill="none" stroke="#ff4400" stroke-width="2.5"/>
              </svg>`},

            { id: 4, name: "Glitch Wolf", type: "NORMAL", attribute: "DARK", level: 4, atk: 1600, def: 1200, desc: "A corrupted beast from the server badlands.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="38" cy="45" rx="20" ry="16" fill="#1a0030" stroke="#8800ff" stroke-width="1.5"/>
                <rect x="21" y="56" width="8" height="12" rx="2" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <rect x="32" y="58" width="8" height="10" rx="2" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <rect x="44" y="58" width="8" height="10" rx="2" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <rect x="54" y="56" width="8" height="12" rx="2" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <ellipse cx="20" cy="35" rx="16" ry="13" fill="#1a0030" stroke="#8800ff" stroke-width="1.5"/>
                <polygon points="5,38 15,33 15,42" fill="#220040" stroke="#8800ff" stroke-width="1"/>
                <circle cx="17" cy="31" r="4" fill="#5500aa"/>
                <circle cx="17" cy="31" r="2" fill="#aa00ff"/>
                <circle cx="25" cy="31" r="4" fill="#5500aa"/>
                <circle cx="25" cy="31" r="2" fill="#aa00ff"/>
                <polygon points="11,24 8,12 18,22" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <polygon points="25,22 24,12 30,20" fill="#1a0030" stroke="#8800ff" stroke-width="1"/>
                <rect x="8" y="36" width="20" height="2" fill="#aa00ff" opacity="0.5"/>
                <rect x="25" y="44" width="30" height="2" fill="#aa00ff" opacity="0.4"/>
                <rect x="15" y="50" width="30" height="1.5" fill="#ff00ff" opacity="0.3"/>
                <path d="M57,42 Q66,35 68,28 Q70,22 65,25" fill="none" stroke="#8800ff" stroke-width="2.5"/>
                <polygon points="30,26 32,18 34,26" fill="#440066"/>
                <polygon points="35,24 37,16 39,24" fill="#440066"/>
              </svg>`},

            { id: 5, name: "Bit Slime", type: "NORMAL", attribute: "WATER", level: 1, atk: 300, def: 300, desc: "A weak blob of raw data.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,15 Q52,10 58,25 Q65,40 55,55 Q45,65 35,63 Q25,65 15,55 Q5,40 12,25 Q18,10 35,15Z" fill="#0055aa" opacity="0.85" stroke="#00aaff" stroke-width="1.5"/>
                <ellipse cx="35" cy="40" rx="18" ry="18" fill="#0077cc" opacity="0.5"/>
                <rect x="24" y="28" width="5" height="5" fill="#00ccff" opacity="0.7"/>
                <rect x="31" y="22" width="5" height="5" fill="#00ccff" opacity="0.7"/>
                <rect x="38" y="28" width="5" height="5" fill="#00ccff" opacity="0.7"/>
                <rect x="27" y="35" width="5" height="5" fill="#00ccff" opacity="0.6"/>
                <rect x="37" y="35" width="5" height="5" fill="#00ccff" opacity="0.6"/>
                <rect x="30" y="42" width="5" height="5" fill="#00ccff" opacity="0.5"/>
                <rect x="38" y="42" width="5" height="5" fill="#00ccff" opacity="0.5"/>
                <circle cx="27" cy="32" r="4" fill="#001133"/>
                <circle cx="43" cy="32" r="4" fill="#001133"/>
                <circle cx="27" cy="32" r="2" fill="#00eeff"/>
                <circle cx="43" cy="32" r="2" fill="#00eeff"/>
                <ellipse cx="20" cy="58" rx="4" ry="6" fill="#0055aa" opacity="0.6"/>
                <ellipse cx="50" cy="60" rx="3" ry="5" fill="#0055aa" opacity="0.6"/>
                <circle cx="52" cy="22" r="5" fill="#0077cc" opacity="0.4" stroke="#00aaff" stroke-width="1"/>
                <circle cx="14" cy="35" r="4" fill="#0077cc" opacity="0.4" stroke="#00aaff" stroke-width="1"/>
              </svg>`},

            { id: 6, name: "Server Golem", type: "NORMAL", attribute: "EARTH", level: 5, atk: 2000, def: 2200, desc: "A heavy golem made of old server racks.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="22" y="8" width="26" height="18" rx="2" fill="#2d3520" stroke="#88aa44" stroke-width="1.5"/>
                <line x1="24" y1="13" x2="46" y2="13" stroke="#88aa44" stroke-width="1"/>
                <line x1="24" y1="18" x2="46" y2="18" stroke="#88aa44" stroke-width="1"/>
                <circle cx="43" cy="15" r="2" fill="#44ff44"/>
                <circle cx="38" cy="15" r="2" fill="#ff4400"/>
                <rect x="25" y="10" width="8" height="5" rx="1" fill="#44ff44" opacity="0.5"/>
                <rect x="16" y="26" width="38" height="30" rx="3" fill="#2d3520" stroke="#88aa44" stroke-width="2"/>
                <line x1="18" y1="33" x2="52" y2="33" stroke="#88aa44" stroke-width="1"/>
                <line x1="18" y1="40" x2="52" y2="40" stroke="#88aa44" stroke-width="1"/>
                <line x1="18" y1="47" x2="52" y2="47" stroke="#88aa44" stroke-width="1"/>
                <circle cx="47" cy="30" r="1.5" fill="#00ff44"/>
                <circle cx="47" cy="37" r="1.5" fill="#ffaa00"/>
                <circle cx="47" cy="44" r="1.5" fill="#00ff44"/>
                <circle cx="47" cy="51" r="1.5" fill="#ff0000"/>
                <rect x="2" y="26" width="14" height="22" rx="3" fill="#2d3520" stroke="#88aa44" stroke-width="1.5"/>
                <rect x="54" y="26" width="14" height="22" rx="3" fill="#2d3520" stroke="#88aa44" stroke-width="1.5"/>
                <rect x="2" y="46" width="14" height="10" rx="3" fill="#3d4530" stroke="#88aa44" stroke-width="1.5"/>
                <rect x="54" y="46" width="14" height="10" rx="3" fill="#3d4530" stroke="#88aa44" stroke-width="1.5"/>
                <rect x="19" y="55" width="13" height="13" rx="2" fill="#2d3520" stroke="#88aa44" stroke-width="1.5"/>
                <rect x="38" y="55" width="13" height="13" rx="2" fill="#2d3520" stroke="#88aa44" stroke-width="1.5"/>
              </svg>`},

            { id: 7, name: "Volt Bat", type: "NORMAL", attribute: "WIND", level: 2, atk: 900, def: 400, desc: "Emits high frequency static noise.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,32 Q25,20 8,15 Q4,25 10,35 Q18,38 28,36Z" fill="#003333" stroke="#00ffcc" stroke-width="1.5"/>
                <line x1="35" y1="32" x2="12" y2="18" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <line x1="35" y1="32" x2="8" y2="26" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <line x1="35" y1="32" x2="11" y2="33" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <path d="M35,32 Q45,20 62,15 Q66,25 60,35 Q52,38 42,36Z" fill="#003333" stroke="#00ffcc" stroke-width="1.5"/>
                <line x1="35" y1="32" x2="58" y2="18" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <line x1="35" y1="32" x2="62" y2="26" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <line x1="35" y1="32" x2="59" y2="33" stroke="#00ffcc" stroke-width="0.8" opacity="0.6"/>
                <ellipse cx="35" cy="38" rx="10" ry="13" fill="#003333" stroke="#00ffcc" stroke-width="1.5"/>
                <ellipse cx="35" cy="26" rx="9" ry="9" fill="#003333" stroke="#00ffcc" stroke-width="1.5"/>
                <polygon points="28,20 26,11 32,19" fill="#003333" stroke="#00ffcc" stroke-width="1"/>
                <polygon points="42,20 44,11 38,19" fill="#003333" stroke="#00ffcc" stroke-width="1"/>
                <circle cx="30" cy="25" r="3" fill="#ffff00"/>
                <circle cx="40" cy="25" r="3" fill="#ffff00"/>
                <circle cx="30" cy="25" r="1.5" fill="#ff8800"/>
                <circle cx="40" cy="25" r="1.5" fill="#ff8800"/>
                <polyline points="16,22 19,26 14,28 18,33" fill="none" stroke="#ffff00" stroke-width="1.5"/>
                <polyline points="54,22 51,26 56,28 52,33" fill="none" stroke="#ffff00" stroke-width="1.5"/>
                <polygon points="32,32 31,37 33,37" fill="white"/>
                <polygon points="38,32 37,37 39,37" fill="white"/>
              </svg>`},

            { id: 8, name: "Flame Sprite", type: "NORMAL", attribute: "FIRE", level: 3, atk: 1100, def: 800, desc: "A small spark that can start a wildfire.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,20 Q18,12 12,25 Q8,38 20,45 Q28,50 35,48Z" fill="#ff4400" opacity="0.5"/>
                <path d="M35,20 Q52,12 58,25 Q62,38 50,45 Q42,50 35,48Z" fill="#ff4400" opacity="0.5"/>
                <path d="M35,25 Q22,18 18,30 Q15,40 25,43Z" fill="#ff8800" opacity="0.6"/>
                <path d="M35,25 Q48,18 52,30 Q55,40 45,43Z" fill="#ff8800" opacity="0.6"/>
                <ellipse cx="35" cy="44" rx="9" ry="12" fill="#cc2200" stroke="#ff8800" stroke-width="1.5"/>
                <circle cx="35" cy="28" r="11" fill="#cc2200" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M28,20 Q26,10 30,8 Q33,14 35,8 Q37,14 40,8 Q44,10 42,20" fill="#ffaa00" opacity="0.8"/>
                <circle cx="30" cy="27" r="3.5" fill="#ffff00"/>
                <circle cx="40" cy="27" r="3.5" fill="#ffff00"/>
                <circle cx="30" cy="27" r="2" fill="#ff2200"/>
                <circle cx="40" cy="27" r="2" fill="#ff2200"/>
                <path d="M30,33 Q35,37 40,33" fill="none" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M29,52 Q27,60 30,62 Q33,55 35,62 Q37,55 40,62 Q43,60 41,52" fill="#ff8800" opacity="0.7"/>
                <circle cx="18" cy="20" r="2" fill="#ffdd00"/>
                <circle cx="52" cy="20" r="2" fill="#ffdd00"/>
                <circle cx="15" cy="35" r="1.5" fill="#ffdd00"/>
                <circle cx="55" cy="35" r="1.5" fill="#ffdd00"/>
              </svg>`},

            { id: 10, name: "Cyber Magician", type: "EFFECT", attribute: "DARK", level: 6, atk: 2400, def: 1000, desc: "Once per turn: Discard 1 Spell to destroy 1 Monster.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,28 18,65 52,65" fill="#1a0040" stroke="#9900ff" stroke-width="1.5"/>
                <polyline points="26,48 30,48 30,52 34,52" fill="none" stroke="#ff00ff" stroke-width="0.8" opacity="0.5"/>
                <polyline points="44,48 40,48 40,52 36,52" fill="none" stroke="#ff00ff" stroke-width="0.8" opacity="0.5"/>
                <polygon points="22,30 35,35 20,50 8,40" fill="#1a0040" stroke="#9900ff" stroke-width="1.5"/>
                <polygon points="48,30 35,35 50,50 62,40" fill="#1a0040" stroke="#9900ff" stroke-width="1.5"/>
                <line x1="10" y1="42" x2="4" y2="18" stroke="#cc88ff" stroke-width="2.5"/>
                <circle cx="4" cy="16" r="5" fill="#6600aa" stroke="#ff00ff" stroke-width="1.5"/>
                <circle cx="4" cy="16" r="2.5" fill="#ff00ff" opacity="0.7"/>
                <circle cx="35" cy="18" r="11" fill="#1a0040" stroke="#9900ff" stroke-width="2"/>
                <polygon points="35,4 27,18 43,18" fill="#1a0040" stroke="#9900ff" stroke-width="1.5"/>
                <line x1="27" y1="18" x2="43" y2="18" stroke="#ff00ff" stroke-width="1.5"/>
                <circle cx="30" cy="17" r="3.5" fill="#000011"/>
                <circle cx="40" cy="17" r="3.5" fill="#000011"/>
                <circle cx="30" cy="17" r="2" fill="#ff00ff"/>
                <circle cx="40" cy="17" r="2" fill="#ff00ff"/>
                <circle cx="56" cy="25" r="4" fill="#6600aa" stroke="#ff00ff" stroke-width="1" opacity="0.7"/>
                <circle cx="60" cy="38" r="3" fill="#9900ff" opacity="0.6"/>
                <circle cx="58" cy="50" r="2" fill="#ff00ff" opacity="0.5"/>
              </svg>`},

            { id: 11, name: "Firewall Guard", type: "EFFECT", attribute: "LIGHT", level: 4, atk: 100, def: 2100, desc: "Flip: Add 1 Spell card from your deck to hand.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M12,20 L58,20 L62,50 L35,68 L8,50Z" fill="#1a2a50" stroke="#00e5ff" stroke-width="2"/>
                <path d="M20,25 L50,25 L53,47 L35,60 L17,47Z" fill="#0d1a3a" stroke="#00aaff" stroke-width="1"/>
                <line x1="22" y1="32" x2="48" y2="32" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="22" y1="38" x2="48" y2="38" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="22" y1="44" x2="48" y2="44" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="28" y1="27" x2="28" y2="54" stroke="#ff4400" stroke-width="1"/>
                <line x1="35" y1="27" x2="35" y2="60" stroke="#ff4400" stroke-width="1"/>
                <line x1="42" y1="27" x2="42" y2="54" stroke="#ff4400" stroke-width="1"/>
                <circle cx="35" cy="43" r="8" fill="#1a2a50" stroke="#00e5ff" stroke-width="2"/>
                <circle cx="35" cy="43" r="4" fill="#00e5ff" opacity="0.4"/>
                <circle cx="35" cy="13" r="9" fill="#1a2a50" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="29" y="9" width="12" height="5" rx="1" fill="#00e5ff" opacity="0.5"/>
                <circle cx="31" cy="12" r="2" fill="#00e5ff"/>
                <circle cx="39" cy="12" r="2" fill="#00e5ff"/>
              </svg>`},

            { id: 12, name: "Speed Router", type: "EFFECT", attribute: "WIND", level: 3, atk: 1200, def: 600, desc: "When Normal Summoned: Special Summon 1 Level 3 monster.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <line x1="0" y1="25" x2="20" y2="35" stroke="#00ffaa" stroke-width="1" opacity="0.4"/>
                <line x1="0" y1="35" x2="15" y2="38" stroke="#00ffaa" stroke-width="1.5" opacity="0.5"/>
                <line x1="0" y1="45" x2="18" y2="42" stroke="#00ffaa" stroke-width="1" opacity="0.4"/>
                <polygon points="20,22 60,30 62,45 20,52" fill="#003330" stroke="#00ffaa" stroke-width="1.5"/>
                <ellipse cx="55" cy="37" rx="12" ry="10" fill="#003330" stroke="#00ffaa" stroke-width="2"/>
                <ellipse cx="57" cy="37" rx="7" ry="6" fill="#00ffaa" opacity="0.15"/>
                <circle cx="62" cy="35" r="4" fill="#00ff88"/>
                <circle cx="62" cy="35" r="2" fill="#ffffff"/>
                <polygon points="30,22 40,12 50,22" fill="#002222" stroke="#00ffaa" stroke-width="1"/>
                <polygon points="30,52 40,62 50,52" fill="#002222" stroke="#00ffaa" stroke-width="1"/>
                <ellipse cx="20" cy="32" rx="5" ry="4" fill="#00ffaa" opacity="0.5"/>
                <ellipse cx="20" cy="42" rx="5" ry="4" fill="#00ffaa" opacity="0.5"/>
                <line x1="28" y1="35" x2="50" y2="35" stroke="#00ffaa" stroke-width="0.8" opacity="0.5"/>
                <line x1="28" y1="40" x2="45" y2="40" stroke="#00ffaa" stroke-width="0.8" opacity="0.5"/>
                <ellipse cx="28" cy="55" rx="6" ry="3" fill="#005544" stroke="#00ffaa" stroke-width="1"/>
                <ellipse cx="42" cy="58" rx="6" ry="3" fill="#005544" stroke="#00ffaa" stroke-width="1"/>
              </svg>`},

            { id: 13, name: "Virus Carrier", type: "EFFECT", attribute: "DARK", level: 1, atk: 0, def: 0, desc: "If destroyed, destroy the monster that attacked it.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="38" r="18" fill="#1a0022" stroke="#cc00cc" stroke-width="2"/>
                <line x1="35" y1="20" x2="35" y2="10" stroke="#cc00cc" stroke-width="2"/><circle cx="35" cy="8" r="3" fill="#ff00ff"/>
                <line x1="50" y1="25" x2="58" y2="17" stroke="#cc00cc" stroke-width="2"/><circle cx="60" cy="15" r="3" fill="#ff00ff"/>
                <line x1="53" y1="38" x2="64" y2="38" stroke="#cc00cc" stroke-width="2"/><circle cx="66" cy="38" r="3" fill="#ff00ff"/>
                <line x1="50" y1="51" x2="58" y2="59" stroke="#cc00cc" stroke-width="2"/><circle cx="60" cy="61" r="3" fill="#ff00ff"/>
                <line x1="35" y1="56" x2="35" y2="66" stroke="#cc00cc" stroke-width="2"/><circle cx="35" cy="68" r="3" fill="#ff00ff"/>
                <line x1="20" y1="51" x2="12" y2="59" stroke="#cc00cc" stroke-width="2"/><circle cx="10" cy="61" r="3" fill="#ff00ff"/>
                <line x1="17" y1="38" x2="6" y2="38" stroke="#cc00cc" stroke-width="2"/><circle cx="4" cy="38" r="3" fill="#ff00ff"/>
                <line x1="20" y1="25" x2="12" y2="17" stroke="#cc00cc" stroke-width="2"/><circle cx="10" cy="15" r="3" fill="#ff00ff"/>
                <circle cx="35" cy="38" r="12" fill="#220033" opacity="0.6"/>
                <circle cx="29" cy="34" r="4" fill="#330044"/>
                <circle cx="41" cy="34" r="4" fill="#330044"/>
                <circle cx="29" cy="34" r="2" fill="#ff00ff" opacity="0.8"/>
                <circle cx="41" cy="34" r="2" fill="#ff00ff" opacity="0.8"/>
                <path d="M26,43 Q30,47 35,45 Q40,47 44,43" fill="none" stroke="#cc00cc" stroke-width="1.5"/>
              </svg>`},

            { id: 14, name: "Binary Sorcerer", type: "EFFECT", attribute: "LIGHT", level: 4, atk: 1700, def: 1500, desc: "Gains 200 ATK for every Spell in your GY.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,28 17,65 53,65" fill="#2a2a00" stroke="#ddaa00" stroke-width="1.5"/>
                <text x="21" y="45" font-size="5" fill="#ffdd00" opacity="0.4" font-family="monospace">0110</text>
                <text x="22" y="52" font-size="5" fill="#ffdd00" opacity="0.4" font-family="monospace">1001</text>
                <text x="23" y="59" font-size="5" fill="#ffdd00" opacity="0.4" font-family="monospace">1100</text>
                <polygon points="22,30 35,36 18,52 7,40" fill="#2a2a00" stroke="#ddaa00" stroke-width="1.5"/>
                <polygon points="48,30 35,36 52,52 63,40" fill="#2a2a00" stroke="#ddaa00" stroke-width="1.5"/>
                <circle cx="8" cy="25" r="6" fill="#3a3a00" stroke="#ffdd00" stroke-width="1.5"/>
                <text x="5" y="27" font-size="5.5" fill="#ffdd00" font-family="monospace">01</text>
                <circle cx="62" cy="30" r="6" fill="#3a3a00" stroke="#ffdd00" stroke-width="1.5"/>
                <text x="59" y="32" font-size="5.5" fill="#ffdd00" font-family="monospace">10</text>
                <circle cx="35" cy="18" r="11" fill="#2a2a00" stroke="#ddaa00" stroke-width="2"/>
                <polygon points="35,3 26,18 44,18" fill="#1a1a00" stroke="#ddaa00" stroke-width="1.5"/>
                <text x="31" y="14" font-size="4.5" fill="#ffdd00" font-family="monospace">11</text>
                <circle cx="30" cy="17" r="3.5" fill="#1a1000"/>
                <circle cx="40" cy="17" r="3.5" fill="#1a1000"/>
                <circle cx="30" cy="17" r="2" fill="#ffdd00"/>
                <circle cx="40" cy="17" r="2" fill="#ffdd00"/>
                <circle cx="12" cy="48" r="5" fill="#3a3a00" stroke="#ffdd00" stroke-width="1" opacity="0.7"/>
                <circle cx="58" cy="50" r="5" fill="#3a3a00" stroke="#ffdd00" stroke-width="1" opacity="0.7"/>
              </svg>`},

            { id: 15, name: "Quantum Ninja", type: "EFFECT", attribute: "DARK", level: 5, atk: 2100, def: 800, desc: "Can attack your opponent directly.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="28" cy="46" rx="16" ry="18" fill="#110011" stroke="#6600cc" stroke-width="1" opacity="0.3"/>
                <ellipse cx="42" cy="46" rx="16" ry="18" fill="#110011" stroke="#6600cc" stroke-width="1" opacity="0.3"/>
                <rect x="26" y="30" width="18" height="28" rx="3" fill="#0d0d1a" stroke="#6600cc" stroke-width="1.5"/>
                <line x1="22" y1="26" x2="48" y2="52" stroke="#aaaaaa" stroke-width="2"/>
                <line x1="48" y1="26" x2="22" y2="52" stroke="#aaaaaa" stroke-width="2"/>
                <ellipse cx="35" cy="22" rx="11" ry="12" fill="#0d0d1a" stroke="#6600cc" stroke-width="2"/>
                <rect x="26" y="22" width="18" height="9" rx="2" fill="#1a001a" stroke="#6600cc" stroke-width="1"/>
                <rect x="28" y="16" width="6" height="5" rx="1" fill="#6600cc"/>
                <rect x="36" y="16" width="6" height="5" rx="1" fill="#6600cc"/>
                <rect x="29" y="17" width="4" height="3" rx="1" fill="#cc00ff"/>
                <rect x="37" y="17" width="4" height="3" rx="1" fill="#cc00ff"/>
                <line x1="25" y1="14" x2="45" y2="14" stroke="#cc00ff" stroke-width="2"/>
                <circle cx="18" cy="20" r="2" fill="#9900ff" opacity="0.7"/>
                <circle cx="52" cy="18" r="2" fill="#9900ff" opacity="0.7"/>
                <circle cx="14" cy="40" r="1.5" fill="#cc00ff" opacity="0.5"/>
                <circle cx="56" cy="42" r="1.5" fill="#cc00ff" opacity="0.5"/>
                <rect x="26" y="55" width="8" height="12" rx="2" fill="#0d0d1a" stroke="#6600cc" stroke-width="1"/>
                <rect x="36" y="55" width="8" height="12" rx="2" fill="#0d0d1a" stroke="#6600cc" stroke-width="1"/>
              </svg>`},

            { id: 16, name: "Tech Healer", type: "EFFECT", attribute: "WATER", level: 3, atk: 1000, def: 2000, desc: "Once per turn: Heal 500 LP.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,30 Q18,20 8,30 Q5,42 18,48 Q28,52 35,46Z" fill="#001a3a" stroke="#00aaff" stroke-width="1.5"/>
                <path d="M35,30 Q52,20 62,30 Q65,42 52,48 Q42,52 35,46Z" fill="#001a3a" stroke="#00aaff" stroke-width="1.5"/>
                <line x1="35" y1="32" x2="12" y2="34" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="36" x2="10" y2="40" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="32" x2="58" y2="34" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="36" x2="60" y2="40" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <polygon points="35,32 22,65 48,65" fill="#001a3a" stroke="#00aaff" stroke-width="1.5"/>
                <rect x="31" y="44" width="8" height="16" rx="1" fill="#00aaff" opacity="0.5"/>
                <rect x="26" y="49" width="18" height="6" rx="1" fill="#00aaff" opacity="0.5"/>
                <rect x="26" y="30" width="18" height="16" rx="3" fill="#001a3a" stroke="#00aaff" stroke-width="1.5"/>
                <rect x="33" y="32" width="4" height="12" rx="1" fill="#00e5ff" opacity="0.7"/>
                <rect x="29" y="36" width="12" height="4" rx="1" fill="#00e5ff" opacity="0.7"/>
                <circle cx="35" cy="20" r="11" fill="#001a3a" stroke="#00aaff" stroke-width="2"/>
                <ellipse cx="35" cy="10" rx="12" ry="4" fill="none" stroke="#00e5ff" stroke-width="2"/>
                <rect x="27" y="17" width="16" height="7" rx="3" fill="#00aaff" opacity="0.4"/>
                <circle cx="30" cy="20" r="2.5" fill="#00e5ff"/>
                <circle cx="40" cy="20" r="2.5" fill="#00e5ff"/>
              </svg>`},

            { id: 17, name: "Scrap Mechanic", type: "EFFECT", attribute: "EARTH", level: 4, atk: 1500, def: 1500, desc: "Tribute this card: Special Summon a Machine from GY.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="20" y="28" width="30" height="28" rx="4" fill="#3a2a10" stroke="#aa7733" stroke-width="2"/>
                <circle cx="24" cy="32" r="2" fill="#886622"/><circle cx="46" cy="32" r="2" fill="#886622"/>
                <circle cx="24" cy="52" r="2" fill="#886622"/><circle cx="46" cy="52" r="2" fill="#886622"/>
                <rect x="27" y="35" width="16" height="10" rx="1" fill="#2a1a00" stroke="#aa7733" stroke-width="1"/>
                <line x1="29" y1="38" x2="41" y2="38" stroke="#ffaa00" stroke-width="1"/>
                <line x1="29" y1="41" x2="38" y2="41" stroke="#ffaa00" stroke-width="0.8"/>
                <circle cx="41" cy="41" r="2" fill="#ff4400"/>
                <rect x="22" y="10" width="26" height="20" rx="4" fill="#3a2a10" stroke="#aa7733" stroke-width="2"/>
                <circle cx="30" cy="19" r="5" fill="#2a1a00" stroke="#aa7733" stroke-width="1"/>
                <circle cx="40" cy="19" r="5" fill="#2a1a00" stroke="#aa7733" stroke-width="1"/>
                <circle cx="30" cy="19" r="2.5" fill="#ffaa00"/>
                <circle cx="40" cy="19" r="2.5" fill="#ffaa00"/>
                <line x1="35" y1="10" x2="35" y2="3" stroke="#aa7733" stroke-width="2"/>
                <circle cx="35" cy="2" r="2" fill="#ffaa00"/>
                <rect x="5" y="28" width="16" height="20" rx="4" fill="#3a2a10" stroke="#aa7733" stroke-width="1.5"/>
                <rect x="2" y="44" width="12" height="8" rx="2" fill="#2a1a00" stroke="#aa7733" stroke-width="1"/>
                <ellipse cx="3" cy="38" rx="3" ry="5" fill="#666666" stroke="#999999" stroke-width="1"/>
                <rect x="49" y="28" width="16" height="20" rx="4" fill="#3a2a10" stroke="#aa7733" stroke-width="1.5"/>
                <polygon points="64,40 70,37 70,43 64,46" fill="#666666" stroke="#999999" stroke-width="1"/>
                <rect x="22" y="54" width="11" height="14" rx="3" fill="#3a2a10" stroke="#aa7733" stroke-width="1.5"/>
                <rect x="37" y="54" width="11" height="14" rx="3" fill="#3a2a10" stroke="#aa7733" stroke-width="1.5"/>
              </svg>`},

            { id: 30, name: "Mecha-Lord Alpha", type: "FUSION", attribute: "EARTH", level: 8, atk: 3000, def: 2500, desc: "Neon Knight + Speed Router. Piercing damage.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,2 50,10 52,24 35,28 18,24 20,10" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <rect x="22" y="14" width="26" height="7" rx="1" fill="#88ff00" opacity="0.7"/>
                <rect x="0" y="28" width="18" height="16" rx="3" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <rect x="52" y="28" width="18" height="16" rx="3" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <rect x="0" y="31" width="22" height="5" rx="1" fill="#2a4000" stroke="#88ff00" stroke-width="1"/>
                <rect x="48" y="31" width="22" height="5" rx="1" fill="#2a4000" stroke="#88ff00" stroke-width="1"/>
                <circle cx="0" cy="33" r="3" fill="#88ff00" opacity="0.8"/>
                <circle cx="70" cy="33" r="3" fill="#88ff00" opacity="0.8"/>
                <rect x="16" y="26" width="38" height="28" rx="4" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <circle cx="35" cy="38" r="9" fill="#0a2000" stroke="#88ff00" stroke-width="2"/>
                <circle cx="35" cy="38" r="5" fill="#44ff00" opacity="0.5"/>
                <polygon points="35,32 38,38 35,44 32,38" fill="#88ff00" opacity="0.8"/>
                <line x1="18" y1="32" x2="50" y2="32" stroke="#88ff00" stroke-width="0.7" opacity="0.4"/>
                <line x1="18" y1="48" x2="50" y2="48" stroke="#88ff00" stroke-width="0.7" opacity="0.4"/>
                <rect x="17" y="52" width="16" height="16" rx="3" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <rect x="37" y="52" width="16" height="16" rx="3" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <ellipse cx="25" cy="68" rx="8" ry="3" fill="#44ff00" opacity="0.5"/>
                <ellipse cx="45" cy="68" rx="8" ry="3" fill="#44ff00" opacity="0.5"/>
              </svg>`},

            { id: 31, name: "Ultimate Firewall", type: "FUSION", attribute: "LIGHT", level: 9, atk: 0, def: 4000, desc: "Firewall Guard + Firewall Guard. Cannot be destroyed by battle.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,3 L62,16 L66,50 L35,68 L4,50 L8,16Z" fill="#0d1a3a" stroke="#ffffff" stroke-width="2"/>
                <path d="M35,10 L56,20 L59,47 L35,62 L11,47 L14,20Z" fill="#0a1530" stroke="#00e5ff" stroke-width="1.5"/>
                <line x1="14" y1="30" x2="56" y2="30" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="14" y1="38" x2="56" y2="38" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="14" y1="46" x2="56" y2="46" stroke="#ff4400" stroke-width="1.5"/>
                <line x1="22" y1="22" x2="22" y2="56" stroke="#ff4400" stroke-width="1"/>
                <line x1="30" y1="18" x2="30" y2="60" stroke="#ff4400" stroke-width="1"/>
                <line x1="40" y1="18" x2="40" y2="60" stroke="#ff4400" stroke-width="1"/>
                <line x1="48" y1="22" x2="48" y2="56" stroke="#ff4400" stroke-width="1"/>
                <polygon points="35,25 44,35 35,45 26,35" fill="#001133" stroke="#00e5ff" stroke-width="2"/>
                <polygon points="35,28 41,35 35,42 29,35" fill="#00aaff" opacity="0.5"/>
                <circle cx="35" cy="35" r="4" fill="#ffffff" opacity="0.7"/>
                <polygon points="15,18 20,24 15,30 10,24" fill="#001133" stroke="#00e5ff" stroke-width="1.5"/>
                <polygon points="55,18 60,24 55,30 50,24" fill="#001133" stroke="#00e5ff" stroke-width="1.5"/>
                <polygon points="15,42 20,48 15,54 10,48" fill="#001133" stroke="#00e5ff" stroke-width="1.5"/>
                <polygon points="55,42 60,48 55,54 50,48" fill="#001133" stroke="#00e5ff" stroke-width="1.5"/>
                <ellipse cx="35" cy="8" rx="14" ry="5" fill="none" stroke="#ffffff" stroke-width="1.5" opacity="0.5"/>
              </svg>`},

            { id: 32, name: "Chaos Dragon", type: "FUSION", attribute: "DARK", level: 10, atk: 4000, def: 3000, desc: "Plasma Dragon + Glitch Wolf. Banish 1 card on attack.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,28 Q20,10 3,8 Q-2,22 5,35 Q15,40 30,38Z" fill="#1a0033" stroke="#8800ff" stroke-width="1.5"/>
                <path d="M35,28 Q14,16 5,22 Q0,30 8,38Z" fill="#330055" opacity="0.5"/>
                <path d="M35,28 Q50,10 67,8 Q72,22 65,35 Q55,40 40,38Z" fill="#1a0033" stroke="#8800ff" stroke-width="1.5"/>
                <path d="M35,28 Q56,16 65,22 Q70,30 62,38Z" fill="#330055" opacity="0.5"/>
                <line x1="35" y1="28" x2="6" y2="15" stroke="#8800ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="28" x2="4" y2="28" stroke="#8800ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="28" x2="64" y2="15" stroke="#8800ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="35" y1="28" x2="66" y2="28" stroke="#8800ff" stroke-width="0.8" opacity="0.5"/>
                <ellipse cx="35" cy="48" rx="16" ry="18" fill="#1a0033" stroke="#8800ff" stroke-width="2"/>
                <path d="M22,38 Q26,35 30,38 Q34,35 38,38 Q42,35 46,38" fill="none" stroke="#4400aa" stroke-width="1" opacity="0.6"/>
                <path d="M20,44 Q24,41 28,44 Q32,41 36,44 Q40,41 44,44 Q48,41 50,44" fill="none" stroke="#4400aa" stroke-width="1" opacity="0.6"/>
                <polygon points="30,30 40,30 38,44 32,44" fill="#1a0033" stroke="#8800ff" stroke-width="1.5"/>
                <polygon points="35,6 50,15 50,28 35,32 20,28 20,15" fill="#1a0033" stroke="#8800ff" stroke-width="2"/>
                <polygon points="22,14 18,4 26,14" fill="#330055" stroke="#8800ff" stroke-width="1"/>
                <polygon points="35,10 33,2 37,2 38,10" fill="#330055" stroke="#8800ff" stroke-width="1"/>
                <polygon points="48,14 52,4 44,14" fill="#330055" stroke="#8800ff" stroke-width="1"/>
                <circle cx="28" cy="19" r="5" fill="#200020"/>
                <circle cx="42" cy="19" r="5" fill="#200020"/>
                <circle cx="28" cy="19" r="3" fill="#aa00ff"/>
                <circle cx="42" cy="19" r="3" fill="#aa00ff"/>
                <circle cx="28" cy="19" r="1.5" fill="#ffffff"/>
                <circle cx="42" cy="19" r="1.5" fill="#ffffff"/>
                <polygon points="35,24 42,28 35,32 28,28" fill="#220033" stroke="#8800ff" stroke-width="1"/>
                <path d="M42,60 Q55,65 62,58 Q67,50 62,62" fill="none" stroke="#8800ff" stroke-width="2.5"/>
                <polygon points="62,64 66,58 60,60" fill="#8800ff"/>
              </svg>`},

            { id: 33, name: "Twin-Core Golem", type: "FUSION", attribute: "EARTH", level: 7, atk: 2600, def: 2400, desc: "Server Golem + Server Golem. Can attack twice.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="10" y="22" width="22" height="35" rx="4" fill="#2a3a10" stroke="#88bb44" stroke-width="2"/>
                <rect x="38" y="22" width="22" height="35" rx="4" fill="#2a3a10" stroke="#88bb44" stroke-width="2"/>
                <rect x="28" y="30" width="14" height="18" rx="2" fill="#1a2a08" stroke="#88bb44" stroke-width="1.5"/>
                <circle cx="21" cy="38" r="8" fill="#1a2a00" stroke="#88bb44" stroke-width="1.5"/>
                <circle cx="21" cy="38" r="5" fill="#44aa00" opacity="0.4"/>
                <circle cx="21" cy="38" r="2.5" fill="#88ff00" opacity="0.8"/>
                <circle cx="49" cy="38" r="8" fill="#1a2a00" stroke="#88bb44" stroke-width="1.5"/>
                <circle cx="49" cy="38" r="5" fill="#44aa00" opacity="0.4"/>
                <circle cx="49" cy="38" r="2.5" fill="#88ff00" opacity="0.8"/>
                <line x1="29" y1="38" x2="41" y2="38" stroke="#88ff00" stroke-width="2" opacity="0.7"/>
                <rect x="10" y="8" width="22" height="16" rx="3" fill="#2a3a10" stroke="#88bb44" stroke-width="2"/>
                <rect x="38" y="8" width="22" height="16" rx="3" fill="#2a3a10" stroke="#88bb44" stroke-width="2"/>
                <rect x="14" y="11" width="7" height="5" rx="1" fill="#44ff00" opacity="0.8"/>
                <rect x="23" y="11" width="7" height="5" rx="1" fill="#44ff00" opacity="0.8"/>
                <rect x="42" y="11" width="7" height="5" rx="1" fill="#44ff00" opacity="0.8"/>
                <rect x="51" y="11" width="7" height="5" rx="1" fill="#44ff00" opacity="0.8"/>
                <line x1="12" y1="30" x2="30" y2="30" stroke="#88bb44" stroke-width="0.8" opacity="0.5"/>
                <line x1="12" y1="42" x2="30" y2="42" stroke="#88bb44" stroke-width="0.8" opacity="0.5"/>
                <line x1="40" y1="30" x2="58" y2="30" stroke="#88bb44" stroke-width="0.8" opacity="0.5"/>
                <line x1="40" y1="42" x2="58" y2="42" stroke="#88bb44" stroke-width="0.8" opacity="0.5"/>
                <rect x="12" y="56" width="12" height="12" rx="2" fill="#2a3a10" stroke="#88bb44" stroke-width="1.5"/>
                <rect x="46" y="56" width="12" height="12" rx="2" fill="#2a3a10" stroke="#88bb44" stroke-width="1.5"/>
                <ellipse cx="18" cy="68" rx="8" ry="3" fill="#44ff00" opacity="0.3"/>
                <ellipse cx="52" cy="68" rx="8" ry="3" fill="#44ff00" opacity="0.3"/>
              </svg>`},

            { id: 50, name: "System Reboot", type: "SPELL", attribute: "SPELL", desc: "Special Summon 1 monster from your GY.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="30" fill="none" stroke="#00e5ff" stroke-width="2" opacity="0.7"/>
                <circle cx="35" cy="35" r="24" fill="none" stroke="#00e5ff" stroke-width="1" opacity="0.4"/>
                <path d="M35,7 A28,28 0 0,1 63,35" fill="none" stroke="#00e5ff" stroke-width="3"/>
                <path d="M63,35 A28,28 0 0,1 35,63" fill="none" stroke="#0088aa" stroke-width="3"/>
                <path d="M35,63 A28,28 0 0,1 7,35" fill="none" stroke="#00e5ff" stroke-width="3"/>
                <path d="M7,35 A28,28 0 0,1 35,7" fill="none" stroke="#0088aa" stroke-width="3"/>
                <rect x="31" y="3" width="8" height="8" rx="1" fill="#001a2a" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="31" y="59" width="8" height="8" rx="1" fill="#001a2a" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="3" y="31" width="8" height="8" rx="1" fill="#001a2a" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="59" y="31" width="8" height="8" rx="1" fill="#001a2a" stroke="#00e5ff" stroke-width="1.5"/>
                <circle cx="35" cy="35" r="14" fill="#001a2a" opacity="0.8"/>
                <ellipse cx="35" cy="32" rx="5" ry="7" fill="#00e5ff" opacity="0.6"/>
                <circle cx="35" cy="24" r="4" fill="#00e5ff" opacity="0.7"/>
                <circle cx="35" cy="35" r="10" fill="#00aaff" opacity="0.1"/>
              </svg>`},

            { id: 51, name: "Overclock", type: "SPELL", attribute: "SPELL", desc: "Target monster gains 700 ATK until end of turn.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M10,48 A28,28 0 0,1 60,48" fill="#1a1a00" stroke="#ffaa00" stroke-width="2"/>
                <path d="M12,48 A26,26 0 0,1 25,25" fill="none" stroke="#44ff44" stroke-width="5" stroke-linecap="round"/>
                <path d="M25,25 A26,26 0 0,1 45,19" fill="none" stroke="#ffaa00" stroke-width="5" stroke-linecap="round"/>
                <path d="M45,19 A26,26 0 0,1 58,48" fill="none" stroke="#ff2200" stroke-width="5" stroke-linecap="round"/>
                <line x1="35" y1="48" x2="55" y2="21" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round"/>
                <circle cx="35" cy="48" r="4" fill="#333300" stroke="#ffaa00" stroke-width="2"/>
                <line x1="8" y1="30" x2="20" y2="34" stroke="#ffaa00" stroke-width="1.5" opacity="0.6"/>
                <line x1="5" y1="38" x2="18" y2="40" stroke="#ffaa00" stroke-width="2" opacity="0.7"/>
                <line x1="8" y1="46" x2="20" y2="46" stroke="#ffaa00" stroke-width="1.5" opacity="0.6"/>
                <polygon points="33,55 30,62 36,58 33,65 40,56 34,60" fill="#ffff00" stroke="#ff8800" stroke-width="1"/>
                <rect x="26" y="60" width="18" height="8" rx="2" fill="#331100" stroke="#ff4400" stroke-width="1"/>
                <text x="28" y="67" font-size="7" fill="#ff4400" font-family="monospace" font-weight="bold">MAX</text>
              </svg>`},

            { id: 52, name: "Firewall Patch", type: "SPELL", attribute: "SPELL", desc: "Gain 1000 LP.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,5 L58,16 L62,48 L35,65 L8,48 L12,16Z" fill="#001a40" stroke="#00e5ff" stroke-width="2"/>
                <path d="M35,12 L52,20 L55,45 L35,58 L15,45 L18,20Z" fill="#001030" stroke="#0088cc" stroke-width="1"/>
                <rect x="30" y="25" width="10" height="24" rx="2" fill="#00aa44" opacity="0.8"/>
                <rect x="23" y="32" width="24" height="10" rx="2" fill="#00aa44" opacity="0.8"/>
                <rect x="29" y="24" width="12" height="26" rx="2" fill="none" stroke="#00ff88" stroke-width="1.5"/>
                <rect x="22" y="31" width="26" height="12" rx="2" fill="none" stroke="#00ff88" stroke-width="1.5"/>
                <circle cx="35" cy="8" r="3" fill="#00e5ff" opacity="0.6"/>
                <line x1="12" y1="20" x2="58" y2="20" stroke="#00e5ff" stroke-width="0.8" opacity="0.4"/>
              </svg>`},

            { id: 53, name: "Dark Web Deal", type: "SPELL", attribute: "SPELL", desc: "Draw 2 cards, then discard 1 card.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="28" fill="#0d000d" stroke="#660066" stroke-width="2"/>
                <circle cx="35" cy="35" r="22" fill="#0d000d" stroke="#440044" stroke-width="1"/>
                <line x1="35" y1="35" x2="35" y2="8" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="58" y2="21" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="62" y2="48" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="50" y2="60" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="20" y2="60" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="8" y2="48" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <line x1="35" y1="35" x2="12" y2="21" stroke="#660066" stroke-width="1" opacity="0.7"/>
                <circle cx="35" cy="35" r="8" fill="none" stroke="#660066" stroke-width="1" opacity="0.8"/>
                <circle cx="35" cy="35" r="15" fill="none" stroke="#660066" stroke-width="1" opacity="0.5"/>
                <circle cx="35" cy="35" r="5" fill="#220022" stroke="#cc00cc" stroke-width="1.5"/>
                <line x1="32" y1="32" x2="27" y2="26" stroke="#cc00cc" stroke-width="1.2"/>
                <line x1="30" y1="35" x2="24" y2="33" stroke="#cc00cc" stroke-width="1.2"/>
                <line x1="31" y1="38" x2="26" y2="43" stroke="#cc00cc" stroke-width="1.2"/>
                <line x1="38" y1="32" x2="43" y2="26" stroke="#cc00cc" stroke-width="1.2"/>
                <line x1="40" y1="35" x2="46" y2="33" stroke="#cc00cc" stroke-width="1.2"/>
                <line x1="39" y1="38" x2="44" y2="43" stroke="#cc00cc" stroke-width="1.2"/>
                <rect x="10" y="20" width="8" height="10" rx="1" fill="#220022" stroke="#cc00cc" stroke-width="1" opacity="0.6"/>
                <rect x="52" y="20" width="8" height="10" rx="1" fill="#220022" stroke="#cc00cc" stroke-width="1" opacity="0.6"/>
              </svg>`},

            { id: 54, name: "Thunder Strike", type: "SPELL", attribute: "SPELL", desc: "Destroy 1 monster on the field.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="25" cy="15" rx="18" ry="10" fill="#1a1a2a" stroke="#6666aa" stroke-width="1"/>
                <ellipse cx="45" cy="13" rx="20" ry="11" fill="#1a1a2a" stroke="#6666aa" stroke-width="1"/>
                <polygon points="40,22 32,42 40,40 30,62 46,38 37,40 44,22" fill="#ffff00" stroke="#ff8800" stroke-width="1.5"/>
                <line x1="20" y1="28" x2="28" y2="45" stroke="#ffff00" stroke-width="1" opacity="0.5"/>
                <line x1="50" y1="26" x2="44" y2="42" stroke="#ffff00" stroke-width="1" opacity="0.5"/>
                <circle cx="38" cy="62" r="8" fill="#ff8800" opacity="0.3"/>
                <circle cx="38" cy="62" r="4" fill="#ffff00" opacity="0.4"/>
                <line x1="30" y1="62" x2="25" y2="65" stroke="#ffff00" stroke-width="1.5" opacity="0.7"/>
                <line x1="42" y1="62" x2="47" y2="66" stroke="#ffff00" stroke-width="1.5" opacity="0.7"/>
                <line x1="38" y1="65" x2="38" y2="70" stroke="#ffff00" stroke-width="1.5" opacity="0.7"/>
              </svg>`},

            { id: 55, name: "Polymerization", type: "SPELL", attribute: "SPELL", desc: "Fusion Summon 1 Fusion Monster from Extra Deck.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="28" fill="#0d0d20" opacity="0.9"/>
                <path d="M35,35 Q42,20 58,18 Q65,25 60,35 Q55,45 42,45 Q28,44 20,35 Q14,25 20,16 Q28,8 35,12 Q45,16 50,28" fill="none" stroke="#aa44ff" stroke-width="2"/>
                <path d="M35,35 Q28,50 12,52 Q5,45 10,35 Q15,25 28,25 Q42,26 50,35 Q56,45 50,54 Q42,62 35,58 Q25,54 20,42" fill="none" stroke="#ff44aa" stroke-width="2"/>
                <rect x="8" y="24" width="14" height="18" rx="2" fill="#1a0040" stroke="#aa44ff" stroke-width="1.5" transform="rotate(-20 15 33)"/>
                <rect x="48" y="24" width="14" height="18" rx="2" fill="#400010" stroke="#ff44aa" stroke-width="1.5" transform="rotate(20 55 33)"/>
                <polygon points="35,24 42,35 35,46 28,35" fill="#330033" stroke="#ff88ff" stroke-width="2"/>
                <polygon points="35,27 40,35 35,43 30,35" fill="#aa44ff" opacity="0.4"/>
                <circle cx="35" cy="35" r="4" fill="#ff88ff" opacity="0.7"/>
                <circle cx="20" cy="15" r="2" fill="#aa44ff" opacity="0.6"/>
                <circle cx="50" cy="14" r="2" fill="#ff44aa" opacity="0.6"/>
              </svg>`},

            { id: 56, name: "Field Shield", type: "SPELL", attribute: "SPELL", desc: "All your monsters gain 500 DEF.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="58" rx="28" ry="8" fill="#0a1a2a" stroke="#0088cc" stroke-width="1.5"/>
                <path d="M8,56 Q8,10 35,8 Q62,10 62,56" fill="#001a3a" stroke="#00aaff" stroke-width="2" opacity="0.7"/>
                <path d="M15,52 Q15,20 35,18 Q55,20 55,52" fill="none" stroke="#0066aa" stroke-width="1" opacity="0.5"/>
                <path d="M9,40 Q9,35 35,34 Q61,35 61,40" fill="none" stroke="#00aaff" stroke-width="1" opacity="0.5"/>
                <path d="M11,48 Q11,45 35,44 Q59,45 59,48" fill="none" stroke="#00aaff" stroke-width="1" opacity="0.5"/>
                <path d="M12,30 Q12,25 35,24 Q58,25 58,30" fill="none" stroke="#00aaff" stroke-width="0.8" opacity="0.4"/>
                <ellipse cx="22" cy="52" rx="6" ry="8" fill="#004466" stroke="#0088cc" stroke-width="1" opacity="0.5"/>
                <ellipse cx="35" cy="52" rx="5" ry="7" fill="#004466" stroke="#0088cc" stroke-width="1" opacity="0.5"/>
                <ellipse cx="48" cy="52" rx="6" ry="8" fill="#004466" stroke="#0088cc" stroke-width="1" opacity="0.5"/>
                <circle cx="35" cy="10" r="5" fill="#00e5ff" opacity="0.3"/>
              </svg>`},

            { id: 57, name: "Data Corruption", type: "SPELL", attribute: "SPELL", desc: "Destroy 1 Spell/Trap card.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="8" y="12" width="54" height="46" rx="3" fill="#0d0d0d" stroke="#cc0000" stroke-width="2"/>
                <rect x="10" y="14" width="50" height="42" rx="2" fill="#0a0000" opacity="0.8"/>
                <rect x="10" y="20" width="30" height="4" fill="#ff2200" opacity="0.7"/>
                <rect x="28" y="20" width="22" height="4" fill="#110000" opacity="0.9"/>
                <rect x="10" y="28" width="15" height="3" fill="#ff2200" opacity="0.5"/>
                <rect x="38" y="26" width="22" height="5" fill="#ff2200" opacity="0.6"/>
                <rect x="12" y="34" width="40" height="3" fill="#ff4400" opacity="0.4"/>
                <rect x="25" y="34" width="18" height="3" fill="#110000" opacity="0.8"/>
                <rect x="10" y="40" width="25" height="4" fill="#ff2200" opacity="0.5"/>
                <rect x="48" y="38" width="12" height="6" fill="#ff4400" opacity="0.4"/>
                <polygon points="35,16 42,28 28,28" fill="#ff0000" opacity="0.7"/>
                <text x="33" y="26" font-size="7" fill="#ffffff" font-family="monospace">!</text>
                <text x="12" y="52" font-size="5" fill="#ff2200" opacity="0.4" font-family="monospace">011011</text>
                <line x1="50" y1="42" x2="58" y2="50" stroke="#ff0000" stroke-width="2"/>
                <line x1="58" y1="42" x2="50" y2="50" stroke="#ff0000" stroke-width="2"/>
              </svg>`},

            { id: 70, name: "404 Not Found", type: "TRAP", attribute: "TRAP", desc: "Negate an attack from an opponent's monster.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="5" y="12" width="60" height="40" rx="4" fill="#0d0d1a" stroke="#ff4466" stroke-width="2"/>
                <rect x="8" y="15" width="54" height="34" rx="2" fill="#050515"/>
                <text x="11" y="37" font-size="20" fill="#ff4466" font-family="monospace" font-weight="bold">404</text>
                <text x="9" y="44" font-size="6" fill="#ff4466" font-family="monospace">NOT FOUND</text>
                <rect x="50" y="38" width="5" height="8" fill="#ff4466" opacity="0.8"/>
                <rect x="28" y="52" width="14" height="6" rx="1" fill="#1a1a2a" stroke="#ff4466" stroke-width="1"/>
                <rect x="22" y="58" width="26" height="5" rx="2" fill="#1a1a2a" stroke="#ff4466" stroke-width="1"/>
                <circle cx="60" cy="48" r="2.5" fill="#ff0000" opacity="0.8"/>
                <circle cx="54" cy="48" r="2.5" fill="#ffaa00" opacity="0.5"/>
              </svg>`},

            { id: 71, name: "DDoS Attack", type: "TRAP", attribute: "TRAP", desc: "Destroy 1 attacking monster.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="26" y="28" width="18" height="22" rx="2" fill="#1a0000" stroke="#ff2200" stroke-width="2"/>
                <circle cx="35" cy="37" r="5" fill="#331100" stroke="#ff4400" stroke-width="1.5"/>
                <circle cx="35" cy="37" r="2.5" fill="#ff2200"/>
                <polygon points="35,5 32,14 38,14" fill="#ff4400"/>
                <line x1="35" y1="14" x2="35" y2="28" stroke="#ff4400" stroke-width="2"/>
                <polygon points="58,8 52,15 57,19" fill="#ff4400"/>
                <line x1="55" y1="17" x2="43" y2="30" stroke="#ff4400" stroke-width="2"/>
                <polygon points="65,37 56,34 56,40" fill="#ff4400"/>
                <line x1="56" y1="37" x2="44" y2="37" stroke="#ff4400" stroke-width="2"/>
                <polygon points="58,62 52,55 57,51" fill="#ff4400"/>
                <line x1="55" y1="53" x2="43" y2="46" stroke="#ff4400" stroke-width="2"/>
                <polygon points="35,65 32,56 38,56" fill="#ff4400"/>
                <line x1="35" y1="56" x2="35" y2="50" stroke="#ff4400" stroke-width="2"/>
                <polygon points="12,62 18,55 13,51" fill="#ff4400"/>
                <line x1="15" y1="53" x2="27" y2="46" stroke="#ff4400" stroke-width="2"/>
                <polygon points="5,37 14,34 14,40" fill="#ff4400"/>
                <line x1="14" y1="37" x2="26" y2="37" stroke="#ff4400" stroke-width="2"/>
                <polygon points="12,8 18,15 13,19" fill="#ff4400"/>
                <line x1="15" y1="17" x2="27" y2="30" stroke="#ff4400" stroke-width="2"/>
              </svg>`},

            { id: 72, name: "Lag Spike", type: "TRAP", attribute: "TRAP", desc: "Opponent's monsters cannot attack this turn.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="32" r="26" fill="#0d0d1a" stroke="#8888ff" stroke-width="2"/>
                <circle cx="35" cy="32" r="22" fill="#080820" stroke="#5555aa" stroke-width="1"/>
                <line x1="35" y1="12" x2="35" y2="16" stroke="#8888ff" stroke-width="2"/>
                <line x1="35" y1="48" x2="35" y2="52" stroke="#8888ff" stroke-width="2"/>
                <line x1="11" y1="32" x2="15" y2="32" stroke="#8888ff" stroke-width="2"/>
                <line x1="55" y1="32" x2="59" y2="32" stroke="#8888ff" stroke-width="2"/>
                <line x1="35" y1="32" x2="35" y2="16" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="35" y1="32" x2="48" y2="38" stroke="#8888ff" stroke-width="2" stroke-linecap="round"/>
                <circle cx="35" cy="32" r="3" fill="#aaaaff" stroke="#ffffff" stroke-width="1"/>
                <polygon points="35,8 30,20 35,16 40,20" fill="#aaaaff" opacity="0.6"/>
                <polygon points="60,14 52,24 57,22 55,30" fill="#aaaaff" opacity="0.4"/>
                <polygon points="10,14 18,24 13,22 15,30" fill="#aaaaff" opacity="0.4"/>
                <rect x="20" y="58" width="30" height="10" rx="3" fill="#0d0d1a" stroke="#8888ff" stroke-width="1.5"/>
                <text x="23" y="66" font-size="8" fill="#8888ff" font-family="monospace" font-weight="bold">LAG</text>
              </svg>`},

            { id: 73, name: "Mirror Forcefield", type: "TRAP", attribute: "TRAP", desc: "Destroy all attack position monsters opponent controls.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M5,20 L35,5 L65,20 L65,55 L35,68 L5,55Z" fill="#0d1a2a" stroke="#aaddff" stroke-width="2"/>
                <path d="M10,24 L35,12 L60,24 L60,52 L35,62 L10,52Z" fill="#1a2a3a" stroke="#88bbff" stroke-width="1"/>
                <line x1="10" y1="12" x2="30" y2="45" stroke="white" stroke-width="3" opacity="0.12"/>
                <line x1="18" y1="8" x2="38" y2="40" stroke="white" stroke-width="2" opacity="0.08"/>
                <line x1="35" y1="5" x2="35" y2="25" stroke="#ff4400" stroke-width="1.5" stroke-dasharray="3,2" opacity="0.5"/>
                <polygon points="22,18 28,24 24,28" fill="#ff4400" opacity="0.7"/>
                <line x1="26" y1="25" x2="10" y2="15" stroke="#ff4400" stroke-width="1.5" opacity="0.7"/>
                <polygon points="48,18 42,24 46,28" fill="#ff4400" opacity="0.7"/>
                <line x1="44" y1="25" x2="60" y2="15" stroke="#ff4400" stroke-width="1.5" opacity="0.7"/>
                <polygon points="35,20 42,33 35,46 28,33" fill="#0d1a2a" stroke="#aaddff" stroke-width="2"/>
                <polygon points="35,24 40,33 35,42 30,33" fill="#aaddff" opacity="0.3"/>
                <circle cx="35" cy="33" r="4" fill="#ffffff" opacity="0.5"/>
                <line x1="12" y1="35" x2="58" y2="35" stroke="#88bbff" stroke-width="0.7" opacity="0.3"/>
              </svg>`},

            { id: 74, name: "Backup File", type: "TRAP", attribute: "TRAP", desc: "Return 1 destroyed monster to your hand.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="15,8 55,8 60,15 60,62 15,62" fill="#0d1a2a" stroke="#00aaff" stroke-width="2"/>
                <polygon points="55,8 55,15 60,15" fill="#0d0d0d" stroke="#00aaff" stroke-width="1"/>
                <line x1="22" y1="22" x2="52" y2="22" stroke="#0088cc" stroke-width="1.5"/>
                <line x1="22" y1="28" x2="48" y2="28" stroke="#0088cc" stroke-width="1.5"/>
                <line x1="22" y1="34" x2="52" y2="34" stroke="#0088cc" stroke-width="1.5"/>
                <line x1="22" y1="40" x2="44" y2="40" stroke="#0088cc" stroke-width="1.5"/>
                <path d="M28,56 Q28,46 35,46 Q42,46 42,56" fill="none" stroke="#00e5ff" stroke-width="2.5"/>
                <polygon points="28,56 23,48 33,48" fill="#00e5ff"/>
                <circle cx="35" cy="16" r="5" fill="#001a3a" stroke="#00aaff" stroke-width="1.5"/>
                <line x1="33" y1="16" x2="37" y2="16" stroke="#00aaff" stroke-width="1.5"/>
                <line x1="35" y1="14" x2="35" y2="18" stroke="#00aaff" stroke-width="1.5"/>
              </svg>`},

            { id: 75, name: "Magic Jammer", type: "TRAP", attribute: "TRAP", desc: "Negate a Spell card activation.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="28" y="38" width="14" height="22" rx="2" fill="#1a1a00" stroke="#ffaa00" stroke-width="2"/>
                <rect x="24" y="56" width="22" height="6" rx="2" fill="#2a2a00" stroke="#ffaa00" stroke-width="1.5"/>
                <line x1="35" y1="38" x2="35" y2="24" stroke="#ffaa00" stroke-width="2.5"/>
                <circle cx="35" cy="22" r="4" fill="#1a1a00" stroke="#ffaa00" stroke-width="2"/>
                <path d="M20,30 Q25,22 30,30" fill="none" stroke="#666666" stroke-width="1.5" opacity="0.4"/>
                <path d="M15,32 Q22,18 30,32" fill="none" stroke="#666666" stroke-width="1.5" opacity="0.3"/>
                <path d="M40,30 Q45,22 50,30" fill="none" stroke="#666666" stroke-width="1.5" opacity="0.4"/>
                <path d="M40,32 Q48,18 55,32" fill="none" stroke="#666666" stroke-width="1.5" opacity="0.3"/>
                <line x1="10" y1="18" x2="62" y2="50" stroke="#ff2200" stroke-width="4" stroke-linecap="round"/>
                <line x1="10" y1="50" x2="62" y2="18" stroke="#ff2200" stroke-width="4" stroke-linecap="round"/>
                <circle cx="35" cy="46" r="4" fill="#ffaa00" opacity="0.5"/>
                <line x1="36" y1="10" x2="40" y2="6" stroke="#ffff00" stroke-width="1.5" opacity="0.7"/>
                <line x1="34" y1="8" x2="30" y2="4" stroke="#ffff00" stroke-width="1.5" opacity="0.7"/>
              </svg>`},

               // --- NEW HIGH-TIER EFFECT MONSTERS (IDs 18-21) ---
            { id: 18, name: "Omega Sentinel", type: "EFFECT", attribute: "LIGHT", level: 8, atk: 2800, def: 2600,
              desc: "Cannot be targeted by card effects. Once per turn: Negate 1 card effect and destroy it.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="18" r="16" fill="none" stroke="#ffdd00" stroke-width="1" opacity="0.5"/>
                <circle cx="35" cy="18" r="12" fill="none" stroke="#ffffff" stroke-width="0.7" opacity="0.4"/>
                <line x1="35" y1="2" x2="35" y2="6" stroke="#ffdd00" stroke-width="2"/>
                <line x1="52" y1="6" x2="50" y2="9" stroke="#ffdd00" stroke-width="2"/>
                <line x1="18" y1="6" x2="20" y2="9" stroke="#ffdd00" stroke-width="2"/>
                <line x1="60" y1="16" x2="58" y2="18" stroke="#ffdd00" stroke-width="2"/>
                <line x1="10" y1="16" x2="12" y2="18" stroke="#ffdd00" stroke-width="2"/>
                <path d="M22,30 Q0,14 2,4 Q12,18 20,34Z" fill="#1a2a50" stroke="#00e5ff" stroke-width="1.5"/>
                <path d="M22,30 Q5,20 8,12 Q16,24 20,34Z" fill="#0a1a40" stroke="#aaddff" stroke-width="0.8"/>
                <path d="M48,30 Q70,14 68,4 Q58,18 50,34Z" fill="#1a2a50" stroke="#00e5ff" stroke-width="1.5"/>
                <path d="M48,30 Q65,20 62,12 Q54,24 50,34Z" fill="#0a1a40" stroke="#aaddff" stroke-width="0.8"/>
                <path d="M24,32 Q8,28 10,20 Q18,28 22,36Z" fill="#2a3a60" stroke="#88ccff" stroke-width="1"/>
                <path d="M46,32 Q62,28 60,20 Q52,28 48,36Z" fill="#2a3a60" stroke="#88ccff" stroke-width="1"/>
                <line x1="22" y1="30" x2="5" y2="8" stroke="#aaddff" stroke-width="0.6" opacity="0.5"/>
                <line x1="22" y1="32" x2="3" y2="16" stroke="#aaddff" stroke-width="0.6" opacity="0.5"/>
                <line x1="48" y1="30" x2="65" y2="8" stroke="#aaddff" stroke-width="0.6" opacity="0.5"/>
                <line x1="48" y1="32" x2="67" y2="16" stroke="#aaddff" stroke-width="0.6" opacity="0.5"/>
                <polygon points="26,34 44,34 46,58 35,64 24,58" fill="#1a2a50" stroke="#00e5ff" stroke-width="2"/>
                <polygon points="35,38 40,44 35,50 30,44" fill="#001133" stroke="#00e5ff" stroke-width="1.5"/>
                <polygon points="35,40 39,44 35,48 31,44" fill="#00aaff" opacity="0.6"/>
                <circle cx="35" cy="44" r="3" fill="#ffffff" opacity="0.8"/>
                <line x1="28" y1="40" x2="42" y2="40" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="27" y1="46" x2="43" y2="46" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <line x1="27" y1="52" x2="43" y2="52" stroke="#00e5ff" stroke-width="0.8" opacity="0.5"/>
                <polygon points="28,18 42,18 44,28 35,32 26,28" fill="#1a2a50" stroke="#00e5ff" stroke-width="2"/>
                <polygon points="30,20 40,20 42,26 35,30 28,26" fill="#0a1540" stroke="#88ccff" stroke-width="1"/>
                <rect x="29" y="23" width="5" height="3" rx="1" fill="#ffffff"/>
                <rect x="36" y="23" width="5" height="3" rx="1" fill="#ffffff"/>
                <rect x="30" y="23" width="3" height="3" rx="1" fill="#00e5ff"/>
                <rect x="37" y="23" width="3" height="3" rx="1" fill="#00e5ff"/>
                <polygon points="35,12 32,18 38,18" fill="#1a2a50" stroke="#ffdd00" stroke-width="1.5"/>
                <circle cx="35" cy="11" r="3.5" fill="#ffdd00" opacity="0.9"/>
                <line x1="52" y1="36" x2="68" y2="16" stroke="#aaddff" stroke-width="3.5" stroke-linecap="round"/>
                <rect x="57" y="29" width="5" height="2.5" rx="1" fill="#ffffff" transform="rotate(-45 59 30)"/>
                <circle cx="52" cy="37" r="3.5" fill="#00aaff" stroke="#ffffff" stroke-width="1"/>
                <rect x="27" y="60" width="8" height="10" rx="2" fill="#1a2a50" stroke="#00e5ff" stroke-width="1.5"/>
                <rect x="35" y="60" width="8" height="10" rx="2" fill="#1a2a50" stroke="#00e5ff" stroke-width="1.5"/>
                <ellipse cx="31" cy="70" rx="6" ry="2" fill="#00e5ff" opacity="0.5"/>
                <ellipse cx="39" cy="70" rx="6" ry="2" fill="#00e5ff" opacity="0.5"/>
              </svg>`},

            { id: 19, name: "Void Phantom", type: "EFFECT", attribute: "DARK", level: 7, atk: 2600, def: 200,
              desc: "Can attack all opponent monsters once each. Unaffected by Trap card effects.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="38" r="28" fill="#000000" opacity="0.7"/>
                <circle cx="35" cy="38" r="22" fill="#110011" stroke="#440044" stroke-width="1"/>
                <circle cx="35" cy="38" r="15" fill="#1a0022" stroke="#6600aa" stroke-width="1.5"/>
                <path d="M35,38 Q52,25 62,30 Q66,42 55,50 Q40,55 35,38" fill="none" stroke="#330033" stroke-width="1.5" opacity="0.7"/>
                <path d="M35,38 Q18,25 8,30 Q4,42 15,50 Q30,55 35,38" fill="none" stroke="#330033" stroke-width="1.5" opacity="0.7"/>
                <path d="M35,22 Q38,12 44,8 Q46,4 48,8 Q45,14 40,18" fill="none" stroke="#aa00ff" stroke-width="2"/>
                <path d="M35,22 Q32,12 26,8 Q24,4 22,8 Q25,14 30,18" fill="none" stroke="#aa00ff" stroke-width="2"/>
                <path d="M52,30 Q64,24 68,16 Q70,10 65,14 Q60,20 54,28" fill="none" stroke="#aa00ff" stroke-width="1.5"/>
                <path d="M18,30 Q6,24 2,16 Q0,10 5,14 Q10,20 16,28" fill="none" stroke="#aa00ff" stroke-width="1.5"/>
                <path d="M50,46 Q64,50 66,57 Q64,62 60,58 Q55,52 50,48" fill="none" stroke="#8800ff" stroke-width="1.5"/>
                <path d="M20,46 Q6,50 4,57 Q6,62 10,58 Q15,52 20,48" fill="none" stroke="#8800ff" stroke-width="1.5"/>
                <ellipse cx="35" cy="36" rx="12" ry="15" fill="#1a0033" stroke="#9900ff" stroke-width="2"/>
                <path d="M24,50 Q20,60 22,66 Q28,60 30,68 Q34,60 35,68 Q36,60 40,68 Q42,60 48,66 Q50,58 46,50" fill="#0d0022" stroke="#6600aa" stroke-width="1"/>
                <ellipse cx="35" cy="26" rx="10" ry="11" fill="#110022" stroke="#9900ff" stroke-width="1.5"/>
                <circle cx="29" cy="24" r="4.5" fill="#000000" stroke="#6600aa" stroke-width="1.2"/>
                <circle cx="41" cy="24" r="4.5" fill="#000000" stroke="#6600aa" stroke-width="1.2"/>
                <circle cx="29" cy="24" r="3" fill="#aa00ff"/>
                <circle cx="41" cy="24" r="3" fill="#aa00ff"/>
                <circle cx="29" cy="24" r="1.4" fill="#ff88ff"/>
                <circle cx="41" cy="24" r="1.4" fill="#ff88ff"/>
                <line x1="24" y1="24" x2="18" y2="24" stroke="#aa00ff" stroke-width="1.2" opacity="0.8"/>
                <line x1="46" y1="24" x2="52" y2="24" stroke="#aa00ff" stroke-width="1.2" opacity="0.8"/>
                <path d="M28,31 Q32,35 35,33 Q38,35 42,31" fill="none" stroke="#9900ff" stroke-width="1.5"/>
                <circle cx="14" cy="18" r="4" fill="#220033" stroke="#aa00ff" stroke-width="1"/>
                <circle cx="14" cy="18" r="2" fill="#8800ff" opacity="0.7"/>
                <circle cx="56" cy="20" r="4" fill="#220033" stroke="#aa00ff" stroke-width="1"/>
                <circle cx="56" cy="20" r="2" fill="#8800ff" opacity="0.7"/>
              </svg>`},

            { id: 20, name: "Celestial Phoenix", type: "EFFECT", attribute: "FIRE", level: 8, atk: 2900, def: 1800,
              desc: "Once per turn: If this card is destroyed, Special Summon it from the GY during the End Phase.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="48" rx="30" ry="18" fill="#330000" opacity="0.5"/>
                <path d="M20,32 Q2,8 0,0 Q10,12 18,28Z" fill="#aa2200" stroke="#ff6600" stroke-width="1.5"/>
                <path d="M20,32 Q6,12 5,4 Q14,16 19,30Z" fill="#ff4400" opacity="0.6"/>
                <path d="M20,32 Q8,18 10,10 Q16,20 20,32Z" fill="#ff8800" opacity="0.4"/>
                <line x1="18" y1="32" x2="3" y2="5" stroke="#ffaa00" stroke-width="0.8" opacity="0.5"/>
                <line x1="19" y1="29" x2="6" y2="11" stroke="#ffaa00" stroke-width="0.8" opacity="0.5"/>
                <rect x="4" y="13" width="8" height="5" rx="1" fill="#331100" stroke="#ff6600" stroke-width="1" transform="rotate(-48 8 15)"/>
                <rect x="9" y="7" width="7" height="4" rx="1" fill="#331100" stroke="#ff8800" stroke-width="1" transform="rotate(-55 12 9)"/>
                <path d="M50,32 Q68,8 70,0 Q60,12 52,28Z" fill="#aa2200" stroke="#ff6600" stroke-width="1.5"/>
                <path d="M50,32 Q64,12 65,4 Q56,16 51,30Z" fill="#ff4400" opacity="0.6"/>
                <path d="M50,32 Q62,18 60,10 Q54,20 50,32Z" fill="#ff8800" opacity="0.4"/>
                <line x1="52" y1="32" x2="67" y2="5" stroke="#ffaa00" stroke-width="0.8" opacity="0.5"/>
                <line x1="51" y1="29" x2="64" y2="11" stroke="#ffaa00" stroke-width="0.8" opacity="0.5"/>
                <rect x="58" y="13" width="8" height="5" rx="1" fill="#331100" stroke="#ff6600" stroke-width="1" transform="rotate(48 62 15)"/>
                <rect x="54" y="7" width="7" height="4" rx="1" fill="#331100" stroke="#ff8800" stroke-width="1" transform="rotate(55 58 9)"/>
                <ellipse cx="35" cy="44" rx="12" ry="15" fill="#660000" stroke="#ff4400" stroke-width="2"/>
                <polygon points="35,37 40,43 35,49 30,43" fill="#110000" stroke="#ff8800" stroke-width="1.5"/>
                <circle cx="35" cy="43" r="4" fill="#ff6600" opacity="0.6"/>
                <circle cx="35" cy="43" r="2" fill="#ffff00" opacity="0.9"/>
                <line x1="26" y1="41" x2="44" y2="41" stroke="#ff6600" stroke-width="0.8" opacity="0.5"/>
                <line x1="25" y1="47" x2="45" y2="47" stroke="#ff6600" stroke-width="0.8" opacity="0.5"/>
                <polygon points="28,20 42,20 44,30 35,33 26,30" fill="#660000" stroke="#ff4400" stroke-width="2"/>
                <path d="M31,14 Q29,4 27,0 Q31,8 35,12Z" fill="#ff4400" stroke="#ff8800" stroke-width="1"/>
                <path d="M35,12 Q35,2 35,0 Q37,5 37,10 Q37,11 35,12Z" fill="#ff6600" stroke="#ffaa00" stroke-width="1"/>
                <path d="M39,14 Q41,4 43,0 Q39,8 35,12Z" fill="#ff4400" stroke="#ff8800" stroke-width="1"/>
                <ellipse cx="30" cy="24" rx="3.5" ry="4" fill="#000000"/>
                <ellipse cx="40" cy="24" rx="3.5" ry="4" fill="#000000"/>
                <ellipse cx="30" cy="24" rx="2" ry="2.5" fill="#ffaa00"/>
                <ellipse cx="40" cy="24" rx="2" ry="2.5" fill="#ffaa00"/>
                <ellipse cx="30" cy="24" rx="1" ry="1.2" fill="#ff0000"/>
                <ellipse cx="40" cy="24" rx="1" ry="1.2" fill="#ff0000"/>
                <polygon points="32,28 38,28 35,33" fill="#ff8800"/>
                <path d="M28,57 Q14,64 10,70" fill="none" stroke="#ff4400" stroke-width="2.5"/>
                <path d="M30,59 Q19,66 17,70" fill="none" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M42,57 Q56,64 60,70" fill="none" stroke="#ff4400" stroke-width="2.5"/>
                <path d="M40,59 Q51,66 53,70" fill="none" stroke="#ff8800" stroke-width="1.5"/>
                <circle cx="7" cy="56" r="2" fill="#ffaa00"/>
                <circle cx="63" cy="56" r="2" fill="#ffaa00"/>
                <circle cx="11" cy="44" r="1.2" fill="#ff6600"/>
                <circle cx="59" cy="46" r="1.2" fill="#ff6600"/>
              </svg>`},

            { id: 21, name: "Abyssal Leviathan", type: "EFFECT", attribute: "WATER", level: 9, atk: 3200, def: 2400,
              desc: "When Summoned: Destroy all Spells/Traps on the field. Gains 500 ATK for each card destroyed.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="52" rx="33" ry="16" fill="#000a2a" opacity="0.7"/>
                <line x1="0" y1="58" x2="70" y2="54" stroke="#004488" stroke-width="0.9" opacity="0.5"/>
                <line x1="0" y1="63" x2="70" y2="60" stroke="#004488" stroke-width="0.7" opacity="0.4"/>
                <path d="M8,62 Q22,68 38,65 Q54,62 64,68 Q68,60 58,55 Q42,50 26,53 Q14,56 8,62Z" fill="#003355" stroke="#0088cc" stroke-width="2"/>
                <path d="M6,42 Q4,54 9,60 Q18,57 26,52 Q36,48 46,50 Q60,52 64,45 Q67,36 60,30 Q50,36 38,39 Q24,41 14,39 Q6,39 6,42Z" fill="#004466" stroke="#00aacc" stroke-width="2"/>
                <line x1="14" y1="52" x2="56" y2="52" stroke="#0088cc" stroke-width="0.8" opacity="0.5"/>
                <line x1="11" y1="45" x2="59" y2="45" stroke="#0088cc" stroke-width="0.8" opacity="0.5"/>
                <polygon points="20,40 22,34 24,40" fill="#005577" stroke="#00aacc" stroke-width="1"/>
                <polygon points="29,38 31,32 33,38" fill="#005577" stroke="#00aacc" stroke-width="1"/>
                <polygon points="38,37 40,31 42,37" fill="#005577" stroke="#00aacc" stroke-width="1"/>
                <polygon points="47,38 49,32 51,38" fill="#005577" stroke="#00aacc" stroke-width="1"/>
                <polygon points="4,20 18,12 36,15 42,26 36,36 14,36 4,28" fill="#003355" stroke="#0088cc" stroke-width="2.5"/>
                <polygon points="7,28 20,30 36,32 36,38 14,38 4,32" fill="#002244" stroke="#0066aa" stroke-width="1.5"/>
                <circle cx="14" cy="21" r="6.5" fill="#000022" stroke="#00aacc" stroke-width="2"/>
                <circle cx="14" cy="21" r="4.5" fill="#003366" opacity="0.8"/>
                <circle cx="14" cy="21" r="2.8" fill="#00ccff"/>
                <circle cx="14" cy="21" r="1.3" fill="#ffffff"/>
                <circle cx="12" cy="20" r="0.8" fill="#ffffff" opacity="0.8"/>
                <circle cx="28" cy="17" r="5.5" fill="#000022" stroke="#00aacc" stroke-width="1.8"/>
                <circle cx="28" cy="17" r="3.5" fill="#003366" opacity="0.7"/>
                <circle cx="28" cy="17" r="2.2" fill="#00ccff"/>
                <circle cx="28" cy="17" r="1" fill="#ffffff"/>
                <polygon points="11,33 13,43 15,33" fill="#aaddff" opacity="0.9"/>
                <polygon points="17,34 19,44 21,34" fill="#aaddff" opacity="0.9"/>
                <polygon points="23,34 25,44 27,34" fill="#aaddff" opacity="0.9"/>
                <polygon points="29,34 31,42 33,34" fill="#aaddff" opacity="0.9"/>
                <path d="M36,30 Q47,20 58,14 Q63,10 65,15 Q60,19 52,23 Q44,28 38,33" fill="none" stroke="#0088cc" stroke-width="2.5"/>
                <circle cx="65" cy="15" r="3.5" fill="#00aacc" stroke="#aaddff" stroke-width="1.2"/>
                <path d="M36,36 Q52,36 64,28 Q70,22 68,28 Q61,33 50,38 Q42,39 37,37" fill="none" stroke="#0066aa" stroke-width="2"/>
                <circle cx="42" cy="28" r="2.5" fill="#00ffcc" opacity="0.6"/>
                <circle cx="52" cy="34" r="2" fill="#00ffcc" opacity="0.5"/>
                <circle cx="20" cy="48" r="2.5" fill="#00ffcc" opacity="0.5"/>
                <circle cx="52" cy="50" r="2" fill="#00ffcc" opacity="0.4"/>
                <path d="M17,14 Q22,4 26,2 Q28,8 24,13Z" fill="#005577" stroke="#00aacc" stroke-width="1"/>
                <path d="M23,12 Q28,2 32,0 Q33,6 29,11Z" fill="#005577" stroke="#00aacc" stroke-width="1"/>
              </svg>`},

            // --- NEW HIGH-TIER FUSION (ID 34) ---
            { id: 34, name: "Arcane Titan", type: "FUSION", attribute: "DARK", level: 12, atk: 4500, def: 4000,
              desc: "Cyber Magician + Chaos Dragon. Cannot be destroyed. Unaffected by all other card effects.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,35 Q8,4 0,0 Q8,14 16,28Z" fill="#330044" opacity="0.5"/>
                <path d="M35,35 Q0,18 0,30 Q8,30 18,35Z" fill="#440055" opacity="0.4"/>
                <path d="M35,35 Q62,4 70,0 Q62,14 54,28Z" fill="#2a3a00" opacity="0.5"/>
                <path d="M35,35 Q70,18 70,30 Q62,30 52,35Z" fill="#3a4a00" opacity="0.4"/>
                <polygon points="0,30 18,24 22,40 6,46" fill="#220033" stroke="#9900ff" stroke-width="2"/>
                <circle cx="9" cy="36" r="3.5" fill="#aa00ff" opacity="0.8"/>
                <polygon points="70,30 52,24 48,40 64,46" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <circle cx="61" cy="36" r="3.5" fill="#88ff00" opacity="0.8"/>
                <polygon points="22,28 48,28 50,56 35,63 20,56" fill="#111122" stroke="#888888" stroke-width="2"/>
                <polygon points="22,28 35,28 35,63 20,56" fill="#220033" stroke="#9900ff" stroke-width="1.2"/>
                <polygon points="35,28 48,28 50,56 35,63" fill="#1a3000" stroke="#88ff00" stroke-width="1.2"/>
                <line x1="35" y1="28" x2="35" y2="63" stroke="#ffffff" stroke-width="2"/>
                <circle cx="35" cy="44" r="9" fill="#110011" stroke="#ffffff" stroke-width="2.5"/>
                <path d="M26,44 Q30,36 35,39 Q40,36 44,44" fill="#aa00ff" opacity="0.5"/>
                <path d="M26,44 Q30,52 35,49 Q40,52 44,44" fill="#44aa00" opacity="0.5"/>
                <circle cx="35" cy="44" r="5" fill="none" stroke="#ffffff" stroke-width="1.5"/>
                <circle cx="35" cy="44" r="2.5" fill="#ffffff" opacity="0.9"/>
                <polygon points="25,14 45,14 46,26 35,30 24,26" fill="#111122" stroke="#ffffff" stroke-width="2.5"/>
                <polygon points="25,15 22,4 28,13" fill="#220033" stroke="#9900ff" stroke-width="1.5"/>
                <polygon points="30,13 29,2 33,12" fill="#330044" stroke="#cc00ff" stroke-width="1.5"/>
                <polygon points="35,12 35,0 37,11" fill="#111111" stroke="#ffffff" stroke-width="2"/>
                <polygon points="40,13 41,2 37,12" fill="#1a3000" stroke="#88ff00" stroke-width="1.5"/>
                <polygon points="45,15 48,4 42,13" fill="#2a4000" stroke="#88ff00" stroke-width="1.5"/>
                <circle cx="25" cy="6" r="2.5" fill="#aa00ff"/>
                <circle cx="30" cy="4" r="2.5" fill="#cc00ff"/>
                <circle cx="35" cy="2" r="3" fill="#ffffff"/>
                <circle cx="40" cy="4" r="2.5" fill="#88ff00"/>
                <circle cx="45" cy="6" r="2.5" fill="#44ff00"/>
                <rect x="27" y="18" width="16" height="8" rx="2" fill="#000000"/>
                <circle cx="31" cy="22" r="3" fill="#aa00ff"/>
                <circle cx="31" cy="22" r="1.5" fill="#ff88ff"/>
                <circle cx="39" cy="22" r="3" fill="#44ff00"/>
                <circle cx="39" cy="22" r="1.5" fill="#aaffaa"/>
                <rect x="2" y="42" width="17" height="22" rx="3" fill="#220033" stroke="#9900ff" stroke-width="2"/>
                <rect x="0" y="60" width="14" height="10" rx="3" fill="#330044" stroke="#cc00ff" stroke-width="2"/>
                <circle cx="7" cy="68" r="4" fill="#440055" stroke="#ff00ff" stroke-width="2"/>
                <circle cx="7" cy="68" r="2" fill="#ff00ff" opacity="0.8"/>
                <rect x="51" y="42" width="17" height="22" rx="3" fill="#1a3000" stroke="#88ff00" stroke-width="2"/>
                <rect x="56" y="60" width="14" height="10" rx="3" fill="#2a4000" stroke="#aaff44" stroke-width="2"/>
                <circle cx="63" cy="68" r="4" fill="#2a4a00" stroke="#88ff44" stroke-width="2"/>
                <circle cx="63" cy="68" r="2" fill="#88ff00" opacity="0.8"/>
                <rect x="22" y="58" width="10" height="14" rx="2" fill="#111122" stroke="#888888" stroke-width="1.5"/>
                <rect x="38" y="58" width="10" height="14" rx="2" fill="#111122" stroke="#888888" stroke-width="1.5"/>
                <ellipse cx="27" cy="72" rx="10" ry="3" fill="#aa00ff" opacity="0.4"/>
                <ellipse cx="43" cy="72" rx="10" ry="3" fill="#44ff00" opacity="0.4"/>
              </svg>`},

            // --- NEW SPELLS (IDs 58-60) ---
            { id: 58, name: "Neon Genesis", type: "SPELL", attribute: "SPELL",
              desc: "Draw 3 cards. You cannot Special Summon this turn after activation.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="32" fill="#0a0a18"/>
                <line x1="35" y1="35" x2="35" y2="4" stroke="#ff00ff" stroke-width="2.5" opacity="0.9"/>
                <line x1="35" y1="35" x2="63" y2="19" stroke="#ff8800" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="65" y2="54" stroke="#ffff00" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="48" y2="65" stroke="#00ff88" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="22" y2="65" stroke="#00ffff" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="5" y2="54" stroke="#0088ff" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="7" y2="19" stroke="#ff44ff" stroke-width="2.5" opacity="0.8"/>
                <line x1="35" y1="35" x2="66" y2="35" stroke="#ff4400" stroke-width="2" opacity="0.7"/>
                <line x1="35" y1="35" x2="4" y2="35" stroke="#ff4400" stroke-width="2" opacity="0.7"/>
                <rect x="28" y="4" width="8" height="12" rx="1" fill="#1a0040" stroke="#ff00ff" stroke-width="2" transform="rotate(-12 32 10)"/>
                <line x1="30" y1="7" x2="34" y2="7" stroke="#ff00ff" stroke-width="1" transform="rotate(-12 32 10)"/>
                <line x1="30" y1="10" x2="34" y2="10" stroke="#ff00ff" stroke-width="0.8" transform="rotate(-12 32 10)"/>
                <rect x="54" y="14" width="8" height="12" rx="1" fill="#1a0040" stroke="#ff8800" stroke-width="2" transform="rotate(25 58 20)"/>
                <rect x="54" y="48" width="8" height="12" rx="1" fill="#001a00" stroke="#00ff88" stroke-width="2" transform="rotate(-30 58 54)"/>
                <circle cx="35" cy="35" r="13" fill="#0d0a20" stroke="#ffffff" stroke-width="2.5"/>
                <circle cx="35" cy="35" r="9" fill="#1a0040" stroke="#ff00ff" stroke-width="2"/>
                <polygon points="35,25 38,33 35,41 32,33" fill="#ff00ff" opacity="0.7"/>
                <polygon points="25,35 33,32 41,35 33,38" fill="#00ffff" opacity="0.7"/>
                <circle cx="35" cy="35" r="3.5" fill="#ffffff" opacity="0.95"/>
                <text x="5" y="40" font-size="4.5" fill="#ff00ff" opacity="0.5" font-family="monospace">1010</text>
                <text x="53" y="25" font-size="4.5" fill="#ffff00" opacity="0.5" font-family="monospace">0110</text>
                <text x="43" y="60" font-size="4.5" fill="#00ffff" opacity="0.5" font-family="monospace">1100</text>
              </svg>`},

            { id: 59, name: "Cyber Awakening", type: "SPELL", attribute: "SPELL",
              desc: "Special Summon up to 2 Effect Monsters from your hand. They cannot attack this turn.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="0" y="46" width="70" height="24" fill="#080818"/>
                <line x1="0" y1="56" x2="70" y2="56" stroke="#0033aa" stroke-width="0.8" opacity="0.5"/>
                <line x1="0" y1="63" x2="70" y2="63" stroke="#0033aa" stroke-width="0.6" opacity="0.3"/>
                <line x1="10" y1="46" x2="10" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.4"/>
                <line x1="20" y1="46" x2="20" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.3"/>
                <line x1="30" y1="46" x2="30" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.4"/>
                <line x1="40" y1="46" x2="40" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.3"/>
                <line x1="50" y1="46" x2="50" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.4"/>
                <line x1="60" y1="46" x2="60" y2="70" stroke="#0033aa" stroke-width="0.5" opacity="0.3"/>
                <rect x="7" y="26" width="14" height="22" rx="2" fill="#001133" stroke="#0088ff" stroke-width="1.8"/>
                <rect x="9" y="20" width="10" height="10" rx="5" fill="#001133" stroke="#0088ff" stroke-width="1.5"/>
                <circle cx="12" cy="24" r="2.2" fill="#0088ff"/>
                <circle cx="16" cy="24" r="2.2" fill="#0088ff"/>
                <rect x="8" y="46" width="3" height="3" fill="#0088ff" opacity="0.6"/>
                <rect x="13" y="47" width="2" height="2" fill="#0088ff" opacity="0.4"/>
                <rect x="18" y="46" width="3" height="3" fill="#0088ff" opacity="0.3"/>
                <rect x="49" y="24" width="14" height="24" rx="2" fill="#110022" stroke="#aa00ff" stroke-width="1.8"/>
                <rect x="51" y="18" width="10" height="10" rx="5" fill="#110022" stroke="#aa00ff" stroke-width="1.5"/>
                <circle cx="54" cy="22" r="2.2" fill="#aa00ff"/>
                <circle cx="58" cy="22" r="2.2" fill="#aa00ff"/>
                <rect x="50" y="46" width="3" height="3" fill="#aa00ff" opacity="0.6"/>
                <rect x="55" y="47" width="2" height="2" fill="#aa00ff" opacity="0.4"/>
                <rect x="59" y="46" width="3" height="3" fill="#aa00ff" opacity="0.3"/>
                <circle cx="35" cy="30" r="20" fill="none" stroke="#00e5ff" stroke-width="2.5"/>
                <circle cx="35" cy="30" r="15" fill="none" stroke="#0088aa" stroke-width="1.2"/>
                <line x1="35" y1="11" x2="35" y2="16" stroke="#00e5ff" stroke-width="2"/>
                <line x1="35" y1="44" x2="35" y2="49" stroke="#00e5ff" stroke-width="2"/>
                <line x1="16" y1="30" x2="21" y2="30" stroke="#00e5ff" stroke-width="2"/>
                <line x1="49" y1="30" x2="54" y2="30" stroke="#00e5ff" stroke-width="2"/>
                <circle cx="35" cy="30" r="9" fill="#001a2a" stroke="#00e5ff" stroke-width="2"/>
                <ellipse cx="35" cy="30" rx="4.5" ry="7" fill="#00aaff" opacity="0.4"/>
                <ellipse cx="35" cy="30" rx="7" ry="4.5" fill="#00aaff" opacity="0.3"/>
                <circle cx="35" cy="30" r="2.5" fill="#ffffff" opacity="0.8"/>
                <line x1="30" y1="13" x2="28" y2="5" stroke="#00e5ff" stroke-width="1.2" opacity="0.6"/>
                <line x1="35" y1="12" x2="35" y2="3" stroke="#00e5ff" stroke-width="1.5" opacity="0.7"/>
                <line x1="40" y1="13" x2="42" y2="5" stroke="#00e5ff" stroke-width="1.2" opacity="0.6"/>
              </svg>`},

            { id: 60, name: "Quantum Storm", type: "SPELL", attribute: "SPELL",
              desc: "Halve all monsters' ATK until end of turn. Draw 1 card.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="32" r="32" fill="#060620"/>
                <path d="M35,32 Q44,18 58,12 Q67,10 64,21 Q56,29 45,31 Q38,31 35,32" fill="none" stroke="#aaaaff" stroke-width="3"/>
                <path d="M35,32 Q50,41 60,52 Q66,60 56,62 Q46,59 40,50 Q37,43 35,32" fill="none" stroke="#8888ff" stroke-width="2.5"/>
                <path d="M35,32 Q20,40 10,50 Q3,58 12,62 Q22,61 28,52 Q33,44 35,32" fill="none" stroke="#aaaaff" stroke-width="3"/>
                <path d="M35,32 Q18,22 8,13 Q2,7 12,8 Q21,11 27,20 Q32,27 35,32" fill="none" stroke="#8888ff" stroke-width="2.5"/>
                <path d="M35,32 Q41,25 48,22 Q52,20 50,27 Q45,30 39,32" fill="none" stroke="#ffffff" stroke-width="2" opacity="0.7"/>
                <path d="M35,32 Q28,40 26,47 Q24,51 28,48 Q33,44 35,32" fill="none" stroke="#ffffff" stroke-width="2" opacity="0.6"/>
                <rect x="4" y="4" width="24" height="16" rx="2" fill="#110000" stroke="#ff4400" stroke-width="2"/>
                <text x="7" y="16" font-size="10" fill="#ff4400" font-family="monospace" font-weight="bold">ATK</text>
                <line x1="16" y1="20" x2="16" y2="29" stroke="#ff4400" stroke-width="2.5"/>
                <polygon points="12,27 16,34 20,27" fill="#ff4400"/>
                <rect x="4" y="34" width="24" height="16" rx="2" fill="#001100" stroke="#44ff44" stroke-width="2"/>
                <text x="6" y="46" font-size="9" fill="#44ff44" font-family="monospace" font-weight="bold"> 2!</text>
                <circle cx="35" cy="32" r="11" fill="#0d0d30" stroke="#aaaaff" stroke-width="2.5"/>
                <circle cx="35" cy="32" r="7" fill="#060620" stroke="#8888ff" stroke-width="2"/>
                <circle cx="35" cy="32" r="3.5" fill="#aaaaff" opacity="0.5"/>
                <circle cx="35" cy="32" r="1.8" fill="#ffffff" opacity="0.8"/>
                <rect x="48" y="6" width="13" height="19" rx="2" fill="#001a3a" stroke="#00e5ff" stroke-width="2"/>
                <line x1="51" y1="11" x2="59" y2="11" stroke="#00e5ff" stroke-width="1.2"/>
                <line x1="51" y1="15" x2="59" y2="15" stroke="#00e5ff" stroke-width="1.2"/>
                <line x1="51" y1="19" x2="56" y2="19" stroke="#00e5ff" stroke-width="1.2"/>
                <polygon points="55,24 50,19 60,19" fill="#00e5ff"/>
              </svg>`},

            // --- NEW TRAPS (IDs 76-77) ---
            { id: 76, name: "Dimensional Prison", type: "TRAP", attribute: "TRAP",
              desc: "When an opponent's monster declares an attack: Banish that monster instead of sending to GY.", rarity: "UR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="0" y="0" width="70" height="70" fill="#040412"/>
                <ellipse cx="18" cy="35" rx="16" ry="30" fill="#080820" stroke="#0044aa" stroke-width="2.5"/>
                <ellipse cx="18" cy="35" rx="11" ry="24" fill="none" stroke="#0066cc" stroke-width="1.2"/>
                <line x1="8" y1="7" x2="8" y2="63" stroke="#0066cc" stroke-width="1.5" opacity="0.8"/>
                <line x1="13" y1="5" x2="13" y2="65" stroke="#0088cc" stroke-width="1.8"/>
                <line x1="18" y1="6" x2="18" y2="64" stroke="#00aacc" stroke-width="2.5"/>
                <line x1="23" y1="5" x2="23" y2="65" stroke="#0088cc" stroke-width="1.8"/>
                <line x1="28" y1="7" x2="28" y2="63" stroke="#0066cc" stroke-width="1.5" opacity="0.8"/>
                <line x1="5" y1="20" x2="31" y2="20" stroke="#0066cc" stroke-width="1.8"/>
                <line x1="4" y1="35" x2="32" y2="35" stroke="#0088cc" stroke-width="2.5"/>
                <line x1="5" y1="50" x2="31" y2="50" stroke="#0066cc" stroke-width="1.8"/>
                <ellipse cx="52" cy="30" rx="13" ry="15" fill="#221122" stroke="#6600aa" stroke-width="1.8" opacity="0.9"/>
                <ellipse cx="49" cy="21" rx="8.5" ry="9" fill="#221122" stroke="#6600aa" stroke-width="1.2"/>
                <circle cx="45" cy="20" r="3" fill="#aa00ff"/>
                <circle cx="53" cy="20" r="3" fill="#aa00ff"/>
                <circle cx="45" cy="20" r="1.5" fill="#ff88ff"/>
                <circle cx="53" cy="20" r="1.5" fill="#ff88ff"/>
                <path d="M36,30 Q28,33 22,35" stroke="#6600aa" stroke-width="2.5" fill="none"/>
                <path d="M36,24 Q30,26 24,25" stroke="#440088" stroke-width="2" fill="none"/>
                <path d="M36,36 Q28,38 23,39" stroke="#440088" stroke-width="2" fill="none"/>
                <line x1="58" y1="17" x2="68" y2="9" stroke="#8800ff" stroke-width="1.5" opacity="0.6"/>
                <line x1="62" y1="28" x2="70" y2="25" stroke="#8800ff" stroke-width="1.2" opacity="0.5"/>
                <line x1="60" y1="41" x2="68" y2="47" stroke="#8800ff" stroke-width="1.5" opacity="0.6"/>
                <path d="M4,35 Q4,7 18,6 Q32,5 32,35" fill="none" stroke="#0044aa" stroke-width="1.5" opacity="0.6" stroke-dasharray="4,3"/>
                <circle cx="4" cy="14" r="1.2" fill="#aaddff" opacity="0.7"/>
                <circle cx="64" cy="11" r="1.2" fill="#aaddff" opacity="0.6"/>
                <circle cx="67" cy="57" r="1.2" fill="#aaddff" opacity="0.7"/>
                <circle cx="44" cy="60" r="2" fill="#8800ff" opacity="0.5"/>
              </svg>`},

            { id: 77, name: "Infinite Loop", type: "TRAP", attribute: "TRAP",
              desc: "Activate when opponent activates a card effect. Negate it. For 3 turns, negate every effect they activate.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="33" fill="#0a0510"/>
                <circle cx="35" cy="35" r="30" fill="none" stroke="#440088" stroke-width="3" stroke-dasharray="9,5"/>
                <path d="M35,13 Q14,13 8,27 Q2,42 14,53 Q26,64 35,58 Q44,64 56,53 Q68,42 62,27 Q56,13 35,13Z" fill="none" stroke="#8800ff" stroke-width="2.5"/>
                <circle cx="35" cy="5" r="3" fill="#aa00ff"/>
                <circle cx="64" cy="19" r="3" fill="#cc00ff"/>
                <circle cx="65" cy="52" r="3" fill="#aa00ff"/>
                <circle cx="35" cy="65" r="3" fill="#cc00ff"/>
                <circle cx="5" cy="52" r="3" fill="#aa00ff"/>
                <circle cx="6" cy="19" r="3" fill="#cc00ff"/>
                <rect x="23" y="23" width="24" height="24" rx="4" fill="#0f0020" stroke="#9900ff" stroke-width="2.5"/>
                <text x="26" y="32" font-size="6" fill="#cc00ff" font-family="monospace">LOOP</text>
                <text x="27" y="43" font-size="12" fill="#ff00ff" font-family="monospace" font-weight="bold"></text>
                <circle cx="35" cy="9" r="6" fill="#110022" stroke="#ff0000" stroke-width="2"/>
                <line x1="32" y1="6" x2="38" y2="12" stroke="#ff0000" stroke-width="2.5"/>
                <line x1="38" y1="6" x2="32" y2="12" stroke="#ff0000" stroke-width="2.5"/>
                <circle cx="57" cy="55" r="5" fill="#110022" stroke="#ff0000" stroke-width="2"/>
                <line x1="54" y1="52" x2="60" y2="58" stroke="#ff0000" stroke-width="2"/>
                <line x1="60" y1="52" x2="54" y2="58" stroke="#ff0000" stroke-width="2"/>
                <circle cx="13" cy="55" r="5" fill="#110022" stroke="#ff0000" stroke-width="2"/>
                <line x1="10" y1="52" x2="16" y2="58" stroke="#ff0000" stroke-width="2"/>
                <line x1="16" y1="52" x2="10" y2="58" stroke="#ff0000" stroke-width="2"/>
                <path d="M52,35 Q58,24 52,16" fill="none" stroke="#9900ff" stroke-width="2"/>
                <polygon points="49,18 55,14 52,20" fill="#9900ff"/>
                            </svg>`},

            //  APEX VAULT EXCLUSIVE CARDS 
            { id: 80, name: "Eternal Sovereign", type: "EFFECT", attribute: "LIGHT", level: 10, atk: 3500, def: 3000,
              desc: "Cannot be targeted or destroyed by card effects. Gains 300 ATK for each monster in the opponent's GY.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="9" r="9" fill="none" stroke="#ffd700" stroke-width="2"/>
                <circle cx="35" cy="9" r="5" fill="#fffbe0" opacity="0.7"/>
                <line x1="35" y1="0" x2="35" y2="4" stroke="#ffd700" stroke-width="2"/>
                <line x1="44" y1="2" x2="42" y2="6" stroke="#ffd700" stroke-width="2"/>
                <line x1="26" y1="2" x2="28" y2="6" stroke="#ffd700" stroke-width="2"/>
                <polygon points="28,18 42,18 46,22 44,26 35,28 26,26 24,22" fill="#2a1a00" stroke="#ffd700" stroke-width="2"/>
                <rect x="30" y="20" width="10" height="5" rx="1" fill="#ffd700" opacity="0.8"/>
                <rect x="22" y="27" width="26" height="22" rx="3" fill="#1a1000" stroke="#ffd700" stroke-width="2"/>
                <polygon points="22,27 10,30 8,44 22,46" fill="#1a1000" stroke="#ffd700" stroke-width="1.5"/>
                <polygon points="48,27 60,30 62,44 48,46" fill="#1a1000" stroke="#ffd700" stroke-width="1.5"/>
                <rect x="26" y="47" width="8" height="16" rx="2" fill="#1a1000" stroke="#ffd700" stroke-width="1.5"/>
                <rect x="36" y="47" width="8" height="16" rx="2" fill="#1a1000" stroke="#ffd700" stroke-width="1.5"/>
                <ellipse cx="30" cy="63" rx="6" ry="2.5" fill="#ffd700" opacity="0.5"/>
                <ellipse cx="40" cy="63" rx="6" ry="2.5" fill="#ffd700" opacity="0.5"/>
                <circle cx="35" cy="9" r="2.5" fill="#ffffff"/>
              </svg>` },

            { id: 81, name: "Null Protocol", type: "EFFECT", attribute: "DARK", level: 9, atk: 3300, def: 2800,
              desc: "When destroyed: Banish all cards in the opponent's Graveyard. Unaffected by effect damage.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="30" fill="#000000"/>
                <circle cx="35" cy="35" r="26" fill="none" stroke="#ff0000" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.7"/>
                <circle cx="35" cy="35" r="20" fill="#0a000a" stroke="#cc0000" stroke-width="1"/>
                <text x="19" y="29" font-size="5" fill="#ff0000" font-family="monospace" opacity="0.6">01 ERROR</text>
                <text x="18" y="36" font-size="5" fill="#ff0000" font-family="monospace" opacity="0.6">NULL 0x00</text>
                <text x="20" y="43" font-size="5" fill="#ff0000" font-family="monospace" opacity="0.6">!! VOID !!</text>
                <circle cx="35" cy="35" r="10" fill="#1a0000" stroke="#ff0000" stroke-width="2"/>
                <line x1="28" y1="28" x2="42" y2="42" stroke="#ff0000" stroke-width="2.5"/>
                <line x1="42" y1="28" x2="28" y2="42" stroke="#ff0000" stroke-width="2.5"/>
                <circle cx="35" cy="35" r="4" fill="#000000" stroke="#ff2200" stroke-width="1.5"/>
                <rect x="5" y="12" width="8" height="5" rx="1" fill="#220000" stroke="#ff0000" stroke-width="1" opacity="0.7"/>
                <rect x="57" y="12" width="8" height="5" rx="1" fill="#220000" stroke="#ff0000" stroke-width="1" opacity="0.7"/>
                <rect x="5" y="53" width="8" height="5" rx="1" fill="#220000" stroke="#ff0000" stroke-width="1" opacity="0.7"/>
                <rect x="57" y="53" width="8" height="5" rx="1" fill="#220000" stroke="#ff0000" stroke-width="1" opacity="0.7"/>
              </svg>` },

            { id: 82, name: "Genesis Core", type: "FUSION", attribute: "LIGHT", level: 12, atk: 4500, def: 4000,
              desc: "Eternal Sovereign + Abyssal Leviathan. Cannot be destroyed. Inflicts 500 damage to opponent each of your End Phases.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="28" fill="#050520" stroke="#ffffff" stroke-width="1" opacity="0.5"/>
                <ellipse cx="35" cy="35" rx="28" ry="10" fill="none" stroke="#00e5ff" stroke-width="1.5" opacity="0.7"/>
                <ellipse cx="35" cy="35" rx="10" ry="28" fill="none" stroke="#ffd700" stroke-width="1.5" opacity="0.7"/>
                <ellipse cx="35" cy="35" rx="22" ry="22" fill="none" stroke="#ff00aa" stroke-width="1" opacity="0.4" transform="rotate(45 35 35)"/>
                <circle cx="35" cy="35" r="12" fill="#0a0a30" stroke="#ffffff" stroke-width="2"/>
                <circle cx="35" cy="35" r="8" fill="#101050" stroke="#00e5ff" stroke-width="1.5"/>
                <circle cx="35" cy="35" r="4" fill="#ffffff" opacity="0.95"/>
                <circle cx="35" cy="7" r="4" fill="#ffd700" stroke="#ffffff" stroke-width="1"/>
                <circle cx="35" cy="63" r="4" fill="#ffd700" stroke="#ffffff" stroke-width="1"/>
                <circle cx="7" cy="35" r="4" fill="#00e5ff" stroke="#ffffff" stroke-width="1"/>
                <circle cx="63" cy="35" r="4" fill="#00e5ff" stroke="#ffffff" stroke-width="1"/>
                <circle cx="55" cy="15" r="3" fill="#ff00aa" stroke="#ffffff" stroke-width="1"/>
                <circle cx="15" cy="55" r="3" fill="#ff00aa" stroke="#ffffff" stroke-width="1"/>
                <circle cx="15" cy="15" r="3" fill="#ff8800" stroke="#ffffff" stroke-width="1"/>
                <circle cx="55" cy="55" r="3" fill="#ff8800" stroke="#ffffff" stroke-width="1"/>
              </svg>` },

            { id: 83, name: "Hex Witch", type: "EFFECT", attribute: "DARK", level: 7, atk: 2700, def: 2200,
              desc: "When Normal Summoned: Halve the opponent's current LP. Once per turn: Target 1 monster and negate its effects this turn.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,2 22,24 48,24" fill="#1a001a" stroke="#aa00ff" stroke-width="2"/>
                <rect x="20" y="24" width="30" height="5" rx="1" fill="#1a001a" stroke="#aa00ff" stroke-width="1.5"/>
                <ellipse cx="35" cy="34" rx="13" ry="11" fill="#110022" stroke="#aa00ff" stroke-width="2"/>
                <circle cx="29" cy="31" r="3.5" fill="#000011"/>
                <circle cx="29" cy="31" r="2" fill="#cc00ff"/>
                <circle cx="41" cy="31" r="3.5" fill="#000011"/>
                <circle cx="41" cy="31" r="2" fill="#cc00ff"/>
                <path d="M28,37 Q32,41 35,39 Q38,41 42,37" fill="none" stroke="#cc00ff" stroke-width="1.5"/>
                <polygon points="26,28 24,18 30,26" fill="#1a001a" stroke="#aa00ff" stroke-width="1"/>
                <polygon points="44,28 46,18 40,26" fill="#1a001a" stroke="#aa00ff" stroke-width="1"/>
                <rect x="26" y="43" width="18" height="20" rx="3" fill="#1a001a" stroke="#aa00ff" stroke-width="1.5"/>
                <polygon points="15,44 26,43 26,55 12,52" fill="#110022" stroke="#aa00ff" stroke-width="1"/>
                <polygon points="55,44 44,43 44,55 58,52" fill="#110022" stroke="#aa00ff" stroke-width="1"/>
                <circle cx="18" cy="38" r="5" fill="#330055" stroke="#ff00ff" stroke-width="1.5"/>
                <circle cx="18" cy="38" r="3" fill="#cc00ff" opacity="0.7"/>
                <circle cx="52" cy="38" r="5" fill="#330055" stroke="#ff00ff" stroke-width="1.5"/>
                <circle cx="52" cy="38" r="3" fill="#cc00ff" opacity="0.7"/>
                <rect x="28" y="60" width="6" height="10" rx="2" fill="#1a001a" stroke="#aa00ff" stroke-width="1"/>
                <rect x="36" y="60" width="6" height="10" rx="2" fill="#1a001a" stroke="#aa00ff" stroke-width="1"/>
              </svg>` },

            { id: 84, name: "Prism Hydra", type: "EFFECT", attribute: "WATER", level: 8, atk: 3100, def: 2600,
              desc: "Cannot be destroyed by battle more than once per turn. When this card destroys a monster by battle, draw 1 card.", rarity: "SP",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="58" rx="25" ry="10" fill="#001a3a" opacity="0.7"/>
                <path d="M28,42 Q18,30 12,18 Q8,8 14,6 Q20,6 18,16 Q22,24 28,34Z" fill="#003366" stroke="#00ccff" stroke-width="1.5"/>
                <ellipse cx="14" cy="8" rx="7" ry="6" fill="#004488" stroke="#00e5ff" stroke-width="1.5"/>
                <circle cx="11" cy="6" r="2.5" fill="#000022"/>
                <circle cx="11" cy="6" r="1.5" fill="#ff4444"/>
                <circle cx="17" cy="6" r="2.5" fill="#000022"/>
                <circle cx="17" cy="6" r="1.5" fill="#ff4444"/>
                <polygon points="10,12 14,18 18,12" fill="#004488" stroke="#00ccff" stroke-width="1"/>
                <path d="M35,40 Q35,26 35,12 Q35,4 40,3 Q46,3 43,12 Q40,20 38,32Z" fill="#003366" stroke="#66ddff" stroke-width="1.5"/>
                <ellipse cx="40" cy="5" rx="7" ry="6" fill="#0055aa" stroke="#66ddff" stroke-width="1.5"/>
                <circle cx="37" cy="3" r="2.5" fill="#000022"/>
                <circle cx="37" cy="3" r="1.5" fill="#ff4444"/>
                <circle cx="43" cy="3" r="2.5" fill="#000022"/>
                <circle cx="43" cy="3" r="1.5" fill="#ff4444"/>
                <polygon points="37,10 40,17 43,10" fill="#0055aa" stroke="#66ddff" stroke-width="1"/>
                <path d="M42,42 Q52,30 58,18 Q62,8 56,6 Q50,6 52,16 Q48,24 42,34Z" fill="#003366" stroke="#aaeeff" stroke-width="1.5"/>
                <ellipse cx="56" cy="8" rx="7" ry="6" fill="#0044aa" stroke="#aaeeff" stroke-width="1.5"/>
                <circle cx="53" cy="6" r="2.5" fill="#000022"/>
                <circle cx="53" cy="6" r="1.5" fill="#ff4444"/>
                <circle cx="59" cy="6" r="2.5" fill="#000022"/>
                <circle cx="59" cy="6" r="1.5" fill="#ff4444"/>
                <polygon points="52,12 56,18 60,12" fill="#0044aa" stroke="#aaeeff" stroke-width="1"/>
                <ellipse cx="35" cy="52" rx="18" ry="14" fill="#002244" stroke="#00aaff" stroke-width="2"/>
                <path d="M22,52 Q35,46 48,52 Q35,58 22,52" fill="#003366" stroke="#00ccff" stroke-width="1"/>
                <ellipse cx="22" cy="60" rx="6" ry="4" fill="#003366" stroke="#00aaff" stroke-width="1"/>
                <ellipse cx="35" cy="64" rx="6" ry="4" fill="#003366" stroke="#00aaff" stroke-width="1"/>
                <ellipse cx="48" cy="60" rx="6" ry="4" fill="#003366" stroke="#00aaff" stroke-width="1"/>
              </svg>` },

            //  LOW-LEVEL COMMONS & RARES (85-100) 
            { id: 85, name: "Pixel Pawn", type: "NORMAL", attribute: "LIGHT", level: 1, atk: 400, def: 200,
              desc: "A basic unit in the digital army. Made entirely of large, chunky pixels that shift when it moves.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="24" y="8" width="22" height="20" rx="4" fill="#bfcfff" stroke="#4466ff" stroke-width="2"/>
                <rect x="28" y="14" width="5" height="6" rx="1" fill="#001aff" opacity="0.6"/>
                <rect x="37" y="14" width="5" height="6" rx="1" fill="#001aff" opacity="0.6"/>
                <rect x="29" y="22" width="12" height="3" rx="1" fill="#4466ff" opacity="0.5"/>
                <rect x="28" y="28" width="14" height="24" rx="3" fill="#7099ff" stroke="#4466ff" stroke-width="2"/>
                <rect x="16" y="30" width="12" height="6" rx="2" fill="#7099ff" stroke="#4466ff" stroke-width="1.5"/>
                <rect x="42" y="30" width="12" height="6" rx="2" fill="#7099ff" stroke="#4466ff" stroke-width="1.5"/>
                <rect x="30" y="52" width="6" height="14" rx="2" fill="#4466ff" stroke="#2244cc" stroke-width="1.5"/>
                <rect x="38" y="52" width="6" height="14" rx="2" fill="#4466ff" stroke="#2244cc" stroke-width="1.5"/>
                <rect x="22" y="30" width="6" height="6" fill="#a0b8ff" opacity="0.4"/>
                <rect x="28" y="36" width="6" height="6" fill="#a0b8ff" opacity="0.4"/>
                <rect x="34" y="30" width="6" height="6" fill="#a0b8ff" opacity="0.4"/>
                <rect x="40" y="36" width="6" height="6" fill="#a0b8ff" opacity="0.4"/>
              </svg>` },

            { id: 86, name: "Glitch Gremlin", type: "EFFECT", attribute: "DARK", level: 2, atk: 600, def: 400,
              desc: "FLIP: Your opponent randomly discards 1 card from their hand.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="30" rx="18" ry="20" fill="#1a0028" stroke="#9900ff" stroke-width="2"/>
                <ellipse cx="27" cy="23" rx="6" ry="8" fill="#2a0044" stroke="#9900ff" stroke-width="1.5"/>
                <ellipse cx="43" cy="23" rx="6" ry="8" fill="#2a0044" stroke="#9900ff" stroke-width="1.5"/>
                <circle cx="27" cy="23" r="4" fill="#000"/>
                <circle cx="27" cy="23" r="2.5" fill="#cc00ff"/>
                <circle cx="26" cy="22" r="1" fill="#fff"/>
                <circle cx="43" cy="23" r="4" fill="#000"/>
                <circle cx="43" cy="23" r="2.5" fill="#cc00ff"/>
                <circle cx="42" cy="22" r="1" fill="#fff"/>
                <rect x="29" y="34" width="12" height="3" rx="1" fill="#cc00ff" opacity="0.8"/>
                <polygon points="29,40 27,50 33,46 35,52 37,46 43,50 41,40" fill="#1a0028" stroke="#9900ff" stroke-width="1.5"/>
                <rect x="15" y="28" width="5" height="10" rx="2" fill="#1a0028" stroke="#9900ff" stroke-width="1.5" transform="rotate(-20 17 33)"/>
                <rect x="50" y="28" width="5" height="10" rx="2" fill="#1a0028" stroke="#9900ff" stroke-width="1.5" transform="rotate(20 53 33)"/>
                <text x="13" y="18" font-size="8" fill="#ff00ff" font-family="monospace" opacity="0.5">ERR</text>
                <text x="48" y="16" font-size="8" fill="#ff00ff" font-family="monospace" opacity="0.5">0x!</text>
                <path d="M5,35 Q12,30 15,35 Q18,40 25,35" fill="none" stroke="#9900ff" stroke-width="1" opacity="0.5" stroke-dasharray="2,2"/>
                <path d="M55,35 Q60,30 63,35 Q66,40 68,35" fill="none" stroke="#9900ff" stroke-width="1" opacity="0.5" stroke-dasharray="2,2"/>
              </svg>` },

            { id: 87, name: "Iron Beetle", type: "NORMAL", attribute: "EARTH", level: 3, atk: 1200, def: 1500,
              desc: "A mechanical beetle with reinforced steel plating. Its mandibles can cut through solid rock.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="38" rx="22" ry="16" fill="#2a2a2a" stroke="#888" stroke-width="2"/>
                <ellipse cx="35" cy="38" rx="14" ry="10" fill="#444" stroke="#aaa" stroke-width="1.5"/>
                <ellipse cx="35" cy="38" rx="7" ry="5" fill="#555" stroke="#ccc" stroke-width="1"/>
                <ellipse cx="35" cy="22" rx="10" ry="8" fill="#333" stroke="#888" stroke-width="2"/>
                <ellipse cx="29" cy="20" rx="4" ry="5" fill="#111"/>
                <ellipse cx="29" cy="20" rx="2.5" ry="3" fill="#00cc44"/>
                <ellipse cx="41" cy="20" rx="4" ry="5" fill="#111"/>
                <ellipse cx="41" cy="20" rx="2.5" ry="3" fill="#00cc44"/>
                <line x1="14" y1="36" x2="4" y2="28" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="13" y1="40" x2="2" y2="40" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="14" y1="44" x2="4" y2="52" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="56" y1="36" x2="66" y2="28" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="57" y1="40" x2="68" y2="40" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="56" y1="44" x2="66" y2="52" stroke="#666" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M27,15 Q35,8 43,15" fill="none" stroke="#888" stroke-width="2"/>
                <line x1="35" y1="14" x2="35" y2="4" stroke="#888" stroke-width="1.5"/>
                <circle cx="35" cy="3" r="2" fill="#00cc44"/>
              </svg>` },

            { id: 88, name: "Static Fox", type: "EFFECT", attribute: "WIND", level: 2, atk: 750, def: 600,
              desc: "When this card is destroyed by battle: Inflict 300 damage to your opponent.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="22,24 12,8 30,18" fill="#ffaa00" stroke="#ff6600" stroke-width="1.5"/>
                <polygon points="48,24 58,8 40,18" fill="#ffaa00" stroke="#ff6600" stroke-width="1.5"/>
                <ellipse cx="35" cy="32" rx="16" ry="14" fill="#ffcc44" stroke="#ff8800" stroke-width="2"/>
                <ellipse cx="35" cy="45" rx="10" ry="7" fill="#fff5cc" stroke="#ffaa44" stroke-width="1"/>
                <circle cx="28" cy="28" r="5" fill="#111"/>
                <circle cx="28" cy="28" r="3" fill="#00e5ff"/>
                <circle cx="27" cy="27" r="1" fill="#fff"/>
                <circle cx="42" cy="28" r="5" fill="#111"/>
                <circle cx="42" cy="28" r="3" fill="#00e5ff"/>
                <circle cx="41" cy="27" r="1" fill="#fff"/>
                <ellipse cx="35" cy="38" rx="3" ry="2" fill="#ff6600"/>
                <path d="M29,43 Q32,48 35,46 Q38,48 41,43" fill="none" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M24,52 Q18,58 12,62 Q20,60 28,55" fill="#ffcc44" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M28,54 Q22,62 16,68 Q23,62 32,57" fill="#ff9900" stroke="#ff6600" stroke-width="1"/>
                <path d="M46,52 Q52,58 58,62 Q50,60 42,55" fill="#ffcc44" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M42,54 Q48,62 54,68 Q47,62 38,57" fill="#ff9900" stroke="#ff6600" stroke-width="1"/>
                <line x1="35" y1="24" x2="35" y2="16" stroke="#fff" stroke-width="1" opacity="0.6" stroke-dasharray="2,2"/>
                <line x1="20" y1="30" x2="10" y2="26" stroke="#fff" stroke-width="1" opacity="0.5" stroke-dasharray="2,2"/>
                <line x1="50" y1="30" x2="60" y2="26" stroke="#fff" stroke-width="1" opacity="0.5" stroke-dasharray="2,2"/>
              </svg>` },

            { id: 89, name: "Nano Shield", type: "EFFECT", attribute: "LIGHT", level: 3, atk: 800, def: 1800,
              desc: "Once per turn: Reduce damage you take by 500 until the end of this turn.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,5 L58,16 L58,40 Q58,58 35,67 Q12,58 12,40 L12,16 Z" fill="#0a1a2a" stroke="#00aaff" stroke-width="2.5"/>
                <path d="M35,11 L53,20 L53,40 Q53,54 35,62 Q17,54 17,40 L17,20 Z" fill="#0d2035" stroke="#0066cc" stroke-width="1.5"/>
                <path d="M35,18 L48,25 L48,40 Q48,50 35,57 Q22,50 22,40 L22,25 Z" fill="#0a1a2a" stroke="#00ccff" stroke-width="1"/>
                <circle cx="35" cy="38" r="12" fill="#051020" stroke="#00e5ff" stroke-width="2"/>
                <circle cx="35" cy="38" r="8" fill="#082030" stroke="#0099ff" stroke-width="1.5"/>
                <circle cx="35" cy="38" r="5" fill="#0d3050" stroke="#00ccff" stroke-width="1"/>
                <circle cx="35" cy="38" r="2" fill="#00e5ff" opacity="0.9"/>
                <line x1="35" y1="26" x2="35" y2="31" stroke="#00e5ff" stroke-width="1.5" opacity="0.6"/>
                <line x1="35" y1="45" x2="35" y2="50" stroke="#00e5ff" stroke-width="1.5" opacity="0.6"/>
                <line x1="23" y1="38" x2="28" y2="38" stroke="#00e5ff" stroke-width="1.5" opacity="0.6"/>
                <line x1="42" y1="38" x2="47" y2="38" stroke="#00e5ff" stroke-width="1.5" opacity="0.6"/>
              </svg>` },

            { id: 90, name: "Data Rat", type: "NORMAL", attribute: "DARK", level: 1, atk: 350, def: 250,
              desc: "A small rodent that gnaws on server cables. Has caused more crashes than any virus.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="22" cy="25" r="8" fill="#444" stroke="#222" stroke-width="1.5"/>
                <ellipse cx="20" cy="22" rx="4" ry="5" fill="#555" stroke="#333" stroke-width="1"/>
                <circle cx="18" cy="21" r="2.5" fill="#ff3366" opacity="0.8"/>
                <ellipse cx="35" cy="36" rx="22" ry="14" fill="#555" stroke="#333" stroke-width="2"/>
                <ellipse cx="35" cy="40" rx="18" ry="10" fill="#666" stroke="#444" stroke-width="1"/>
                <circle cx="19" cy="22" r="3" fill="#111"/>
                <circle cx="19" cy="22" r="1.5" fill="#ff2255"/>
                <circle cx="18.5" cy="21.5" r="0.6" fill="#fff"/>
                <circle cx="26" cy="24" r="2.5" fill="#111"/>
                <circle cx="26" cy="24" r="1.5" fill="#ff2255"/>
                <ellipse cx="21" cy="32" rx="3" ry="2" fill="#ff8877" opacity="0.7"/>
                <path d="M22,30 L18,28" stroke="#888" stroke-width="1" stroke-linecap="round"/>
                <path d="M22,31 L17,31" stroke="#888" stroke-width="1" stroke-linecap="round"/>
                <path d="M22,32 L18,34" stroke="#888" stroke-width="1" stroke-linecap="round"/>
                <path d="M57,40 Q62,36 66,42 Q68,52 60,56 Q57,50 58,44 Q56,48 52,50" fill="none" stroke="#555" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="15" y1="46" x2="8" y2="52" stroke="#444" stroke-width="2"/>
                <line x1="22" y1="48" x2="18" y2="56" stroke="#444" stroke-width="2"/>
                <line x1="47" y1="46" x2="54" y2="52" stroke="#444" stroke-width="2"/>
                <line x1="40" y1="48" x2="44" y2="56" stroke="#444" stroke-width="2"/>
                <text x="30" y="35" font-size="7" fill="#00ff44" font-family="monospace" opacity="0.5">01</text>
              </svg>` },

            { id: 91, name: "Pulse Hound", type: "NORMAL", attribute: "WIND", level: 4, atk: 1700, def: 900,
              desc: "A canine construct that hunts by detecting electromagnetic pulses. Runs faster than any wireless signal.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="22,16 16,6 30,12" fill="#00aaff" stroke="#0066cc" stroke-width="1.5"/>
                <polygon points="48,16 54,6 40,12" fill="#00aaff" stroke="#0066cc" stroke-width="1.5"/>
                <ellipse cx="35" cy="22" rx="15" ry="12" fill="#003366" stroke="#0088ff" stroke-width="2"/>
                <circle cx="27" cy="19" r="4" fill="#000"/>
                <circle cx="27" cy="19" r="2.5" fill="#00ccff"/>
                <circle cx="26.5" cy="18.5" r="1" fill="#fff"/>
                <circle cx="43" cy="19" r="4" fill="#000"/>
                <circle cx="43" cy="19" r="2.5" fill="#00ccff"/>
                <circle cx="42.5" cy="18.5" r="1" fill="#fff"/>
                <rect x="20" y="30" width="30" height="22" rx="6" fill="#002a4a" stroke="#0077cc" stroke-width="2"/>
                <rect x="25" y="34" width="8" height="10" rx="2" fill="#0044aa" stroke="#0088ff" stroke-width="1"/>
                <rect x="37" y="34" width="8" height="10" rx="2" fill="#0044aa" stroke="#0088ff" stroke-width="1"/>
                <line x1="29" y1="36" x2="29" y2="42" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="41" y1="36" x2="41" y2="42" stroke="#00ccff" stroke-width="1.5"/>
                <rect x="20" y="52" width="7" height="14" rx="3" fill="#003366" stroke="#0077cc" stroke-width="1.5" transform="rotate(-10 23 59)"/>
                <rect x="30" y="53" width="7" height="14" rx="3" fill="#003366" stroke="#0077cc" stroke-width="1.5"/>
                <rect x="40" y="52" width="7" height="14" rx="3" fill="#003366" stroke="#0077cc" stroke-width="1.5"/>
                <rect x="48" y="53" width="7" height="14" rx="3" fill="#003366" stroke="#0077cc" stroke-width="1.5" transform="rotate(10 52 60)"/>
                <path d="M48,45 Q56,42 60,38 Q62,32 58,30" fill="none" stroke="#0088ff" stroke-width="2" stroke-linecap="round"/>
                <path d="M6,26 Q8,22 12,22 Q16,22 18,26" fill="none" stroke="#00ccff" stroke-width="1.2" stroke-dasharray="2,2"/>
                <path d="M4,22 Q7,15 12,15 Q17,15 20,22" fill="none" stroke="#00ccff" stroke-width="1" stroke-dasharray="2,2" opacity="0.6"/>
              </svg>` },

            { id: 92, name: "Circuit Fairy", type: "EFFECT", attribute: "LIGHT", level: 2, atk: 550, def: 800,
              desc: "When Normal Summoned: Draw 1 card, then discard 1 card from your hand.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,30 Q55,18 62,8 Q55,22 46,28" fill="#ccffcc" stroke="#88ff88" stroke-width="1" opacity="0.8"/>
                <path d="M35,30 Q15,18 8,8 Q15,22 24,28" fill="#ccffcc" stroke="#88ff88" stroke-width="1" opacity="0.8"/>
                <path d="M35,30 Q58,35 65,48 Q55,38 44,33" fill="#aaffcc" stroke="#66ffaa" stroke-width="1" opacity="0.7"/>
                <path d="M35,30 Q12,35 5,48 Q15,38 26,33" fill="#aaffcc" stroke="#66ffaa" stroke-width="1" opacity="0.7"/>
                <ellipse cx="35" cy="28" rx="12" ry="14" fill="#e8ffe8" stroke="#44ff88" stroke-width="2"/>
                <circle cx="29" cy="24" r="3.5" fill="#003300"/>
                <circle cx="29" cy="24" r="2" fill="#00ff88"/>
                <circle cx="28.5" cy="23.5" r="0.8" fill="#fff"/>
                <circle cx="41" cy="24" r="3.5" fill="#003300"/>
                <circle cx="41" cy="24" r="2" fill="#00ff88"/>
                <circle cx="40.5" cy="23.5" r="0.8" fill="#fff"/>
                <ellipse cx="35" cy="31" rx="3" ry="2" fill="#ffaacc" opacity="0.8"/>
                <path d="M30,34 Q33,38 35,36 Q37,38 40,34" fill="none" stroke="#44ff88" stroke-width="1.5"/>
                <circle cx="35" cy="18" r="3" fill="#ffff00" stroke="#ffcc00" stroke-width="1.5"/>
                <rect x="32" y="40" width="6" height="18" rx="3" fill="#aaddaa" stroke="#44ff88" stroke-width="1.5"/>
                <line x1="29" y1="26" x2="22" y2="20" stroke="#00ff88" stroke-width="1" stroke-dasharray="2,2"/>
                <line x1="41" y1="26" x2="48" y2="20" stroke="#00ff88" stroke-width="1" stroke-dasharray="2,2"/>
                <line x1="35" y1="55" x2="30" y2="64" stroke="#44ff88" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="35" y1="55" x2="40" y2="64" stroke="#44ff88" stroke-width="1.5" stroke-linecap="round"/>
              </svg>` },

            { id: 93, name: "Rogue Process", type: "EFFECT", attribute: "DARK", level: 4, atk: 1400, def: 1100,
              desc: "Once per turn: Target 1 opponent's monster; it loses 400 ATK until the end of this turn.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="15" y="10" width="40" height="50" rx="5" fill="#080808" stroke="#ff0033" stroke-width="2"/>
                <rect x="19" y="14" width="32" height="38" rx="3" fill="#100008" stroke="#cc0022" stroke-width="1"/>
                <text x="21" y="26" font-size="5.5" fill="#ff0033" font-family="monospace">ACCESS --DENIED</text>
                <text x="21" y="34" font-size="5.5" fill="#ff0033" font-family="monospace">OVERRIDE [OK]</text>
                <text x="21" y="42" font-size="5.5" fill="#ff0033" font-family="monospace">INJECT 0xDEAD</text>
                <text x="21" y="50" font-size="5.5" fill="#cc0000" font-family="monospace" opacity="0.6">RUNNING...</text>
                <circle cx="35" cy="34" r="9" fill="none" stroke="#ff0033" stroke-width="1.5" stroke-dasharray="3,3"/>
                <circle cx="35" cy="34" r="5" fill="none" stroke="#ff3355" stroke-width="1"/>
                <circle cx="35" cy="34" r="2" fill="#ff0044"/>
                <rect x="5" y="24" width="10" height="5" rx="2" fill="#200010" stroke="#ff0033" stroke-width="1"/>
                <line x1="15" y1="26.5" x2="10" y2="26.5" stroke="#ff0033" stroke-width="1.2"/>
                <rect x="55" y="24" width="10" height="5" rx="2" fill="#200010" stroke="#ff0033" stroke-width="1"/>
                <line x1="55" y1="26.5" x2="60" y2="26.5" stroke="#ff0033" stroke-width="1.2"/>
                <rect x="5" y="38" width="10" height="5" rx="2" fill="#200010" stroke="#ff0033" stroke-width="1"/>
                <line x1="15" y1="40.5" x2="10" y2="40.5" stroke="#ff0033" stroke-width="1.2"/>
                <rect x="55" y="38" width="10" height="5" rx="2" fill="#200010" stroke="#ff0033" stroke-width="1"/>
                <line x1="55" y1="40.5" x2="60" y2="40.5" stroke="#ff0033" stroke-width="1.2"/>
              </svg>` },

            { id: 94, name: "Magnet Golem", type: "NORMAL", attribute: "EARTH", level: 4, atk: 1650, def: 1400,
              desc: "A hulking golem assembled from scrap metal and magnetic ore. Polarized plates deflect incoming fire.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="24" y="6" width="22" height="18" rx="4" fill="#334455" stroke="#778899" stroke-width="2"/>
                <rect x="28" y="9" width="6" height="8" rx="2" fill="#aabbcc" stroke="#778899" stroke-width="1" opacity="0.6"/>
                <rect x="36" y="9" width="6" height="8" rx="2" fill="#aabbcc" stroke="#778899" stroke-width="1" opacity="0.6"/>
                <rect x="30" y="17" width="10" height="3" rx="1" fill="#ff3300" opacity="0.8"/>
                <rect x="18" y="24" width="34" height="28" rx="5" fill="#2a3a4a" stroke="#667788" stroke-width="2"/>
                <rect x="22" y="28" width="12" height="18" rx="3" fill="#334455" stroke="#99aacc" stroke-width="1.5"/>
                <rect x="36" y="28" width="12" height="18" rx="3" fill="#334455" stroke="#99aacc" stroke-width="1.5"/>
                <circle cx="28" cy="37" r="4" fill="#1a2535" stroke="#00ccff" stroke-width="1.5"/>
                <circle cx="42" cy="37" r="4" fill="#1a2535" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="28" y1="37" x2="42" y2="37" stroke="#ff3300" stroke-width="2" stroke-dasharray="3,3" opacity="0.8"/>
                <rect x="5" y="26" width="13" height="8" rx="3" fill="#2a3a4a" stroke="#667788" stroke-width="1.5"/>
                <rect x="52" y="26" width="13" height="8" rx="3" fill="#2a3a4a" stroke="#667788" stroke-width="1.5"/>
                <rect x="24" y="52" width="9" height="16" rx="3" fill="#2a3a4a" stroke="#667788" stroke-width="1.5"/>
                <rect x="37" y="52" width="9" height="16" rx="3" fill="#2a3a4a" stroke="#667788" stroke-width="1.5"/>
                <path d="M5,26 Q2,20 5,16 Q9,13 13,16" fill="none" stroke="#ff3300" stroke-width="2" stroke-linecap="round"/>
                <path d="M65,26 Q68,20 65,16 Q61,13 57,16" fill="none" stroke="#0099ff" stroke-width="2" stroke-linecap="round"/>
              </svg>` },

            { id: 95, name: "Shadow Wisp", type: "EFFECT", attribute: "DARK", level: 3, atk: 900, def: 700,
              desc: "When Special Summoned from the hand: Inflict 300 damage to your opponent.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="35" rx="20" ry="28" fill="#0a000f" stroke="#7700aa" stroke-width="2" opacity="0.9"/>
                <ellipse cx="35" cy="32" rx="14" ry="20" fill="#150020" stroke="#9900cc" stroke-width="1.5"/>
                <ellipse cx="35" cy="28" rx="9" ry="14" fill="#1a002a" stroke="#bb00ee" stroke-width="1"/>
                <circle cx="29" cy="24" r="4" fill="#000"/>
                <circle cx="29" cy="24" r="2.5" fill="#cc00ff"/>
                <circle cx="28.5" cy="23.5" r="1" fill="#fff"/>
                <circle cx="41" cy="24" r="4" fill="#000"/>
                <circle cx="41" cy="24" r="2.5" fill="#cc00ff"/>
                <circle cx="40.5" cy="23.5" r="1" fill="#fff"/>
                <path d="M27,54 Q22,62 18,66" stroke="#7700aa" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.7"/>
                <path d="M32,58 Q30,65 28,70" stroke="#7700aa" stroke-width="2.5" fill="none" stroke-linecap="round" opacity="0.7"/>
                <path d="M38,58 Q40,65 42,70" stroke="#7700aa" stroke-width="2.5" fill="none" stroke-linecap="round" opacity="0.7"/>
                <path d="M43,54 Q48,62 52,66" stroke="#7700aa" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.7"/>
                <circle cx="20" cy="38" r="3" fill="#9900cc" opacity="0.5"/>
                <circle cx="50" cy="32" r="2" fill="#9900cc" opacity="0.4"/>
              </svg>` },

            { id: 96, name: "Byte Bunny", type: "NORMAL", attribute: "LIGHT", level: 2, atk: 700, def: 500,
              desc: "A fluffy data-construct that hops between server nodes. Said to bring good luck to connection speed.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="27" y="3" width="6" height="18" rx="3" fill="#ddeeff" stroke="#aabbdd" stroke-width="1.5"/>
                <rect x="37" y="3" width="6" height="18" rx="3" fill="#ddeeff" stroke="#aabbdd" stroke-width="1.5"/>
                <rect x="28" y="4" width="4" height="8" rx="2" fill="#ffbbcc" opacity="0.7"/>
                <rect x="38" y="4" width="4" height="8" rx="2" fill="#ffbbcc" opacity="0.7"/>
                <ellipse cx="35" cy="28" rx="16" ry="14" fill="#eef5ff" stroke="#aabbdd" stroke-width="2"/>
                <ellipse cx="35" cy="38" rx="12" ry="9" fill="#ddeeff" stroke="#99aacc" stroke-width="1.5"/>
                <circle cx="29" cy="25" r="3.5" fill="#110022"/>
                <circle cx="29" cy="25" r="2" fill="#00ccff"/>
                <circle cx="28.5" cy="24.5" r="0.8" fill="#fff"/>
                <circle cx="41" cy="25" r="3.5" fill="#110022"/>
                <circle cx="41" cy="25" r="2" fill="#00ccff"/>
                <circle cx="40.5" cy="24.5" r="0.8" fill="#fff"/>
                <ellipse cx="35" cy="31" rx="3" ry="2" fill="#ffbbcc"/>
                <path d="M30,34 Q33,38 35,36 Q37,38 40,34" fill="none" stroke="#9999cc" stroke-width="1.5"/>
                <line x1="26" y1="30" x2="18" y2="28" stroke="#99aacc" stroke-width="1.2" stroke-linecap="round"/>
                <line x1="26" y1="32" x2="17" y2="32" stroke="#99aacc" stroke-width="1.2" stroke-linecap="round"/>
                <line x1="44" y1="30" x2="52" y2="28" stroke="#99aacc" stroke-width="1.2" stroke-linecap="round"/>
                <line x1="44" y1="32" x2="53" y2="32" stroke="#99aacc" stroke-width="1.2" stroke-linecap="round"/>
                <path d="M42,45 Q50,50 48,58" fill="none" stroke="#ddeeff" stroke-width="2.5" stroke-linecap="round"/>
                <rect x="24" y="46" width="7" height="14" rx="3" fill="#ddeeff" stroke="#aabbdd" stroke-width="1.5"/>
                <rect x="39" y="46" width="7" height="14" rx="3" fill="#ddeeff" stroke="#aabbdd" stroke-width="1.5"/>
              </svg>` },

            { id: 97, name: "Storm Imp", type: "EFFECT", attribute: "WIND", level: 4, atk: 1300, def: 1000,
              desc: "When this card declares an attack: Flip a coin. Heads  this card gains 500 ATK for that battle.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M20,22 Q10,8 18,5 Q25,4 22,16" fill="#4444aa" stroke="#8888ff" stroke-width="1.5"/>
                <path d="M50,22 Q60,8 52,5 Q45,4 48,16" fill="#4444aa" stroke="#8888ff" stroke-width="1.5"/>
                <ellipse cx="35" cy="28" rx="16" ry="14" fill="#222255" stroke="#6666cc" stroke-width="2"/>
                <circle cx="28" cy="24" r="4.5" fill="#111"/>
                <circle cx="28" cy="24" r="3" fill="#ffff00"/>
                <circle cx="27.5" cy="23.5" r="1.2" fill="#fff"/>
                <circle cx="42" cy="24" r="4.5" fill="#111"/>
                <circle cx="42" cy="24" r="3" fill="#ffff00"/>
                <circle cx="41.5" cy="23.5" r="1.2" fill="#fff"/>
                <path d="M28,34 Q32,38 35,36 Q38,38 42,34" fill="none" stroke="#ffff66" stroke-width="1.5"/>
                <polyline points="27,14 24,8 30,12 28,6" fill="none" stroke="#ffff44" stroke-width="1.5" stroke-linejoin="round"/>
                <polyline points="43,14 46,8 40,12 42,6" fill="none" stroke="#ffff44" stroke-width="1.5" stroke-linejoin="round"/>
                <rect x="22" y="40" width="26" height="18" rx="5" fill="#1a1a44" stroke="#5555aa" stroke-width="2"/>
                <polyline points="26,46 29,42 32,47 35,42 38,47 41,42 44,46" fill="none" stroke="#ffff44" stroke-width="1.5" stroke-linejoin="round"/>
                <rect x="22" y="58" width="8" height="10" rx="3" fill="#1a1a44" stroke="#5555aa" stroke-width="1.5"/>
                <rect x="40" y="58" width="8" height="10" rx="3" fill="#1a1a44" stroke="#5555aa" stroke-width="1.5"/>
                <path d="M8,34 Q13,28 18,32" fill="none" stroke="#ffff44" stroke-width="1.5"/>
                <path d="M62,34 Q57,28 52,32" fill="none" stroke="#ffff44" stroke-width="1.5"/>
              </svg>` },

            { id: 98, name: "Firewall Drone", type: "NORMAL", attribute: "LIGHT", level: 3, atk: 1050, def: 1200,
              desc: "An autonomous patrol drone guarding network perimeters. Equipped with EMP emitter and collision avoidance.", rarity: "C",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="22" y="28" width="26" height="18" rx="5" fill="#1a2a3a" stroke="#00aaff" stroke-width="2"/>
                <rect x="26" y="32" width="18" height="10" rx="3" fill="#0d1a2a" stroke="#0077cc" stroke-width="1.5"/>
                <circle cx="35" cy="37" r="4" fill="#001122" stroke="#00ccff" stroke-width="1.5"/>
                <circle cx="35" cy="37" r="2" fill="#00aaff" opacity="0.8"/>
                <rect x="8" y="32" width="14" height="6" rx="3" fill="#1a2a3a" stroke="#0088cc" stroke-width="1.5"/>
                <rect x="48" y="32" width="14" height="6" rx="3" fill="#1a2a3a" stroke="#0088cc" stroke-width="1.5"/>
                <rect x="4" y="33" width="4" height="4" rx="1" fill="#0055aa" stroke="#0088cc" stroke-width="1"/>
                <rect x="62" y="33" width="4" height="4" rx="1" fill="#0055aa" stroke="#0088cc" stroke-width="1"/>
                <line x1="4" y1="35" x2="1" y2="35" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="66" y1="35" x2="69" y2="35" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="35" y1="28" x2="35" y2="20" stroke="#0088cc" stroke-width="2"/>
                <circle cx="35" cy="18" r="5" fill="#0d1a2a" stroke="#00ccff" stroke-width="1.5"/>
                <circle cx="35" cy="18" r="2.5" fill="#00aaff" opacity="0.7"/>
                <line x1="22" y1="28" x2="16" y2="18" stroke="#0088cc" stroke-width="1.5"/>
                <circle cx="14" cy="16" r="4" fill="#0d1a2a" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="48" y1="28" x2="54" y2="18" stroke="#0088cc" stroke-width="1.5"/>
                <circle cx="56" cy="16" r="4" fill="#0d1a2a" stroke="#00ccff" stroke-width="1.5"/>
                <line x1="35" y1="46" x2="35" y2="54" stroke="#0088cc" stroke-width="2"/>
                <ellipse cx="35" cy="57" rx="8" ry="3" fill="none" stroke="#00aaff" stroke-width="1" stroke-dasharray="3,3" opacity="0.6"/>
              </svg>` },

            { id: 99, name: "Crystal Turtle", type: "EFFECT", attribute: "WATER", level: 4, atk: 600, def: 2200,
              desc: "Once per turn: Switch this card to DEF position and gain +800 DEF until the End Phase.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="42" rx="26" ry="18" fill="#001a33" stroke="#00aaff" stroke-width="2"/>
                <path d="M13,38 Q20,22 35,20 Q50,22 57,38" fill="#002244" stroke="#0077cc" stroke-width="2"/>
                <polygon points="35,20 28,26 35,24 42,26" fill="#00ccff" stroke="#0099ff" stroke-width="1" opacity="0.7"/>
                <polygon points="20,30 26,26 25,33 19,36" fill="#00aaff" stroke="#0088cc" stroke-width="1" opacity="0.7"/>
                <polygon points="50,30 44,26 45,33 51,36" fill="#00aaff" stroke="#0088cc" stroke-width="1" opacity="0.7"/>
                <polygon points="22,42 18,36 26,38 25,44" fill="#0099ff" stroke="#0077cc" stroke-width="1" opacity="0.7"/>
                <polygon points="48,42 52,36 44,38 45,44" fill="#0099ff" stroke="#0077cc" stroke-width="1" opacity="0.7"/>
                <ellipse cx="35" cy="36" rx="14" ry="10" fill="#003366" stroke="#00ccff" stroke-width="1.5"/>
                <circle cx="35" cy="36" r="8" fill="#0a2040" stroke="#00aaff" stroke-width="1"/>
                <circle cx="35" cy="36" r="4" fill="#001a30" stroke="#00ccff" stroke-width="1"/>
                <line x1="35" y1="26" x2="35" y2="46" stroke="#00ccff" stroke-width="0.8" opacity="0.5"/>
                <line x1="25" y1="36" x2="45" y2="36" stroke="#00ccff" stroke-width="0.8" opacity="0.5"/>
                <ellipse cx="28" cy="22" rx="4" ry="3" fill="#00ccff" stroke="#66eeff" stroke-width="1" opacity="0.6"/>
                <ellipse cx="42" cy="22" rx="4" ry="3" fill="#00ccff" stroke="#66eeff" stroke-width="1" opacity="0.6"/>
                <rect x="20" y="55" width="8" height="10" rx="4" fill="#001a33" stroke="#0077cc" stroke-width="1.5"/>
                <rect x="42" y="55" width="8" height="10" rx="4" fill="#001a33" stroke="#0077cc" stroke-width="1.5"/>
              </svg>` },

            { id: 100, name: "Holo Phantom", type: "EFFECT", attribute: "LIGHT", level: 4, atk: 1500, def: 1300,
              desc: "Once per turn: You can set this card face-down in Defense Position, hiding its identity from your opponent.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="35" cy="35" rx="24" ry="28" fill="none" stroke="#ffffff" stroke-width="1.5" opacity="0.15"/>
                <ellipse cx="35" cy="35" rx="18" ry="22" fill="#070714" stroke="#aaaaff" stroke-width="1.5" opacity="0.6"/>
                <ellipse cx="35" cy="32" rx="12" ry="15" fill="#0a0a20" stroke="#ccccff" stroke-width="1" opacity="0.7"/>
                <circle cx="28" cy="28" r="4" fill="#000"/>
                <circle cx="28" cy="28" r="2.5" fill="#ffffff" opacity="0.85"/>
                <circle cx="27.5" cy="27.5" r="1" fill="#aaaaff"/>
                <circle cx="42" cy="28" r="4" fill="#000"/>
                <circle cx="42" cy="28" r="2.5" fill="#ffffff" opacity="0.85"/>
                <circle cx="41.5" cy="27.5" r="1" fill="#aaaaff"/>
                <path d="M29,36 Q32,40 35,38 Q38,40 41,36" fill="none" stroke="#ccccff" stroke-width="1.5" opacity="0.7"/>
                <path d="M17,63 Q20,54 24,50 Q28,46 35,48 Q42,46 46,50 Q50,54 53,63" fill="#0a0a20" stroke="#aaaaff" stroke-width="1" opacity="0.6"/>
                <ellipse cx="35" cy="55" rx="10" ry="6" fill="#0d0d25" stroke="#aaaaff" stroke-width="1" opacity="0.5"/>
                <line x1="35" y1="18" x2="35" y2="10" stroke="#ffffff" stroke-width="1" opacity="0.3"/>
                <circle cx="35" cy="8" r="2.5" fill="#aaaaff" opacity="0.5"/>
                <rect x="10" y="33" width="50" height="4" fill="#ffffff" opacity="0.03"/>
              </svg>` },

            //  NEW SPELLS (101-104) 
            { id: 101, name: "Emergency Reboot", type: "SPELL", attribute: "SPELL",
              desc: "Special Summon up to 2 monsters from your Graveyard that were destroyed this turn.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="28" fill="#001122" stroke="#00ff88" stroke-width="2"/>
                <circle cx="35" cy="35" r="22" fill="none" stroke="#00cc66" stroke-width="1.5" stroke-dasharray="4,4"/>
                <path d="M35,14 A21,21 0 0,1 56,35" fill="none" stroke="#00ff88" stroke-width="3" stroke-linecap="round"/>
                <polygon points="56,35 62,30 62,40" fill="#00ff88"/>
                <path d="M35,56 A21,21 0 0,1 14,35" fill="none" stroke="#00ff88" stroke-width="3" stroke-linecap="round"/>
                <polygon points="14,35 8,30 8,40" fill="#00ff88"/>
                <rect x="27" y="27" width="16" height="16" rx="4" fill="#003322" stroke="#00ff88" stroke-width="2"/>
                <line x1="35" y1="31" x2="35" y2="43" stroke="#00ff88" stroke-width="2" stroke-linecap="round"/>
                <line x1="29" y1="37" x2="41" y2="37" stroke="#00ff88" stroke-width="2" stroke-linecap="round"/>
                <circle cx="20" cy="18" r="4" fill="#002211" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="18" y1="16" x2="22" y2="20" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="22" y1="16" x2="18" y2="20" stroke="#00ff88" stroke-width="1.5"/>
                <circle cx="50" cy="18" r="4" fill="#002211" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="48" y1="16" x2="52" y2="20" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="52" y1="16" x2="48" y2="20" stroke="#00ff88" stroke-width="1.5"/>
                <text x="19" y="64" font-size="7" fill="#00ff88" font-family="monospace" opacity="0.7">REBOOT</text>
              </svg>` },

            { id: 102, name: "Fusion Catalyst", type: "SPELL", attribute: "SPELL",
              desc: "Fusion Summon 1 Monster using Monsters from your hand, Deck and/or field.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <circle cx="20" cy="35" r="14" fill="#220044" stroke="#9900ff" stroke-width="2"/>
                <circle cx="50" cy="35" r="14" fill="#004422" stroke="#00cc44" stroke-width="2"/>
                <ellipse cx="35" cy="35" rx="14" ry="14" fill="#110033" stroke="#6633ff" stroke-width="1.5" opacity="0.85"/>
                <circle cx="20" cy="35" r="9" fill="#330066" stroke="#aa22ff" stroke-width="1"/>
                <circle cx="50" cy="35" r="9" fill="#005533" stroke="#00ee55" stroke-width="1"/>
                <circle cx="35" cy="35" r="8" fill="#000" stroke="#ff88ff" stroke-width="1.5"/>
                <circle cx="35" cy="35" r="4" fill="#220044" stroke="#ff00ff" stroke-width="1.5"/>
                <circle cx="35" cy="35" r="2" fill="#ff00ff" opacity="0.9"/>
                <line x1="20" y1="35" x2="35" y2="35" stroke="#aa22ff" stroke-width="1.5" stroke-dasharray="2,2"/>
                <line x1="35" y1="35" x2="50" y2="35" stroke="#00cc44" stroke-width="1.5" stroke-dasharray="2,2"/>
                <path d="M20,21 Q35,10 50,21" fill="none" stroke="#ff88ff" stroke-width="1.2" stroke-dasharray="3,3" opacity="0.7"/>
                <path d="M20,49 Q35,60 50,49" fill="none" stroke="#ff88ff" stroke-width="1.2" stroke-dasharray="3,3" opacity="0.7"/>
                <text x="17" y="39" font-size="8" fill="#aa22ff" font-family="monospace" font-weight="bold">A</text>
                <text x="46" y="39" font-size="8" fill="#00cc44" font-family="monospace" font-weight="bold">B</text>
                <text x="32" y="39" font-size="9" fill="#ff00ff" font-family="monospace" font-weight="bold">+</text>
              </svg>` },

            { id: 103, name: "Overclock Burst", type: "SPELL", attribute: "SPELL",
              desc: "Target 1 monster you control: It gains 1200 ATK until the End Phase, then is destroyed at the End Phase.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="10" y="10" width="50" height="50" rx="6" fill="#1a0000" stroke="#ff4400" stroke-width="2"/>
                <rect x="16" y="16" width="38" height="38" rx="4" fill="#0d0000" stroke="#cc3300" stroke-width="1"/>
                <path d="M35,20 L42,32 L54,32 L44,40 L48,52 L35,44 L22,52 L26,40 L16,32 L28,32 Z" fill="#ff4400" stroke="#ff8800" stroke-width="1.5" opacity="0.9"/>
                <path d="M35,26 L39,33 L46,33 L41,38 L43,45 L35,40 L27,45 L29,38 L24,33 L31,33 Z" fill="#ff8800" stroke="#ffcc00" stroke-width="1"/>
                <circle cx="35" cy="36" r="5" fill="#ffcc00" stroke="#ffffff" stroke-width="1.5"/>
                <circle cx="35" cy="36" r="2.5" fill="#ffffff"/>
                <line x1="35" y1="8" x2="35" y2="14" stroke="#ff4400" stroke-width="2" stroke-linecap="round"/>
                <line x1="62" y1="35" x2="56" y2="35" stroke="#ff4400" stroke-width="2" stroke-linecap="round"/>
                <line x1="8" y1="35" x2="14" y2="35" stroke="#ff4400" stroke-width="2" stroke-linecap="round"/>
                <text x="22" y="66" font-size="8" fill="#ff6600" font-family="monospace" opacity="0.8">+1200ATK</text>
              </svg>` },

            { id: 104, name: "Data Purge", type: "SPELL", attribute: "SPELL",
              desc: "Banish all cards in your opponent's Graveyard. They cannot use GY effects this turn.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <rect x="12" y="8" width="46" height="54" rx="6" fill="#080808" stroke="#ff0000" stroke-width="2"/>
                <rect x="17" y="13" width="36" height="44" rx="4" fill="#0d0000" stroke="#cc0000" stroke-width="1.5"/>
                <rect x="21" y="17" width="28" height="5" rx="2" fill="#1a0000" stroke="#ff0000" stroke-width="1"/>
                <rect x="21" y="24" width="28" height="5" rx="2" fill="#1a0000" stroke="#aa0000" stroke-width="1" opacity="0.8"/>
                <rect x="21" y="31" width="28" height="5" rx="2" fill="#1a0000" stroke="#880000" stroke-width="1" opacity="0.6"/>
                <rect x="21" y="38" width="28" height="5" rx="2" fill="#1a0000" stroke="#660000" stroke-width="1" opacity="0.4"/>
                <rect x="21" y="45" width="28" height="5" rx="2" fill="#1a0000" stroke="#440000" stroke-width="1" opacity="0.2"/>
                <line x1="13" y1="14" x2="57" y2="56" stroke="#ff0000" stroke-width="3" stroke-linecap="round" opacity="0.9"/>
                <line x1="57" y1="14" x2="13" y2="56" stroke="#ff0000" stroke-width="3" stroke-linecap="round" opacity="0.9"/>
                <circle cx="35" cy="35" r="10" fill="#1a0000" stroke="#ff0000" stroke-width="2"/>
                <text x="30" y="39" font-size="10" fill="#ff0000" font-family="monospace" font-weight="bold">X</text>
              </svg>` },

            //  NEW TRAPS (105-106) 
            { id: 105, name: "Reflect Shield", type: "TRAP", attribute: "TRAP",
              desc: "When your monster is attacked: The attacking monster takes damage equal to your monster's current DEF value.", rarity: "R",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <path d="M35,6 L60,18 L60,42 Q60,60 35,67 Q10,60 10,42 L10,18 Z" fill="#0a1a0a" stroke="#44ff44" stroke-width="2.5"/>
                <path d="M35,12 L54,22 L54,42 Q54,56 35,62 Q16,56 16,42 L16,22 Z" fill="#0d200d" stroke="#22cc22" stroke-width="1.5"/>
                <path d="M35,18 L48,26 L48,42 Q48,52 35,57 Q22,52 22,42 L22,26 Z" fill="#0f2a0f" stroke="#00ff44" stroke-width="1"/>
                <path d="M48,28 Q56,22 62,28 L54,36 Q50,34 48,38Z" fill="#aaff88" stroke="#44ff44" stroke-width="1" opacity="0.7"/>
                <circle cx="35" cy="38" r="8" fill="#001a00" stroke="#44ff44" stroke-width="1.5"/>
                <path d="M31,34 L35,38 L31,42" fill="none" stroke="#44ff44" stroke-width="2" stroke-linecap="round"/>
                <path d="M39,34 L35,38 L39,42" fill="none" stroke="#44ff44" stroke-width="2" stroke-linecap="round"/>
                <line x1="52" y1="32" x2="46" y2="34" stroke="#ddff88" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                <line x1="54" y1="36" x2="48" y2="36" stroke="#ddff88" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
                <line x1="52" y1="40" x2="46" y2="38" stroke="#ddff88" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
              </svg>` },

            { id: 106, name: "Chain Overload", type: "TRAP", attribute: "TRAP",
              desc: "When your opponent activates a Spell card: Negate that activation and inflict 500 damage to your opponent.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <ellipse cx="22" cy="28" rx="10" ry="10" fill="#330000" stroke="#ff0000" stroke-width="2"/>
                <ellipse cx="22" cy="28" rx="6" ry="6" fill="#1a0000" stroke="#ff4444" stroke-width="1.5"/>
                <ellipse cx="48" cy="28" rx="10" ry="10" fill="#330000" stroke="#ff0000" stroke-width="2"/>
                <ellipse cx="48" cy="28" rx="6" ry="6" fill="#1a0000" stroke="#ff4444" stroke-width="1.5"/>
                <rect x="24" y="24" width="22" height="8" rx="2" fill="#440000" stroke="#ff0000" stroke-width="1.5"/>
                <ellipse cx="22" cy="48" rx="10" ry="10" fill="#330000" stroke="#ff0000" stroke-width="2"/>
                <ellipse cx="22" cy="48" rx="6" ry="6" fill="#1a0000" stroke="#ff4444" stroke-width="1.5"/>
                <ellipse cx="48" cy="48" rx="10" ry="10" fill="#330000" stroke="#ff0000" stroke-width="2"/>
                <ellipse cx="48" cy="48" rx="6" ry="6" fill="#1a0000" stroke="#ff4444" stroke-width="1.5"/>
                <rect x="24" y="44" width="22" height="8" rx="2" fill="#440000" stroke="#ff0000" stroke-width="1.5"/>
                <line x1="22" y1="34" x2="22" y2="42" stroke="#ff0000" stroke-width="3" stroke-linecap="round"/>
                <line x1="48" y1="34" x2="48" y2="42" stroke="#ff0000" stroke-width="3" stroke-linecap="round"/>
                <polyline points="32,20 35,10 38,18 42,8" fill="none" stroke="#ffcc00" stroke-width="2.5" stroke-linejoin="round"/>
                <circle cx="42" cy="8" r="3" fill="#ffcc00" stroke="#fff" stroke-width="1"/>
                <text x="28" y="64" font-size="7" fill="#ff4444" font-family="monospace" opacity="0.7">NEGATE</text>
              </svg>` },

            //  NEW FUSION (107) 
            { id: 107, name: "Tri-Burst Dragon", type: "FUSION", attribute: "WIND", level: 7, atk: 2800, def: 2000,
              desc: "Volt Bat + Flame Sprite + Glitch Wolf. When this card destroys a monster by battle: Inflict 500 damage to your opponent.", rarity: "SR",
              artIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 70 70">
                <polygon points="35,2 20,55 35,48 50,55" fill="#1a0a00" stroke="#ff6600" stroke-width="2"/>
                <polygon points="35,2 50,55 65,50 52,25" fill="#0a0a1a" stroke="#aa44ff" stroke-width="2"/>
                <polygon points="35,2 20,55 5,50 18,25" fill="#001a0a" stroke="#00eeaa" stroke-width="2"/>
                <ellipse cx="35" cy="20" rx="10" ry="8" fill="#0d0808" stroke="#ff8800" stroke-width="1.5"/>
                <circle cx="30" cy="17" r="3.5" fill="#0a0a00"/>
                <circle cx="30" cy="17" r="2" fill="#ff6600"/>
                <circle cx="29.5" cy="16.5" r="0.8" fill="#fff"/>
                <circle cx="40" cy="17" r="3.5" fill="#0a0a00"/>
                <circle cx="40" cy="17" r="2" fill="#ff6600"/>
                <circle cx="39.5" cy="16.5" r="0.8" fill="#fff"/>
                <path d="M30,23 Q32,26 35,25 Q38,26 40,23" fill="none" stroke="#ff8800" stroke-width="1.5"/>
                <path d="M10,48 Q17,44 20,52 Q15,54 10,52Z" fill="#ff6600" stroke="#ff8800" stroke-width="1" opacity="0.8"/>
                <path d="M60,48 Q53,44 50,52 Q55,54 60,52Z" fill="#aa44ff" stroke="#cc88ff" stroke-width="1" opacity="0.8"/>
                <path d="M35,48 Q32,54 35,60 Q38,54 35,48Z" fill="#00eeaa" stroke="#00cc88" stroke-width="1" opacity="0.8"/>
                <circle cx="35" cy="36" r="12" fill="none" stroke="#ff6600" stroke-width="1.5" opacity="0.4"/>
                <circle cx="35" cy="36" r="8" fill="none" stroke="#aa44ff" stroke-width="1" opacity="0.3"/>
                <circle cx="35" cy="36" r="4" fill="#1a0808" stroke="#ff8800" stroke-width="1.5"/>
                <line x1="35" y1="24" x2="35" y2="32" stroke="#ff6600" stroke-width="1.5" opacity="0.6"/>
                <line x1="35" y1="40" x2="35" y2="48" stroke="#ff6600" stroke-width="1.5" opacity="0.6"/>
                <line x1="23" y1="36" x2="31" y2="36" stroke="#aa44ff" stroke-width="1.5" opacity="0.6"/>
                <line x1="39" y1="36" x2="47" y2="36" stroke="#aa44ff" stroke-width="1.5" opacity="0.6"/>
              </svg>` },

        //  DRAGON'S FURY STRUCTURE DECK EXCLUSIVES (108-113) 
        { id:108, name:"Fury Drake",         type:"NORMAL",  attribute:"FIRE",  level:4, atk:1800, def:900,  rarity:"R",
          desc:"A wild juvenile dragon born from volcanic fury. Its scales burn white-hot in battle.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#1a0500" stroke="#ff5500" stroke-width="2"/><polygon points="35,10 22,52 48,52" fill="#ff4400" opacity=".75"/><circle cx="27" cy="33" r="4" fill="#ffa500"/><circle cx="43" cy="33" r="4" fill="#ffa500"/><path d="M25,47 Q35,40 45,47" fill="none" stroke="#ff8800" stroke-width="2"/><polygon points="35,58 28,68 42,68" fill="#ff4400" opacity=".6"/></svg>` },
        { id:109, name:"Blazewing Sovereign", type:"EFFECT",  attribute:"FIRE",  level:6, atk:2400, def:1800, rarity:"SR",
          desc:"When this card destroys an opponent's monster by battle: You can add 1 FIRE monster from your Graveyard to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="28" ry="22" fill="#1a0800" stroke="#ff6600" stroke-width="2"/><polygon points="35,6 18,42 52,42" fill="#cc3300" opacity=".8"/><polygon points="35,6 10,30 18,42" fill="#ff5500" opacity=".5"/><polygon points="35,6 60,30 52,42" fill="#ff5500" opacity=".5"/><circle cx="28" cy="33" r="5" fill="#ffaa00"/><circle cx="42" cy="33" r="5" fill="#ffaa00"/><circle cx="28" cy="33" r="2" fill="#000"/><circle cx="42" cy="33" r="2" fill="#000"/><ellipse cx="35" cy="55" rx="18" ry="8" fill="#ff3300" opacity=".35"/></svg>` },
        { id:110, name:"Dragon War Sage",    type:"EFFECT",  attribute:"FIRE",  level:5, atk:1900, def:1400, rarity:"R",
          desc:"Once per turn: You can discard 1 card; destroy 1 Spell/Trap on the field.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#1a0a00" stroke="#cc4400" stroke-width="2"/><rect x="31" y="14" width="8" height="30" rx="3" fill="#cc4400"/><circle cx="35" cy="14" r="8" fill="#ff8800"/><polygon points="35,44 20,62 50,62" fill="#882200" opacity=".7"/><line x1="20" y1="35" x2="50" y2="35" stroke="#ff6600" stroke-width="2.5" opacity=".7"/></svg>` },
        { id:111, name:"Ember Familiar",     type:"EFFECT",  attribute:"FIRE",  level:2, atk:900,  def:700,  rarity:"C",
          desc:"When this card is Normal Summoned: Inflict 300 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="25" fill="#1a0500" stroke="#ff8800" stroke-width="1.5"/><ellipse cx="35" cy="42" rx="12" ry="16" fill="#ff5500" opacity=".8"/><ellipse cx="35" cy="38" rx="7" ry="10" fill="#ffaa00" opacity=".9"/><ellipse cx="35" cy="34" rx="4" ry="6" fill="#fff8d0" opacity=".9"/><circle cx="30" cy="28" r="3" fill="#ff8800"/><circle cx="40" cy="28" r="3" fill="#ff8800"/></svg>` },
        { id:112, name:"Blazefang Trap",     type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when an opponent's monster declares an attack: Destroy that monster and inflict damage equal to half its ATK.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#2d0a00" stroke="#ff5500" stroke-width="2"/><polygon points="35,18 20,50 50,50" fill="#ff4400" opacity=".6"/><line x1="20" y1="50" x2="50" y2="50" stroke="#ff8800" stroke-width="2"/><polygon points="35,22 25,45 45,45" fill="#ff8800" opacity=".4"/></svg>` },
        { id:113, name:"Dragon's Roar",      type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All FIRE monsters you control gain 400 ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0a1a00" stroke="#ff6600" stroke-width="2"/><path d="M15,35 Q25,20 35,35 Q45,50 55,35" fill="none" stroke="#ff6600" stroke-width="3"/><path d="M15,42 Q25,27 35,42 Q45,57 55,42" fill="none" stroke="#ff4400" stroke-width="2" opacity=".6"/><circle cx="35" cy="22" r="6" fill="#ff8800" opacity=".7"/></svg>` },

        //  SHADOW COMMAND STRUCTURE DECK EXCLUSIVES (114-119) 
        { id:114, name:"Shadow Reaper",      type:"EFFECT",  attribute:"DARK",  level:4, atk:1600, def:900,  rarity:"R",
          desc:"When this card destroys an opponent's monster by battle: Your opponent discards 1 card at random.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#0a0014" stroke="#8800cc" stroke-width="2"/><polygon points="35,12 15,58 55,58" fill="#440088" opacity=".7"/><rect x="32" y="10" width="6" height="36" rx="2" fill="#9900ee"/><circle cx="35" cy="10" r="5" fill="#cc44ff"/><circle cx="24" cy="32" r="4" fill="#cc00ff"/><circle cx="46" cy="32" r="4" fill="#cc00ff"/></svg>` },
        { id:115, name:"Void Admiral",       type:"EFFECT",  attribute:"DARK",  level:6, atk:2200, def:1700, rarity:"SR",
          desc:"Once per turn: You can target 1 face-up monster your opponent controls; negate its effects until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="27" ry="22" fill="#0a000e" stroke="#7700bb" stroke-width="2"/><polygon points="35,8 15,38 55,38" fill="#550077" opacity=".8"/><ellipse cx="35" cy="8" rx="10" ry="6" fill="#330055"/><circle cx="28" cy="30" r="5" fill="#bb00ff"/><circle cx="42" cy="30" r="5" fill="#bb00ff"/><circle cx="28" cy="30" r="2" fill="#fff"/><circle cx="42" cy="30" r="2" fill="#fff"/><polygon points="35,50 22,62 48,62" fill="#440066" opacity=".6"/></svg>` },
        { id:116, name:"Shade Dancer",       type:"EFFECT",  attribute:"DARK",  level:3, atk:1200, def:800,  rarity:"C",
          desc:"This card can attack your opponent directly. If this card attacks directly, halve the battle damage.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#0a000a" stroke="#9900cc" stroke-width="1.5"/><ellipse cx="35" cy="30" rx="11" ry="14" fill="#440066" opacity=".8"/><circle cx="35" cy="20" r="7" fill="#220033"/><circle cx="30" cy="18" r="3" fill="#cc00ff"/><circle cx="40" cy="18" r="3" fill="#cc00ff"/><path d="M22,50 Q35,38 48,50" fill="#550077" stroke="#9900cc" stroke-width="1.5"/></svg>` },
        { id:117, name:"Dark Conviction",    type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"Send the top 3 cards of your opponent's Deck to the Graveyard.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0a0014" stroke="#9900ee" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#220033" stroke="#cc00ff" stroke-width="1.5"/><text x="35" y="41" text-anchor="middle" font-size="22" fill="#bb00ff"></text><line x1="35" y1="14" x2="35" y2="22" stroke="#9900ee" stroke-width="2"/><line x1="35" y1="48" x2="35" y2="56" stroke="#9900ee" stroke-width="2"/></svg>` },
        { id:118, name:"Shadow Net",         type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"When your opponent Special Summons a monster: Negate the summon and destroy that monster.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0a000e" stroke="#8800cc" stroke-width="2"/><line x1="15" y1="15" x2="55" y2="55" stroke="#8800cc" stroke-width="2"/><line x1="55" y1="15" x2="15" y2="55" stroke="#8800cc" stroke-width="2"/><line x1="35" y1="12" x2="35" y2="58" stroke="#8800cc" stroke-width="2"/><line x1="12" y1="35" x2="58" y2="35" stroke="#8800cc" stroke-width="2"/><circle cx="35" cy="35" r="8" fill="#220033" stroke="#bb00ff" stroke-width="1.5"/></svg>` },
        { id:119, name:"Null Void",          type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Negate the effects of all face-up Spell and Trap cards your opponent controls until your next Standby Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#06000a" stroke="#6600aa" stroke-width="2"/><circle cx="35" cy="35" r="18" fill="#110022" stroke="#9900cc" stroke-width="2"/><line x1="22" y1="22" x2="48" y2="48" stroke="#cc00ff" stroke-width="3"/><circle cx="35" cy="35" r="5" fill="#330055"/></svg>` },

        //  AQUA FORCE STRUCTURE DECK EXCLUSIVES (120-124) 
        { id:120, name:"Tidal Lancer",       type:"NORMAL",  attribute:"WATER", level:4, atk:1700, def:1100, rarity:"R",
          desc:"A warrior from the deep seas who fights with a spear carved from coral and hardened by ocean pressure.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#001428" stroke="#00aaff" stroke-width="2"/><rect x="32" y="10" width="6" height="42" rx="2" fill="#0088cc"/><ellipse cx="35" cy="8" rx="8" ry="5" fill="#00ccff"/><circle cx="27" cy="33" r="4" fill="#00aaff"/><circle cx="43" cy="33" r="4" fill="#00aaff"/><path d="M22,50 Q35,58 48,50" fill="none" stroke="#00ccff" stroke-width="2"/></svg>` },
        { id:121, name:"Abyssal Overlord",   type:"EFFECT",  attribute:"WATER", level:7, atk:2500, def:2000, rarity:"SR",
          desc:"Once per turn: You can return 1 monster on the field to the hand. If this card battles, your opponent cannot activate cards or effects until the end of the Damage Step.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="27" ry="22" fill="#001428" stroke="#0077cc" stroke-width="2"/><polygon points="35,8 16,40 54,40" fill="#003366" opacity=".85"/><ellipse cx="35" cy="8" rx="9" ry="5" fill="#001e40"/><circle cx="27" cy="32" r="5" fill="#00aaff"/><circle cx="43" cy="32" r="5" fill="#00aaff"/><circle cx="27" cy="32" r="2" fill="#fff"/><circle cx="43" cy="32" r="2" fill="#fff"/><path d="M18,48 Q35,60 52,48" fill="#004466" stroke="#00ccff" stroke-width="1.5"/><path d="M22,55 Q35,64 48,55" fill="#003355" stroke="#0088aa" stroke-width="1"/></svg>` },
        { id:122, name:"Coral Shaman",       type:"EFFECT",  attribute:"WATER", level:3, atk:1100, def:900,  rarity:"C",
          desc:"Once per turn: You can draw 1 card, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#001428" stroke="#00bbee" stroke-width="1.5"/><circle cx="35" cy="25" r="9" fill="#00334d"/><circle cx="29" cy="23" r="3" fill="#00aaff"/><circle cx="41" cy="23" r="3" fill="#00aaff"/><path d="M26,30 Q35,38 44,30" fill="none" stroke="#00bbff" stroke-width="1.5"/><path d="M25,42 Q35,55 45,42" fill="#002244" stroke="#0088cc" stroke-width="2"/></svg>` },
        { id:123, name:"Wave Crash",         type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Destroy all monsters your opponent controls with DEF lower than your highest ATK monster's ATK.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#00aaff" stroke-width="2"/><path d="M10,40 Q20,20 30,35 Q40,50 50,30 Q55,20 60,35" fill="none" stroke="#00aaff" stroke-width="3"/><path d="M10,48 Q20,28 30,43 Q40,58 50,38" fill="none" stroke="#0088cc" stroke-width="2" opacity=".6"/></svg>` },
        { id:124, name:"Depth Trap",         type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when a monster is Normal or Special Summoned: Return that monster to the hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#0077cc" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#002244" stroke="#00aaff" stroke-width="1.5"/><path d="M25,28 Q35,42 45,28" fill="none" stroke="#00ccff" stroke-width="2.5"/><line x1="35" y1="28" x2="35" y2="44" stroke="#00aaff" stroke-width="2"/></svg>` },

        //  CYBER BLITZ STRUCTURE DECK EXCLUSIVES (125-129) 
        { id:125, name:"Volt Frame",         type:"NORMAL",  attribute:"EARTH", level:4, atk:1800, def:1300, rarity:"R",
          desc:"A bipedal tactical robot outfitted with high-voltage pulse cannons. An icon of battlefield engineering.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#0a1000" stroke="#aaff00" stroke-width="2"/><rect x="23" y="16" width="24" height="28" rx="4" fill="#1a2200" stroke="#88cc00" stroke-width="1.5"/><circle cx="28" cy="28" r="4" fill="#aaff00"/><circle cx="42" cy="28" r="4" fill="#aaff00"/><rect x="27" y="36" width="16" height="4" rx="2" fill="#88cc00"/><path d="M23,44 L15,56 M47,44 L55,56" stroke="#aaff00" stroke-width="2.5"/></svg>` },
        { id:126, name:"Omnicore Mech",      type:"EFFECT",  attribute:"EARTH", level:7, atk:2600, def:2000, rarity:"SR",
          desc:"Once per turn: You can target 1 machine-type monster in your Graveyard; special summon it in defense position. If this card is destroyed: Special Summon 1 'Volt Frame' from your hand or Deck.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="27" ry="22" fill="#0a1200" stroke="#99ff00" stroke-width="2"/><rect x="20" y="12" width="30" height="30" rx="5" fill="#142200" stroke="#aaff00" stroke-width="2"/><circle cx="27" cy="26" r="5" fill="#aaff00"/><circle cx="43" cy="26" r="5" fill="#aaff00"/><circle cx="27" cy="26" r="2" fill="#000"/><circle cx="43" cy="26" r="2" fill="#000"/><rect x="28" y="35" width="14" height="5" rx="2" fill="#88cc00"/><rect x="18" y="42" width="10" height="18" rx="3" fill="#1a2800" stroke="#aaff00" stroke-width="1.5"/><rect x="42" y="42" width="10" height="18" rx="3" fill="#1a2800" stroke="#aaff00" stroke-width="1.5"/></svg>` },
        { id:127, name:"Nano Pulse",         type:"EFFECT",  attribute:"EARTH", level:2, atk:1000, def:600,  rarity:"C",
          desc:"When this card is Normal Summoned: Deal 500 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="24" fill="#0a1000" stroke="#aaff00" stroke-width="1.5"/><circle cx="35" cy="35" r="12" fill="#142200" stroke="#88cc00" stroke-width="1.5"/><circle cx="35" cy="35" r="5" fill="#aaff00"/><line x1="35" y1="14" x2="35" y2="23" stroke="#aaff00" stroke-width="2"/><line x1="35" y1="47" x2="35" y2="56" stroke="#aaff00" stroke-width="2"/><line x1="14" y1="35" x2="23" y2="35" stroke="#aaff00" stroke-width="2"/><line x1="47" y1="35" x2="56" y2="35" stroke="#aaff00" stroke-width="2"/></svg>` },
        { id:128, name:"System Overload",    type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"All Machine-type monsters you control gain 800 ATK. During the End Phase, destroy all Machine-type monsters you control.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0a1400" stroke="#aaff00" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#142200" stroke="#88ff00" stroke-width="2"/><text x="35" y="42" text-anchor="middle" font-size="20" fill="#aaff00"></text><line x1="35" y1="12" x2="35" y2="19" stroke="#aaff00" stroke-width="2.5"/><line x1="35" y1="51" x2="35" y2="58" stroke="#aaff00" stroke-width="2.5"/><line x1="12" y1="35" x2="19" y2="35" stroke="#aaff00" stroke-width="2.5"/><line x1="51" y1="35" x2="58" y2="35" stroke="#aaff00" stroke-width="2.5"/></svg>` },
        { id:129, name:"Circuit Breaker",    type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when your opponent Special Summons a monster: Halve that monster's ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0a1400" stroke="#88cc00" stroke-width="2"/><path d="M15,35 L28,35 L32,22 L38,48 L42,35 L55,35" fill="none" stroke="#aaff00" stroke-width="3"/><line x1="35" y1="10" x2="35" y2="60" stroke="#55aa00" stroke-width="1" opacity=".5"/></svg>` },

        //  HOLY LIGHT STRUCTURE DECK EXCLUSIVES (130-134) 
        { id:130, name:"Seraph Blade",       type:"NORMAL",  attribute:"LIGHT", level:5, atk:1900, def:1600, rarity:"R",
          desc:"A divine warrior wielding a blazing holy sword. Its judgment falls swift upon those who walk in shadow.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#14100a" stroke="#ffeeaa" stroke-width="2"/><polygon points="35,8 40,35 35,62 30,35" fill="#ffdd88" opacity=".8"/><polygon points="14,35 35,30 56,35 35,40" fill="#ffeecc" opacity=".6"/><circle cx="35" cy="35" r="5" fill="#fff8d0" stroke="#ffaa00" stroke-width="1.5"/><circle cx="35" cy="35" r="12" fill="none" stroke="#ffcc55" stroke-width="1" opacity=".5"/></svg>` },
        { id:131, name:"Celestial Warden",   type:"EFFECT",  attribute:"LIGHT", level:6, atk:2300, def:2000, rarity:"SR",
          desc:"While this card is in Attack Position, your opponent cannot target other LIGHT monsters you control with card effects or attacks.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="26" ry="21" fill="#14100a" stroke="#ffcc44" stroke-width="2"/><polygon points="35,8 20,38 50,38" fill="#aa8833" opacity=".8"/><polygon points="10,25 20,38 35,8" fill="#ffeeaa" opacity=".5"/><polygon points="60,25 50,38 35,8" fill="#ffeeaa" opacity=".5"/><circle cx="28" cy="30" r="5" fill="#ffee88"/><circle cx="42" cy="30" r="5" fill="#ffee88"/><circle cx="28" cy="30" r="2" fill="#aa6600"/><circle cx="42" cy="30" r="2" fill="#aa6600"/><ellipse cx="35" cy="50" rx="18" ry="8" fill="#ffaa33" opacity=".3"/></svg>` },
        { id:132, name:"Pure Heart Squire",  type:"EFFECT",  attribute:"LIGHT", level:2, atk:900,  def:1000, rarity:"C",
          desc:"Your LIGHT monsters cannot be destroyed in battle this turn. Activate during the Battle Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="25" fill="#14100a" stroke="#ffdd88" stroke-width="1.5"/><polygon points="35,16 46,42 24,42" fill="#aa8822" opacity=".7" stroke="#ffdd88" stroke-width="1.5"/><circle cx="35" cy="18" r="8" fill="#1a1400"/><circle cx="30" cy="16" r="3" fill="#ffcc44"/><circle cx="40" cy="16" r="3" fill="#ffcc44"/><ellipse cx="35" cy="26" rx="5" ry="3" fill="#ffeeaa" opacity=".5"/></svg>` },
        { id:133, name:"Blessed Barrier",    type:"TRAP",    attribute:"TRAP",  rarity:"SR",
          desc:"Activate when your opponent's monster attacks: Negate the attack, then you gain LP equal to the attacking monster's ATK.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffcc44" stroke-width="2"/><ellipse cx="35" cy="35" rx="22" ry="18" fill="#1a1600" stroke="#ffee88" stroke-width="2"/><ellipse cx="35" cy="35" rx="14" ry="11" fill="none" stroke="#ffcc55" stroke-width="1.5" opacity=".7"/><polygon points="35,22 40,33 35,44 30,33" fill="#ffcc44" opacity=".6"/></svg>` },
        { id:134, name:"Holy Radiance",      type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All LIGHT monsters you control gain 500 ATK and DEF. Draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffee88" stroke-width="2"/><circle cx="35" cy="35" r="13" fill="#2a2200" stroke="#ffcc44" stroke-width="2"/><line x1="35" y1="12" x2="35" y2="22" stroke="#ffee88" stroke-width="2.5"/><line x1="35" y1="48" x2="35" y2="58" stroke="#ffee88" stroke-width="2.5"/><line x1="12" y1="35" x2="22" y2="35" stroke="#ffee88" stroke-width="2.5"/><line x1="48" y1="35" x2="58" y2="35" stroke="#ffee88" stroke-width="2.5"/><line x1="19" y1="19" x2="26" y2="26" stroke="#ffdd66" stroke-width="2"/><line x1="51" y1="19" x2="44" y2="26" stroke="#ffdd66" stroke-width="2"/><line x1="19" y1="51" x2="26" y2="44" stroke="#ffdd66" stroke-width="2"/><line x1="51" y1="51" x2="44" y2="44" stroke="#ffdd66" stroke-width="2"/><circle cx="35" cy="35" r="5" fill="#ffee88"/></svg>` },

        //  NEMESIS COLLECTION BOX EXCLUSIVES (135-139) 
        { id:135, name:"Nemesis Titan",      type:"EFFECT",  attribute:"EARTH", level:8, atk:3000, def:2500, rarity:"UR",
          desc:"Cannot be Normal Summoned/Set. Must be Special Summoned by having 3 or more monsters in any Graveyard. Unaffected by Spell and Trap effects. Once per turn: You can destroy 1 monster on the field.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="28" ry="22" fill="#0e0e0e" stroke="#aaaaaa" stroke-width="2.5"/><polygon points="35,5 15,40 55,40" fill="#444" opacity=".9"/><polygon points="5,22 15,40 35,5" fill="#666" opacity=".5"/><polygon points="65,22 55,40 35,5" fill="#666" opacity=".5"/><rect x="27" y="26" width="16" height="12" rx="2" fill="#111" stroke="#888" stroke-width="1.5"/><circle cx="31" cy="32" r="3" fill="#aaa"/><circle cx="39" cy="32" r="3" fill="#aaa"/><polygon points="35,58 18,68 52,68" fill="#333" opacity=".7"/><text x="35" y="66" text-anchor="middle" font-size="7" fill="#aaa" opacity=".0">UR</text></svg>` },
        { id:136, name:"Eclipse Dragon",     type:"FUSION",  attribute:"DARK",  level:8, atk:2900, def:2400, rarity:"UR",
          desc:"2 DARK monsters. When this card is Fusion Summoned: You can destroy all Spell/Trap cards on the field. This card cannot be destroyed by card effects.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#060010" stroke="#440088" stroke-width="2.5"/><polygon points="35,5 18,52 52,52" fill="#220044" opacity=".85"/><circle cx="28" cy="32" r="6" fill="#9900ff"/><circle cx="42" cy="32" r="6" fill="#9900ff"/><circle cx="28" cy="32" r="2.5" fill="#fff"/><circle cx="42" cy="32" r="2.5" fill="#fff"/><ellipse cx="35" cy="55" rx="15" ry="7" fill="#440066" opacity=".6"/><polygon points="35,5 18,20 35,30" fill="#550077" opacity=".4"/><polygon points="35,5 52,20 35,30" fill="#550077" opacity=".4"/><circle cx="35" cy="35" r="28" fill="none" stroke="#6600aa" stroke-width="1" opacity=".5"/></svg>` },
        { id:137, name:"Void Empress",       type:"EFFECT",  attribute:"DARK",  level:7, atk:2600, def:2200, rarity:"UR",
          desc:"When this card is Normal or Special Summoned: You can look at the top 5 cards of your opponent's Deck and rearrange them in any order. Once per turn: You can discard 1 card to negate and destroy 1 activated monster effect.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#060010" stroke="#8800bb" stroke-width="2.5"/><ellipse cx="35" cy="28" rx="13" ry="16" fill="#1a0033"/><circle cx="35" cy="16" r="9" fill="#110022"/><circle cx="28" cy="14" r="4" fill="#cc00ff"/><circle cx="42" cy="14" r="4" fill="#cc00ff"/><circle cx="28" cy="14" r="1.5" fill="#fff"/><circle cx="42" cy="14" r="1.5" fill="#fff"/><polygon points="35,8 28,4 42,4" fill="#9900cc"/><path d="M22,44 Q35,56 48,44" fill="#220033" stroke="#aa00ee" stroke-width="2"/><path d="M20,48 Q35,62 50,48" fill="#1a0028" stroke="#8800bb" stroke-width="1.5"/></svg>` },
        { id:138, name:"Phantom Leviathan",  type:"EFFECT",  attribute:"WATER", level:8, atk:2900, def:2300, rarity:"UR",
          desc:"Cannot be targeted by card effects. When this card attacks: It gains 300 ATK for each monster in both players' Graveyards. When this card destroys a monster by battle: Draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="42" rx="28" ry="20" fill="#001428" stroke="#0055aa" stroke-width="2.5"/><path d="M10,40 Q22,15 35,8 Q48,15 60,40" fill="#002244" opacity=".8" stroke="#0077cc" stroke-width="2"/><circle cx="26" cy="30" r="6" fill="#00aaff"/><circle cx="44" cy="30" r="6" fill="#00aaff"/><circle cx="26" cy="30" r="2.5" fill="#fff"/><circle cx="44" cy="30" r="2.5" fill="#fff"/><path d="M18,52 Q35,65 52,52" fill="none" stroke="#0088cc" stroke-width="2"/><path d="M15,46 Q35,60 55,46" fill="#001e3c" stroke="#0066aa" stroke-width="1.5"/></svg>` },
        { id:139, name:"Nemesis Decree",     type:"SPELL",   attribute:"SPELL", rarity:"UR",
          desc:"FIELD SPELL: All monsters on the field lose 500 ATK. When a monster is destroyed by battle while this card is active: The controller of the destroyed monster takes 500 damage.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#0e0e0e" stroke="#aaaaaa" stroke-width="2.5"/><circle cx="35" cy="35" r="18" fill="#1a1a1a" stroke="#888" stroke-width="1.5"/><text x="35" y="41" text-anchor="middle" font-size="22" fill="#aaaaaa"></text><line x1="35" y1="10" x2="35" y2="17" stroke="#aaa" stroke-width="2"/><line x1="35" y1="53" x2="35" y2="60" stroke="#aaa" stroke-width="2"/><line x1="10" y1="35" x2="17" y2="35" stroke="#aaa" stroke-width="2"/><line x1="53" y1="35" x2="60" y2="35" stroke="#aaa" stroke-width="2"/></svg>` },

        //  OMEGA SOURCE BOX EXCLUSIVES (140-144) 
        { id:140, name:"Omega Prime",        type:"EFFECT",  attribute:"LIGHT", level:9, atk:3200, def:2600, rarity:"UR",
          desc:"Cannot be Normal Summoned/Set. Must be Special Summoned by banishing 3 LIGHT monsters from your Graveyard. This card is unaffected by your opponent's card effects. Once per turn: You can target 1 banished card; add it to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#141400" stroke="#ffff00" stroke-width="3"/><polygon points="35,5 20,55 50,55" fill="#aaaa00" opacity=".8"/><polygon points="5,22 20,55 35,5" fill="#ffff88" opacity=".4"/><polygon points="65,22 50,55 35,5" fill="#ffff88" opacity=".4"/><circle cx="27" cy="33" r="6" fill="#ffff00"/><circle cx="43" cy="33" r="6" fill="#ffff00"/><circle cx="27" cy="33" r="2.5" fill="#000"/><circle cx="43" cy="33" r="2.5" fill="#000"/><circle cx="35" cy="35" r="30" fill="none" stroke="#ffff99" stroke-width="1" opacity=".4"/></svg>` },
        { id:141, name:"Zero Hour Dragon",   type:"EFFECT",  attribute:"DARK",  level:8, atk:3000, def:2400, rarity:"UR",
          desc:"When this card is Special Summoned: You can look at your opponent's hand and choose 1 card to banish until your opponent's next End Phase. This card can attack twice per Battle Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#060010" stroke="#4400ff" stroke-width="2.5"/><polygon points="35,6 16,55 54,55" fill="#1a0066" opacity=".9"/><polygon points="6,24 16,55 35,6" fill="#3300aa" opacity=".5"/><polygon points="64,24 54,55 35,6" fill="#3300aa" opacity=".5"/><circle cx="27" cy="33" r="6" fill="#4400ff"/><circle cx="43" cy="33" r="6" fill="#4400ff"/><circle cx="27" cy="33" r="2.5" fill="#aaaaff"/><circle cx="43" cy="33" r="2.5" fill="#aaaaff"/><ellipse cx="35" cy="58" rx="16" ry="7" fill="#220066" opacity=".6"/></svg>` },
        { id:142, name:"Source Eternal",     type:"EFFECT",  attribute:"LIGHT", level:7, atk:2700, def:2300, rarity:"UR",
          desc:"Once per turn: You can pay 1000 LP; Special Summon 1 LIGHT monster from your Deck. If this card would be destroyed: You can pay 1000 LP instead.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#141400" stroke="#eeff00" stroke-width="2.5"/><circle cx="35" cy="35" r="18" fill="none" stroke="#ccdd00" stroke-width="2"/><circle cx="35" cy="35" r="10" fill="none" stroke="#aaff00" stroke-width="2"/><circle cx="35" cy="35" r="5" fill="#eeff00"/><line x1="35" y1="7" x2="35" y2="17" stroke="#eeff00" stroke-width="2"/><line x1="35" y1="53" x2="35" y2="63" stroke="#eeff00" stroke-width="2"/><line x1="7" y1="35" x2="17" y2="35" stroke="#eeff00" stroke-width="2"/><line x1="53" y1="35" x2="63" y2="35" stroke="#eeff00" stroke-width="2"/></svg>` },
        { id:143, name:"Dark Matter Drake",  type:"FUSION",  attribute:"DARK",  level:9, atk:3100, def:2600, rarity:"UR",
          desc:"1 DARK monster + 1 Dragon. Unaffected by monster effects. When this card destroys an opponent's monster by battle: You can banish it instead of sending it to the Graveyard, and inflict 1000 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#030008" stroke="#6600ee" stroke-width="3"/><ellipse cx="35" cy="40" rx="24" ry="18" fill="#110022" opacity=".9"/><polygon points="35,5 14,40 56,40" fill="#33006e" opacity=".85"/><circle cx="26" cy="30" r="6.5" fill="#8800ff"/><circle cx="44" cy="30" r="6.5" fill="#8800ff"/><circle cx="26" cy="30" r="2.5" fill="#fff"/><circle cx="44" cy="30" r="2.5" fill="#fff"/><ellipse cx="35" cy="56" rx="18" ry="9" fill="#440077" opacity=".6"/><path d="M14,25 Q5,10 20,8 Q35,5 35,18" fill="none" stroke="#6600ee" stroke-width="1.5" opacity=".7"/><path d="M56,25 Q65,10 50,8 Q35,5 35,18" fill="none" stroke="#6600ee" stroke-width="1.5" opacity=".7"/></svg>` },
        { id:144, name:"Omega Paradox",      type:"SPELL",   attribute:"SPELL", rarity:"UR",
          desc:"Banish all monsters on the field. Then, Special Summon 1 LIGHT or DARK monster from either player's Graveyard to your field. You can only activate this card once per Duel.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#08000e" stroke="#9933ff" stroke-width="2.5"/><circle cx="35" cy="35" r="19" fill="#110022" stroke="#7700ee" stroke-width="2"/><ellipse cx="35" cy="35" rx="19" ry="8" fill="none" stroke="#cc55ff" stroke-width="2" transform="rotate(30 35 35)"/><ellipse cx="35" cy="35" rx="19" ry="8" fill="none" stroke="#cc55ff" stroke-width="2" transform="rotate(-30 35 35)"/><circle cx="35" cy="35" r="5" fill="#cc66ff"/><circle cx="35" cy="16" r="3" fill="#9933ff"/><circle cx="35" cy="54" r="3" fill="#9933ff"/></svg>` },

        //  NEMESIS COLLECTION PACK EXCLUSIVES (145-154) 
        { id:145, name:"Nemesis Eclipse Dragon",  type:"MONSTER", attribute:"DARK", level:10, atk:3000, def:2500, rarity:"UR",
          desc:"Cannot be Normal Summoned. Must be Special Summoned by banishing 2 DARK monsters from your hand. Once per turn: destroy up to 2 cards your opponent controls and inflict 300 LP damage per card destroyed.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#000010" stroke="#440088" stroke-width="2.5"/><ellipse cx="35" cy="42" rx="22" ry="12" fill="#1a0033" stroke="#660099" stroke-width="1.5"/><polygon points="35,10 20,38 50,38" fill="#2a0044" stroke="#aa00dd" stroke-width="2"/><polygon points="12,30 25,38 15,52" fill="#330055" stroke="#8800cc" stroke-width="1.5"/><polygon points="58,30 45,38 55,52" fill="#330055" stroke="#8800cc" stroke-width="1.5"/><circle cx="35" cy="30" r="7" fill="#440066" stroke="#cc44ff" stroke-width="2"/><circle cx="35" cy="30" r="3" fill="#ee00ff"/><line x1="35" y1="10" x2="35" y2="20" stroke="#cc44ff" stroke-width="2"/></svg>` },
        { id:146, name:"Nemesis Void Reaper",     type:"MONSTER", attribute:"DARK", level:7, atk:2600, def:1900, rarity:"SR",
          desc:"When this card is Normal Summoned: you may send 1 card from your opponent's hand to the GY (chosen at random). Once per turn: this card gains 300 ATK until the end of the turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#050010" stroke="#660044" stroke-width="2.5"/><rect x="30" y="12" width="10" height="34" rx="5" fill="#330033" stroke="#990066" stroke-width="1.5"/><polygon points="35,8 28,26 42,26" fill="#550044" stroke="#cc0066" stroke-width="2"/><ellipse cx="35" cy="50" rx="18" ry="6" fill="#1a0022" stroke="#880055" stroke-width="1.5"/><circle cx="27" cy="32" r="4" fill="#440033" stroke="#ff2288" stroke-width="1.5"/><circle cx="43" cy="32" r="4" fill="#440033" stroke="#ff2288" stroke-width="1.5"/><line x1="20" y1="54" x2="50" y2="54" stroke="#660044" stroke-width="1.5" stroke-dasharray="4,3"/></svg>` },
        { id:147, name:"Phantom Dominion",        type:"MONSTER", attribute:"DARK", level:8, atk:2500, def:2000, rarity:"SR",
          desc:"Once per turn: reduce the ATK of all opponent's monsters by 500 until the end of the turn. If this card destroys a monster by battle: draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#060010" stroke="#4400aa" stroke-width="2.5"/><ellipse cx="35" cy="48" rx="20" ry="10" fill="#0d0022"/><rect x="25" y="20" width="20" height="26" rx="10" fill="#1a0040" stroke="#7744dd" stroke-width="2"/><circle cx="29" cy="32" r="3.5" fill="#8855ff"/><circle cx="41" cy="32" r="3.5" fill="#8855ff"/><path d="M28,42 Q35,46 42,42" stroke="#9966ff" stroke-width="2" fill="none"/><path d="M20,18 Q35,10 50,18" stroke="#6633cc" stroke-width="1.5" fill="none" stroke-dasharray="3,3"/></svg>` },
        { id:148, name:"Shadow Leech",            type:"MONSTER", attribute:"DARK", level:5, atk:1900, def:1400, rarity:"R",
          desc:"At the start of each opponent's Standby Phase: the opponent loses 300 LP. While this card is in your Graveyard, your opponent cannot gain LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#040008" stroke="#330055" stroke-width="2.5"/><ellipse cx="35" cy="38" rx="18" ry="14" fill="#0f0020" stroke="#551188" stroke-width="1.5"/><circle cx="27" cy="33" r="5" fill="#220033" stroke="#9922cc" stroke-width="1.5"/><circle cx="43" cy="33" r="5" fill="#220033" stroke="#9922cc" stroke-width="1.5"/><path d="M28,42 Q35,48 42,42" stroke="#6600aa" stroke-width="2" fill="none"/><line x1="35" y1="22" x2="30" y2="12" stroke="#440066" stroke-width="1.5"/><line x1="35" y1="22" x2="40" y2="12" stroke="#440066" stroke-width="1.5"/></svg>` },
        { id:149, name:"Eclipse Strike",          type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"Destroy all monsters on your opponent's side of the field. For each monster destroyed by this effect, inflict 400 LP damage to your opponent. You can only activate this card once per turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#050010" stroke="#7700bb" stroke-width="2.5"/><circle cx="35" cy="35" r="18" fill="#0d0022" stroke="#5500aa" stroke-width="1.5"/><circle cx="35" cy="35" r="10" fill="#1a0033" stroke="#cc55ff" stroke-width="2"/><line x1="35" y1="10" x2="35" y2="22" stroke="#9922dd" stroke-width="2"/><line x1="35" y1="48" x2="35" y2="60" stroke="#9922dd" stroke-width="2"/><line x1="10" y1="35" x2="22" y2="35" stroke="#9922dd" stroke-width="2"/><line x1="48" y1="35" x2="60" y2="35" stroke="#9922dd" stroke-width="2"/><line x1="18" y1="18" x2="27" y2="27" stroke="#7700bb" stroke-width="1.5"/><line x1="43" y1="43" x2="52" y2="52" stroke="#7700bb" stroke-width="1.5"/><line x1="52" y1="18" x2="43" y2="27" stroke="#7700bb" stroke-width="1.5"/><line x1="18" y1="52" x2="27" y2="43" stroke="#7700bb" stroke-width="1.5"/><circle cx="35" cy="35" r="4" fill="#dd44ff"/></svg>` },
        { id:150, name:"Nemesis Lockdown",        type:"TRAP",    attribute:"TRAP",  rarity:"SR",
          desc:"When your opponent activates a card effect: negate that activation and banish the card. Your opponent cannot activate cards with the same name for the rest of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#080004" stroke="#660033" stroke-width="2.5"/><rect x="22" y="28" width="26" height="22" rx="4" fill="#1a0010" stroke="#990044" stroke-width="2"/><path d="M27,28 L27,22 Q27,14 35,14 Q43,14 43,22 L43,28" fill="none" stroke="#cc0055" stroke-width="2.5"/><circle cx="35" cy="39" r="5" fill="#330022" stroke="#ff3377" stroke-width="2"/><line x1="35" y1="42" x2="35" y2="46" stroke="#ff3377" stroke-width="2"/></svg>` },
        { id:151, name:"Abyssal Sovereign",       type:"MONSTER", attribute:"DARK", level:10, atk:2900, def:2200, rarity:"UR",
          desc:"Cannot be targeted by your opponent's card effects. Once per turn: send 1 DARK monster from your Deck to the GY, then add 1 DARK monster with a different name from your GY to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#030008" stroke="#880055" stroke-width="2.5"/><ellipse cx="35" cy="44" rx="24" ry="14" fill="#0a0018"/><polygon points="35,12 18,44 52,44" fill="#1a0030" stroke="#bb44ee" stroke-width="2.5"/><circle cx="35" cy="28" r="8" fill="#220033" stroke="#ff44cc" stroke-width="2"/><circle cx="35" cy="28" r="4" fill="#ee00aa"/><polygon points="35,6 32,15 38,15" fill="#660077" stroke="#cc44ff" stroke-width="1.5"/><polygon points="20,44 14,58 28,50" fill="#440055" stroke="#9933dd" stroke-width="1.5"/><polygon points="50,44 56,58 42,50" fill="#440055" stroke="#9933dd" stroke-width="1.5"/><line x1="24" y1="34" x2="15" y2="28" stroke="#880055" stroke-width="1.5"/><line x1="46" y1="34" x2="55" y2="28" stroke="#880055" stroke-width="1.5"/></svg>` },
        { id:152, name:"Dark Convergence",        type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"Special Summon up to 2 DARK monsters from your hand in Defense Position. Monsters Special Summoned by this effect cannot attack this turn, but they are unaffected by your opponent's Trap cards.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#060010" stroke="#550088" stroke-width="2.5"/><circle cx="35" cy="35" r="20" fill="none" stroke="#330066" stroke-width="1" stroke-dasharray="6,4"/><circle cx="22" cy="35" r="9" fill="#1a0030" stroke="#8833bb" stroke-width="2"/><circle cx="48" cy="35" r="9" fill="#1a0030" stroke="#8833bb" stroke-width="2"/><path d="M31,35 L39,35" stroke="#cc55ff" stroke-width="3"/><polygon points="39,31 47,35 39,39" fill="#cc55ff"/></svg>` },
        { id:153, name:"Nemesis War Colossus",    type:"MONSTER", attribute:"DARK", level:11, atk:3100, def:2400, rarity:"UR",
          desc:"Requires 3 DARK monsters as Tribute. This card cannot be destroyed by card effects. Once per turn: this card gains 500 ATK and your opponent cannot activate cards or effects in response to this card's attack declaration.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#040008" stroke="#770033" stroke-width="2.5"/><rect x="23" y="20" width="24" height="38" rx="6" fill="#0f0020" stroke="#990055" stroke-width="2"/><rect x="16" y="28" width="10" height="24" rx="4" fill="#1a0030" stroke="#770044" stroke-width="1.5"/><rect x="44" y="28" width="10" height="24" rx="4" fill="#1a0030" stroke="#770044" stroke-width="1.5"/><rect x="20" y="52" width="12" height="12" rx="3" fill="#0d001a" stroke="#880055" stroke-width="1.5"/><rect x="38" y="52" width="12" height="12" rx="3" fill="#0d001a" stroke="#880055" stroke-width="1.5"/><ellipse cx="35" cy="28" rx="10" ry="12" fill="#1a0030" stroke="#cc44aa" stroke-width="2"/><circle cx="30" cy="25" r="3.5" fill="#ff44bb"/><circle cx="40" cy="25" r="3.5" fill="#ff44bb"/><polygon points="35,10 31,18 39,18" fill="#880055" stroke="#cc44aa" stroke-width="1.5"/></svg>` },
        { id:154, name:"Void Sentinel",           type:"MONSTER", attribute:"DARK", level:6, atk:1800, def:2300, rarity:"R",
          desc:"Other DARK monsters you control cannot be targeted by your opponent's card effects. When this card is destroyed and sent to the GY: add 1 DARK Spell/Trap from your Deck to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#050010" stroke="#443366" stroke-width="2.5"/><rect x="25" y="18" width="20" height="36" rx="4" fill="#110022" stroke="#665588" stroke-width="1.5"/><rect x="20" y="24" width="8" height="22" rx="3" fill="#0d001a" stroke="#554477" stroke-width="1.5"/><rect x="42" y="24" width="8" height="22" rx="3" fill="#0d001a" stroke="#554477" stroke-width="1.5"/><circle cx="35" cy="30" r="7" fill="#1a0030" stroke="#9977cc" stroke-width="2"/><line x1="29" y1="30" x2="41" y2="30" stroke="#9977cc" stroke-width="1.5"/><line x1="35" y1="24" x2="35" y2="36" stroke="#9977cc" stroke-width="1.5"/></svg>` },

        //  OMEGA SOURCE PACK EXCLUSIVES (155-164) 
        { id:155, name:"Omega Genesis Leviathan", type:"MONSTER", attribute:"LIGHT", level:12, atk:3500, def:2800, rarity:"UR",
          desc:"Cannot be Normal Summoned or Set. Must be Special Summoned from your hand by revealing all 5 cards in your hand to your opponent, then discarding 2 of them. This card is unaffected by your opponent's activated effects. Once per turn: destroy all monsters your opponent controls and inflict 500 LP damage for each one.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0a0800" stroke="#eecc00" stroke-width="2.5"/><ellipse cx="35" cy="40" rx="26" ry="16" fill="#1a1400" stroke="#cc9900" stroke-width="2"/><polygon points="35,8 12,40 58,40" fill="#221800" stroke="#ffdd44" stroke-width="2.5"/><polygon points="35,8 25,32 45,32" fill="#332200" stroke="#ffee88" stroke-width="2"/><circle cx="35" cy="26" r="8" fill="#2a1c00" stroke="#ffdd00" stroke-width="2.5"/><circle cx="35" cy="26" r="4" fill="#ffee44"/><line x1="8" y1="28" x2="22" y2="34" stroke="#dd9900" stroke-width="2"/><line x1="62" y1="28" x2="48" y2="34" stroke="#dd9900" stroke-width="2"/><polygon points="8,18 14,30 4,32" fill="#664400" stroke="#cc8800" stroke-width="1.5"/><polygon points="62,18 56,30 66,32" fill="#664400" stroke="#cc8800" stroke-width="1.5"/></svg>` },
        { id:156, name:"Omega Seraph Eternal",    type:"MONSTER", attribute:"LIGHT", level:11, atk:3200, def:2600, rarity:"UR",
          desc:"When this card is Special Summoned: your LP becomes 8000. Once per turn: negate the activation of 1 card or effect and shuffle it into the Deck. Your LIGHT monsters cannot be destroyed by card effects while this card is face-up on the field.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#080806" stroke="#ffffff" stroke-width="2.5"/><circle cx="35" cy="32" r="14" fill="#1a1800" stroke="#eeeebb" stroke-width="2"/><ellipse cx="35" cy="32" rx="14" ry="6" fill="#2a2600" stroke="#ffffaa" stroke-width="1.5" transform="rotate(20 35 32)"/><ellipse cx="35" cy="32" rx="14" ry="6" fill="#2a2600" stroke="#ffffaa" stroke-width="1.5" transform="rotate(-20 35 32)"/><circle cx="35" cy="32" r="6" fill="#333000" stroke="#ffff88" stroke-width="2"/><circle cx="35" cy="32" r="3" fill="#ffff44"/><polygon points="35,9 32,18 38,18" fill="#888800" stroke="#ffff44" stroke-width="1.5"/><path d="M15,48 Q35,60 55,48" fill="none" stroke="#cccc66" stroke-width="2"/></svg>` },
        { id:157, name:"Omega Annihilator",       type:"SPELL",   attribute:"SPELL", rarity:"UR",
          desc:"Destroy all cards on the field except this card. Then, draw 3 cards and your opponent draws 1 card. Inflict 1000 LP damage to your opponent. You cannot Special Summon monsters the turn you activate this card, except LIGHT monsters.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0e0a00" stroke="#ffdd00" stroke-width="2.5"/><circle cx="35" cy="35" r="22" fill="#1a1600" stroke="#cc9900" stroke-width="2"/><circle cx="35" cy="35" r="14" fill="#221c00" stroke="#ffcc22" stroke-width="2"/><circle cx="35" cy="35" r="6" fill="#332800" stroke="#ffee44" stroke-width="2"/><circle cx="35" cy="35" r="2.5" fill="#fff700"/><line x1="35" y1="8" x2="35" y2="17" stroke="#ffcc00" stroke-width="2.5"/><line x1="35" y1="53" x2="35" y2="62" stroke="#ffcc00" stroke-width="2.5"/><line x1="8" y1="35" x2="17" y2="35" stroke="#ffcc00" stroke-width="2.5"/><line x1="53" y1="35" x2="62" y2="35" stroke="#ffcc00" stroke-width="2.5"/><line x1="18" y1="18" x2="25" y2="25" stroke="#dd8800" stroke-width="2"/><line x1="52" y1="52" x2="45" y2="45" stroke="#dd8800" stroke-width="2"/><line x1="52" y1="18" x2="45" y2="25" stroke="#dd8800" stroke-width="2"/><line x1="18" y1="52" x2="25" y2="45" stroke="#dd8800" stroke-width="2"/></svg>` },
        { id:158, name:"Source Protocol Zero",    type:"TRAP",    attribute:"TRAP",  rarity:"UR",
          desc:"You can activate this card from your hand. When your opponent would take an action (Summon, activate a card, attack): negate it. You can only use this effect once per turn. The negated card is returned to the owner's hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0a0600" stroke="#ffbb00" stroke-width="2.5"/><polygon points="35,12 12,54 58,54" fill="#1c1200" stroke="#ee9900" stroke-width="2.5"/><polygon points="35,22 18,52 52,52" fill="#2a1c00" stroke="#ffcc44" stroke-width="2"/><polygon points="35,30 24,50 46,50" fill="#331f00" stroke="#ffdd66" stroke-width="1.5"/><circle cx="35" cy="42" r="5" fill="#442800" stroke="#ffee88" stroke-width="2"/><rect x="33" y="32" width="4" height="8" rx="2" fill="#ffdd66"/></svg>` },
        { id:159, name:"Omega Prime Colossus",    type:"MONSTER", attribute:"LIGHT", level:12, atk:3400, def:2900, rarity:"UR",
          desc:"Requires 3 Tributes. This card cannot be destroyed by battle or card effects. Once per turn: banish 1 card from your opponent's hand, field, or GY. When this card inflicts Battle Damage to your opponent: draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0a0900" stroke="#ddcc00" stroke-width="2.5"/><rect x="22" y="14" width="26" height="44" rx="8" fill="#1a1500" stroke="#bbaa00" stroke-width="2"/><rect x="14" y="22" width="12" height="30" rx="5" fill="#151000" stroke="#998800" stroke-width="1.5"/><rect x="44" y="22" width="12" height="30" rx="5" fill="#151000" stroke="#998800" stroke-width="1.5"/><ellipse cx="35" cy="26" rx="10" ry="12" fill="#1e1700" stroke="#ffee44" stroke-width="2.5"/><circle cx="29" cy="23" r="4" fill="#ffee00"/><circle cx="41" cy="23" r="4" fill="#ffee00"/><rect x="24" y="56" width="12" height="10" rx="3" fill="#111000" stroke="#aa9900" stroke-width="1.5"/><rect x="34" y="56" width="12" height="10" rx="3" fill="#111000" stroke="#aa9900" stroke-width="1.5"/><rect x="28" y="8" width="14" height="8" rx="3" fill="#332800" stroke="#ffcc22" stroke-width="1.5"/></svg>` },
        { id:160, name:"Ascendant Throne",        type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"All LIGHT monsters you control gain 800 ATK and DEF until the end of the turn. If you control 3 or more LIGHT monsters: they cannot be destroyed by card effects until the end of your opponent's next turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0a0900" stroke="#ffdd99" stroke-width="2.5"/><polygon points="35,10 20,50 50,50" fill="#1a1500" stroke="#ddbb55" stroke-width="2"/><rect x="22" y="50" width="26" height="14" rx="3" fill="#151000" stroke="#cc9933" stroke-width="1.5"/><rect x="20" y="42" width="30" height="8" rx="2" fill="#1e1800" stroke="#ddaa44" stroke-width="1.5"/><circle cx="35" cy="28" r="7" fill="#2a1f00" stroke="#ffee66" stroke-width="2"/><circle cx="35" cy="28" r="3.5" fill="#ffee44"/></svg>` },
        { id:161, name:"Omega Sovereign Veil",    type:"TRAP",    attribute:"TRAP",  rarity:"SR",
          desc:"Activate when your opponent declares an attack: negate the attack, then all monsters you control are unaffected by your opponent's card effects until the end of this turn. You can only activate 1 'Omega Sovereign Veil' per turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#090700" stroke="#ccaa44" stroke-width="2.5"/><ellipse cx="35" cy="38" rx="24" ry="18" fill="#141000" stroke="#aa8833" stroke-width="2"/><ellipse cx="35" cy="34" rx="18" ry="14" fill="#1a1500" stroke="#ddcc55" stroke-width="1.5"/><ellipse cx="35" cy="30" rx="12" ry="10" fill="#1f1800" stroke="#eedd66" stroke-width="1.5"/><ellipse cx="35" cy="28" rx="6" ry="5" fill="#252000" stroke="#ffee77" stroke-width="1.5"/><circle cx="35" cy="27" r="2.5" fill="#ffee44"/></svg>` },
        { id:162, name:"Genesis Revenant",        type:"MONSTER", attribute:"LIGHT", level:9, atk:2900, def:2300, rarity:"SR",
          desc:"When this card is Special Summoned from the GY: Special Summon 1 LIGHT monster from your GY with ATK lower than this card's ATK. Once per turn: this card cannot be destroyed by battle this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#080800" stroke="#ccddff" stroke-width="2.5"/><ellipse cx="35" cy="44" rx="22" ry="12" fill="#101020"/><ellipse cx="35" cy="40" rx="16" ry="8" fill="#181830" stroke="#8899ee" stroke-width="1.5"/><rect x="25" y="18" width="20" height="28" rx="10" fill="#1a1a30" stroke="#aabbff" stroke-width="2"/><circle cx="28" cy="30" r="4" fill="#3344cc"/><circle cx="42" cy="30" r="4" fill="#3344cc"/><path d="M28,40 Q35,46 42,40" stroke="#88aaff" stroke-width="2" fill="none"/><line x1="35" y1="10" x2="35" y2="18" stroke="#aabbff" stroke-width="2" stroke-dasharray="3,3"/></svg>` },
        { id:163, name:"Omega Eternal Titan",     type:"MONSTER", attribute:"LIGHT", level:12, atk:3300, def:2700, rarity:"UR",
          desc:"This card gains 400 ATK for each monster on the field. Cannot be targeted by Spell or Trap effects. Once per turn: this card can attack all monsters your opponent controls in one Battle Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0c0a00" stroke="#ffffbb" stroke-width="2.5"/><rect x="24" y="16" width="22" height="40" rx="7" fill="#181400" stroke="#dddd88" stroke-width="2"/><rect x="13" y="24" width="14" height="28" rx="5" fill="#141000" stroke="#bbbb66" stroke-width="1.5"/><rect x="43" y="24" width="14" height="28" rx="5" fill="#141000" stroke="#bbbb66" stroke-width="1.5"/><ellipse cx="35" cy="28" rx="9" ry="11" fill="#1e1900" stroke="#ffffcc" stroke-width="2.5"/><circle cx="30" cy="25" r="4" fill="#ffffaa"/><circle cx="40" cy="25" r="4" fill="#ffffaa"/><rect x="26" y="54" width="10" height="10" rx="3" fill="#100d00" stroke="#ccbb55" stroke-width="1.5"/><rect x="34" y="54" width="10" height="10" rx="3" fill="#100d00" stroke="#ccbb55" stroke-width="1.5"/><polygon points="35,6 30,14 40,14" fill="#886600" stroke="#ffee44" stroke-width="1.5"/></svg>` },
        { id:164, name:"Sovereign Light Blade",   type:"MONSTER", attribute:"LIGHT", level:8, atk:2800, def:2200, rarity:"SR",
          desc:"Once per turn: this card can attack twice during the same Battle Phase. If this card destroys an opponent's monster by battle: inflict 500 LP damage to your opponent. LIGHT monsters you control are unaffected by Trap effects during the Battle Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="4" y="4" width="62" height="62" rx="10" fill="#0a0900" stroke="#ffffff" stroke-width="2.5"/><polygon points="35,10 32,38 38,38" fill="#1a1800" stroke="#eeeedd" stroke-width="2.5"/><rect x="26" y="38" width="18" height="8" rx="2" fill="#151200" stroke="#ccccaa" stroke-width="1.5"/><rect x="16" y="42" width="38" height="5" rx="2" fill="#181500" stroke="#aaaabb" stroke-width="1.5"/><rect x="32" y="46" width="6" height="14" rx="2" fill="#111000" stroke="#aaaaaa" stroke-width="1.5"/><line x1="35" y1="10" x2="35" y2="38" stroke="#ffffff" stroke-width="1.5" opacity="0.6"/></svg>` },

        //  MAGMA & METAL PACK EXCLUSIVES (165173) 
        { id:165, name:"Ironfang Drake",     type:"EFFECT",  attribute:"FIRE",  level:5, atk:2150, def:1200, rarity:"R",
          desc:"When this card is Normal Summoned: All FIRE monsters you control gain 400 ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#1c0400" stroke="#ff6600" stroke-width="2"/><polygon points="35,8 20,45 50,45" fill="#aa2200" opacity=".85"/><polygon points="35,8 12,28 20,45" fill="#ff4400" opacity=".4"/><polygon points="35,8 58,28 50,45" fill="#ff4400" opacity=".4"/><circle cx="27" cy="34" r="4.5" fill="#ffaa00"/><circle cx="43" cy="34" r="4.5" fill="#ffaa00"/><circle cx="27" cy="34" r="2" fill="#1c0400"/><circle cx="43" cy="34" r="2" fill="#1c0400"/><path d="M22,52 Q35,62 48,52" fill="#882200" stroke="#ff6600" stroke-width="2"/><polygon points="14,22 8,10 20,18" fill="#cc4400" opacity=".7"/><polygon points="56,22 62,10 50,18" fill="#cc4400" opacity=".7"/></svg>` },
        { id:166, name:"Scorchshard Golem",  type:"EFFECT",  attribute:"EARTH", level:4, atk:1700, def:1400, rarity:"R",
          desc:"Once per turn: You can target 1 monster your opponent controls; it loses 400 ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="10" y="10" width="50" height="50" rx="5" fill="#1a1200" stroke="#cc8822" stroke-width="2"/><rect x="20" y="18" width="30" height="32" rx="4" fill="#2a1a00" stroke="#aa6633" stroke-width="1.5"/><circle cx="28" cy="30" r="5" fill="#cc8833"/><circle cx="42" cy="30" r="5" fill="#cc8833"/><circle cx="28" cy="30" r="2.5" fill="#1a0e00"/><circle cx="42" cy="30" r="2.5" fill="#1a0e00"/><rect x="27" y="40" width="16" height="5" rx="2" fill="#aa6600"/><rect x="16" y="48" width="10" height="14" rx="3" fill="#1a1200" stroke="#aa6633" stroke-width="1.5"/><rect x="44" y="48" width="10" height="14" rx="3" fill="#1a1200" stroke="#aa6633" stroke-width="1.5"/><line x1="10" y1="35" x2="6" y2="28" stroke="#ff8800" stroke-width="2.5"/><line x1="60" y1="35" x2="64" y2="28" stroke="#ff8800" stroke-width="2.5"/></svg>` },
        { id:167, name:"Volcan Djinn",       type:"EFFECT",  attribute:"FIRE",  level:3, atk:1300, def:800,  rarity:"C",
          desc:"When this card is Normal Summoned: Inflict 400 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="27" fill="#1c0800" stroke="#ff8800" stroke-width="1.5"/><ellipse cx="35" cy="28" rx="10" ry="14" fill="#cc4400" opacity=".8"/><circle cx="35" cy="18" r="8" fill="#220800"/><circle cx="30" cy="16" r="3.5" fill="#ff8800"/><circle cx="40" cy="16" r="3.5" fill="#ff8800"/><path d="M26,42 Q35,52 44,42" fill="#882200" stroke="#ff6600" stroke-width="2"/><path d="M25,35 Q15,20 18,10" fill="none" stroke="#ff8800" stroke-width="2" opacity=".7"/><path d="M45,35 Q55,20 52,10" fill="none" stroke="#ff8800" stroke-width="2" opacity=".7"/><ellipse cx="35" cy="52" rx="14" ry="6" fill="#661100" opacity=".5"/></svg>` },
        { id:168, name:"Slag Sentinel",      type:"NORMAL",  attribute:"EARTH", level:4, atk:1900, def:1100, rarity:"C",
          desc:"A hulking guardian cast from cooled magma and reinforced iron. Immovable and utterly relentless.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="12" width="54" height="46" rx="6" fill="#1a1200" stroke="#886633" stroke-width="2"/><rect x="18" y="18" width="34" height="30" rx="4" fill="#251a00" stroke="#aa7744" stroke-width="1.5"/><rect x="10" y="24" width="10" height="24" rx="3" fill="#1a1200" stroke="#775533" stroke-width="1.5"/><rect x="50" y="24" width="10" height="24" rx="3" fill="#1a1200" stroke="#775533" stroke-width="1.5"/><circle cx="28" cy="30" r="5" fill="#cc8833"/><circle cx="42" cy="30" r="5" fill="#cc8833"/><rect x="26" y="38" width="18" height="6" rx="3" fill="#886622"/><rect x="22" y="50" width="12" height="10" rx="3" fill="#151000" stroke="#774422" stroke-width="1.5"/><rect x="36" y="50" width="12" height="10" rx="3" fill="#151000" stroke="#774422" stroke-width="1.5"/></svg>` },
        { id:169, name:"Pyroclast Wyvern",   type:"EFFECT",  attribute:"FIRE",  level:6, atk:2300, def:1800, rarity:"SR",
          desc:"When this card destroys an opponent's monster by battle: Inflict 500 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="26" ry="20" fill="#1c0500" stroke="#ff5500" stroke-width="2"/><polygon points="35,6 17,38 53,38" fill="#cc2200" opacity=".9"/><polygon points="35,6 8,25 17,38" fill="#ff5500" opacity=".5"/><polygon points="35,6 62,25 53,38" fill="#ff5500" opacity=".5"/><circle cx="27" cy="30" r="5" fill="#ffaa00"/><circle cx="43" cy="30" r="5" fill="#ffaa00"/><circle cx="27" cy="30" r="2" fill="#1c0400"/><circle cx="43" cy="30" r="2" fill="#1c0400"/><path d="M18,50 Q35,62 52,50" fill="#881100" stroke="#ff6600" stroke-width="2"/><path d="M10,20 Q4,8 12,6" fill="none" stroke="#ff8800" stroke-width="2.5" opacity=".8"/><path d="M60,20 Q66,8 58,6" fill="none" stroke="#ff8800" stroke-width="2.5" opacity=".8"/></svg>` },
        { id:170, name:"Cinder Hound",       type:"EFFECT",  attribute:"FIRE",  level:2, atk:1000, def:700,  rarity:"C",
          desc:"This card can attack your opponent directly. If this card attacks directly, halve the battle damage.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="38" r="24" fill="#1c0800" stroke="#ff8833" stroke-width="1.5"/><ellipse cx="20" cy="40" rx="7" ry="11" fill="#1a0800" stroke="#ff6600" stroke-width="1"/><ellipse cx="50" cy="40" rx="7" ry="11" fill="#1a0800" stroke="#ff6600" stroke-width="1"/><ellipse cx="14" cy="42" rx="5" ry="8" fill="#1a0800" stroke="#ff6600" stroke-width="1"/><ellipse cx="56" cy="42" rx="5" ry="8" fill="#1a0800" stroke="#ff6600" stroke-width="1"/><ellipse cx="35" cy="30" rx="14" ry="12" fill="#251000" stroke="#ff7733" stroke-width="1.5"/><circle cx="29" cy="26" r="4" fill="#440800" stroke="#ff9944" stroke-width="1.5"/><circle cx="41" cy="26" r="4" fill="#440800" stroke="#ff9944" stroke-width="1.5"/><circle cx="29" cy="26" r="2" fill="#ffaa00"/><circle cx="41" cy="26" r="2" fill="#ffaa00"/><polygon points="20,22 16,10 24,18" fill="#ff4400" opacity=".7"/><polygon points="50,22 54,10 46,18" fill="#ff4400" opacity=".7"/><path d="M58,38 Q65,32 67,24" fill="none" stroke="#ff8800" stroke-width="2" opacity=".8"/></svg>` },
        { id:171, name:"Metal Shredder",     type:"EFFECT",  attribute:"EARTH", level:4, atk:1800, def:1000, rarity:"R",
          desc:"When this card destroys an opponent's monster by battle: You can draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="10" y="10" width="50" height="50" rx="6" fill="#0e0e0e" stroke="#999999" stroke-width="2"/><polygon points="35,15 22,48 48,48" fill="#4a4a4a" opacity=".9" stroke="#888" stroke-width="1.5"/><circle cx="35" cy="28" r="7" fill="#1a1a1a" stroke="#bbbbbb" stroke-width="2"/><circle cx="35" cy="28" r="3.5" fill="#999"/><rect x="8" y="30" width="14" height="8" rx="3" fill="#0e0e0e" stroke="#888" stroke-width="1.5"/><rect x="48" y="30" width="14" height="8" rx="3" fill="#0e0e0e" stroke="#888" stroke-width="1.5"/><line x1="8" y1="34" x2="4" y2="20" stroke="#bbbbbb" stroke-width="3"/><line x1="62" y1="34" x2="66" y2="20" stroke="#bbbbbb" stroke-width="3"/><polygon points="4,14 0,22 8,22" fill="#777"/><polygon points="66,14 62,22 70,22" fill="#777"/></svg>` },
        { id:172, name:"Magma Surge",        type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Destroy all monsters your opponent controls that are in Defense Position.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#1a0500" stroke="#ff6600" stroke-width="2"/><path d="M12,55 Q20,30 28,42 Q34,52 40,28 Q46,10 54,42 Q58,55 62,50" fill="none" stroke="#ff5500" stroke-width="3"/><ellipse cx="20" cy="52" rx="8" ry="4" fill="#ff4400" opacity=".5"/><ellipse cx="40" cy="50" rx="10" ry="5" fill="#ff6600" opacity=".4"/><ellipse cx="58" cy="54" rx="6" ry="3" fill="#ff4400" opacity=".5"/><circle cx="28" cy="42" r="4" fill="#ffaa00" opacity=".7"/><circle cx="46" cy="36" r="3" fill="#ffcc00" opacity=".7"/></svg>` },
        { id:173, name:"Scorched Earth",     type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"When your opponent Normal Summons a monster: Inflict damage to your opponent equal to that monster's Level x 100.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#1a0800" stroke="#ff4400" stroke-width="2"/><line x1="12" y1="48" x2="58" y2="48" stroke="#663300" stroke-width="2"/><path d="M12,48 Q18,28 24,38 Q30,48 36,24 Q40,10 46,30 Q50,44 58,32" fill="none" stroke="#ff8800" stroke-width="2.5"/><circle cx="36" cy="24" r="6" fill="#ff4400" opacity=".8"/><circle cx="24" cy="38" r="4" fill="#ff6600" opacity=".6"/><line x1="30" y1="55" x2="30" y2="62" stroke="#ff4400" stroke-width="2"/><line x1="40" y1="55" x2="40" y2="62" stroke="#ff4400" stroke-width="2"/></svg>` },

        //  CYBER CHAOS PACK EXCLUSIVES (174186) 
        { id:174, name:"Glitch Specter",     type:"EFFECT",  attribute:"DARK",  level:4, atk:1600, def:900,  rarity:"R",
          desc:"When this card is destroyed by battle and sent to the Graveyard: Inflict 500 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#0a0018" stroke="#9922ff" stroke-width="2"/><ellipse cx="35" cy="32" rx="14" ry="18" fill="#180030" opacity=".9"/><circle cx="28" cy="26" r="4.5" fill="#aa00ff"/><circle cx="42" cy="26" r="4.5" fill="#aa00ff"/><circle cx="28" cy="26" r="2" fill="#040010"/><circle cx="42" cy="26" r="2" fill="#040010"/><rect x="22" y="38" width="26" height="3" rx="1" fill="#7700cc" opacity=".7"/><rect x="25" y="43" width="20" height="3" rx="1" fill="#7700cc" opacity=".5"/><rect x="18" y="26" width="6" height="2" fill="#ff44ff" opacity=".8"/><rect x="46" y="26" width="6" height="2" fill="#ff44ff" opacity=".8"/><rect x="10" y="32" width="10" height="2" fill="#cc00ff" opacity=".6"/><rect x="50" y="32" width="10" height="2" fill="#cc00ff" opacity=".6"/></svg>` },
        { id:175, name:"Voidshard Crawler",  type:"EFFECT",  attribute:"DARK",  level:3, atk:1200, def:1000, rarity:"C",
          desc:"Once per turn: You can discard 1 card; add 1 Trap Card from your Graveyard to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="44" rx="22" ry="16" fill="#060010" stroke="#660099" stroke-width="1.5"/><ellipse cx="35" cy="32" rx="14" ry="10" fill="#100022" stroke="#8800cc" stroke-width="1.5"/><circle cx="28" cy="29" r="4" fill="#220044"/><circle cx="42" cy="29" r="4" fill="#220044"/><circle cx="28" cy="29" r="2" fill="#bb00ff"/><circle cx="42" cy="29" r="2" fill="#bb00ff"/><line x1="18" y1="40" x2="8" y2="36" stroke="#660099" stroke-width="1.5"/><line x1="20" y1="46" x2="8" y2="48" stroke="#660099" stroke-width="1.5"/><line x1="52" y1="40" x2="62" y2="36" stroke="#660099" stroke-width="1.5"/><line x1="50" y1="46" x2="62" y2="48" stroke="#660099" stroke-width="1.5"/><line x1="22" y1="53" x2="16" y2="62" stroke="#660099" stroke-width="1.5"/><line x1="48" y1="53" x2="54" y2="62" stroke="#660099" stroke-width="1.5"/></svg>` },
        { id:176, name:"Static Phantom",     type:"EFFECT",  attribute:"WIND",  level:4, atk:1700, def:1200, rarity:"R",
          desc:"This card can attack your opponent directly. If this card attacks directly: your opponent discards 1 card at random.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#0e0028" stroke="#88aaff" stroke-width="2"/><ellipse cx="35" cy="30" rx="12" ry="16" fill="#1a1a40" opacity=".9"/><circle cx="35" cy="17" r="8" fill="#0e0e28"/><circle cx="30" cy="15" r="3.5" fill="#aabbff"/><circle cx="40" cy="15" r="3.5" fill="#aabbff"/><path d="M24,44 Q35,56 46,44" fill="#1a2255" stroke="#8899ff" stroke-width="2"/><path d="M14,30 Q6,18 14,12" fill="none" stroke="#aabbff" stroke-width="2" opacity=".8"/><path d="M56,30 Q64,18 56,12" fill="none" stroke="#aabbff" stroke-width="2" opacity=".8"/><line x1="12" y1="38" x2="4" y2="34" stroke="#aaaaff" stroke-width="1.5" opacity=".7"/><line x1="58" y1="38" x2="66" y2="34" stroke="#aaaaff" stroke-width="1.5" opacity=".7"/></svg>` },
        { id:177, name:"Null Cipher",        type:"EFFECT",  attribute:"DARK",  level:2, atk:900,  def:800,  rarity:"C",
          desc:"Once per turn: You can draw 1 card, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#080018" stroke="#7755ff" stroke-width="1.5"/><circle cx="35" cy="35" r="18" fill="#100028" stroke="#5533cc" stroke-width="1.5"/><circle cx="35" cy="35" r="10" fill="#1a0038" stroke="#9977ff" stroke-width="1.5"/><circle cx="35" cy="35" r="4" fill="#6644ff"/><line x1="35" y1="12" x2="35" y2="20" stroke="#8866ff" stroke-width="2"/><line x1="35" y1="50" x2="35" y2="58" stroke="#8866ff" stroke-width="2"/><line x1="12" y1="35" x2="20" y2="35" stroke="#8866ff" stroke-width="2"/><line x1="50" y1="35" x2="58" y2="35" stroke="#8866ff" stroke-width="2"/><text x="35" y="39" text-anchor="middle" font-size="10" fill="#cc99ff" font-family="monospace">0101</text></svg>` },
        { id:178, name:"Chaos Revenant",     type:"EFFECT",  attribute:"DARK",  level:5, atk:2100, def:1500, rarity:"SR",
          desc:"Once per turn: You can target 1 face-up monster your opponent controls; negate its effects until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#06000e" stroke="#aa44dd" stroke-width="2.5"/><polygon points="35,8 18,50 52,50" fill="#2a004a" opacity=".9"/><polygon points="35,8 10,28 18,50" fill="#550088" opacity=".4"/><polygon points="35,8 60,28 52,50" fill="#550088" opacity=".4"/><circle cx="27" cy="36" r="5" fill="#8800cc"/><circle cx="43" cy="36" r="5" fill="#8800cc"/><circle cx="27" cy="36" r="2" fill="#fff"/><circle cx="43" cy="36" r="2" fill="#fff"/><ellipse cx="35" cy="54" rx="14" ry="6" fill="#440066" opacity=".6"/><path d="M20,20 Q10,8 18,5" fill="none" stroke="#9922ee" stroke-width="2" opacity=".7"/><path d="M50,20 Q60,8 52,5" fill="none" stroke="#9922ee" stroke-width="2" opacity=".7"/></svg>` },
        { id:179, name:"Phase Invader",      type:"EFFECT",  attribute:"DARK",  level:4, atk:1800, def:1100, rarity:"C",
          desc:"This card can attack your opponent directly. If this card attacks directly, halve the battle damage.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="27" fill="#060018" stroke="#6644cc" stroke-width="1.5"/><ellipse cx="35" cy="32" rx="10" ry="13" fill="#110028" opacity=".8"/><circle cx="35" cy="20" r="7" fill="#0e001e"/><circle cx="30" cy="18" r="3" fill="#8866ff"/><circle cx="40" cy="18" r="3" fill="#8866ff"/><polygon points="35,50 25,44 45,44" fill="#331166" stroke="#9955ff" stroke-width="1.5"/><polygon points="28,36 18,42 24,30" fill="#220055" stroke="#7744cc" stroke-width="1"/><polygon points="42,36 52,42 46,30" fill="#220055" stroke="#7744cc" stroke-width="1"/><line x1="35" y1="55" x2="35" y2="64" stroke="#6644cc" stroke-width="2"/><line x1="28" y1="60" x2="42" y2="60" stroke="#6644cc" stroke-width="2"/></svg>` },
        { id:180, name:"Ferroflux Beast",    type:"EFFECT",  attribute:"DARK",  level:6, atk:2250, def:1700, rarity:"SR",
          desc:"When this card is Normal Summoned: You can target 1 Spell or Trap Card your opponent controls; destroy it.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="26" ry="20" fill="#0a0018" stroke="#8833bb" stroke-width="2"/><rect x="20" y="14" width="30" height="28" rx="6" fill="#18002c" stroke="#9944cc" stroke-width="2"/><circle cx="27" cy="26" r="5" fill="#6600aa"/><circle cx="43" cy="26" r="5" fill="#6600aa"/><circle cx="27" cy="26" r="2" fill="#dd88ff"/><circle cx="43" cy="26" r="2" fill="#dd88ff"/><rect x="26" y="35" width="18" height="5" rx="2" fill="#550088"/><rect x="10" y="40" width="12" height="20" rx="4" fill="#10001e" stroke="#8833bb" stroke-width="1.5"/><rect x="48" y="40" width="12" height="20" rx="4" fill="#10001e" stroke="#8833bb" stroke-width="1.5"/><line x1="10" y1="32" x2="4" y2="22" stroke="#aa55ff" stroke-width="2"/><line x1="60" y1="32" x2="66" y2="22" stroke="#aa55ff" stroke-width="2"/></svg>` },
        { id:181, name:"Entropy Null",       type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Send the top 2 cards of your opponent's Deck to the Graveyard. Then your opponent discards 1 card from their hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#0a0018" stroke="#8844ff" stroke-width="2"/><circle cx="35" cy="35" r="20" fill="#110028" stroke="#6622cc" stroke-width="1.5"/><circle cx="35" cy="35" r="12" fill="#180032" stroke="#aa55ff" stroke-width="1.5"/><circle cx="35" cy="35" r="5" fill="#9922ee"/><line x1="35" y1="10" x2="35" y2="20" stroke="#8844ff" stroke-width="2.5"/><line x1="35" y1="50" x2="35" y2="60" stroke="#8844ff" stroke-width="2.5"/><line x1="10" y1="35" x2="20" y2="35" stroke="#8844ff" stroke-width="2.5"/><line x1="50" y1="35" x2="60" y2="35" stroke="#8844ff" stroke-width="2.5"/><line x1="17" y1="17" x2="25" y2="25" stroke="#7733dd" stroke-width="2"/><line x1="53" y1="53" x2="45" y2="45" stroke="#7733dd" stroke-width="2"/><line x1="53" y1="17" x2="45" y2="25" stroke="#7733dd" stroke-width="2"/><line x1="17" y1="53" x2="25" y2="45" stroke="#7733dd" stroke-width="2"/></svg>` },
        { id:182, name:"Signal Disrupt",     type:"TRAP",    attribute:"TRAP",  rarity:"SR",
          desc:"When your opponent activates a Spell Card: Negate that activation and destroy it.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#060018" stroke="#7722ee" stroke-width="2"/><line x1="20" y1="20" x2="50" y2="50" stroke="#8833ff" stroke-width="3"/><line x1="50" y1="20" x2="20" y2="50" stroke="#8833ff" stroke-width="3"/><circle cx="35" cy="35" r="16" fill="none" stroke="#6622cc" stroke-width="2"/><circle cx="35" cy="35" r="8" fill="#100022" stroke="#9944ff" stroke-width="1.5"/><circle cx="35" cy="35" r="3" fill="#aa55ff"/></svg>` },
        { id:183, name:"Data Hemorrhage",    type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Discard 1 card; draw 2 cards.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#08001a" stroke="#6633cc" stroke-width="2"/><rect x="16" y="20" width="16" height="22" rx="3" fill="#140030" stroke="#8855ff" stroke-width="1.5"/><line x1="19" y1="26" x2="29" y2="26" stroke="#9966ff" stroke-width="1.5"/><line x1="19" y1="30" x2="29" y2="30" stroke="#9966ff" stroke-width="1.5"/><line x1="19" y1="34" x2="29" y2="34" stroke="#9966ff" stroke-width="1.5"/><rect x="37" y="20" width="16" height="22" rx="3" fill="#140030" stroke="#8855ff" stroke-width="1.5"/><line x1="40" y1="26" x2="50" y2="26" stroke="#9966ff" stroke-width="1.5"/><line x1="40" y1="30" x2="50" y2="30" stroke="#9966ff" stroke-width="1.5"/><line x1="40" y1="34" x2="50" y2="34" stroke="#9966ff" stroke-width="1.5"/><polygon points="35,12 30,22 40,22" fill="#aa66ff" opacity=".8"/><line x1="24" y1="42" x2="35" y2="50" stroke="#6633cc" stroke-width="2"/><line x1="46" y1="42" x2="35" y2="50" stroke="#6633cc" stroke-width="2"/><circle cx="35" cy="52" r="3" fill="#8844ff"/></svg>` },
        { id:184, name:"Cascade Null",       type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"When your opponent's monster declares an attack: Negate that attack, and that monster loses 800 ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#080020" stroke="#5533bb" stroke-width="2"/><path d="M15,50 Q25,20 35,30 Q45,40 55,15" fill="none" stroke="#7755ff" stroke-width="3"/><path d="M15,55 Q25,25 35,35 Q45,45 55,20" fill="none" stroke="#5533cc" stroke-width="2" opacity=".6"/><circle cx="35" cy="30" r="6" fill="#220055" stroke="#8866ff" stroke-width="2"/><line x1="22" y1="12" x2="30" y2="26" stroke="#9977ff" stroke-width="2" stroke-dasharray="3,3"/></svg>` },
        { id:185, name:"Paradox Link",       type:"EFFECT",  attribute:"DARK",  level:5, atk:2000, def:1600, rarity:"R",
          desc:"When this card is Special Summoned from the Graveyard: Target 1 monster your opponent controls; destroy it.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#060014" stroke="#7722dd" stroke-width="2"/><polygon points="35,10 20,52 50,52" fill="#1e0040" opacity=".85"/><circle cx="22" cy="35" r="7" fill="#220044" stroke="#9933ff" stroke-width="2"/><circle cx="48" cy="35" r="7" fill="#220044" stroke="#9933ff" stroke-width="2"/><line x1="29" y1="35" x2="41" y2="35" stroke="#cc55ff" stroke-width="3"/><circle cx="35" cy="35" r="3" fill="#aa44ff"/><path d="M25,15 Q35,8 45,15" fill="none" stroke="#7722dd" stroke-width="1.5" stroke-dasharray="3,2"/></svg>` },
        { id:186, name:"Rift Eater",         type:"EFFECT",  attribute:"DARK",  level:6, atk:2200, def:2000, rarity:"SR",
          desc:"When this card destroys an opponent's monster by battle: You can add 1 DARK monster from your Graveyard to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="40" rx="27" ry="20" fill="#040010" stroke="#6600bb" stroke-width="2"/><polygon points="35,7 16,40 54,40" fill="#1a0035" opacity=".9"/><circle cx="27" cy="32" r="6" fill="#440077"/><circle cx="43" cy="32" r="6" fill="#440077"/><circle cx="27" cy="32" r="2.5" fill="#dd66ff"/><circle cx="43" cy="32" r="2.5" fill="#dd66ff"/><path d="M15,50 Q35,62 55,50" fill="#220033" stroke="#8833cc" stroke-width="2"/><ellipse cx="35" cy="60" rx="18" ry="7" fill="#1a0028" opacity=".5"/><line x1="10" y1="22" x2="18" y2="30" stroke="#8822ee" stroke-width="1.5"/><line x1="60" y1="22" x2="52" y2="30" stroke="#8822ee" stroke-width="1.5"/></svg>` },

        //  APEX GENESIS PACK EXCLUSIVES (187196) 
        { id:187, name:"Solaris Titan",      type:"EFFECT",  attribute:"LIGHT", level:5, atk:2200, def:1800, rarity:"SR",
          desc:"This card is unaffected by Trap card effects. When this card is Normal Summoned: Gain 500 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#141200" stroke="#ffee44" stroke-width="2.5"/><polygon points="35,6 20,50 50,50" fill="#2a2400" opacity=".9"/><polygon points="35,6 8,24 20,50" fill="#ffee88" opacity=".35"/><polygon points="35,6 62,24 50,50" fill="#ffee88" opacity=".35"/><circle cx="35" cy="28" r="9" fill="#1e1a00" stroke="#ffe000" stroke-width="2"/><circle cx="35" cy="28" r="5" fill="#ffee44"/><circle cx="35" cy="28" r="2" fill="#fff8c0"/><line x1="35" y1="5" x2="35" y2="14" stroke="#ffdd00" stroke-width="2.5"/><line x1="10" y1="16" x2="17" y2="22" stroke="#ffdd00" stroke-width="2"/><line x1="60" y1="16" x2="53" y2="22" stroke="#ffdd00" stroke-width="2"/></svg>` },
        { id:188, name:"Aethon the Undying", type:"EFFECT",  attribute:"LIGHT", level:6, atk:2300, def:2100, rarity:"SR",
          desc:"Once per turn: You can target 1 LIGHT monster in your Graveyard; Special Summon it. That monster is destroyed during the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#101000" stroke="#ffffff" stroke-width="2.5"/><ellipse cx="35" cy="32" rx="12" ry="16" fill="#1e1c00" opacity=".9"/><circle cx="35" cy="16" r="9" fill="#141200"/><circle cx="29" cy="14" r="4" fill="#ffffa0"/><circle cx="41" cy="14" r="4" fill="#ffffa0"/><circle cx="29" cy="14" r="1.5" fill="#fff"/><circle cx="41" cy="14" r="1.5" fill="#fff"/><path d="M22,46 Q35,58 48,46" fill="#1e1e00" stroke="#eeeeaa" stroke-width="2"/><path d="M15,35 Q8,26 10,18" fill="none" stroke="#fffff0" stroke-width="2" opacity=".8"/><path d="M55,35 Q62,26 60,18" fill="none" stroke="#fffff0" stroke-width="2" opacity=".8"/><line x1="35" y1="5" x2="35" y2="11" stroke="#ffffff" stroke-width="2.5" stroke-dasharray="3,2"/></svg>` },
        { id:189, name:"Apex Warden",        type:"EFFECT",  attribute:"EARTH", level:4, atk:1900, def:1400, rarity:"R",
          desc:"This card cannot be destroyed by Spell card effects. Once per turn: You can draw 1 card, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="10" y="12" width="50" height="46" rx="6" fill="#0e1400" stroke="#88cc44" stroke-width="2"/><rect x="16" y="18" width="38" height="30" rx="4" fill="#182400" stroke="#66aa33" stroke-width="1.5"/><circle cx="27" cy="30" r="5" fill="#88cc44"/><circle cx="43" cy="30" r="5" fill="#88cc44"/><circle cx="27" cy="30" r="2" fill="#0e1400"/><circle cx="43" cy="30" r="2" fill="#0e1400"/><rect x="26" y="40" width="18" height="5" rx="2" fill="#66aa22"/><rect x="8" y="22" width="8" height="26" rx="3" fill="#0e1400" stroke="#66aa33" stroke-width="1.5"/><rect x="54" y="22" width="8" height="26" rx="3" fill="#0e1400" stroke="#66aa33" stroke-width="1.5"/><polygon points="35,8 30,16 40,16" fill="#446600" stroke="#88cc44" stroke-width="1.5"/></svg>` },
        { id:190, name:"Verdant Colossus",   type:"EFFECT",  attribute:"EARTH", level:7, atk:2700, def:2400, rarity:"SR",
          desc:"When this card is Normal Summoned: Destroy all Defense Position monsters your opponent controls.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="42" rx="27" ry="20" fill="#0a1200" stroke="#55aa22" stroke-width="2"/><rect x="18" y="12" width="34" height="36" rx="7" fill="#142200" stroke="#66bb33" stroke-width="2.5"/><rect x="8" y="20" width="14" height="28" rx="5" fill="#0e1800" stroke="#449922" stroke-width="1.5"/><rect x="48" y="20" width="14" height="28" rx="5" fill="#0e1800" stroke="#449922" stroke-width="1.5"/><ellipse cx="35" cy="22" rx="11" ry="13" fill="#1a2800" stroke="#88cc44" stroke-width="2"/><circle cx="29" cy="19" r="4.5" fill="#55aa22"/><circle cx="41" cy="19" r="4.5" fill="#55aa22"/><rect x="20" y="46" width="14" height="14" rx="4" fill="#0a1200" stroke="#449922" stroke-width="1.5"/><rect x="36" y="46" width="14" height="14" rx="4" fill="#0a1200" stroke="#449922" stroke-width="1.5"/></svg>` },
        { id:191, name:"Refraction Wing",    type:"EFFECT",  attribute:"WIND",  level:5, atk:2100, def:1600, rarity:"SR",
          desc:"Once per turn: This card can attack twice during the same Battle Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#080e22" stroke="#88aaff" stroke-width="2"/><ellipse cx="35" cy="35" rx="8" ry="20" fill="#141e44" stroke="#aabbff" stroke-width="1.5"/><polygon points="35,15 8,30 35,42" fill="#2233aa" opacity=".75" stroke="#8899ff" stroke-width="1.5"/><polygon points="35,15 62,30 35,42" fill="#2233aa" opacity=".75" stroke="#8899ff" stroke-width="1.5"/><polygon points="35,18 12,25 35,34" fill="#4455cc" opacity=".5"/><polygon points="35,18 58,25 35,34" fill="#4455cc" opacity=".5"/><circle cx="35" cy="35" r="5" fill="#1a2255" stroke="#ccddff" stroke-width="2"/><line x1="28" y1="52" x2="42" y2="52" stroke="#8899ff" stroke-width="2"/><line x1="25" y1="57" x2="45" y2="57" stroke="#6677dd" stroke-width="1.5" opacity=".7"/></svg>` },
        { id:192, name:"Genesis Lance",      type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Add 1 monster from your Graveyard to your hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#100e00" stroke="#ffcc33" stroke-width="2"/><line x1="14" y1="56" x2="56" y2="14" stroke="#ffdd44" stroke-width="3"/><polygon points="56,14 48,18 52,22" fill="#ffcc33"/><circle cx="14" cy="56" r="8" fill="#221a00" stroke="#ffaa00" stroke-width="2"/><circle cx="14" cy="56" r="4" fill="#ffcc44"/><circle cx="35" cy="35" r="6" fill="#2a2000" stroke="#ffdd66" stroke-width="1.5"/><circle cx="35" cy="35" r="3" fill="#fff"/></svg>` },
        { id:193, name:"Apex Nova",          type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"All monsters you control gain 600 ATK until the end of this turn.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#0e0c00" stroke="#ffee00" stroke-width="2.5"/><circle cx="35" cy="35" r="22" fill="#1a1600" stroke="#ffdd00" stroke-width="2"/><circle cx="35" cy="35" r="14" fill="#221e00" stroke="#ffcc22" stroke-width="2"/><circle cx="35" cy="35" r="7" fill="#2a2400" stroke="#ffee44" stroke-width="2"/><circle cx="35" cy="35" r="3" fill="#ffee00"/><line x1="35" y1="8" x2="35" y2="16" stroke="#ffdd00" stroke-width="2.5"/><line x1="35" y1="54" x2="35" y2="62" stroke="#ffdd00" stroke-width="2.5"/><line x1="8" y1="35" x2="16" y2="35" stroke="#ffdd00" stroke-width="2.5"/><line x1="54" y1="35" x2="62" y2="35" stroke="#ffdd00" stroke-width="2.5"/><line x1="16" y1="16" x2="23" y2="23" stroke="#ddbb00" stroke-width="2"/><line x1="54" y1="16" x2="47" y2="23" stroke="#ddbb00" stroke-width="2"/><line x1="16" y1="54" x2="23" y2="47" stroke="#ddbb00" stroke-width="2"/><line x1="54" y1="54" x2="47" y2="47" stroke="#ddbb00" stroke-width="2"/></svg>` },
        { id:194, name:"Prismatic Shield",   type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"When you would take effect damage: Negate that damage, and gain LP equal to the amount negated.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#100e00" stroke="#ffcc44" stroke-width="2"/><polygon points="35,14 54,30 48,52 22,52 16,30" fill="#1e1a00" stroke="#ffdd66" stroke-width="2"/><polygon points="35,22 48,32 44,48 26,48 22,32" fill="#2a2400" stroke="#ffee88" stroke-width="1.5"/><polygon points="35,30 44,38 40,48 30,48 26,38" fill="#332e00" stroke="#ffee99" stroke-width="1"/><circle cx="35" cy="38" r="5" fill="#382e00" stroke="#ffee44" stroke-width="1.5"/><circle cx="35" cy="38" r="2.5" fill="#ffe000"/></svg>` },
        { id:195, name:"Nexus Collapse",     type:"TRAP",    attribute:"TRAP",  rarity:"UR",
          desc:"When an opponent's monster declares an attack: Destroy all monsters your opponent controls.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="6" y="6" width="58" height="58" rx="8" fill="#100e00" stroke="#ffffff" stroke-width="2.5"/><circle cx="35" cy="35" r="22" fill="#1e1c00" stroke="#ddcc00" stroke-width="2"/><line x1="20" y1="20" x2="50" y2="50" stroke="#ffee44" stroke-width="3"/><line x1="50" y1="20" x2="20" y2="50" stroke="#ffee44" stroke-width="3"/><circle cx="35" cy="35" r="10" fill="#2a2800" stroke="#ffcc33" stroke-width="2"/><circle cx="35" cy="35" r="5" fill="#332e00" stroke="#fff07a" stroke-width="1.5"/><circle cx="35" cy="35" r="2" fill="#ffffff"/></svg>` },
        { id:196, name:"Apex Fusion Dragon", type:"FUSION",  attribute:"LIGHT", level:8, atk:2900, def:2300, rarity:"UR",
          desc:"Cannot be targeted or destroyed by card effects. Inflicts 500 damage to your opponent each of your End Phases.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#141200" stroke="#ffffff" stroke-width="3"/><polygon points="35,5 16,50 54,50" fill="#2a2800" opacity=".9"/><polygon points="35,5 8,22 16,50" fill="#ffffaa" opacity=".35"/><polygon points="35,5 62,22 54,50" fill="#ffffaa" opacity=".35"/><ellipse cx="35" cy="22" rx="5" ry="7" fill="#221e00" stroke="#ffffcc" stroke-width="2"/><circle cx="27" cy="36" r="6" fill="#ffee44"/><circle cx="43" cy="36" r="6" fill="#ffee44"/><circle cx="27" cy="36" r="2.5" fill="#141200"/><circle cx="43" cy="36" r="2.5" fill="#141200"/><path d="M18,55 Q35,65 52,55" fill="#332e00" stroke="#ffffcc" stroke-width="2"/><polygon points="8,14 2,26 14,26" fill="#ccbb22" opacity=".8"/><polygon points="62,14 68,26 56,26" fill="#ccbb22" opacity=".8"/></svg>` },

        //  DRAGON'S FURY  "FURY" ARCHETYPE EXCLUSIVES (197-205) 
        { id:197, name:"Fury Hatchling",     type:"EFFECT",  attribute:"FIRE",  level:2, atk:800,  def:600,  rarity:"C",
          desc:"When this card is Normal Summoned: Gain 200 LP for each FIRE monster you control (including this card).",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#1a0200" stroke="#cc2200" stroke-width="2"/><ellipse cx="35" cy="38" rx="14" ry="16" fill="#2a0500" stroke="#ff3300" stroke-width="1.5"/><polygon points="35,28 28,38 42,38" fill="#ff4400" opacity=".8"/><ellipse cx="35" cy="38" rx="8" ry="10" fill="#ff2200" opacity=".4"/><circle cx="30" cy="32" r="3" fill="#ff8800"/><circle cx="40" cy="32" r="3" fill="#ff8800"/><path d="M28,48 Q35,55 42,48" fill="none" stroke="#ff4400" stroke-width="2"/></svg>` },
        { id:198, name:"Fury Lancer",        type:"EFFECT",  attribute:"FIRE",  level:4, atk:1800, def:1100, rarity:"R",
          desc:"When this card destroys an opponent's monster by battle: Inflict 400 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#1a0200" stroke="#ff3300" stroke-width="2"/><line x1="20" y1="18" x2="50" y2="52" stroke="#ff5500" stroke-width="4" stroke-linecap="round"/><polygon points="50,52 44,48 48,44" fill="#ff8800"/><circle cx="31" cy="26" r="8" fill="#2a0500" stroke="#ff4400" stroke-width="1.5"/><circle cx="29" cy="24" r="2.5" fill="#ff6600"/><circle cx="33" cy="24" r="2.5" fill="#ff6600"/><path d="M25,32 Q31,37 37,32" fill="none" stroke="#ff5500" stroke-width="1.5"/></svg>` },
        { id:199, name:"Fury Tyrant",        type:"EFFECT",  attribute:"FIRE",  level:6, atk:2300, def:1800, rarity:"SR",
          desc:"Once per turn: You can discard 1 card; destroy 1 monster your opponent controls.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="27" ry="22" fill="#1a0000" stroke="#ee2200" stroke-width="2"/><polygon points="35,8 18,38 52,38" fill="#551100" opacity=".9"/><polygon points="35,8 8,24 18,38" fill="#ff3300" opacity=".4"/><polygon points="35,8 62,24 52,38" fill="#ff3300" opacity=".4"/><circle cx="27" cy="30" r="6" fill="#ff4400"/><circle cx="43" cy="30" r="6" fill="#ff4400"/><circle cx="27" cy="30" r="2.5" fill="#200000"/><circle cx="43" cy="30" r="2.5" fill="#200000"/><path d="M20,47 Q35,58 50,47" fill="#330800" stroke="#ff4400" stroke-width="2"/></svg>` },
        { id:200, name:"Fury Warlord",       type:"EFFECT",  attribute:"FIRE",  level:7, atk:2700, def:2100, rarity:"SR",
          desc:"When this card is Summoned: All Fury monsters you control gain 300 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#100000" stroke="#dd1100" stroke-width="3"/><polygon points="35,5 12,45 58,45" fill="#440800" opacity=".9"/><polygon points="35,5 6,20 12,45" fill="#ff2200" opacity=".5"/><polygon points="35,5 64,20 58,45" fill="#ff2200" opacity=".5"/><circle cx="26" cy="32" r="7" fill="#ff3300"/><circle cx="44" cy="32" r="7" fill="#ff3300"/><circle cx="26" cy="32" r="3" fill="#100"/><circle cx="44" cy="32" r="3" fill="#100"/><ellipse cx="35" cy="55" rx="20" ry="8" fill="#cc1100" opacity=".35"/><polygon points="8,12 3,22 14,22" fill="#ff2200" opacity=".8"/><polygon points="62,12 67,22 56,22" fill="#ff2200" opacity=".8"/></svg>` },
        { id:201, name:"Fury Ascendant",     type:"FUSION",  attribute:"FIRE",  level:9, atk:3100, def:2500, rarity:"UR",
          desc:"\"Fury Tyrant\" + \"Fury Lancer\". When Fusion Summoned: Destroy all Spell/Trap cards your opponent controls. When this card destroys a monster by battle: Inflict 600 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#100000" stroke="#ff9900" stroke-width="3"/><polygon points="35,4 14,48 56,48" fill="#440800" opacity=".9"/><polygon points="35,4 6,18 14,48" fill="#ff4400" opacity=".45"/><polygon points="35,4 64,18 56,48" fill="#ff4400" opacity=".45"/><circle cx="26" cy="34" r="7" fill="#ff6600"/><circle cx="44" cy="34" r="7" fill="#ff6600"/><circle cx="26" cy="34" r="3" fill="#fff"/><circle cx="44" cy="34" r="3" fill="#fff"/><ellipse cx="35" cy="22" rx="5" ry="7" fill="#220000" stroke="#ff9900" stroke-width="2"/><path d="M16,56 Q35,68 54,56" fill="#660800" stroke="#ff9900" stroke-width="2"/><polygon points="5,14 0,24 12,24" fill="#ffaa00" opacity=".85"/><polygon points="65,14 70,24 58,24" fill="#ffaa00" opacity=".85"/></svg>` },
        { id:202, name:"Fury Surge",         type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All FIRE monsters you control gain 600 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#1a0200" stroke="#ff4400" stroke-width="2"/><path d="M12,35 Q20,18 30,30 Q38,42 46,26 Q52,14 58,28" fill="none" stroke="#ff4400" stroke-width="3"/><path d="M12,45 Q20,30 30,42 Q38,54 46,38" fill="none" stroke="#cc2200" stroke-width="2" opacity=".6"/><circle cx="35" cy="16" r="8" fill="#ff6600" opacity=".6"/></svg>` },
        { id:203, name:"Pyre of Fury",       type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"Destroy all opponent monsters with ATK 1500 or less.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#1a0100" stroke="#ff3300" stroke-width="2"/><ellipse cx="35" cy="50" rx="18" ry="8" fill="#441100" opacity=".8"/><ellipse cx="35" cy="40" rx="12" ry="14" fill="#ff3300" opacity=".7"/><ellipse cx="35" cy="28" rx="8" ry="12" fill="#ff6600" opacity=".8"/><ellipse cx="35" cy="18" rx="4" ry="8" fill="#ff9900" opacity=".9"/><ellipse cx="35" cy="13" rx="2" ry="4" fill="#fff8d0"/></svg>` },
        { id:204, name:"Fury Claw",          type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when an opponent's monster declares an attack: Destroy that monster and inflict 500 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#1a0000" stroke="#cc2200" stroke-width="2"/><path d="M20,24 Q28,12 35,24 Q42,12 50,24 L50,52 L35,45 L20,52 Z" fill="#441100" opacity=".8" stroke="#ff4400" stroke-width="1.5"/><line x1="35" y1="24" x2="35" y2="45" stroke="#ff6600" stroke-width="2"/></svg>` },
        { id:205, name:"Fury Brand",         type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Draw 2 cards, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#1a0200" stroke="#ff5500" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#280800" stroke="#ff4400" stroke-width="1.5"/><path d="M35,20 L40,30 L55,32 L44,42 L47,57 L35,50 L23,57 L26,42 L15,32 L30,30 Z" fill="#ff4400" opacity=".6"/><circle cx="35" cy="35" r="5" fill="#ff8800"/></svg>` },

        //  AQUA FORCE  "TIDE" ARCHETYPE EXCLUSIVES (206-214) 
        { id:206, name:"Tide Sprite",        type:"EFFECT",  attribute:"WATER", level:2, atk:700,  def:900,  rarity:"C",
          desc:"When this card is Normal Summoned: Draw 1 card, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#001428" stroke="#00ccee" stroke-width="1.5"/><ellipse cx="35" cy="38" rx="10" ry="12" fill="#001e3a" stroke="#00aaff" stroke-width="1"/><circle cx="35" cy="26" r="8" fill="#002244"/><circle cx="31" cy="24" r="2.5" fill="#00ccff"/><circle cx="39" cy="24" r="2.5" fill="#00ccff"/><path d="M25,18 Q18,10 20,20" fill="none" stroke="#00aaff" stroke-width="2" stroke-linecap="round"/><path d="M45,18 Q52,10 50,20" fill="none" stroke="#00aaff" stroke-width="2" stroke-linecap="round"/><path d="M26,40 Q35,48 44,40" fill="none" stroke="#00ccee" stroke-width="1.5"/></svg>` },
        { id:207, name:"Tide Warden",        type:"EFFECT",  attribute:"WATER", level:4, atk:1700, def:1400, rarity:"R",
          desc:"Once per turn: Draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#001428" stroke="#0099cc" stroke-width="2"/><line x1="35" y1="12" x2="35" y2="58" stroke="#0088cc" stroke-width="4" stroke-linecap="round"/><ellipse cx="35" cy="10" rx="7" ry="5" fill="#003366" stroke="#00ccff" stroke-width="1.5"/><circle cx="28" cy="32" r="5" fill="#0099cc"/><circle cx="42" cy="32" r="5" fill="#0099cc"/><circle cx="28" cy="32" r="2" fill="#fffdfd22"/><circle cx="42" cy="32" r="2" fill="#fffdfd22"/><path d="M22,46 Q35,56 48,46" fill="none" stroke="#00aabb" stroke-width="2"/></svg>` },
        { id:208, name:"Tide Marshal",       type:"EFFECT",  attribute:"WATER", level:6, atk:2200, def:1800, rarity:"SR",
          desc:"When this card is Summoned: Return 1 monster your opponent controls to their hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="26" ry="22" fill="#001222" stroke="#0077bb" stroke-width="2"/><polygon points="35,8 16,38 54,38" fill="#002244" opacity=".9"/><polygon points="35,8 8,22 16,38" fill="#0088cc" opacity=".45"/><polygon points="35,8 62,22 54,38" fill="#0088cc" opacity=".45"/><circle cx="27" cy="30" r="5" fill="#00aaff"/><circle cx="43" cy="30" r="5" fill="#00aaff"/><circle cx="27" cy="30" r="2" fill="#fff"/><circle cx="43" cy="30" r="2" fill="#fff"/><path d="M16,48 Q35,62 54,48" fill="#003355" stroke="#0088bb" stroke-width="2"/></svg>` },
        { id:209, name:"Tide Emperor",       type:"EFFECT",  attribute:"WATER", level:7, atk:2500, def:2100, rarity:"SR",
          desc:"When this card is Summoned: Draw 2 cards, then discard 1. Once per turn: Gain 500 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#000e1c" stroke="#0066aa" stroke-width="3"/><polygon points="35,5 15,48 55,48" fill="#002244" opacity=".9"/><polygon points="35,5 5,20 15,48" fill="#0099dd" opacity=".4"/><polygon points="35,5 65,20 55,48" fill="#0099dd" opacity=".4"/><circle cx="26" cy="34" r="7" fill="#00aaff"/><circle cx="44" cy="34" r="7" fill="#00aaff"/><circle cx="26" cy="34" r="3" fill="#003"/><circle cx="44" cy="34" r="3" fill="#003"/><ellipse cx="35" cy="22" rx="5" ry="7" fill="#000e1c" stroke="#00ccff" stroke-width="2"/><path d="M14,56 Q35,68 56,56" fill="#003366" stroke="#0088cc" stroke-width="2"/><polygon points="4,14 0,24 10,24" fill="#00bbff" opacity=".85"/><polygon points="66,14 70,24 60,24" fill="#00bbff" opacity=".85"/></svg>` },
        { id:210, name:"Tidal Sovereign",    type:"FUSION",  attribute:"WATER", level:9, atk:3000, def:2500, rarity:"UR",
          desc:"\"Tide Emperor\" + \"Tide Marshal\". When Fusion Summoned: Send the top 3 cards of your opponent's Deck to the Graveyard.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#00080e" stroke="#00bbee" stroke-width="3"/><path d="M10,38 Q22,12 35,6 Q48,12 60,38" fill="#001a2e" opacity=".85" stroke="#0077cc" stroke-width="2"/><circle cx="26" cy="28" r="7" fill="#00aaff"/><circle cx="44" cy="28" r="7" fill="#00aaff"/><circle cx="26" cy="28" r="3" fill="#fff"/><circle cx="44" cy="28" r="3" fill="#fff"/><path d="M16,50 Q35,65 54,50" fill="none" stroke="#00ccff" stroke-width="2.5"/><path d="M12,43 Q35,58 58,43" fill="#001a30" stroke="#0055aa" stroke-width="1.5"/><path d="M10,38 Q5,50 8,60 M60,38 Q65,50 62,60" fill="none" stroke="#0077cc" stroke-width="2"/></svg>` },
        { id:211, name:"Tidal Surge",        type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All WATER monsters you control gain 500 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#00aaff" stroke-width="2"/><path d="M10,35 Q18,18 28,30 Q36,42 44,26 Q50,14 60,26" fill="none" stroke="#00aaff" stroke-width="3"/><path d="M10,45 Q18,28 28,42 Q36,56 44,40" fill="none" stroke="#0077cc" stroke-width="2" opacity=".6"/><circle cx="35" cy="16" r="7" fill="#00bbff" opacity=".5"/></svg>` },
        { id:212, name:"Deep Current",       type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Draw 2 cards, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#0088cc" stroke-width="2"/><path d="M14,30 Q24,22 34,30 Q44,38 54,30" fill="none" stroke="#00aaff" stroke-width="2.5"/><path d="M14,40 Q24,32 34,40 Q44,48 54,40" fill="none" stroke="#0088cc" stroke-width="2"/><path d="M14,50 Q24,42 34,50 Q44,58 54,50" fill="none" stroke="#006699" stroke-width="1.5"/><circle cx="14" cy="20" r="3" fill="#00ccff"/><circle cx="56" cy="20" r="3" fill="#00ccff"/></svg>` },
        { id:213, name:"Tidal Lock",         type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate during your opponent's attack: Negate that attack and gain 800 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#0077cc" stroke-width="2"/><circle cx="35" cy="32" r="14" fill="#002244" stroke="#00aaff" stroke-width="2"/><rect x="28" y="22" width="14" height="10" rx="3" fill="#001428" stroke="#00aaff" stroke-width="1.5"/><rect x="30" y="32" width="10" height="12" rx="2" fill="#002244" stroke="#0077cc" stroke-width="1.5"/><circle cx="35" cy="38" r="3" fill="#00aaff"/><line x1="35" y1="38" x2="35" y2="43" stroke="#0077cc" stroke-width="2"/></svg>` },
        { id:214, name:"Riptide",            type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when a monster is Summoned: Return that monster to the hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#001428" stroke="#0055aa" stroke-width="2"/><path d="M18,50 Q22,30 35,22 Q48,30 52,50" fill="none" stroke="#00aaff" stroke-width="2.5"/><path d="M22,52 Q26,35 35,26 Q44,35 48,52" fill="none" stroke="#0077cc" stroke-width="2"/><circle cx="35" cy="22" r="6" fill="#002244" stroke="#00ccff" stroke-width="1.5"/></svg>` },

        //  SHADOW COMMAND  "ABYSS" ARCHETYPE EXCLUSIVES (215-223) 
        { id:215, name:"Abyss Pawn",         type:"EFFECT",  attribute:"DARK",  level:2, atk:900,  def:700,  rarity:"C",
          desc:"When this card is Normal Summoned: Your opponent discards 1 random card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#06000a" stroke="#8800cc" stroke-width="1.5"/><circle cx="35" cy="24" r="8" fill="#220033"/><rect x="28" y="32" width="14" height="18" rx="3" fill="#1a0028" stroke="#8800cc" stroke-width="1.5"/><ellipse cx="35" cy="50" rx="10" ry="4" fill="#33004d" opacity=".7"/><circle cx="30" cy="22" r="2.5" fill="#cc00ff"/><circle cx="40" cy="22" r="2.5" fill="#cc00ff"/></svg>` },
        { id:216, name:"Abyss Knight",       type:"EFFECT",  attribute:"DARK",  level:4, atk:1700, def:1200, rarity:"R",
          desc:"When this card destroys an opponent's monster by battle: Banish that monster instead of sending it to the Graveyard.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#06000a" stroke="#990099" stroke-width="2"/><line x1="35" y1="14" x2="35" y2="56" stroke="#880099" stroke-width="3" stroke-linecap="round"/><rect x="24" y="28" width="22" height="14" rx="3" fill="#1a0028" stroke="#aa00cc" stroke-width="1.5"/><circle cx="29" cy="26" r="4" fill="#440055"/><circle cx="41" cy="26" r="4" fill="#440055"/><circle cx="29" cy="26" r="1.5" fill="#cc00ff"/><circle cx="41" cy="26" r="1.5" fill="#cc00ff"/><path d="M22,46 Q35,58 48,46" fill="none" stroke="#880099" stroke-width="2"/></svg>` },
        { id:217, name:"Abyss Sorcerer",     type:"EFFECT",  attribute:"DARK",  level:5, atk:2000, def:1600, rarity:"SR",
          desc:"Once per turn: Your opponent discards 1 random card from their hand.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="27" fill="#06000a" stroke="#aa00ee" stroke-width="2"/><circle cx="35" cy="22" r="9" fill="#220033"/><circle cx="29" cy="20" r="3" fill="#cc00ff"/><circle cx="41" cy="20" r="3" fill="#cc00ff"/><circle cx="29" cy="20" r="1" fill="#fff"/><circle cx="41" cy="20" r="1" fill="#fff"/><path d="M26,30 Q35,40 44,30" fill="#1a0028" stroke="#9900cc" stroke-width="1.5"/><path d="M26,40 Q35,55 44,40" fill="#1a0028" stroke="#7700aa" stroke-width="2"/><circle cx="35" cy="55" r="5" fill="#330044" stroke="#cc00ff" stroke-width="1.5"/></svg>` },
        { id:218, name:"Abyss Tyrant",       type:"EFFECT",  attribute:"DARK",  level:7, atk:2700, def:2200, rarity:"SR",
          desc:"When this card is Summoned: Destroy all Spell/Trap cards your opponent controls.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="27" ry="22" fill="#04000a" stroke="#7700bb" stroke-width="2"/><polygon points="35,8 14,38 56,38" fill="#220033" opacity=".9"/><polygon points="35,8 6,22 14,38" fill="#aa00dd" opacity=".4"/><polygon points="35,8 64,22 56,38" fill="#aa00dd" opacity=".4"/><circle cx="26" cy="30" r="6" fill="#bb00ff"/><circle cx="44" cy="30" r="6" fill="#bb00ff"/><circle cx="26" cy="30" r="2.5" fill="#fff"/><circle cx="44" cy="30" r="2.5" fill="#fff"/><path d="M14,48 Q35,62 56,48" fill="#330044" stroke="#8800bb" stroke-width="2"/></svg>` },
        { id:219, name:"Abyssal Sovereign",  type:"FUSION",  attribute:"DARK",  level:9, atk:3200, def:2600, rarity:"UR",
          desc:"\"Abyss Tyrant\" + \"Abyss Sorcerer\". When Fusion Summoned: Your opponent discards 2 cards. When this card destroys a monster by battle: Your opponent discards 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#030008" stroke="#cc00ff" stroke-width="3"/><polygon points="35,4 13,48 57,48" fill="#220033" opacity=".9"/><polygon points="35,4 4,18 13,48" fill="#9900cc" opacity=".45"/><polygon points="35,4 66,18 57,48" fill="#9900cc" opacity=".45"/><circle cx="25" cy="34" r="7" fill="#cc00ff"/><circle cx="45" cy="34" r="7" fill="#cc00ff"/><circle cx="25" cy="34" r="3" fill="#fff"/><circle cx="45" cy="34" r="3" fill="#fff"/><ellipse cx="35" cy="20" rx="5" ry="8" fill="#0a000e" stroke="#dd00ff" stroke-width="2"/><path d="M12,56 Q35,70 58,56" fill="#330044" stroke="#cc00ff" stroke-width="2.5"/><polygon points="3,12 0,24 12,24" fill="#ee00ff" opacity=".8"/><polygon points="67,12 70,24 58,24" fill="#ee00ff" opacity=".8"/></svg>` },
        { id:220, name:"Abyss Rite",         type:"SPELL",   attribute:"SPELL", rarity:"SR",
          desc:"Send the top 5 cards of your opponent's Deck to the Graveyard.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#06000a" stroke="#9900cc" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#130018" stroke="#aa00ee" stroke-width="1.5"/><path d="M35,22 L38,30 L48,30 L40,36 L43,46 L35,40 L27,46 L30,36 L22,30 L32,30 Z" fill="#880099" opacity=".7"/><circle cx="35" cy="35" r="4" fill="#cc00ff"/></svg>` },
        { id:221, name:"Abyss Purge",        type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Destroy all Spell and Trap cards on the field.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#06000a" stroke="#770099" stroke-width="2"/><line x1="18" y1="18" x2="52" y2="52" stroke="#aa00cc" stroke-width="3"/><line x1="52" y1="18" x2="18" y2="52" stroke="#aa00cc" stroke-width="3"/><circle cx="35" cy="35" r="10" fill="#130018" stroke="#cc00ff" stroke-width="1.5"/><circle cx="35" cy="35" r="4" fill="#770099"/></svg>` },
        { id:222, name:"Abyss Dominion",     type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All monsters your opponent controls lose 600 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#04000a" stroke="#880099" stroke-width="2"/><ellipse cx="35" cy="35" rx="20" ry="20" fill="#130018" opacity=".8"/><path d="M22,20 Q35,14 48,20 Q55,30 48,42 Q35,50 22,42 Q15,30 22,20 Z" fill="none" stroke="#aa00cc" stroke-width="2"/><text x="35" y="40" text-anchor="middle" font-size="16" fill="#cc00ff"></text></svg>` },
        { id:223, name:"Abyss Snare",        type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when your opponent activates a Spell: Negate that Spell and destroy it.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#06000a" stroke="#8800bb" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#1a001e" stroke="#aa00dd" stroke-width="1.5"/><path d="M22,22 Q35,18 48,22 Q52,35 48,48 Q35,52 22,48 Q18,35 22,22 Z" fill="none" stroke="#cc00ee" stroke-width="2"/><line x1="35" y1="20" x2="35" y2="50" stroke="#9900cc" stroke-width="2"/><line x1="20" y1="35" x2="50" y2="35" stroke="#9900cc" stroke-width="2"/></svg>` },

        //  CYBER BLITZ  "GRID" ARCHETYPE EXCLUSIVES (224-232) 
        { id:224, name:"Grid Drone",         type:"EFFECT",  attribute:"EARTH", level:2, atk:900,  def:700,  rarity:"C",
          desc:"When this card is Normal Summoned: Inflict 300 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#061000" stroke="#88cc00" stroke-width="1.5"/><ellipse cx="35" cy="35" rx="12" ry="8" fill="#102200" stroke="#aaff00" stroke-width="1.5"/><circle cx="35" cy="35" r="5" fill="#88cc00"/><line x1="23" y1="35" x2="12" y2="28" stroke="#66aa00" stroke-width="2"/><line x1="23" y1="35" x2="12" y2="42" stroke="#66aa00" stroke-width="2"/><line x1="47" y1="35" x2="58" y2="28" stroke="#66aa00" stroke-width="2"/><line x1="47" y1="35" x2="58" y2="42" stroke="#66aa00" stroke-width="2"/><circle cx="35" cy="35" r="2" fill="#ccff44"/></svg>` },
        { id:225, name:"Grid Soldier",       type:"EFFECT",  attribute:"EARTH", level:4, atk:1800, def:1300, rarity:"R",
          desc:"When this card destroys an opponent's monster by battle: Gain 500 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#061000" stroke="#99dd00" stroke-width="2"/><rect x="26" y="16" width="18" height="24" rx="3" fill="#122200" stroke="#99dd00" stroke-width="1.5"/><rect x="29" y="40" width="12" height="16" rx="2" fill="#102200" stroke="#77cc00" stroke-width="1"/><circle cx="29" cy="26" r="4" fill="#aaee00"/><circle cx="41" cy="26" r="4" fill="#aaee00"/><circle cx="29" cy="26" r="1.5" fill="#000"/><circle cx="41" cy="26" r="1.5" fill="#000"/><path d="M24,46 L21,62 M46,46 L49,62" stroke="#aaee00" stroke-width="2.5"/></svg>` },
        { id:226, name:"Grid Commander",     type:"EFFECT",  attribute:"EARTH", level:6, atk:2300, def:1800, rarity:"SR",
          desc:"Once per turn: Target 1 monster your opponent controls; it loses 600 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="26" ry="21" fill="#061000" stroke="#88cc00" stroke-width="2"/><polygon points="35,8 18,38 52,38" fill="#112200" opacity=".9"/><polygon points="35,8 8,22 18,38" fill="#aaff00" opacity=".4"/><polygon points="35,8 62,22 52,38" fill="#aaff00" opacity=".4"/><circle cx="27" cy="30" r="5" fill="#aaee00"/><circle cx="43" cy="30" r="5" fill="#aaee00"/><circle cx="27" cy="30" r="2" fill="#000"/><circle cx="43" cy="30" r="2" fill="#000"/><rect x="30" y="36" width="10" height="4" rx="2" fill="#77cc00"/></svg>` },
        { id:227, name:"Grid Overlord",      type:"EFFECT",  attribute:"EARTH", level:7, atk:2800, def:2100, rarity:"SR",
          desc:"When this card is Summoned: Destroy 1 monster your opponent controls.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="29" fill="#040e00" stroke="#88ff00" stroke-width="3"/><rect x="18" y="10" width="34" height="38" rx="6" fill="#0e2400" stroke="#aaff00" stroke-width="2"/><circle cx="27" cy="26" r="6" fill="#aaff00"/><circle cx="43" cy="26" r="6" fill="#aaff00"/><circle cx="27" cy="26" r="2.5" fill="#000"/><circle cx="43" cy="26" r="2.5" fill="#000"/><rect x="28" y="36" width="14" height="6" rx="3" fill="#55cc00"/><rect x="14" y="48" width="12" height="20" rx="3" fill="#0f2000" stroke="#aaff00" stroke-width="1.5"/><rect x="44" y="48" width="12" height="20" rx="3" fill="#0f2000" stroke="#aaff00" stroke-width="1.5"/></svg>` },
        { id:228, name:"Grid Titan",         type:"FUSION",  attribute:"EARTH", level:9, atk:3300, def:2500, rarity:"UR",
          desc:"\"Grid Overlord\" + \"Grid Commander\". Cannot be destroyed by card effects. When Fusion Summoned: Draw 2 cards.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#030e00" stroke="#bbff44" stroke-width="3"/><rect x="14" y="8" width="42" height="42" rx="8" fill="#0e2400" stroke="#aaff00" stroke-width="2.5"/><circle cx="26" cy="26" r="7" fill="#aaff00"/><circle cx="44" cy="26" r="7" fill="#aaff00"/><circle cx="26" cy="26" r="3" fill="#000"/><circle cx="44" cy="26" r="3" fill="#000"/><rect x="27" y="38" width="16" height="6" rx="3" fill="#66cc00"/><rect x="8" y="50" width="16" height="22" rx="4" fill="#0a1e00" stroke="#bbff44" stroke-width="2"/><rect x="46" y="50" width="16" height="22" rx="4" fill="#0a1e00" stroke="#bbff44" stroke-width="2"/><polygon points="4,12 0,24 12,24" fill="#bbff44" opacity=".8"/><polygon points="66,12 70,24 58,24" fill="#bbff44" opacity=".8"/></svg>` },
        { id:229, name:"Grid Protocol",      type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All EARTH monsters you control gain 500 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#061000" stroke="#99dd00" stroke-width="2"/><rect x="16" y="20" width="16" height="12" rx="2" fill="#112200" stroke="#88cc00" stroke-width="1.5"/><rect x="38" y="20" width="16" height="12" rx="2" fill="#112200" stroke="#88cc00" stroke-width="1.5"/><rect x="27" y="38" width="16" height="12" rx="2" fill="#172800" stroke="#aaee00" stroke-width="1.5"/><line x1="24" y1="32" x2="35" y2="38" stroke="#aaff00" stroke-width="2"/><line x1="46" y1="32" x2="35" y2="38" stroke="#aaff00" stroke-width="2"/></svg>` },
        { id:230, name:"Grid Surge",         type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Draw 2 cards, then discard 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#061000" stroke="#88dd00" stroke-width="2"/><path d="M18,35 L28,35 L32,20 L38,50 L42,35 L52,35" fill="none" stroke="#aaff00" stroke-width="3" stroke-linejoin="round"/><circle cx="18" cy="35" r="4" fill="#55cc00"/><circle cx="52" cy="35" r="4" fill="#55cc00"/></svg>` },
        { id:231, name:"Grid Firewall",      type:"TRAP",    attribute:"TRAP",  rarity:"SR",
          desc:"Activate when an opponent's monster with ATK 2000 or more declares an attack: Negate that attack and halve that monster's ATK.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#061000" stroke="#77bb00" stroke-width="2"/><rect x="18" y="18" width="34" height="34" rx="4" fill="#0c1e00" stroke="#99dd00" stroke-width="1.5"/><rect x="24" y="24" width="22" height="22" rx="3" fill="#112400" stroke="#88bb00" stroke-width="1"/><line x1="18" y1="18" x2="52" y2="52" stroke="#aaff00" stroke-width="2" opacity=".5"/><line x1="52" y1="18" x2="18" y2="52" stroke="#aaff00" stroke-width="2" opacity=".5"/><circle cx="35" cy="35" r="5" fill="#66cc00"/></svg>` },
        { id:232, name:"Grid Override",      type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when your opponent activates a Spell: Negate it and inflict 600 damage to your opponent.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#061000" stroke="#66bb00" stroke-width="2"/><circle cx="35" cy="35" r="16" fill="#0d2000" stroke="#99dd00" stroke-width="1.5"/><text x="35" y="42" text-anchor="middle" font-size="20" fill="#aaff00"></text><line x1="35" y1="10" x2="35" y2="19" stroke="#99dd00" stroke-width="2"/><line x1="35" y1="51" x2="35" y2="60" stroke="#99dd00" stroke-width="2"/></svg>` },

        //  HOLY LIGHT  "AURORA" ARCHETYPE EXCLUSIVES (233-241) 
        { id:233, name:"Aurora Acolyte",     type:"EFFECT",  attribute:"LIGHT", level:2, atk:800,  def:1000, rarity:"C",
          desc:"When this card is Normal Summoned: Gain 500 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="26" fill="#14100a" stroke="#ffee88" stroke-width="1.5"/><circle cx="35" cy="25" r="8" fill="#1e1600"/><circle cx="30" cy="23" r="2.5" fill="#ffdd44"/><circle cx="40" cy="23" r="2.5" fill="#ffdd44"/><path d="M27,30 Q35,36 43,30" fill="none" stroke="#ffcc33" stroke-width="1.5"/><ellipse cx="35" cy="40" rx="9" ry="10" fill="#1a1400" stroke="#ffcc44" stroke-width="1"/><circle cx="35" cy="35" r="4" fill="#ffeeaa" opacity=".5"/></svg>` },
        { id:234, name:"Aurora Paladin",     type:"EFFECT",  attribute:"LIGHT", level:4, atk:1800, def:1600, rarity:"R",
          desc:"Once per turn: All LIGHT monsters you control gain 400 ATK until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="28" fill="#14100a" stroke="#ffcc44" stroke-width="2"/><polygon points="35,14 42,36 35,56 28,36" fill="#ddaa22" opacity=".8"/><polygon points="14,35 36,28 56,35 36,42" fill="#ffeedd" opacity=".5"/><circle cx="35" cy="32" r="6" fill="#ffeeaa" opacity=".6"/><circle cx="35" cy="32" r="12" fill="none" stroke="#ffcc44" stroke-width="1" opacity=".5"/></svg>` },
        { id:235, name:"Aurora Sage",        type:"EFFECT",  attribute:"LIGHT", level:5, atk:1900, def:1700, rarity:"SR",
          desc:"When this card is Summoned: Draw 1 card. Once per turn: Gain 300 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="27" fill="#14100a" stroke="#ffdd88" stroke-width="2"/><circle cx="35" cy="22" r="9" fill="#1e1600"/><circle cx="29" cy="20" r="3" fill="#ffcc44"/><circle cx="41" cy="20" r="3" fill="#ffcc44"/><circle cx="29" cy="20" r="1" fill="#fff"/><circle cx="41" cy="20" r="1" fill="#fff"/><line x1="35" y1="12" x2="35" y2="20" stroke="#ffdd44" stroke-width="2"/><polygon points="35,8 32,12 38,12" fill="#ffcc44"/><path d="M26,32 Q35,42 44,32" fill="#1e1a10" stroke="#ffcc33" stroke-width="2"/><path d="M26,44 Q35,56 44,44" fill="#1a1600" stroke="#ddaa22" stroke-width="2"/></svg>` },
        { id:236, name:"Aurora Guardian",    type:"EFFECT",  attribute:"LIGHT", level:7, atk:2600, def:2300, rarity:"SR",
          desc:"Once per turn: Target 1 monster your opponent controls; negate its effects until the End Phase.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><ellipse cx="35" cy="38" rx="27" ry="22" fill="#14100a" stroke="#ffcc44" stroke-width="2.5"/><polygon points="35,8 18,38 52,38" fill="#331e00" opacity=".9"/><polygon points="35,8 8,22 18,38" fill="#ffeebb" opacity=".45"/><polygon points="35,8 62,22 52,38" fill="#ffeebb" opacity=".45"/><circle cx="27" cy="30" r="6" fill="#ffee88"/><circle cx="43" cy="30" r="6" fill="#ffee88"/><circle cx="27" cy="30" r="2.5" fill="#441e00"/><circle cx="43" cy="30" r="2.5" fill="#441e00"/><path d="M14,50 Q35,64 56,50" fill="#2a1800" stroke="#ffcc44" stroke-width="2"/></svg>` },
        { id:237, name:"Aurora Divinity",    type:"FUSION",  attribute:"LIGHT", level:9, atk:3100, def:2600, rarity:"UR",
          desc:"\"Aurora Guardian\" + \"Aurora Sage\". When Fusion Summoned: Gain 2000 LP and draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><circle cx="35" cy="35" r="30" fill="#0e0a00" stroke="#ffffff" stroke-width="3"/><polygon points="35,4 14,48 56,48" fill="#332200" opacity=".9"/><polygon points="35,4 5,18 14,48" fill="#ffffaa" opacity=".4"/><polygon points="35,4 65,18 56,48" fill="#ffffaa" opacity=".4"/><ellipse cx="35" cy="20" rx="5" ry="8" fill="#1e1600" stroke="#ffffcc" stroke-width="2"/><circle cx="26" cy="36" r="7" fill="#ffee44"/><circle cx="44" cy="36" r="7" fill="#ffee44"/><circle cx="26" cy="36" r="3" fill="#0e0a00"/><circle cx="44" cy="36" r="3" fill="#0e0a00"/><path d="M14,56 Q35,70 56,56" fill="#2a2000" stroke="#ffffcc" stroke-width="2.5"/><polygon points="3,12 0,24 12,24" fill="#ffee44" opacity=".85"/><polygon points="67,12 70,24 58,24" fill="#ffee44" opacity=".85"/></svg>` },
        { id:238, name:"Aurora Blessing",    type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"All LIGHT monsters you control gain 600 ATK and DEF until the End Phase. Draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffee88" stroke-width="2"/><circle cx="35" cy="35" r="14" fill="#221a00" stroke="#ffcc44" stroke-width="2"/><line x1="35" y1="12" x2="35" y2="21" stroke="#ffee88" stroke-width="2.5"/><line x1="35" y1="49" x2="35" y2="58" stroke="#ffee88" stroke-width="2.5"/><line x1="12" y1="35" x2="21" y2="35" stroke="#ffee88" stroke-width="2.5"/><line x1="49" y1="35" x2="58" y2="35" stroke="#ffee88" stroke-width="2.5"/><line x1="19" y1="19" x2="26" y2="26" stroke="#ffdd66" stroke-width="2"/><line x1="51" y1="19" x2="44" y2="26" stroke="#ffdd66" stroke-width="2"/><line x1="19" y1="51" x2="26" y2="44" stroke="#ffdd66" stroke-width="2"/><line x1="51" y1="51" x2="44" y2="44" stroke="#ffdd66" stroke-width="2"/><circle cx="35" cy="35" r="6" fill="#ffee88"/></svg>` },
        { id:239, name:"Heaven's Light",     type:"SPELL",   attribute:"SPELL", rarity:"R",
          desc:"Gain 1500 LP. Draw 1 card.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffcc44" stroke-width="2"/><ellipse cx="35" cy="28" rx="18" ry="12" fill="#221a00" stroke="#ffee88" stroke-width="1.5"/><line x1="35" y1="40" x2="35" y2="58" stroke="#ffcc33" stroke-width="3"/><path d="M20,58 Q35,50 50,58" fill="none" stroke="#ddaa44" stroke-width="2"/><circle cx="35" cy="28" r="8" fill="#ffeeaa" opacity=".5"/></svg>` },
        { id:240, name:"Aurora Veil",        type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when an opponent's monster declares an attack: Negate that attack and gain 1000 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffcc44" stroke-width="2"/><ellipse cx="35" cy="35" rx="22" ry="18" fill="#1e1800" stroke="#ffee88" stroke-width="2"/><ellipse cx="35" cy="35" rx="14" ry="11" fill="none" stroke="#ffcc44" stroke-width="1.5" opacity=".7"/><ellipse cx="35" cy="35" rx="7" ry="6" fill="#2a2200" stroke="#ffaa22" stroke-width="1"/><line x1="35" y1="17" x2="35" y2="53" stroke="#ffee88" stroke-width="1.5" opacity=".5"/><line x1="13" y1="35" x2="57" y2="35" stroke="#ffee88" stroke-width="1.5" opacity=".5"/></svg>` },
        { id:241, name:"Holy Barrier",       type:"TRAP",    attribute:"TRAP",  rarity:"R",
          desc:"Activate when your opponent activates a Spell: Negate it and gain 800 LP.",
          artIcon:`<svg width="70" height="70" viewBox="0 0 70 70"><rect x="8" y="8" width="54" height="54" rx="8" fill="#14100a" stroke="#ffdd66" stroke-width="2"/><polygon points="35,14 48,42 22,42" fill="#221a00" stroke="#ffcc44" stroke-width="1.5"/><circle cx="35" cy="35" r="10" fill="#1a1600" stroke="#ffee88" stroke-width="2"/><line x1="22" y1="22" x2="48" y2="48" stroke="#ffcc44" stroke-width="2" opacity=".6"/><line x1="48" y1="22" x2="22" y2="48" stroke="#ffcc44" stroke-width="2" opacity=".6"/><circle cx="35" cy="35" r="4" fill="#ffdd66"/></svg>` }
        ];

        // UPDATED PACKS WITH NEW CARDS
        const PACKS = [
            { id: 'p1', name: "Starter Circuit", cost: 5,   color: "from-blue-600 to-blue-400",
              list: [1,2,4,5,6,7,8,11,12,16,17,51,52,55,56,70,72,74,
                     85,85,85,86,87,87,87,88,89,90,90,90,91,92,96,96,96,98,98,98] },
            { id: 'p2', name: "Magma & Metal",   cost: 15,  color: "from-red-600 to-yellow-500",
              list: [3,6,8,13,17,30,33,50,53,54,57,71,75,1,20,60,87,87,88,91,91,93,94,94,95,97,97,98,101,103,105,165,166,167,168,169,170,171,172,173] },
            { id: 'p3', name: "Cyber Chaos",     cost: 30,  color: "from-purple-600 to-pink-500",
              list: [10,14,15,30,31,32,50,53,71,73,3,10,32,19,59,76,93,93,95,97,99,100,102,104,106,107,89,92,174,175,176,177,178,179,180,181,182,183,184,185,186] },
            { id: 'p4', name: "Apex Genesis",    cost: 50,  color: "from-yellow-300 via-white to-pink-400", levelReq: 5,
              list: [18,21,34,58,77,20,19,32,10,15,59,76,60,73,50,99,100,101,102,103,104,105,106,107,187,188,189,190,191,192,193,194,195,196] },
            { id: 'p5', name: "Apex Vault",      cost: 500, color: "from-yellow-300 via-fuchsia-500 to-cyan-400",
              singleCard: true, levelReq: 10,
              list: [
                18,18,19,19,20,20,21,21,31,31,32,32,
                80,80,80, 81,81,81, 82,82, 83,83,83, 84,84,84,
                104,104,106,106
              ] },
            //  Collection-exclusive packs (internal  not shown in Packs tab) 
            { id: 'pNem', name: "Nemesis Collection Pack", cost: 0, color: "from-purple-900 to-violet-700",
              internal: true,
              list: [
                // Exclusive Nemesis cards (145-154)  weighted heavier
                145,145,146,146,146,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,
                // Best existing cards as bonus pulls
                135,135,136,136,137,137,138,138,139,139,
                104,106,107,73,76,99,100,102
              ] },
            { id: 'pOmg', name: "Omega Source Pack",       cost: 0, color: "from-yellow-900 to-amber-600",
              internal: true,
              list: [
                // God-tier Omega exclusives (155-164)  weighted heavier
                155,155,155,156,156,156,157,157,157,158,158,158,159,159,159,160,160,161,161,162,162,163,163,163,164,164,
                // Ultra-rare bonus pulls from existing pool
                140,140,141,141,142,142,143,143,144,144,
                81,82,83,84,106,107
              ] },
        ];

        //  CARD SLEEVES 
        const CARD_SLEEVES = [
            { id:'slv_default', name:'Classic Indigo',  cost:0,   border:'#6366f1', icon:'',
              desc:'Deep indigo diamond lattice weave  the timeless duelist standard.',
              gradient:'repeating-linear-gradient(45deg,#0d0b2a,#0d0b2a 11px,#1e1b4b 11px,#1e1b4b 22px)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si0" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0d0b2a"/><stop offset="100%" stop-color="#2e2c7a"/></linearGradient></defs><rect width="72" height="98" fill="url(#si0)"/><g stroke="#4f46e5" stroke-width="0.6" opacity="0.42"><line x1="-4" y1="0" x2="76" y2="98"/><line x1="12" y1="0" x2="92" y2="98"/><line x1="28" y1="0" x2="108" y2="98"/><line x1="-20" y1="0" x2="60" y2="98"/><line x1="76" y1="0" x2="-4" y2="98"/><line x1="60" y1="0" x2="-20" y2="98"/><line x1="44" y1="0" x2="-36" y2="98"/><line x1="92" y1="0" x2="12" y2="98"/></g><polygon points="36,33 52,49 36,65 20,49" fill="#1e1b60" stroke="#818cf8" stroke-width="1.5"/><polygon points="36,39 46,49 36,59 26,49" fill="#3730a3" stroke="#6366f1" stroke-width="1"/><circle cx="36" cy="49" r="5" fill="#4f46e5"/><circle cx="36" cy="49" r="2" fill="#c7d2fe"/></svg>` },
            { id:'slv_neon',    name:'Neon Circuit',    cost:150, border:'#00e5ff', icon:'',
              desc:'PCB circuit traces crackle across a midnight-blue card back.',
              gradient:'repeating-linear-gradient(90deg,#020d1a,#020d1a 15px,#031828 15px,#031828 16px),repeating-linear-gradient(0deg,#020d1a,#020d1a 15px,#031828 15px,#031828 16px)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#020d1a"/><stop offset="100%" stop-color="#041a2e"/></linearGradient></defs><rect width="72" height="98" fill="url(#si1)"/><g stroke="#00e5ff" stroke-width="0.8" opacity="0.55"><line x1="5" y1="18" x2="40" y2="18"/><line x1="40" y1="18" x2="40" y2="30"/><line x1="40" y1="30" x2="67" y2="30"/><line x1="5" y1="42" x2="22" y2="42"/><line x1="22" y1="42" x2="22" y2="58"/><line x1="22" y1="58" x2="62" y2="58"/><line x1="62" y1="58" x2="62" y2="72"/><line x1="62" y1="72" x2="40" y2="72"/><line x1="12" y1="78" x2="40" y2="78"/><line x1="67" y1="18" x2="67" y2="30"/><line x1="5" y1="85" x2="22" y2="85"/><line x1="50" y1="85" x2="67" y2="85"/></g><g fill="#00e5ff" opacity="0.9"><circle cx="40" cy="18" r="2.5"/><circle cx="40" cy="30" r="2.5"/><circle cx="22" cy="42" r="2.5"/><circle cx="22" cy="58" r="2.5"/><circle cx="62" cy="58" r="2.5"/><circle cx="62" cy="72" r="2.5"/></g><rect x="27" y="39" width="18" height="20" rx="2" fill="#02111e" stroke="#00e5ff" stroke-width="1.2"/><g stroke="#00e5ff" stroke-width="0.5" opacity="0.6"><line x1="30" y1="39" x2="30" y2="59"/><line x1="34" y1="39" x2="34" y2="59"/><line x1="38" y1="39" x2="38" y2="59"/><line x1="42" y1="39" x2="42" y2="59"/></g><circle cx="36" cy="49" r="4" fill="#010d18" stroke="#00e5ff" stroke-width="1"/><circle cx="36" cy="49" r="1.8" fill="#00e5ff"/></svg>` },
            { id:'slv_dragon',  name:'Dragon Scale',    cost:200, border:'#ef4444', icon:'',
              desc:'Overlapping crimson dragon scales tessellated on obsidian  fierce and primal.',
              gradient:'repeating-radial-gradient(circle at 0% 50%,transparent 28%,rgba(127,29,29,0.55) 29%,rgba(127,29,29,0.55) 34%,transparent 35%),repeating-radial-gradient(circle at 100% 50%,transparent 28%,rgba(127,29,29,0.55) 29%,rgba(127,29,29,0.55) 34%,transparent 35%),linear-gradient(160deg,#0e0000,#2a0000)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0e0000"/><stop offset="100%" stop-color="#3a0000"/></linearGradient></defs><rect width="72" height="98" fill="url(#si2)"/><g stroke="#7f1d1d" stroke-width="0.9" fill="none" opacity="0.75"><path d="M0,10 Q18,2 36,10 Q54,2 72,10"/><path d="M-18,10 Q0,2 18,10 Q36,2 54,10 Q72,2 90,10"/><path d="M-18,22 Q0,14 18,22 Q36,14 54,22 Q72,14 90,22"/><path d="M0,22 Q18,14 36,22 Q54,14 72,22"/><path d="M0,34 Q18,26 36,34 Q54,26 72,34"/><path d="M-18,34 Q0,26 18,34 Q36,26 54,34 Q72,26 90,34"/><path d="M-18,46 Q0,38 18,46 Q36,38 54,46 Q72,38 90,46"/><path d="M0,46 Q18,38 36,46 Q54,38 72,46"/><path d="M0,58 Q18,50 36,58 Q54,50 72,58"/><path d="M-18,58 Q0,50 18,58 Q36,50 54,58 Q72,50 90,58"/><path d="M-18,70 Q0,62 18,70 Q36,62 54,70 Q72,62 90,70"/><path d="M0,70 Q18,62 36,70 Q54,62 72,70"/><path d="M0,82 Q18,74 36,82 Q54,74 72,82"/><path d="M-18,82 Q0,74 18,82 Q36,74 54,82 Q72,74 90,82"/><path d="M-18,94 Q0,86 18,94 Q36,86 54,94 Q72,86 90,94"/></g><circle cx="36" cy="49" r="14" fill="#1a0000" stroke="#ef4444" stroke-width="1.5" opacity="0.85"/><polygon points="36,39 44,50 36,58 28,50" fill="#2a0000" stroke="#dc2626" stroke-width="1.2"/><circle cx="36" cy="49" r="5" fill="#7f1d1d"/><circle cx="36" cy="49" r="2" fill="#f87171"/></svg>` },
            { id:'slv_rune',    name:'Mystic Runes',    cost:180, border:'#c084fc', icon:'',
              desc:'Ancient runic alphabet glows with eldritch energy on dark obsidian.',
              gradient:'radial-gradient(ellipse at 50% 50%,#1a0030 0%,#0d0014 100%)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si3" x1="0.5" y1="0" x2="0.5" y2="1"><stop offset="0%" stop-color="#0d0014"/><stop offset="100%" stop-color="#1a0035"/></linearGradient></defs><rect width="72" height="98" fill="url(#si3)"/><g stroke="#581c87" stroke-width="0.4" opacity="0.4"><line x1="0" y1="25" x2="72" y2="25"/><line x1="0" y1="50" x2="72" y2="50"/><line x1="0" y1="75" x2="72" y2="75"/><line x1="18" y1="0" x2="18" y2="98"/><line x1="54" y1="0" x2="54" y2="98"/></g><g font-family="serif" font-size="11" fill="#c084fc" opacity="0.62" text-anchor="middle"><text x="9" y="17"></text><text x="27" y="13"></text><text x="45" y="17"></text><text x="63" y="13"></text><text x="6" y="40"></text><text x="66" y="40"></text><text x="9" y="90"></text><text x="27" y="94"></text><text x="45" y="90"></text><text x="63" y="94"></text><text x="6" y="67"></text><text x="66" y="67"></text></g><circle cx="36" cy="49" r="16" fill="#1a0030" stroke="#9333ea" stroke-width="1.5"/><ellipse cx="36" cy="49" rx="10" ry="6" fill="#0d0020" stroke="#c084fc" stroke-width="1.2"/><circle cx="36" cy="49" r="5" fill="#2d0060" stroke="#a855f7" stroke-width="1"/><circle cx="36" cy="49" r="2" fill="#e879f9"/><circle cx="36" cy="49" r="16" fill="none" stroke="#7e22ce" stroke-width="0.8" stroke-dasharray="3,3"/></svg>` },
            { id:'slv_plasma',  name:'Plasma Storm',    cost:250, border:'#38bdf8', icon:'',
              desc:'Jagged lightning bolts radiate from a white-hot core of raw energy.',
              gradient:'repeating-linear-gradient(60deg,#020818,#020818 12px,#03102a 12px,#03102a 13px),repeating-linear-gradient(-60deg,#020818,#020818 12px,#03102a 12px,#03102a 13px)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si4" x1="0.5" y1="0" x2="0.5" y2="1"><stop offset="0%" stop-color="#020818"/><stop offset="100%" stop-color="#030f28"/></linearGradient><radialGradient id="gl4" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#38bdf8" stop-opacity="0.35"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><rect width="72" height="98" fill="url(#si4)"/><circle cx="36" cy="49" r="30" fill="url(#gl4)"/><g stroke="#bfdbfe" stroke-width="1.2" fill="none" opacity="0.8"><polyline points="36,49 33,38 36,32 31,20"/><polyline points="36,49 24,44 18,47 8,43"/><polyline points="36,49 42,37 45,30 53,16"/><polyline points="36,49 46,51 54,48 64,50"/><polyline points="36,49 40,61 38,69 44,81"/><polyline points="36,49 26,56 22,64 12,72"/></g><g stroke="#7dd3fc" stroke-width="1.8" fill="none" opacity="0.9"><polyline points="36,49 34,43 37,36"/><polyline points="36,49 42,47 47,51"/><polyline points="36,49 34,55 38,63"/><polyline points="36,49 30,51 25,47"/></g><circle cx="36" cy="49" r="5" fill="#0c4a6e" stroke="#38bdf8" stroke-width="1.5"/><circle cx="36" cy="49" r="2" fill="#7dd3fc"/></svg>` },
            { id:'slv_shadow',  name:'Shadow Realm',    cost:300, border:'#a855f7', icon:'',
              desc:'A concentric void vortex spirals into absolute darkness. Consume your opponents.',
              gradient:'radial-gradient(ellipse at 50% 50%,#220050 0%,#100030 40%,#000000 100%)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><radialGradient id="si5" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#220050"/><stop offset="40%" stop-color="#100030"/><stop offset="100%" stop-color="#000000"/></radialGradient></defs><rect width="72" height="98" fill="black"/><rect width="72" height="98" fill="url(#si5)"/><g stroke="#7c3aed" fill="none" opacity="0.55"><ellipse cx="36" cy="49" rx="32" ry="22" stroke-width="0.6"/><ellipse cx="36" cy="49" rx="26" ry="17" stroke-width="0.7"/><ellipse cx="36" cy="49" rx="20" ry="13" stroke-width="0.8"/><ellipse cx="36" cy="49" rx="14" ry="9" stroke-width="0.9"/><ellipse cx="36" cy="49" rx="8" ry="5" stroke-width="1.0"/></g><g stroke="#a855f7" stroke-width="0.7" fill="none" opacity="0.42"><path d="M36,49 Q20,30 10,20"/><path d="M36,49 Q50,30 60,18"/><path d="M36,49 Q52,60 62,72"/><path d="M36,49 Q20,62 10,74"/></g><circle cx="36" cy="49" r="10" fill="#000" stroke="#a855f7" stroke-width="1.5"/><circle cx="36" cy="49" r="4" fill="#1a0040" stroke="#c084fc" stroke-width="1"/><circle cx="36" cy="49" r="1.5" fill="#e879f9"/></svg>` },
            { id:'slv_gold',    name:'Gold Foil Elite', cost:350, border:'#fbbf24', icon:'',
              desc:'Mirror-polished Art Deco gold filigree on a velvet-black canvas. Pure prestige.',
              gradient:'repeating-linear-gradient(45deg,#1a0f00,#1a0f00 11px,#261500 11px,#261500 12px),repeating-linear-gradient(-45deg,#1a0f00,#1a0f00 11px,#261500 11px,#261500 12px)',
              svgPreview:`<svg width="72" height="98" viewBox="0 0 72 98"><defs><linearGradient id="si6" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#1a0f00"/><stop offset="50%" stop-color="#2d1900"/><stop offset="100%" stop-color="#3a2200"/></linearGradient></defs><rect width="72" height="98" fill="url(#si6)"/><g stroke="#92400e" stroke-width="0.7" fill="none" opacity="0.72"><path d="M4,4 L20,4 L20,6 L6,6 L6,20 L4,20 Z"/><path d="M8,8 Q12,8 12,12 Q12,16 16,16"/><path d="M68,4 L52,4 L52,6 L66,6 L66,20 L68,20 Z"/><path d="M64,8 Q60,8 60,12 Q60,16 56,16"/><path d="M4,94 L20,94 L20,92 L6,92 L6,78 L4,78 Z"/><path d="M8,90 Q12,90 12,86 Q12,82 16,82"/><path d="M68,94 L52,94 L52,92 L66,92 L66,78 L68,78 Z"/><path d="M64,90 Q60,90 60,86 Q60,82 56,82"/></g><g stroke="#92400e" stroke-width="0.5" opacity="0.28"><line x1="4" y1="4" x2="68" y2="94"/><line x1="68" y1="4" x2="4" y2="94"/></g><g fill="#b45309" opacity="0.8"><circle cx="8" cy="8" r="2"/><circle cx="64" cy="8" r="2"/><circle cx="8" cy="90" r="2"/><circle cx="64" cy="90" r="2"/></g><circle cx="36" cy="49" r="18" fill="#1a0f00" stroke="#ca8a04" stroke-width="1.5"/><polygon points="36,34 39,44 49,44 41,51 44,61 36,55 28,61 31,51 23,44 33,44" fill="#2d1a00" stroke="#f59e0b" stroke-width="1.2"/><circle cx="36" cy="49" r="7" fill="#3d2700" stroke="#fbbf24" stroke-width="1"/><circle cx="36" cy="49" r="3" fill="#f59e0b"/></svg>` },
        ];

        //  PLAYMATS 
        const PLAYMATS = [
            { id:'mat_default',  name:'Standard Arena',  cost:0,   accent:'#00e5ff', icon:'',
              desc:'The clean professional tournament field. Timeless.',
              bg:'linear-gradient(180deg,#071224 0%,#0a1628 40%,#081820 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><linearGradient id="pm0" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#071224"/><stop offset="100%" stop-color="#081820"/></linearGradient></defs><rect width="140" height="70" fill="url(#pm0)"/><line x1="70" y1="0" x2="70" y2="70" stroke="#1e3a5f" stroke-width="1.5"/><g stroke="#00e5ff" stroke-width="0.7" fill="none" opacity="0.5"><rect x="15" y="8" width="14" height="14" rx="2"/><rect x="33" y="8" width="14" height="14" rx="2"/><rect x="51" y="8" width="14" height="14" rx="2"/><rect x="77" y="48" width="14" height="14" rx="2"/><rect x="95" y="48" width="14" height="14" rx="2"/><rect x="113" y="48" width="14" height="14" rx="2"/></g><g stroke="#4ade80" stroke-width="0.6" fill="none" opacity="0.4"><rect x="15" y="26" width="14" height="10" rx="1"/><rect x="33" y="26" width="14" height="10" rx="1"/><rect x="51" y="26" width="14" height="10" rx="1"/><rect x="77" y="34" width="14" height="10" rx="1"/><rect x="95" y="34" width="14" height="10" rx="1"/><rect x="113" y="34" width="14" height="10" rx="1"/></g><circle cx="5" cy="35" r="7" fill="none" stroke="#00e5ff" stroke-width="0.6" opacity="0.4"/><circle cx="135" cy="35" r="7" fill="none" stroke="#00e5ff" stroke-width="0.6" opacity="0.4"/><line x1="0" y1="35" x2="140" y2="35" stroke="#00e5ff" stroke-width="0.4" opacity="0.2"/></svg>` },
            { id:'mat_cyber',    name:'Cyber Arena',     cost:200, accent:'#00e5ff', icon:'',
              desc:'Holographic hexagonal grid above a neon city skyline. The future of dueling.',
              bg:'linear-gradient(180deg,#000d1a 0%,#001228 60%,#000a1a 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><linearGradient id="pm1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#000d1a"/><stop offset="100%" stop-color="#001228"/></linearGradient></defs><rect width="140" height="70" fill="url(#pm1)"/><g stroke="#00e5ff" stroke-width="0.5" fill="none" opacity="0.3"><polygon points="10,5 18,5 22,12 18,19 10,19 6,12"/><polygon points="28,5 36,5 40,12 36,19 28,19 24,12"/><polygon points="46,5 54,5 58,12 54,19 46,19 42,12"/><polygon points="64,5 72,5 76,12 72,19 64,19 60,12"/><polygon points="82,5 90,5 94,12 90,19 82,19 78,12"/><polygon points="100,5 108,5 112,12 108,19 100,19 96,12"/><polygon points="118,5 126,5 130,12 126,19 118,19 114,12"/><polygon points="19,19 27,19 31,26 27,33 19,33 15,26"/><polygon points="37,19 45,19 49,26 45,33 37,33 33,26"/><polygon points="55,19 63,19 67,26 63,33 55,33 51,26"/><polygon points="73,19 81,19 85,26 81,33 73,33 69,26"/><polygon points="91,19 99,19 103,26 99,33 91,33 87,26"/><polygon points="109,19 117,19 121,26 117,33 109,33 105,26"/><polygon points="10,33 18,33 22,40 18,47 10,47 6,40"/><polygon points="28,33 36,33 40,40 36,47 28,47 24,40"/><polygon points="46,33 54,33 58,40 54,47 46,47 42,40"/><polygon points="64,33 72,33 76,40 72,47 64,47 60,40"/><polygon points="82,33 90,33 94,40 90,47 82,47 78,40"/><polygon points="100,33 108,33 112,40 108,47 100,47 96,40"/><polygon points="118,33 126,33 130,40 126,47 118,47 114,40"/><polygon points="19,47 27,47 31,54 27,61 19,61 15,54"/><polygon points="37,47 45,47 49,54 45,61 37,61 33,54"/><polygon points="55,47 63,47 67,54 63,61 55,61 51,54"/><polygon points="73,47 81,47 85,54 81,61 73,61 69,54"/><polygon points="91,47 99,47 103,54 99,61 91,61 87,54"/><polygon points="109,47 117,47 121,54 117,61 109,61 105,54"/></g><g fill="#001020" opacity="0.95"><rect x="0" y="62" width="140" height="8"/><rect x="5" y="55" width="7" height="15"/><rect x="18" y="57" width="11" height="13"/><rect x="35" y="52" width="6" height="18"/><rect x="46" y="56" width="9" height="14"/><rect x="60" y="50" width="7" height="20"/><rect x="72" y="54" width="9" height="16"/><rect x="87" y="52" width="5" height="18"/><rect x="97" y="56" width="11" height="14"/><rect x="114" y="54" width="7" height="16"/><rect x="128" y="57" width="6" height="13"/></g><line x1="0" y1="62" x2="140" y2="62" stroke="#00e5ff" stroke-width="1" opacity="0.7"/><g fill="#00e5ff" opacity="0.7"><circle cx="22" cy="26" r="1.5"/><circle cx="58" cy="26" r="1.5"/><circle cx="94" cy="26" r="1.5"/><circle cx="40" cy="40" r="1.5"/><circle cx="76" cy="40" r="1.5"/><circle cx="112" cy="40" r="1.5"/></g></svg>` },
            { id:'mat_ancient',  name:'Ancient Temple',  cost:180, accent:'#d97706', icon:'',
              desc:'Torchlit stone ruins with hieroglyphic carvings and the watching Eye of Ra.',
              bg:'linear-gradient(180deg,#1a0e05 0%,#2a1608 50%,#200e04 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><linearGradient id="pm2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a0e05"/><stop offset="100%" stop-color="#2d1808"/></linearGradient></defs><rect width="140" height="70" fill="url(#pm2)"/><g stroke="#3d2510" stroke-width="0.6" fill="none" opacity="0.6"><line x1="0" y1="14" x2="140" y2="14"/><line x1="0" y1="28" x2="140" y2="28"/><line x1="0" y1="42" x2="140" y2="42"/><line x1="0" y1="56" x2="140" y2="56"/><line x1="20" y1="0" x2="20" y2="14"/><line x1="50" y1="0" x2="50" y2="14"/><line x1="80" y1="0" x2="80" y2="14"/><line x1="110" y1="0" x2="110" y2="14"/><line x1="10" y1="14" x2="10" y2="28"/><line x1="40" y1="14" x2="40" y2="28"/><line x1="70" y1="14" x2="70" y2="28"/><line x1="100" y1="14" x2="100" y2="28"/><line x1="130" y1="14" x2="130" y2="28"/><line x1="22" y1="28" x2="22" y2="42"/><line x1="52" y1="28" x2="52" y2="42"/><line x1="82" y1="28" x2="82" y2="42"/><line x1="112" y1="28" x2="112" y2="42"/><line x1="12" y1="42" x2="12" y2="56"/><line x1="42" y1="42" x2="42" y2="56"/><line x1="72" y1="42" x2="72" y2="56"/><line x1="102" y1="42" x2="102" y2="56"/><line x1="132" y1="42" x2="132" y2="56"/><line x1="25" y1="56" x2="25" y2="70"/><line x1="55" y1="56" x2="55" y2="70"/><line x1="85" y1="56" x2="85" y2="70"/><line x1="115" y1="56" x2="115" y2="70"/></g><path d="M52,70 L52,40 Q70,22 88,40 L88,70" fill="#170b02" stroke="#92400e" stroke-width="1.2" opacity="0.9"/><ellipse cx="70" cy="44" rx="9" ry="6" fill="#2d1808" stroke="#d97706" stroke-width="1"/><circle cx="70" cy="44" r="4" fill="#1a1000" stroke="#f59e0b" stroke-width="0.8"/><circle cx="70" cy="44" r="2" fill="#d97706"/><line x1="61" y1="44" x2="58" y2="44" stroke="#d97706" stroke-width="0.8"/><line x1="79" y1="44" x2="82" y2="44" stroke="#d97706" stroke-width="0.8"/><line x1="64" y1="48" x2="62" y2="51" stroke="#d97706" stroke-width="0.8"/><line x1="76" y1="48" x2="78" y2="51" stroke="#d97706" stroke-width="0.8"/><circle cx="5" cy="35" r="6" fill="#92400e" opacity="0.35"/><circle cx="5" cy="35" r="3" fill="#d97706" opacity="0.5"/><circle cx="135" cy="35" r="6" fill="#92400e" opacity="0.35"/><circle cx="135" cy="35" r="3" fill="#d97706" opacity="0.5"/></svg>` },
            { id:'mat_void',     name:'Void Dimension',  cost:250, accent:'#a78bfa', icon:'',
              desc:'A swirling cosmic portal opens beneath the field. Stars, nebulae, and oblivion.',
              bg:'radial-gradient(ellipse at 50% 50%,#1a0040 0%,#0a0020 50%,#000000 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><radialGradient id="pm3a" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#1a0040"/><stop offset="50%" stop-color="#0a0020"/><stop offset="100%" stop-color="#000000"/></radialGradient><radialGradient id="pm3b" cx="30%" cy="40%" r="40%"><stop offset="0%" stop-color="#4c1d95" stop-opacity="0.45"/><stop offset="100%" stop-color="transparent"/></radialGradient><radialGradient id="pm3c" cx="70%" cy="65%" r="35%"><stop offset="0%" stop-color="#1e40af" stop-opacity="0.4"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><rect width="140" height="70" fill="url(#pm3a)"/><rect width="140" height="70" fill="url(#pm3b)"/><rect width="140" height="70" fill="url(#pm3c)"/><g fill="white"><circle cx="12" cy="8" r="0.8"/><circle cx="28" cy="15" r="0.6"/><circle cx="45" cy="5" r="0.9"/><circle cx="60" cy="18" r="0.6"/><circle cx="72" cy="7" r="0.7"/><circle cx="88" cy="12" r="0.8"/><circle cx="105" cy="4" r="0.6"/><circle cx="118" cy="16" r="0.7"/><circle cx="132" cy="9" r="0.9"/><circle cx="8" cy="32" r="0.6"/><circle cx="35" cy="38" r="0.7"/><circle cx="52" cy="28" r="0.5"/><circle cx="95" cy="35" r="0.8"/><circle cx="110" cy="25" r="0.6"/><circle cx="128" cy="34" r="0.7"/><circle cx="18" cy="55" r="0.7"/><circle cx="40" cy="62" r="0.5"/><circle cx="68" cy="52" r="0.9"/><circle cx="80" cy="65" r="0.6"/><circle cx="100" cy="57" r="0.7"/><circle cx="125" cy="60" r="0.8"/></g><ellipse cx="70" cy="35" rx="28" ry="18" fill="none" stroke="#7c3aed" stroke-width="0.8" opacity="0.5"/><ellipse cx="70" cy="35" rx="20" ry="13" fill="none" stroke="#6d28d9" stroke-width="0.7" opacity="0.6"/><ellipse cx="70" cy="35" rx="13" ry="8" fill="none" stroke="#8b5cf6" stroke-width="0.8" opacity="0.7"/><ellipse cx="70" cy="35" rx="7" ry="4.5" fill="#0a0020" stroke="#a78bfa" stroke-width="1" opacity="0.8"/><circle cx="70" cy="35" r="3" fill="#1a0040" stroke="#c4b5fd" stroke-width="0.8"/><circle cx="70" cy="35" r="1.2" fill="#ede9fe"/></svg>` },
            { id:'mat_volcanic', name:'Volcanic Core',   cost:220, accent:'#f97316', icon:'',
              desc:'Glowing lava crack networks pulse with heat through dark fragmented stone.',
              bg:'linear-gradient(180deg,#1a0300 0%,#0f0100 60%,#1a0300 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><linearGradient id="pm4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a0300"/><stop offset="100%" stop-color="#0d0100"/></linearGradient></defs><rect width="140" height="70" fill="url(#pm4)"/><g stroke="#2a0800" stroke-width="1.2" opacity="0.8"><line x1="0" y1="20" x2="45" y2="15"/><line x1="45" y1="15" x2="70" y2="22"/><line x1="70" y1="22" x2="100" y2="12"/><line x1="100" y1="12" x2="140" y2="18"/><line x1="0" y1="48" x2="30" y2="42"/><line x1="30" y1="42" x2="70" y2="50"/><line x1="70" y1="50" x2="95" y2="40"/><line x1="95" y1="40" x2="140" y2="46"/><line x1="20" y1="8" x2="20" y2="28"/><line x1="50" y1="5" x2="45" y2="25"/><line x1="90" y1="3" x2="88" y2="22"/><line x1="120" y1="8" x2="118" y2="30"/><line x1="15" y1="40" x2="12" y2="65"/><line x1="50" y1="38" x2="48" y2="68"/><line x1="85" y1="42" x2="82" y2="70"/><line x1="115" y1="38" x2="113" y2="66"/></g><g stroke="#ea580c" stroke-width="1.5" fill="none" opacity="0.85"><path d="M0,22 Q15,18 20,28 Q28,35 45,30 Q60,24 70,35 Q80,44 95,38 Q108,30 120,38 Q132,44 140,40"/><path d="M20,8 Q22,15 30,20 Q35,28 45,30"/><path d="M90,5 Q88,12 88,22 Q90,30 95,38"/><path d="M0,48 Q12,44 15,55 Q18,62 30,65"/><path d="M95,40 Q100,50 100,65"/><path d="M120,38 Q125,50 128,65"/></g><g stroke="#fb923c" stroke-width="0.8" fill="none" opacity="0.6"><path d="M0,22 Q15,18 20,28 Q28,35 45,30 Q60,24 70,35 Q80,44 95,38 Q108,30 120,38 Q132,44 140,40"/></g><circle cx="20" cy="28" r="5" fill="#7c2d12" opacity="0.5"/><circle cx="70" cy="35" r="8" fill="#7c2d12" opacity="0.5"/><circle cx="95" cy="38" r="5" fill="#7c2d12" opacity="0.5"/><circle cx="70" cy="35" r="3.5" fill="#f97316" opacity="0.6"/></svg>` },
            { id:'mat_crystal',  name:'Crystal Palace',  cost:300, accent:'#67e8f9', icon:'',
              desc:'Towering ice crystal facets refract cold light across the dueling plain.',
              bg:'linear-gradient(160deg,#001020 0%,#001a30 50%,#002040 100%)',
              svgPreview:`<svg width="140" height="70" viewBox="0 0 140 70"><defs><linearGradient id="pm5" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#001020"/><stop offset="50%" stop-color="#001a2e"/><stop offset="100%" stop-color="#00243c"/></linearGradient></defs><rect width="140" height="70" fill="url(#pm5)"/><g stroke="#67e8f9" stroke-width="0.6" fill="none" opacity="0.4"><polygon points="0,0 28,0 42,22 14,35 0,20"/><polygon points="28,0 70,0 60,18 42,22"/><polygon points="70,0 112,0 98,22 80,18 60,18"/><polygon points="112,0 140,0 140,22 126,35 98,22"/><polygon points="0,20 14,35 0,50"/><polygon points="0,50 14,35 28,52 14,70 0,70"/><polygon points="14,35 42,22 56,45 28,52"/><polygon points="42,22 60,18 80,18 70,42 56,45"/><polygon points="80,18 98,22 112,38 96,50 70,42"/><polygon points="98,22 126,35 140,50 140,22"/><polygon points="126,35 140,50 140,70 126,65 112,55 112,38"/><polygon points="96,50 112,55 126,65 112,70 84,70 78,58"/><polygon points="56,45 70,42 78,58 84,70 56,70 40,58"/><polygon points="28,52 56,45 40,58 14,70"/></g><g stroke="#a5f3fc" stroke-width="1.1" opacity="0.6"><line x1="28" y1="0" x2="42" y2="22"/><line x1="70" y1="0" x2="60" y2="18"/><line x1="112" y1="0" x2="98" y2="22"/><line x1="42" y1="22" x2="56" y2="45"/><line x1="80" y1="18" x2="70" y2="42"/><line x1="98" y1="22" x2="112" y2="38"/></g><polygon points="70,14 80,35 70,56 60,35" fill="#001a2e" stroke="#67e8f9" stroke-width="1.5" opacity="0.9"/><polygon points="70,22 76,35 70,48 64,35" fill="#002a40" stroke="#a5f3fc" stroke-width="1"/><circle cx="70" cy="35" r="4" fill="#003a52" stroke="#e0f2fe" stroke-width="1"/><circle cx="70" cy="35" r="2" fill="#67e8f9"/></svg>` },
        ];

        //  PLAYER ICONS 
        const PLAYER_ICONS = [
            { id:'icon_lightning', emoji:'', name:'Lightning',   cost:0,   desc:'The shock that started it all.' },
            { id:'icon_sword',     emoji:'', name:'Duelist',     cost:250, desc:'Born to battle. Nothing more.' },
            { id:'icon_fire',      emoji:'', name:'Blaze',       cost:300, desc:'Burn everything in your path.' },
            { id:'icon_wolf',      emoji:'', name:'Pack Leader', cost:380, desc:'Hunt alone. Rule the field.' },
            { id:'icon_skull',     emoji:'', name:'Reaper',      cost:400, desc:'Feared on every duel floor.' },
            { id:'icon_moon',      emoji:'', name:'Shadow Moon', cost:450, desc:'Strikes when no one is watching.' },
            { id:'icon_robot',     emoji:'', name:'Cyber Core',  cost:550, desc:'Cold logic. Total efficiency.' },
            { id:'icon_eye',       emoji:'', name:'All-Seeing',  cost:600, desc:'Nothing escapes your gaze.' },
            { id:'icon_gem',       emoji:'', name:'Diamond',     cost:700, desc:'Refined. Unbreakable. Rare.' },
            { id:'icon_crown',     emoji:'', name:'Champion',    cost:800, desc:'Only for those who have earned it.' },
            { id:'icon_dragon',    emoji:'', name:'Dragon King', cost:950, desc:'Ancient power. Commands respect.' },
            { id:'icon_star',      emoji:'', name:'Legend',      cost:1200,desc:'Your name will be remembered.' },
        ];

        //  STRUCTURE DECKS 
        const STRUCTURE_DECKS = [
            { id:'sd1', name:"Dragon's Fury",   cost:150,  color:'from-red-900 to-orange-700',   icon:'', linkedPack:'p2',
              desc:"Unleash fire and fury! 40-card Dragon/FIRE deck with powerful exclusive monsters.",
              maxBuy:3,
              list:[197,197,197,198,198,199,199,200,200,201,202,202,203,203,204,205,205,
                    108,108,108,109,109,110,110,111,111,112,113,113,
                    3,3,17,17,33,87,87,71,75,57] },
            { id:'sd2', name:"Shadow Command",  cost:250,  color:'from-purple-900 to-violet-800', icon:'', linkedPack:'p3',
              desc:"Control the darkness. Trap and spell synergy with exclusive DARK monsters.",
              maxBuy:3,
              list:[215,215,215,216,216,217,217,218,218,219,220,221,222,223,223,
                    114,114,115,115,116,117,117,118,119,
                    10,10,73,76,89,92,100,102,104,32,32,32,93,99,104] },
            { id:'sd3', name:"Aqua Force",      cost:150,  color:'from-blue-900 to-cyan-700',    icon:'', linkedPack:'p1',
              desc:"Flow like water, strike like the tide. 40-card WATER control deck.",
              maxBuy:3,
              list:[206,206,206,207,207,208,208,209,209,210,211,212,213,213,214,214,
                    120,120,121,121,122,122,123,124,
                    1,1,2,4,51,52,55,70,72,85,85,86,91,96,98] },
            { id:'sd4', name:"Cyber Blitz",     cost:500,  color:'from-green-900 to-lime-700',   icon:'', linkedPack:'p4',
              desc:"Machine superiority through overwhelming firepower and effect chains.",
              maxBuy:3,
              list:[224,224,224,225,225,226,226,227,227,228,229,230,231,232,232,
                    125,125,126,126,127,127,128,128,129,129,
                    10,14,15,59,76,93,97,99,32,31,50,71,30,30] },
            { id:'sd5', name:"Holy Light",      cost:500,  color:'from-yellow-700 to-amber-500', icon:'', linkedPack:'p4',
              desc:"Divine radiance on the battlefield. LIGHT monster synergy and LP recovery.",
              maxBuy:3,
              list:[233,233,233,234,234,235,235,236,236,237,238,239,240,241,241,
                    130,130,131,131,132,132,133,134,134,
                    18,21,34,58,77,20,60,101,103,98,90,88,96,105] },
        ];

        //  COLLECTOR BOXES 
        const COLLECTOR_BOXES = [
            { id:'cb1', name:"Nemesis Collection",
              cost:12000, color:'from-gray-800 via-gray-600 to-gray-800',
              glowColor:'rgba(170,170,170,0.5)', borderColor:'#aaaaaa',
              icon:'', icon2:'',
              desc:"Three warm-up packs prepare the way, then 8 Nemesis Collection packs loaded with exclusive DARK-type powerhouses  capped off by one guaranteed pull from the Nemesis Vault.",
              // openSequence drives buyCollectorBox logic
              openSequence: [
                  { packId:'p1', count:1, label:'Starter Circuit Pack' },
                  { packId:'p2', count:1, label:'Magma & Metal Pack' },
                  { packId:'p3', count:1, label:'Cyber Chaos Pack' },
                  { packId:'pNem', count:8, label:'Nemesis Collection Packs' },
              ],
              guaranteedPool:[135,136,137,138,139,145,151,153],
              guaranteedLabel:' Nemesis Vault  Guaranteed UR',
            },
            { id:'cb2', name:"Omega Source",
              cost:20000, color:'from-yellow-900 via-yellow-700 to-yellow-900',
              glowColor:'rgba(255,215,0,0.5)', borderColor:'#ffd700',
              icon:'', icon2:'',
              desc:"Two elite packs for warm-up, then 8 god-tier Omega Source packs bursting with absurdly powerful LIGHT deity cards  sealed with one guaranteed pull from the Omega Vault.",
              openSequence: [
                  { packId:'p3', count:1, label:'Cyber Chaos Pack' },
                  { packId:'p4', count:1, label:'Apex Genesis Pack' },
                  { packId:'pOmg', count:8, label:'Omega Source Packs' },
              ],
              guaranteedPool:[140,141,142,143,144,155,156,157,158,159],
              guaranteedLabel:' Omega Vault  Guaranteed God-Tier UR',
            },
        ];

        // --- 1b. DUELIST DATA ---

        const DUELISTS_POOL = [
            { name: "Byte",     deck: 'Machine Sync',   diff: 1, reward: 25,  rare: false, color: '#00e5ff',
              face: `<circle r="16" fill="#003344" stroke="#00e5ff" stroke-width="2.5"/><rect x="-8" y="-6" width="16" height="9" rx="5" fill="#004466"/><circle cx="-3.5" cy="-2" r="3" fill="#00e5ff"/><circle cx="3.5" cy="-2" r="3" fill="#00e5ff"/><rect x="-4" y="4" width="8" height="2" rx="1" fill="#00e5ff" opacity="0.7"/>` },
            { name: "Aria",     deck: 'Aqua Flow',      diff: 2, reward: 40,  rare: false, color: '#44aaff',
              face: `<circle r="16" fill="#001a33" stroke="#44aaff" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#44aaff" opacity="0.85"/><circle cx="4" cy="-2" r="3.5" fill="#44aaff" opacity="0.85"/><path d="M-5,5 Q0,10 5,5" fill="none" stroke="#44aaff" stroke-width="2"/>` },
            { name: "Blaze",    deck: 'Inferno Rage',   diff: 3, reward: 60,  rare: false, color: '#ff4400',
              face: `<circle r="16" fill="#2a0500" stroke="#ff4400" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#ff4400"/><circle cx="4" cy="-2" r="3.5" fill="#ff4400"/><path d="M-4,6 Q0,11 4,6" fill="none" stroke="#ff8800" stroke-width="2"/><path d="M-7,-12 Q-4,-7 0,-12 Q4,-7 7,-12" fill="none" stroke="#ff8800" stroke-width="1.5"/>` },
            { name: "Viper",    deck: 'Dark Serpent',   diff: 2, reward: 45,  rare: false, color: '#8800ff',
              face: `<circle r="16" fill="#110022" stroke="#8800ff" stroke-width="2.5"/><ellipse cx="-4" cy="-2" rx="3.5" ry="4.5" fill="#660099"/><ellipse cx="4" cy="-2" rx="3.5" ry="4.5" fill="#660099"/><ellipse cx="-4" cy="-2" rx="1.5" ry="2" fill="#ff88ff"/><ellipse cx="4" cy="-2" rx="1.5" ry="2" fill="#ff88ff"/><path d="M-3,6 Q0,10 3,6" fill="none" stroke="#cc00ff" stroke-width="2"/>` },
            { name: "Cipher",   deck: 'Binary Code',    diff: 2, reward: 40,  rare: false, color: '#44ff88',
              face: `<circle r="16" fill="#002211" stroke="#44ff88" stroke-width="2.5"/><rect x="-8" y="-6" width="16" height="11" rx="3" fill="#003322"/><circle cx="-3.5" cy="-1" r="3" fill="#44ff88"/><circle cx="3.5" cy="-1" r="3" fill="#44ff88"/><rect x="-4" y="5" width="8" height="2.5" rx="1" fill="#44ff88" opacity="0.8"/>` },
            { name: "Storm",    deck: 'Volt Strike',    diff: 3, reward: 65,  rare: false, color: '#ffff00',
              face: `<circle r="16" fill="#1a1a00" stroke="#ffff00" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#eeee00"/><circle cx="4" cy="-2" r="3.5" fill="#eeee00"/><path d="M-3,6 Q0,11 3,6" fill="none" stroke="#ffff00" stroke-width="2"/><polyline points="-8,-14 -5,-6" stroke="#ffff00" stroke-width="1.5"/><polyline points="8,-14 5,-6" stroke="#ffff00" stroke-width="1.5"/>` },
            { name: "Nova",     deck: 'Star Force',     diff: 3, reward: 70,  rare: false, color: '#ffaa00',
              face: `<circle r="16" fill="#1a0a00" stroke="#ffaa00" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#ffaa00"/><circle cx="4" cy="-2" r="3.5" fill="#ffaa00"/><circle cx="-4" cy="-2" r="1.5" fill="#fff"/><circle cx="4" cy="-2" r="1.5" fill="#fff"/><path d="M-5,6 Q0,12 5,6" fill="none" stroke="#ffcc44" stroke-width="2"/>` },
            { name: "Ghost",    deck: 'Phantom Trap',   diff: 4, reward: 90,  rare: false, color: '#aaaaaa',
              face: `<circle r="16" fill="#111111" stroke="#aaaaaa" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#888"/><circle cx="4" cy="-2" r="3.5" fill="#888"/><ellipse cx="0" cy="7" rx="5" ry="5.5" fill="#111" stroke="#aaa" stroke-width="1"/><line x1="-4" y1="10" x2="-4" y2="14" stroke="#aaa" stroke-width="1.5"/><line x1="0" y1="11" x2="0" y2="15" stroke="#aaa" stroke-width="1.5"/><line x1="4" y1="10" x2="4" y2="14" stroke="#aaa" stroke-width="1.5"/>` },
            //  RARE DUELISTS 
            { name: "OMEGA",      deck: 'Apex Force',   diff: 5, reward: 110, rare: true,  color: '#ff00ff',
              face: `<circle r="16" fill="#1a0033" stroke="#ff00ff" stroke-width="3"/><circle cx="-4" cy="-2" r="4" fill="#ff00ff"/><circle cx="4" cy="-2" r="4" fill="#ff00ff"/><circle cx="-4" cy="-2" r="1.8" fill="#fff"/><circle cx="4" cy="-2" r="1.8" fill="#fff"/><path d="M-6,6 Q0,13 6,6" fill="none" stroke="#ff00ff" stroke-width="2.5"/><line x1="-9" y1="-14" x2="9" y2="-14" stroke="#ff00ff" stroke-width="2"/>` },
            { name: "Void Lord",  deck: 'Dark Abyss',   diff: 5, reward: 140, rare: true,  color: '#9900cc',
              face: `<circle r="16" fill="#0a000a" stroke="#aa00ff" stroke-width="3"/><ellipse cx="-4" cy="-2" rx="4" ry="5" fill="#440066"/><ellipse cx="4" cy="-2" rx="4" ry="5" fill="#440066"/><circle cx="-4" cy="-2" r="2" fill="#dd00ff"/><circle cx="4" cy="-2" r="2" fill="#dd00ff"/><path d="M-4,7 Q0,12 4,7" fill="none" stroke="#aa00ff" stroke-width="2.5"/>` },
            { name: "Celestia",   deck: 'Cosmic Birth',  diff: 5, reward: 125, rare: true,  color: '#e8e8ff',
              face: `<circle r="16" fill="#0a0a2a" stroke="#c8c8ff" stroke-width="3"/><circle cx="-4" cy="-2" r="3.5" fill="#aaddff"/><circle cx="4" cy="-2" r="3.5" fill="#aaddff"/><circle cx="-4" cy="-2" r="1.5" fill="#fff"/><circle cx="4" cy="-2" r="1.5" fill="#fff"/><path d="M-5,6 Q0,12 5,6" fill="none" stroke="#ffffff" stroke-width="2.5"/><path d="M-10,-8 Q0,-15 10,-8" fill="none" stroke="#ffe88a" stroke-width="1.5"/>` }
        ];

        const DUELIST_MAP_SPOTS = [
            { x: 17, y: 33 }, // North America
            { x: 22, y: 64 }, // South America
            { x: 42, y: 28 }, // Europe
            { x: 46, y: 57 }, // Africa
            { x: 63, y: 16 }, // Russia / Siberia
            { x: 69, y: 46 }, // South Asia
            { x: 78, y: 30 }, // East Asia
            { x: 84, y: 70 }, // Australia
            { x: 54, y: 42 }, // Middle East
            { x: 57, y: 22 }, // Central Asia
        ];

                const STORY_MAP_SPOTS = [
            { x: 12, y: 52 }, { x: 32, y: 44 }, { x: 27, y: 78 },
            { x: 50, y: 70 }, { x: 36, y: 72 }, { x: 60, y: 62 },
            { x: 71, y: 65 }, { x: 75, y: 52 }, { x: 87, y: 50 },
            { x: 45, y: 38 }, { x: 55, y: 55 }, { x: 62, y: 35 },
        ];

        const STORY_EVENTS_POOL = [
            {
                type: 'explore', symbol: '', color: '#44ffaa',
                title: 'Ancient Ruins',
                intro: 'Crumbling stone archways rise from the ground ahead. Something might be hidden inside  or waiting.',
                options: [
                    { key: 'search', label: ' Search the Ruins', outcomes: [
                        { w:3, text: 'You dig through the rubble and unearth a forgotten card!', give: {type:'card', rarity:'R'} },
                        { w:3, text: 'A rusted tin full of old coins tumbles from behind a cracked pillar.', give: {type:'money', amount:60} },
                        { w:3, text: 'Nothing but dust, spiders, and disappointment.', give: null },
                        { w:1, text: 'You trigger an ancient trap! Someone nearby lifts your wallet in the chaos.', give: {type:'money', amount:-45} }
                    ]},
                    { key: 'leave', label: ' Walk Away', outcomes: [
                        { w:1, text: 'Probably just old rocks. You carry on.', give: null }
                    ]}
                ]
            },
            {
                type: 'search', symbol: '?', color: '#ffaa22',
                title: 'Suspicious Crate',
                intro: 'A large wooden crate sits in the middle of nowhere. No label, no explanation. Could be anything inside.',
                options: [
                    { key: 'open', label: ' Crack It Open', outcomes: [
                        { w:2, text: 'A sealed mini booster pack! Someone must have left it here.', give: {type:'pack'} },
                        { w:3, text: 'A crumpled wad of cash spills out. Finders keepers!', give: {type:'money', amount:75} },
                        { w:2, text: 'Just packing foam and a broken cassette player. Nothing useful.', give: null },
                        { w:1, text: 'A spring-loaded dye pack explodes in your face. A nearby thug lifts $30 while you\'re blinded.', give: {type:'money', amount:-30} },
                        { w:2, text: 'A card sits abandoned at the bottom.', give: {type:'card', rarity:'C'} }
                    ]},
                    { key: 'ignore', label: ' Leave It Alone', outcomes: [
                        { w:1, text: 'Wise choice. Could\'ve been anything in there.', give: null }
                    ]}
                ]
            },
            {
                type: 'rest', symbol: '', color: '#88dd55',
                title: 'Rest Area',
                intro: 'A quiet clearing with a bench and a faded REST STOP sign. You\'ve been walking for a while...',
                options: [
                    { key: 'rest', label: ' Take a Break', outcomes: [
                        { w:4, text: 'You rest your legs and clear your head. You feel sharper.', give: {type:'xp', amount:80} },
                        { w:3, text: 'A kind stranger leaves a card on the bench before you wake.', give: {type:'card', rarity:'C'} },
                        { w:2, text: 'You doze off. When you wake, someone\'s rifled through your jacket.', give: {type:'money', amount:-25} },
                        { w:1, text: 'You rest with purpose  insights flow freely.', give: {type:'xp', amount:200} }
                    ]},
                    { key: 'skip', label: ' Keep Moving', outcomes: [
                        { w:1, text: 'No time to rest. You push on.', give: null }
                    ]}
                ]
            },
            {
                type: 'talk', symbol: '', color: '#66aaff',
                title: 'Old Duelist',
                intro: 'A weathered old man sits shuffling a worn deck. He looks up and nods slowly. "You have the eyes of a duelist."',
                options: [
                    { key: 'talk', label: ' Sit and Talk', outcomes: [
                        { w:3, text: '"Take this," the elder says, pressing an old card into your hand. "I\'ve no more use of it."', give: {type:'card', rarity:'R'} },
                        { w:3, text: 'He shares tales of legendary duels. Your instincts sharpen.', give: {type:'xp', amount:120} },
                        { w:2, text: '"Here\'s some coin  buy yourself a decent card." He winks and walks away.', give: {type:'money', amount:50} },
                        { w:1, text: 'He talks and talks... An hour later he wanders off mid-sentence. You\'ve learned absolutely nothing.', give: null }
                    ]},
                    { key: 'ignore', label: ' Nod and Move On', outcomes: [
                        { w:1, text: 'You walk past. He sighs. Opportunity lost?', give: null }
                    ]}
                ]
            },
            {
                type: 'merchant', symbol: '', color: '#ffd700',
                title: 'Wandering Merchant',
                intro: 'A cheerful merchant with a colorful cart waves you over. "Rare cards! Strange goods! Fair prices  mostly!"',
                options: [
                    { key: 'browse', label: ' Browse the Goods', outcomes: [
                        { w:4, text: 'He pulls out something special  practically a gift at this price.', give: {type:'card', rarity:'SR'} },
                        { w:3, text: '"Free sample pack, on the house!" He tosses you a mini-bundle.', give: {type:'pack'} },
                        { w:2, text: '"Ah, good taste! Here." He slides you some travel cash.', give: {type:'money', amount:40} },
                        { w:1, text: 'You buy something that turns out to be worthless junk. The merchant is long gone before you realize.', give: {type:'money', amount:-20} }
                    ]},
                    { key: 'pass', label: ' Not Interested', outcomes: [
                        { w:1, text: '"Your loss!" he calls after you cheerfully.', give: null }
                    ]}
                ]
            },
            {
                type: 'merchant', symbol: '', color: '#cc88ff',
                title: 'Shady Dealer',
                intro: 'A figure in a dark hoodie leans against an alley wall. "Psst. I got cards. Real cards. No questions asked."',
                options: [
                    { key: 'deal', label: ' Make a Deal', outcomes: [
                        { w:3, text: 'Against all odds, the deal is legit. You walk away with a solid card.', give: {type:'card', rarity:'R'} },
                        { w:2, text: 'You hand over cash. The card dissolves in your hands  it was a printed fake. Classic.', give: {type:'money', amount:-50} },
                        { w:2, text: '"...What if I just gave you this? I\'m trying to go straight." A surprisingly good card.', give: {type:'card', rarity:'SR'} },
                        { w:1, text: 'You get a worthless card... but feel oddly satisfied with the whole interaction.', give: null }
                    ]},
                    { key: 'refuse', label: ' Hard Pass', outcomes: [
                        { w:1, text: '"Suit yourself." He melts back into the shadows.', give: null }
                    ]}
                ]
            },
            {
                type: 'find', symbol: '', color: '#ffe040',
                title: 'Lucky Discovery',
                intro: 'Something glints in the grass off the path. Could just be trash... or something worth stopping for.',
                options: [
                    { key: 'check', label: ' Go Check It Out', outcomes: [
                        { w:4, text: 'A card lying face-down in the dirt  still in perfect condition!', give: {type:'card', rarity:'C'} },
                        { w:3, text: 'Some forgotten bills blow past your feet. You snatch them up.', give: {type:'money', amount:35} },
                        { w:2, text: 'A sealed booster blister pack, slightly muddy but still functional!', give: {type:'pack'} },
                        { w:1, text: 'It was a gum wrapper. A very shiny gum wrapper. Zero monetary value.', give: null }
                    ]},
                    { key: 'ignore', label: ' Probably Trash', outcomes: [
                        { w:1, text: 'Could\'ve been something. You\'ll never know.', give: null }
                    ]}
                ]
            },
            {
                type: 'ambush', symbol: '', color: '#ff3322',
                title: 'Highway Robbers',
                intro: 'Three rough-looking figures block your path. "Hand over the cash and the cards, duelist. Or we settle this the other way."',
                options: [
                    { key: 'fight', label: ' Fight Them! (DUEL)', outcomes: [
                        { w:1, text: 'You square up for a duel. No backing down now.', give: {type:'ambush', robberName:'Lead Robber', diff:2, reward:60, penalty:50} }
                    ]},
                    { key: 'pay', label: ' Pay Them Off', outcomes: [
                        { w:1, text: 'You reluctantly hand over some cash. They snatch it and scatter into the alley.', give: {type:'money', amount:-50} }
                    ]},
                    { key: 'run', label: ' Make a Break For It', outcomes: [
                        { w:6, text: 'You sprint away and they don\'t bother chasing. Lucky!', give: null },
                        { w:4, text: 'They were faster than they looked. One trips you and grabs your wallet before bolting.', give: {type:'money', amount:-35} }
                    ]}
                ]
            },
            {
                type: 'ambush', symbol: '', color: '#cc0033',
                title: 'Gang of Thieves',
                intro: 'You walk into a dead end. Five masked figures close in on you. "Empty your pockets or duel our boss." No good options here.',
                options: [
                    { key: 'duel', label: ' Duel the Boss', outcomes: [
                        { w:1, text: 'Their boss steps forward with a twisted grin. "Let\'s make this interesting."', give: {type:'ambush', robberName:'Gang Boss', diff:3, reward:90, penalty:70} }
                    ]},
                    { key: 'pay', label: ' Give Them What They Want', outcomes: [
                        { w:1, text: 'You hand over a wad of cash. They count it, nod, and let you pass.', give: {type:'money', amount:-70} }
                    ]}
                ]
            },
            {
                type: 'talk', symbol: '', color: '#ee88ff',
                title: 'Mysterious Stranger',
                intro: 'A cloaked figure steps from the shadows and offers you a sealed card without a word. Their eyes gleam with something otherworldly.',
                options: [
                    { key: 'accept', label: ' Accept the Card', outcomes: [
                        { w:5, text: 'The card ripples with energy in your hands. Something legendary.', give: {type:'card', rarity:'SR'} },
                        { w:2, text: 'The card disintegrates the moment they leave. A test you didn\'t ask for.', give: null },
                        { w:2, text: 'You accept it. Somehow it becomes two cards. No explanation given.', give: {type:'pack'} },
                        { w:1, text: 'Ultra rare. You have no idea how they had it. Don\'t question it.', give: {type:'card', rarity:'UR'} }
                    ]},
                    { key: 'refuse', label: ' Refuse and Back Away', outcomes: [
                        { w:1, text: 'The stranger vanishes into thin air. You\'re left wondering what that was about.', give: null }
                    ]}
                ]
            },
            {
                type: 'explore', symbol: '', color: '#77bbdd',
                title: 'Abandoned Duel Station',
                intro: 'A rusted holographic duel station sits in an overgrown lot, faintly humming. Whatever tournament was held here is long forgotten.',
                options: [
                    { key: 'boot', label: ' Boot It Up', outcomes: [
                        { w:3, text: 'Old match data gives you a surprising tactical insight.', give: {type:'xp', amount:150} },
                        { w:3, text: 'A prize from an old tournament is still locked in the dispenser!', give: {type:'card', rarity:'R'} },
                        { w:2, text: 'The machine whirs to life then immediately crashes. At least it wasn\'t boring.', give: null },
                        { w:1, text: 'Jackpot mode  unclaimed winnings from a decade ago drop into your hands.', give: {type:'money', amount:100} }
                    ]},
                    { key: 'leave', label: ' Leave It Alone', outcomes: [
                        { w:1, text: 'Probably haunted. Good call.', give: null }
                    ]}
                ]
            },
            {
                type: 'rest', symbol: '', color: '#aaeedd',
                title: 'Wise Hermit',
                intro: 'An ancient hermit sits cross-legged on a cliff, staring into the distance. Without looking up: "You carry a heavy deck."',
                options: [
                    { key: 'listen', label: ' Sit and Listen', outcomes: [
                        { w:4, text: 'He shares techniques passed through generations of duelists. A genuine surge of insight washes over you.', give: {type:'xp', amount:180} },
                        { w:2, text: '"This card," pulling one from thin air, "is yours now. Don\'t ask how I have it."', give: {type:'card', rarity:'SR'} },
                        { w:2, text: 'His words are pure wisdom... but deeply confusing. After an hour you smile and nod goodbye.', give: {type:'xp', amount:40} },
                        { w:2, text: 'He asks you three riddles. You get one right. He rewards the effort anyway.', give: {type:'money', amount:40} }
                    ]},
                    { key: 'pass', label: ' Respectfully Carry On', outcomes: [
                        { w:1, text: '"The path chooses the duelist," he murmurs as you pass.', give: null }
                    ]}
                ]
            }
        ];

        function generateDuelMap() {
            const count = Math.floor(Math.random() * 7) + 2; // 28 duelists
            const normalPool = DUELISTS_POOL.filter(d => !d.rare);
            const rarePool   = DUELISTS_POOL.filter(d =>  d.rare);
            const spots = [...DUELIST_MAP_SPOTS].sort(() => Math.random() - 0.5).slice(0, count);
            const duelists = spots.map((spot, i) => {
                const isRare = Math.random() < 0.15 && rarePool.length;
                const pool   = isRare ? rarePool : normalPool;
                const base   = pool[Math.floor(Math.random() * pool.length)];
                return { ...base, mapX: spot.x, mapY: spot.y, uid: i };
            });

            // Generate story spots: ~30% chance per slot (2535%), max 3 on map at once
            const storySpots = [];
            const storyMapPool = [...STORY_MAP_SPOTS].sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(3, storyMapPool.length); i++) {
                if (Math.random() < 0.30) {
                    const base = STORY_EVENTS_POOL[Math.floor(Math.random() * STORY_EVENTS_POOL.length)];
                    storySpots.push({ ...base, mapX: storyMapPool[i].x, mapY: storyMapPool[i].y, uid: `story_${i}` });
                }
            }
            currentStorySpots = storySpots;
            return duelists;
        }

        // Current duel map (refreshed every time you enter the Duel screen)
        let currentDuelMap = [];
        let currentStorySpots = [];

        // --- 2. GAME STATE MANAGEMENT ---

        let gameState = {
            view: 'MENU',
            money: 100,
            level: 1,
            xp: 0,
            wins: 0,
            losses: 0,
            inventory: {},
            mainDeck: [],
            extraDeck: [],
            shopFirstPulls: { 'p1': true, 'p2': true, 'p3': true, 'p4': true },
            dailyReward: { lastClaimed: null, currentDay: 1 },
            wheelLastSpin: null,
            shopTab: 'PACKS',
            equippedSleeve: 'slv_default',
            equippedPlaymat: 'mat_default',
            ownedAccessories: { 'slv_default': true, 'mat_default': true },
            structureDecksBought: {},
            duelistName: 'Unnamed Duelist',
            equippedSymbol: 'icon_lightning',
            ownedSymbols: { 'icon_lightning': true },
        };

        //  AUTO-LOAD SAVE DATA ON STARTUP 
        {
            const _raw = localStorage.getItem('neonDuelist_save');
            if (_raw) {
                try {
                    const _saved = JSON.parse(_raw);
                    Object.assign(gameState, _saved);
                } catch(e) { /* corrupt save  start fresh */ }
            }
        }

        // Temporary state for opening multiple packs
        let openingSession = {
            batches: [],
            totalPacks: 0,
            currentPackIndex: 0
        };

// No starters on reset  player starts fresh with free pulls

        // --- 3. CORE LOGIC ---

        function getCardById(id) {
            return CARD_DB.find(c => c.id === id);
        }

        function addToDeck(cardId) {
            const card = getCardById(cardId);
            const isExtra = card.type === 'FUSION';
            const targetDeck = isExtra ? gameState.extraDeck : gameState.mainDeck;
            const limit = isExtra ? 15 : 60;

            if (targetDeck.length >= limit) {
                showToast(`Deck Full! Max ${limit}.`, 'error');
                return;
            }

            const copiesInMain = gameState.mainDeck.filter(id => id === cardId).length;
            const copiesInExtra = gameState.extraDeck.filter(id => id === cardId).length;
            if (copiesInMain + copiesInExtra >= 3) {
                showToast("Max 3 copies allowed!", 'error');
                return;
            }

            const owned = gameState.inventory[cardId] || 0;
            if (copiesInMain + copiesInExtra >= owned) {
                showToast("You don't own more copies!", 'error');
                return;
            }

            // Save trunk scroll position before re-render
            const trunk = document.querySelector('.custom-scrollbar');
            const savedScroll = trunk ? trunk.scrollTop : 0;

            targetDeck.push(cardId);
            renderDeckBuilder();

            // Restore scroll after re-render
            requestAnimationFrame(() => {
                const t = document.querySelector('.custom-scrollbar');
                if (t) t.scrollTop = savedScroll;
            });
        }

        function removeFromDeck(index, isExtra) {
            const trunk = document.querySelector('.custom-scrollbar');
            const savedScroll = trunk ? trunk.scrollTop : 0;
            if (isExtra) gameState.extraDeck.splice(index, 1);
            else gameState.mainDeck.splice(index, 1);
            renderDeckBuilder();
            requestAnimationFrame(() => {
                const t = document.querySelector('.custom-scrollbar');
                if (t) t.scrollTop = savedScroll;
            });
        }

        function buyPack(packId, amount) {
            const pack = PACKS.find(p => p.id === packId);
            if (!pack) return;

            // Level lock check
            if (pack.levelReq && gameState.level < pack.levelReq) {
                showToast(`Requires Level ${pack.levelReq} to unlock!`, 'error');
                return;
            }

            const cardsPerBatch = pack.singleCard ? 1 : 5;
            let cost = pack.cost * amount;
            let isFree = false;

            // Free first pull only applies to normal packs
            if (!pack.singleCard && amount === 1 && gameState.shopFirstPulls[packId]) {
                cost = 0;
                isFree = true;
                gameState.shopFirstPulls[packId] = false;
            }

            if (gameState.money < cost) {
                showToast("Not enough credits!", "error");
                return;
            }

            gameState.money -= cost;

            // Generate batches (1 card each for vault, 5 for normal packs)
            let batches = [];
            for (let i = 0; i < amount; i++) {
                let batch = [];
                for (let j = 0; j < cardsPerBatch; j++) {
                    const cardId = pack.list[Math.floor(Math.random() * pack.list.length)];
                    batch.push(cardId);
                    gameState.inventory[cardId] = (gameState.inventory[cardId] || 0) + 1;
                }
                batches.push(batch);
            }

            renderShop();
            startPackOpeningSession(batches);
        }

        function startPackOpeningSession(batches) {
            openingSession = {
                batches: batches,
                totalPacks: batches.length,
                currentPackIndex: 0
            };
            
            const overlay = document.getElementById('pack-overlay');
            overlay.classList.remove('hidden');
            
            showNextBatch();
        }

        function showNextBatch() {
            if (openingSession.batches.length === 0) {
                closePackOverlay();
                return;
            }
            SoundEngine.packOpen();
            const currentBatch = openingSession.batches.shift();
            openingSession.currentPackIndex++;

            const container = document.getElementById('pack-cards-container');
            const title = document.getElementById('pack-title');
            const btn = document.getElementById('overlay-action-btn');

            container.innerHTML = '';
            title.innerText = `OPENING PACK ${openingSession.currentPackIndex} / ${openingSession.totalPacks}`;

            // Render Cards
            currentBatch.forEach((id, index) => {
                const card = getCardById(id);
                const wrapper = document.createElement('div');
                wrapper.className = `transform transition-all duration-500 opacity-0 translate-y-10 scale-90`;
                wrapper.style.transitionDelay = `${index * 100}ms`; 
                
                wrapper.innerHTML = `
                    <div class="w-48 h-72 card-container cursor-pointer" onclick="SoundEngine.cardFlip();this.querySelector('.card').classList.remove('flipped')">
                        <div class="card flipped">
                            <div class="card-face card-back shadow-[0_0_15px_rgba(255,255,255,0.2)]">
                                <div class="card-back-design"></div>
                            </div>
                            <div class="card-face card-front">
                                ${renderCardHTML(card, "w-full", "h-full").replace(/card-container|m-1|inline-block|card-face card-back[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/g, '')}
                                <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-1 rounded animate-pulse shadow-md z-20">NEW!</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(wrapper);

                setTimeout(() => {
                    wrapper.classList.remove('opacity-0', 'translate-y-10', 'scale-90');
                }, 50);
            });

            // Button Logic
            if (openingSession.batches.length > 0) {
                btn.innerText = "NEXT PACK >>";
                btn.onclick = showNextBatch;
                btn.className = "mt-10 px-8 py-3 bg-yellow-500 text-black font-bold text-xl rounded hover:bg-yellow-400 anime-skew border-2 border-white shadow-lg";
            } else {
                btn.innerText = "DONE";
                btn.onclick = closePackOverlay;
                btn.className = "mt-10 px-8 py-3 bg-white text-black font-bold text-xl rounded hover:bg-gray-200 anime-skew";
            }
        }

                //  SAVE / LOAD 
        function saveGame() {
            const s = Object.assign({}, gameState);
            delete s._lastBGMView; // ephemeral, don't persist
            localStorage.setItem('neonDuelist_save', JSON.stringify(s));
        }

function resetGame() {
            localStorage.removeItem('neonDuelist_save');
            gameState = {
                view: 'MENU',
                money: 100,
                level: 1,
                xp: 0,
                wins: 0,
                losses: 0,
                inventory: {},
                mainDeck: [],
                extraDeck: [],
                shopFirstPulls: { 'p1': true, 'p2': true, 'p3': true, 'p4': true },
                dailyReward: { lastClaimed: null, currentDay: 1 },
                wheelLastSpin: null,
                shopTab: 'PACKS',
                equippedSleeve: 'slv_default',
                equippedPlaymat: 'mat_default',
                ownedAccessories: { 'slv_default': true, 'mat_default': true },
                structureDecksBought: {},
                duelistName: 'Unnamed Duelist',
                equippedSymbol: 'icon_lightning',
                ownedSymbols: { 'icon_lightning': true },
            };

            const starterCards = [1, 1, 2, 4, 4, 6, 7, 8, 51, 52];
            starterCards.forEach(id => {
                gameState.inventory[id] = (gameState.inventory[id] || 0) + 1;
            });

            renderApp();
            showToast("Game Reset!", "info");
        }

                //  MULTIPLAYER 
        const SERVER_URL = 'https://neonduelist.onrender.com';
        let socket = null;
        let mpState = {
            connected: false, inPvP: false, pvpRole: null,
            oppId: null, oppName: '', oppSymbol: '', oppLevel: 1,
            oppDeck: [], oppExtraDeck: [],
            rpsMe: null, rpsOpp: null, rpsRound: 1, rpsScore: { me: 0, opp: 0 },
            onlinePlayers: [], reqPending: false, pendingAttack: null,
            oppSleeve: null, oppPlaymat: null,
        };

        function _mpResolveEmoji(symbolId) {
            const entry = (typeof PLAYER_ICONS !== 'undefined') ? PLAYER_ICONS.find(i => i.id === symbolId) : null;
            return entry ? entry.emoji : (symbolId || '');
        }

        function mpConnect() {
            if (socket) return;
            socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
            socket.on('connect', () => {
                mpState.connected = true;
                socket.emit('register', {
                    name: gameState.duelistName || 'Unnamed Duelist',
                    symbol: _mpResolveEmoji(gameState.equippedSymbol),
                    level: gameState.level || 1
                });
                // Also enter world immediately on connect/reconnect if already on duel map
                if (gameState.view === 'DUEL') {
                    if (!gameState._mpPos) gameState._mpPos = { x: 10 + Math.random() * 80, y: 10 + Math.random() * 80 };
                    gameState._mpInWorld = true;
                    socket.emit('enterWorld', gameState._mpPos);
                }
            });
            socket.on('disconnect', () => { mpState.connected = false; });
            socket.on('worldUpdate', players => {
                mpState.onlinePlayers = players.filter(p => p.id !== socket.id);
                _refreshMpMarkers();
                const badge = document.getElementById('mp-online-badge');
                if (badge) badge.textContent = ` ${mpState.onlinePlayers.length + 1} ONLINE`;
            });
            socket.on('incomingReq', data => _showIncomingRequest(data));
            socket.on('reqTimedOut', () => _closeIncomingRequest());
            socket.on('reqSent', () => showToast('Duel request sent! Waiting 30s...', 'info'));
            socket.on('reqExpired', () => { mpState.reqPending = false; showToast('Request timed out.', 'error'); });
            socket.on('reqDeclined', () => { mpState.reqPending = false; showToast('Opponent declined.', 'error'); });
            socket.on('reqFailed', msg => showToast(msg || 'Request failed.', 'error'));
            socket.on('pvpStart', data => {
                mpState.pvpRole = data.role; mpState.oppId = data.opponentId;
                mpState.oppName = data.name || 'Opponent'; mpState.oppSymbol = data.symbol || '';
                mpState.oppLevel = data.level || 1; mpState.inPvP = true;
                mpState.oppDeck = []; mpState.oppExtraDeck = [];
                showToast(`PvP vs ${mpState.oppName}! Rock Paper Scissors to decide who goes first!`, 'info');
                _openRpsModal();
            });
            socket.on('rpsChoice', choice => {
                mpState.rpsOpp = choice;
                if (mpState.rpsMe) _resolveRps(mpState.rpsMe, mpState.rpsOpp);
            });
            socket.on('pvpAction', data => _applyPvpAction(data));
            socket.on('pvpEnd', data => _handlePvpEnd(data));
            socket.on('oppDisconnected', () => showToast('Opponent disconnected! You win in 20s if they don\'t return.', 'error'));
        }

        window._mpPlayerCache = window._mpPlayerCache || {};

        function _refreshMpMarkers() {
            const cont = document.getElementById('mp-markers');
            if (!cont) return;
            window._mpPlayerCache = {};
            cont.innerHTML = mpState.onlinePlayers.map(p => {
                if (p.inBattle) return '';
                window._mpPlayerCache[p.id] = p;
                const x = p.pos?.x || 50, y = p.pos?.y || 50;
                return `<div class="duelist-marker" style="left:${x}%;top:${y}%;pointer-events:auto;" onclick="_showChallenge('${p.id}')">
                    <div class="relative">
                        <div class="absolute inset-0 rounded-full bg-purple-500 opacity-40 duelist-ping"></div>
                        <div class="relative z-10 w-8 h-8 rounded-full bg-purple-900 border-2 border-purple-400 flex items-center justify-center text-sm shadow-lg" title="${p.name} Lv.${p.level}">${p.symbol || ''}</div>
                    </div>
                    <div class="text-[9px] text-purple-300 font-mono text-center mt-1 leading-none" style="pointer-events:none;text-shadow:0 0 4px #000">${p.name}</div>
                </div>`;
            }).join('');
        }

        function _showChallenge(pid) {
            const p = window._mpPlayerCache[pid] || { id: pid, name: 'Unknown', symbol: '', level: '?' };
            if (mpState.inPvP || mpState.reqPending) { showToast('You are busy.', 'error'); return; }
            let ex = document.getElementById('challenge-popup'); if (ex) ex.remove();
            const dlg = document.createElement('div');
            dlg.id = 'challenge-popup';
            dlg.className = 'fixed inset-0 z-[850] bg-black/80 flex items-center justify-center';
            dlg.innerHTML = `<div class="bg-[#060d1c] border-2 border-purple-500 rounded-xl p-6 text-center min-w-[280px]">
                <div class="text-4xl mb-2">${p.symbol || ''}</div>
                <div class="text-purple-200 font-[Bangers] text-2xl tracking-wider">${p.name}</div>
                <div class="text-purple-500 font-mono text-xs mb-4">Level ${p.level}</div>
                <div class="flex gap-3 justify-center">
                    <button onclick="_sendReq('${p.id}');document.getElementById('challenge-popup').remove()" class="font-[Bangers] text-xl px-6 py-2 bg-purple-900 hover:bg-purple-700 border-2 border-purple-400 rounded-lg text-white tracking-widest"> DUEL REQUEST</button>
                    <button onclick="document.getElementById('challenge-popup').remove()" class="font-[Bangers] text-xl px-5 py-2 bg-gray-700 hover:bg-gray-600 border-2 border-gray-500 rounded-lg text-gray-300"></button>
                </div>
            </div>`;
            document.body.appendChild(dlg);
        }

        function _sendReq(id) {
            if (!socket || !mpState.connected) { showToast('Not connected to server!', 'error'); return; }
            if (gameState.mainDeck.length < 40) { showToast(`Your deck only has ${gameState.mainDeck.length} cards  need at least 40 to duel!`, 'error'); return; }
            mpState.reqPending = true;
            socket.emit('requestDuel', id);
        }

        function _showIncomingRequest(data) {
            let el = document.getElementById('incoming-req'); if (el) el.remove();
            const dlg = document.createElement('div');
            dlg.id = 'incoming-req';
            dlg.className = 'fixed inset-0 z-[860] bg-black/80 flex items-center justify-center';
            dlg.innerHTML = `<div class="bg-[#060d1c] border-2 border-cyan-500 rounded-xl p-6 text-center min-w-[280px]">
                <div class="text-4xl mb-2">${data.symbol || ''}</div>
                <div class="text-cyan-200 font-[Bangers] text-2xl tracking-wider">${data.name}</div>
                <div class="text-cyan-600 font-mono text-xs mb-1">Level ${data.level}</div>
                <div class="text-yellow-400 font-mono text-xs mb-4">Challenges you to a duel! (30s to accept)</div>
                <div class="flex gap-3 justify-center">
                    <button onclick="_respondReq(true)" class="font-[Bangers] text-xl px-6 py-2 bg-green-900 hover:bg-green-700 border-2 border-green-400 rounded-lg text-white tracking-widest"> ACCEPT</button>
                    <button onclick="_respondReq(false)" class="font-[Bangers] text-xl px-5 py-2 bg-red-900 hover:bg-red-700 border-2 border-red-500 rounded-lg text-white tracking-widest"> DECLINE</button>
                </div>
            </div>`;
            document.body.appendChild(dlg);
        }

        function _closeIncomingRequest() { const el = document.getElementById('incoming-req'); if (el) el.remove(); }

        function _respondReq(accepted) {
            _closeIncomingRequest();
            if (accepted && gameState.mainDeck.length < 40) {
                showToast(`Your deck only has ${gameState.mainDeck.length} cards  need at least 40! Declining.`, 'error');
                if (socket) socket.emit('respondReq', false);
                return;
            }
            if (socket) socket.emit('respondReq', accepted);
            if (!accepted) showToast('Declined.', 'info');
        }

        //  RPS 
        function _openRpsModal() {
            mpState.rpsMe = null; mpState.rpsOpp = null; mpState.rpsRound = 1; mpState.rpsScore = { me: 0, opp: 0 };
            let el = document.getElementById('rps-modal');
            if (!el) { el = document.createElement('div'); el.id = 'rps-modal'; document.body.appendChild(el); }
            el.className = 'fixed inset-0 z-[900] bg-black/90 flex items-center justify-center';
            el.innerHTML = `<div class="bg-[#060d1c] border-2 border-cyan-500 rounded-xl p-6 text-center min-w-[320px] max-w-sm">
                <div class="text-cyan-300 font-[Bangers] text-3xl tracking-widest mb-1">ROCK PAPER SCISSORS</div>
                <div class="text-cyan-700 font-mono text-xs mb-4">Best of 3  winner goes first</div>
                <div id="rps-score" class="text-yellow-300 font-[Bangers] text-xl mb-3"></div>
                <div id="rps-status" class="text-cyan-400 font-mono text-sm mb-4">Choose your move!</div>
                <div class="flex gap-4 justify-center mb-4">
                    <button onclick="_submitRps('R')" class="text-3xl p-3 bg-black/40 border border-cyan-700 rounded-xl hover:border-cyan-400 hover:bg-cyan-900/30 transition-all" title="Rock"></button>
                    <button onclick="_submitRps('P')" class="text-3xl p-3 bg-black/40 border border-cyan-700 rounded-xl hover:border-cyan-400 hover:bg-cyan-900/30 transition-all" title="Paper"></button>
                    <button onclick="_submitRps('S')" class="text-3xl p-3 bg-black/40 border border-cyan-700 rounded-xl hover:border-cyan-400 hover:bg-cyan-900/30 transition-all" title="Scissors"></button>
                </div>
                <div id="rps-waiting" class="text-cyan-700 font-mono text-xs"></div>
            </div>`;
            _renderRps();
        }

        function _renderRps() {
            const s = document.getElementById('rps-score');
            if (s) s.textContent = `YOU ${mpState.rpsScore.me}  ${mpState.rpsScore.opp} OPP  (Round ${mpState.rpsRound}/3)`;
        }

        function _submitRps(choice) {
            if (mpState.rpsMe) return;
            mpState.rpsMe = choice;
            document.querySelectorAll('#rps-modal button').forEach(b => b.disabled = true);
            const wait = document.getElementById('rps-waiting'); if (wait) wait.textContent = 'Waiting for opponent...';
            const status = document.getElementById('rps-status');
            if (status) status.textContent = { R: 'You chose  Rock', P: 'You chose  Paper', S: 'You chose  Scissors' }[choice];
            if (socket) socket.emit('rpsChoice', choice);
            if (mpState.rpsOpp) _resolveRps(mpState.rpsMe, mpState.rpsOpp);
        }

        function _resolveRps(me, opp) {
            const wins = { R: 'S', P: 'R', S: 'P' };
            let result;
            if (me === opp) result = 'tie';
            else if (wins[me] === opp) { result = 'win'; mpState.rpsScore.me++; }
            else { result = 'lose'; mpState.rpsScore.opp++; }
            const names = { R: 'Rock', P: 'Paper', S: 'Scissors' };
            const status = document.getElementById('rps-status');
            if (status) status.textContent = `You: ${names[me]} vs Opp: ${names[opp]}  ${result === 'tie' ? ' TIE  replay!' : result === 'win' ? ' You win the round!' : ' Opp wins the round!'}`;
            _renderRps();
            const done = mpState.rpsScore.me >= 2 || mpState.rpsScore.opp >= 2 || mpState.rpsRound >= 3;
            if (done) {
                setTimeout(() => { const el = document.getElementById('rps-modal'); if (el) el.remove(); _pickFirst(); }, 1500);
            } else {
                mpState.rpsRound++; mpState.rpsMe = null; mpState.rpsOpp = null;
                setTimeout(() => {
                    document.querySelectorAll('#rps-modal button').forEach(b => b.disabled = false);
                    const wait = document.getElementById('rps-waiting'); if (wait) wait.textContent = '';
                    const st = document.getElementById('rps-status'); if (st) st.textContent = 'Choose your move!';
                    _renderRps();
                }, 1200);
            }
        }

        function _pickFirst() {
            const iGoFirst = mpState.rpsScore.me > mpState.rpsScore.opp;
            showToast(iGoFirst ? ' You won RPS! You go first!' : ' Opponent goes first!', 'info');
            setTimeout(() => _startPvpDuel(iGoFirst), 1000);
        }

        //  PvP STATE SYNC 
        function _pvpSerializeSide(side) {
            return {
                lp: side.lp,
                hand: [...side.hand],
                monsterZones: side.monsterZones.map(z => z ? { ...z } : null),
                spellTrapZones: side.spellTrapZones.map(z => z ? { ...z } : null),
                graveyard: [...side.graveyard],
                banished: [...side.banished],
                normalSummonUsed: side.normalSummonUsed,
            };
        }

                // Debounced sync  coalesces rapid state changes into one emit
        let _pvpSyncTimer = null;
        function _pvpScheduleSync(delay = 350) {
            if (!mpState.inPvP) return;
            clearTimeout(_pvpSyncTimer);
            _pvpSyncTimer = setTimeout(_pvpEmitStateSync, delay);
        }

        function _pvpEmitStateSync() {
            if (!mpState.inPvP || !socket || !duelState) return;
            socket.emit('pvpAction', {
                type: 'stateSync',
                myPlayer:         _pvpSerializeSide(duelState.player),
                myAi:             _pvpSerializeSide(duelState.ai),
                phase:            duelState.phase,
                turnPlayer:       duelState.turnPlayer,
                turnCount:        duelState.turnCount,
                alreadyAttacked:  [...duelState.alreadyAttacked],
                aiAlreadyAttacked:[...duelState.aiAlreadyAttacked],
                log:              duelState.log.slice(0, 15),
            });
        }
        // 

        //  PvP ENGINE 
        function _startPvpDuel(playerFirst) {
            socket.emit('pvpAction', {
                type: 'shareDeck',
                deck: [...gameState.mainDeck],
                extraDeck: [...gameState.extraDeck],
                sleeve: gameState.equippedSleeve || null,
                playmat: gameState.equippedPlaymat || null,
            });
            setTimeout(() => _initPvpDuel(playerFirst), 300);
        }

        function _initPvpDuel(playerFirst) {
            const shuffle = arr => { const a = [...arr]; for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
            const playerDeck = shuffle([...gameState.mainDeck]);
            const aiDeck = shuffle([...(mpState.oppDeck.length ? mpState.oppDeck : gameState.mainDeck)]);
            duelState = {
                phase: 'DRAW', turnPlayer: playerFirst ? 'PLAYER' : 'AI',
                turnCount: 1, firstTurnPlayer: playerFirst ? 'PLAYER' : 'AI',
                opponentData: { name: mpState.oppName, symbol: mpState.oppSymbol, level: mpState.oppLevel, diff: 3, pvp: true, reward: 150 },
                player: { lp:4000, hand:[], deck:playerDeck, extraDeck:[...gameState.extraDeck], graveyard:[], banished:[], monsterZones:[null,null,null,null,null], spellTrapZones:[null,null,null,null,null], normalSummonUsed:false },
                ai:     { lp:4000, hand:[], deck:aiDeck,     extraDeck:[...(mpState.oppExtraDeck.length?mpState.oppExtraDeck:gameState.extraDeck)], graveyard:[], banished:[], monsterZones:[null,null,null,null,null], spellTrapZones:[null,null,null,null,null], normalSummonUsed:false },
                selectedHandCard:null, selectedZone:null, alreadyAttacked:[], aiAlreadyAttacked:[], log:[]
            };
            for (let i = 0; i < 5; i++) { duelDraw('player'); duelDraw('ai'); }
            socket.emit('setBattle', true);
            gameState.view = 'DUEL';
            renderApp();
            SoundEngine.playDuelBGM();
            logDuel(' PvP DUEL BEGINS! ');
            logDuel(playerFirst ? 'You go first! Draw a card.' : 'Opponent goes first. Wait for their move.');
            if (playerFirst) duelDraw('player');
            renderDuelField();
        }

        function _applyPvpAction(action) {
            if (!mpState.inPvP) return;
            const { type } = action;
            if (type === 'shareDeck') {
                mpState.oppDeck = action.deck||[];
                mpState.oppExtraDeck = action.extraDeck||[];
                mpState.oppSleeve = action.sleeve || null;
                mpState.oppPlaymat = action.playmat || null;
                return;
            }
            if (type === 'stateSync') {
                if (!duelState) return;
                // Sender's "player" side = our "ai" side (and vice versa)
                const p = action.myPlayer, a = action.myAi;
                duelState.ai.lp              = p.lp;
                duelState.ai.hand            = p.hand;
                duelState.ai.monsterZones    = p.monsterZones;
                duelState.ai.spellTrapZones  = p.spellTrapZones;
                duelState.ai.graveyard       = p.graveyard;
                duelState.ai.banished        = p.banished;
                duelState.ai.normalSummonUsed= p.normalSummonUsed;
                duelState.player.lp              = a.lp;
                duelState.player.hand            = a.hand;
                duelState.player.monsterZones    = a.monsterZones;
                duelState.player.spellTrapZones  = a.spellTrapZones;
                duelState.player.graveyard       = a.graveyard;
                duelState.player.banished        = a.banished;
                duelState.player.normalSummonUsed= a.normalSummonUsed;
                // Flip turn perspective: sender's PLAYER turn = our AI turn
                duelState.phase     = action.phase;
                duelState.turnPlayer= action.turnPlayer === 'PLAYER' ? 'AI' : 'PLAYER';
                duelState.turnCount = action.turnCount;
                // Flip attacked arrays: sender's alreadyAttacked = their player's = our ai's
                duelState.aiAlreadyAttacked = action.alreadyAttacked;
                duelState.alreadyAttacked   = action.aiAlreadyAttacked;
                // Merge new log entries (avoid duplicates)
                if (action.log && action.log.length) {
                    const existing = new Set(duelState.log);
                    const newEntries = action.log.filter(e => !existing.has(e));
                    if (newEntries.length) duelState.log = [...newEntries, ...duelState.log].slice(0, 40);
                }
                renderDuelField();
                return;
            }
            if (!duelState) return;
            if (type === 'summon') {
                const { handCardId, zoneIndex, position } = action;
                duelState.ai.monsterZones[zoneIndex] = { id:handCardId, position, summonedThisTurn:true, faceDown:position==='DEF' };
                const hi = duelState.ai.hand.indexOf(handCardId);
                if (hi!==-1) duelState.ai.hand.splice(hi,1); else if (duelState.ai.hand.length) duelState.ai.hand.shift();
                duelState.ai.normalSummonUsed = true; SoundEngine.summon();
                logDuel(`Opponent summons ${getCardById(handCardId)?.name||'a monster'} in ${position} position!`);
                renderDuelField(); return;
            }
            if (type === 'setSpellTrap') {
                const { handCardId, zoneIndex, isTrap } = action;
                const hi = duelState.ai.hand.indexOf(handCardId);
                if (hi!==-1) duelState.ai.hand.splice(hi,1); else if (duelState.ai.hand.length) duelState.ai.hand.shift();
                if (isTrap) { duelState.ai.spellTrapZones[zoneIndex]={id:handCardId,faceDown:true,activatedThisTurn:false}; logDuel('Opponent sets a card face-down.'); }
                else { duelState.ai.spellTrapZones[zoneIndex]={id:handCardId,faceDown:false,activatedThisTurn:true}; logDuel(`Opponent activates ${getCardById(handCardId)?.name||'a Spell'}!`); }
                renderDuelField(); return;
            }
            //  PvP Chain system 
            if (type === 'attackDeclare') {
                const ctx={attackerOwner:'ai',attackerIdx:action.attackerIdx,targetIdx:action.targetIdx};
                logDuel(`Opponent declares an attack!`);
                askPlayerChain('ATTACK',ctx).then(pick=>{
                    if (pick) {
                        resolveChainPick(pick,'ATTACK',ctx,()=>{
                            if(!socket||!duelState)return;
                            socket.emit('pvpAction',{type:'chainResult',attackNegated:!!(ctx.attackNegated),attackerIdx:action.attackerIdx,targetIdx:action.targetIdx,isDirect:false});
                            _pvpEmitStateSync();
                        });
                    } else {
                        if(socket) socket.emit('pvpAction',{type:'chainResult',attackNegated:false,attackerIdx:action.attackerIdx,targetIdx:action.targetIdx,isDirect:false});
                    }
                });
                return;
            }
            if (type === 'directDeclare') {
                const ctx={attackerOwner:'ai',attackerIdx:action.attackerIdx,isDirect:true};
                logDuel(`Opponent declares a direct attack!`);
                askPlayerChain('ATTACK',ctx).then(pick=>{
                    if (pick) {
                        resolveChainPick(pick,'ATTACK',ctx,()=>{
                            if(!socket||!duelState)return;
                            socket.emit('pvpAction',{type:'chainResult',attackNegated:!!(ctx.attackNegated),attackerIdx:action.attackerIdx,isDirect:true});
                            _pvpEmitStateSync();
                        });
                    } else {
                        if(socket) socket.emit('pvpAction',{type:'chainResult',attackNegated:false,attackerIdx:action.attackerIdx,isDirect:true});
                    }
                });
                return;
            }
            if (type === 'chainResult') {
                if (!duelState) return;
                const {attackNegated,attackerIdx,targetIdx,isDirect}=action;
                mpState.pendingAttack=null;
                if (attackNegated) {
                    logDuel('Your attack was negated by opponent\'s trap!');
                    if (!duelState.alreadyAttacked.includes(attackerIdx)) duelState.alreadyAttacked.push(attackerIdx);
                    renderDuelField();
                    return;
                }
                if (isDirect) {
                    const attSlot=duelState.player.monsterZones[attackerIdx]; if(!attSlot)return;
                    const attATK=getEffectiveATK(attSlot);
                    const halveDirect=[170,176,179].includes(attSlot.id);
                    const finalDmg=halveDirect?Math.floor(attATK/2):attATK;
                    duelState.ai.lp=Math.max(0,duelState.ai.lp-finalDmg);
                    duelState.alreadyAttacked.push(attackerIdx);
                    duelState.selectedZone=null;
                    logDuel(`${getCardById(attSlot.id)?.name||'Monster'} attacks directly! Opp takes ${finalDmg} DMG${halveDirect?' (halved)':''}! (Opp LP:${duelState.ai.lp})`);
                    if(attSlot.id===176&&duelState.ai.hand.length){const ri=Math.floor(Math.random()*duelState.ai.hand.length);const did=duelState.ai.hand.splice(ri,1)[0];duelState.ai.graveyard.push(did);logDuel(`Static Phantom: Opp discards ${getCardById(did)?.name||'a card'}!`);}
                    renderDuelField();
                    setTimeout(_pvpEmitStateSync,120);
                    if(duelState.ai.lp<=0) endDuel('player','lp');
                } else {
                    resolveAttack('player',attackerIdx,'ai',targetIdx);
                    renderDuelField();
                    setTimeout(_pvpEmitStateSync,120);
                    if(duelState.player.lp<=0) endDuel('ai','lp');
                    if(duelState.ai.lp<=0) endDuel('player','lp');
                }
                return;
            }
            // Legacy fallback
            if (type === 'attack') { _pvpResolveAttack(action.attackerIdx, action.targetIdx); return; }
            if (type === 'directAttack') { _pvpDirectAttack(action.attackerIdx); return; }
            if (type === 'endTurn') { _pvpOpponentEndTurn(); return; }
            if (type === 'forfeit') { endDuel('player','forfeit'); return; }
        }

        function _pvpOpponentEndTurn() {
            if (!duelState) return;
            logDuel("Opponent's turn ends. Your turn begins!");
            // turnCount already updated via stateSync  don't double-increment
            duelState.phase='DRAW'; duelState.turnPlayer='PLAYER';
            duelState.alreadyAttacked=[]; duelState.aiAlreadyAttacked=[];
            duelState.ai.normalSummonUsed=false; duelState.player.normalSummonUsed=false;
            duelState.selectedHandCard=null; duelState.selectedZone=null;
            showToast('Your turn!', 'info');
            // handlePhaseStart runs draw animation then auto-advances to Standby
            handlePhaseStart('DRAW', 'PLAYER');
        }

        function _pvpResolveAttack(opp_attackerIdx, pl_targetIdx) {
            resolveAttack('ai', opp_attackerIdx, 'player', pl_targetIdx);
            renderDuelField();
        }

        function _pvpDirectAttack(opp_attackerIdx) {
            const attSlot = duelState.ai.monsterZones[opp_attackerIdx]; if (!attSlot) return;
            const attATK = getEffectiveATK(attSlot);
            duelState.player.lp = Math.max(0, duelState.player.lp - attATK);
            duelState.aiAlreadyAttacked.push(opp_attackerIdx);
            logDuel(`Opponent's ${getCardById(attSlot.id)?.name||'monster'} attacks directly! You take ${attATK} DMG! (Your LP: ${duelState.player.lp})`);
            renderDuelField();
            if (duelState.player.lp <= 0) endDuel('ai','lp');
        }

        function _handlePvpEnd(data) {
            if (!mpState.inPvP) return;
            mpState.inPvP = false;
            if (socket) socket.emit('setBattle', false);
            if (data.won) endDuel('player','pvp'); else endDuel('ai','pvp');
        }
        // 

        // --- 4. RENDERERS ---

        const root = document.getElementById('game-root');

        function renderApp() {
            saveGame();
            root.innerHTML = '';
            const _bv = gameState._lastBGMView || null, _cv = gameState.view;
            if (_bv !== _cv) {
                gameState._lastBGMView = _cv;
                if      (_cv === 'MENU')                      SoundEngine.playMenuBGM();
                else if (_cv === 'SHOP' || _cv === 'BUILDER') SoundEngine.playShopBGM();
                else if (_cv === 'DUEL')                      SoundEngine.playMapBGM();
            }
            if (gameState.view === 'MENU') renderMainMenu();
            else if (gameState.view === 'BUILDER') renderDeckBuilder();
            else if (gameState.view === 'SHOP') renderShop();
            else if (gameState.view === 'DUEL') renderDuel();
            // Multiplayer presence tracking
            if (!socket) mpConnect();
            const _nowInDuel = gameState.view === 'DUEL';
            if (_nowInDuel && !gameState._mpInWorld) {
                gameState._mpInWorld = true;
                if (!gameState._mpPos) gameState._mpPos = { x: 10 + Math.random() * 80, y: 10 + Math.random() * 80 };
                if (socket) socket.emit('enterWorld', gameState._mpPos);
            } else if (!_nowInDuel && gameState._mpInWorld) {
                gameState._mpInWorld = false;
                if (socket) socket.emit('leaveWorld');
            }
        }

        // Helper: Card HTML Generator
        function renderCardHTML(card, widthClass = "w-48", heightClass="h-72", isFaceUp = true) {
            if (!isFaceUp) {
                return `
                <div class="${widthClass} ${heightClass} card-container inline-block m-2">
                    <div class="card flipped">
                        <div class="card-face card-back shadow-lg">
                            <div class="card-back-design"></div>
                        </div>
                         <div class="card-face card-front"></div>
                    </div>
                </div>`;
            }

            const styles = CARD_TYPES[card.type] || CARD_TYPES.NORMAL;
            const attr = ATTRIBUTES[card.attribute] || ATTRIBUTES.LIGHT;

            // Pattern Logic based on type/attribute
            let patternClass = "pattern-grid";
            if(card.attribute === 'FIRE' || card.attribute === 'DARK') patternClass = "pattern-lines";
            if(card.attribute === 'LIGHT' || card.attribute === 'SPELL') patternClass = "pattern-circle";
            if(card.type === 'TRAP' || card.type === 'FUSION') patternClass = "pattern-hex";

            let stars = "";
            if(card.level) {
                for(let i=0; i<card.level; i++) stars += ICONS.STAR;
            }

// HOLO EFFECT LOGIC
            let rarityEffect = "";
            let rarityBadge = "";
            if(card.rarity === 'R') {
                rarityEffect = `<div class="rarity-R"></div>`;
                rarityBadge = `<div class="absolute bottom-1 right-1 text-[8px] font-bold text-gray-700 bg-white/50 px-1 rounded">R</div>`;
            } else if (card.rarity === 'SR') {
                rarityEffect = `<div class="rarity-SR"></div>`;
                rarityBadge = `<div class="absolute bottom-1 right-1 text-[8px] font-bold text-yellow-800 bg-yellow-200/80 px-1 rounded border border-yellow-500">SR</div>`;
            } else if (card.rarity === 'UR') {
                rarityEffect = `<div class="rarity-UR"></div>`;
                rarityBadge = `<div class="absolute bottom-1 right-1 text-[8px] font-bold text-white bg-purple-600/80 px-1 rounded border border-purple-400">UR</div>`;
            } else if (card.rarity === 'SP') {
                rarityEffect = `<div class="rarity-SP"></div><div class="rarity-UR" style="opacity:0.5"></div>`;
                rarityBadge = `<div class="absolute bottom-1 right-1 text-[8px] font-bold text-black bg-gradient-to-r from-yellow-200 via-white to-pink-200 px-1 rounded border-2 border-yellow-400 animate-pulse shadow-[0_0_6px_rgba(255,255,255,0.9)]">SP</div>`;
            }

            return `
            <div class="${widthClass} ${heightClass} card-container inline-block m-1 relative group select-none">
                <div class="card">
                    <div class="card-face card-front ${styles.color} p-2 border-4 ${styles.border}">
                        <!-- Header -->
                        <div class="flex justify-between items-center bg-white/40 px-1 rounded border border-black/10 mb-1">
                            <span class="font-bold text-xs truncate leading-tight w-3/4 ${card.rarity === 'UR' ? 'text-yellow-700' : ''} ${card.rarity === 'SP' ? 'text-transparent bg-clip-text bg-gradient-to-r from-yellow-600 via-pink-500 to-purple-600' : ''}">${card.name}</span>                            <span class="${attr.color}">${attr.icon}</span>
                        </div>
                        
                        <!-- Level/Rank -->
                        ${card.level ? `<div class="flex justify-end mb-0.5 space-x-0.5">${stars}</div>` : ''}

                        <!-- Art Box -->
                        <div class="card-art-box flex-grow shadow-inner flex items-center justify-center relative ${patternClass} ${attr.bg} bg-opacity-50">
                            <!-- Artistic Gradient Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-br from-transparent to-black/40"></div>
                            
                            <!-- Main Art Icon -->
                            <div class="relative z-10 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] transform scale-125">
                                ${card.artIcon || ICONS.ROBOT}
                            </div>
                            
                            <!-- Holographic Layer (On Top of Art) -->
                            ${rarityEffect}
                        </div>

                        <!-- Description & Stats -->
                        <div class="bg-white/90 border-2 border-black/10 mt-1 relative flex flex-col" style="min-height:30%">
                            <div class="text-[8px] font-bold px-1 pt-0.5 border-b border-black/10 shrink-0">[${card.type} / ${card.attribute}]</div>
                            <div class="text-[8px] leading-tight overflow-hidden text-gray-800 italic flex-1 px-1 py-0.5">${card.desc}</div>
                            ${card.atk !== undefined ?
                            `<div class="flex justify-between border-t-2 border-black/30 px-1 py-0.5 font-mono font-bold bg-black/5 shrink-0" style="font-size:10px;">
                                <span class="text-red-800">ATK/ ${card.atk}</span>
                                <span class="text-blue-800">DEF/ ${card.def}</span>
                            </div>` : ''}

                            <!-- Rarity Badge -->
                            ${rarityBadge}
                        </div>
                    </div>
                    
                    <div class="card-face card-back shadow-lg">
                        <div class="card-back-design"></div>
                    </div>
                </div>
            </div>
            `;
        }

        // --- VIEW: MAIN MENU ---
        function renderMainMenu() {
            const _sym = PLAYER_ICONS.find(i=>i.id===gameState.equippedSymbol) || PLAYER_ICONS[0];
            root.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full relative z-10">
                    <!-- TOP-RIGHT: RESET SAVE -->
                    <div class="absolute top-5 right-5 z-20">
                        <button onclick="confirmResetGame()" class="bg-red-700 hover:bg-red-500 text-white border border-red-400 px-3 py-1 rounded text-xs font-bold tracking-wider shadow-lg transition-transform hover:scale-110">
                            ERASE DATA
                        </button>
                    </div>

                    <!-- PROFILE CARD (top-left) -->
                    <div class="absolute top-5 left-5 z-20"
                         style="background:rgba(0,0,0,0.6);border:1.5px solid #334155;border-radius:14px;padding:12px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 0 18px rgba(0,229,255,0.12);">
                        <div style="font-size:36px;line-height:1;filter:drop-shadow(0 0 8px rgba(0,229,255,0.5))">${_sym.emoji}</div>
                        <div>
                            <div style="font-family:'Bangers',cursive;font-size:20px;color:#e2e8f0;letter-spacing:.06em;line-height:1">${gameState.duelistName}</div>
                            <div style="font-family:monospace;font-size:10px;color:#6b7280;margin-top:2px">Lv.${gameState.level} &nbsp;&nbsp; ${gameState.wins}W / ${gameState.losses}L &nbsp;&nbsp; $${gameState.money.toLocaleString()}</div>
                            <button onclick="openRenameModal()" style="margin-top:5px;font-family:monospace;font-size:9px;color:#00e5ff;background:rgba(0,229,255,0.06);border:1px solid #164e63;border-radius:6px;padding:2px 10px;cursor:pointer;letter-spacing:.06em"> RENAME</button>
                        </div>
                    </div>

                    <h1 class="text-8xl font-[Orbitron] text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 mb-2 italic drop-shadow-[0_0_15px_rgba(0,229,255,0.8)] anime-skew text-center">NEON DUELIST</h1>
                    <div class="text-xl text-cyan-300 font-bold tracking-[0.5em] mb-12 anime-skew animate-pulse text-center">TCG BATTLE SIMULATOR</div>

                    <div class="flex flex-col gap-6 w-80">
                        <button onclick="gameState.view='DUEL'; renderApp()" class="anime-btn h-16 text-2xl font-bold bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 rounded-sm anime-skew text-white">
                            <span class="inline-block anime-unskew flex items-center justify-center gap-2">${ICONS.SWORD} DUEL</span>
                        </button>
                        
                        <button onclick="gameState.view='BUILDER'; renderApp()" class="anime-btn h-16 text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 rounded-sm anime-skew text-white">
                            <span class="inline-block anime-unskew flex items-center justify-center gap-2">${ICONS.SCROLL} DECK BUILDER</span>
                        </button>
                        
                        <button onclick="gameState.view='SHOP'; renderApp()" class="anime-btn h-16 text-2xl font-bold bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 rounded-sm anime-skew text-white">
                            <span class="inline-block anime-unskew flex items-center justify-center gap-2">${ICONS.MONEY} DUEL SHOP</span>
                        </button>
                    </div>

                    <div class="absolute bottom-5 right-5 text-gray-500 font-mono text-sm">
                        Build v1.5 // Save: AUTO
                    </div>
                </div>

                <!-- RENAME MODAL -->
                <div id="rename-modal" style="display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;">
                    <div style="background:#0f172a;border:2px solid #00e5ff;border-radius:16px;padding:32px;min-width:340px;box-shadow:0 0 40px rgba(0,229,255,0.25);display:flex;flex-direction:column;gap:14px;align-items:center">
                        <div style="font-family:'Bangers',cursive;font-size:28px;color:#00e5ff;letter-spacing:.1em">RENAME DUELIST</div>
                        <input id="rename-input" maxlength="20" placeholder="Enter your duelist name..."
                               style="width:100%;background:#1e293b;border:1.5px solid #334155;border-radius:8px;padding:10px 14px;color:#f1f5f9;font-family:monospace;font-size:15px;outline:none;text-align:center"
                               onkeydown="if(event.key==='Enter') saveRename()" />
                        <div style="font-family:monospace;font-size:9px;color:#475569">Max 20 characters &nbsp;&nbsp; This is your public duelist ID</div>
                        <div style="display:flex;gap:10px;width:100%">
                            <button onclick="document.getElementById('rename-modal').style.display='none'" style="flex:1;font-family:'Bangers',cursive;font-size:18px;padding:8px;border-radius:10px;background:#1e293b;border:1.5px solid #334155;color:#94a3b8;cursor:pointer">CANCEL</button>
                            <button onclick="saveRename()" style="flex:2;font-family:'Bangers',cursive;font-size:18px;padding:8px;border-radius:10px;background:linear-gradient(135deg,#0e7490,#00e5ff);border:1.5px solid #00e5ff;color:#000;cursor:pointer">CONFIRM</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- VIEW: DECK BUILDER ---
        function renderDeckBuilder() {
            const mainCount = gameState.mainDeck.length;
            const extraCount = gameState.extraDeck.length;
            const isValid = mainCount >= 40 && mainCount <= 60;
            const _typeOrder = id => {
                const c = getCardById(parseInt(id));
                if (!c) return 99;
                const t = (c.type || '').toUpperCase();
                if (t === 'SPELL') return 10;
                if (t === 'TRAP')  return 20;
                return 0; // all monster types
            };
            const sortedInventory = Object.keys(gameState.inventory).sort((a, b) => {
                const tA = _typeOrder(a), tB = _typeOrder(b);
                if (tA !== tB) return tA - tB;
                const cA = getCardById(parseInt(a)), cB = getCardById(parseInt(b));
                if (!cA || !cB) return 0;
                if (tA === 0) {
                    // Both monsters: level desc, then ATK desc, then name
                    const lvDiff = (cB.level || 0) - (cA.level || 0);
                    if (lvDiff !== 0) return lvDiff;
                    const atkDiff = (cB.atk || 0) - (cA.atk || 0);
                    if (atkDiff !== 0) return atkDiff;
                }
                return (cA.name || '').localeCompare(cB.name || '');
            });

            root.innerHTML = `
                <div class="flex h-full p-2 gap-2 bg-gray-900/90 text-white">
                    
                    <!-- Left: Current Deck -->
                    <div class="w-1/2 flex flex-col border-r-4 border-gray-700 pr-2">
                        <div class="flex justify-between items-center bg-gray-800 p-3 rounded-t-lg border-b-2 border-cyan-500">
                            <div>
                                <h2 class="text-2xl font-[Bangers] text-cyan-400 tracking-wider">CONSTRUCT DECK</h2>
                                <div class="text-xs text-gray-400">Right-Click to Remove</div>
                            </div>
                            <div class="text-right">
                                <div class="${isValid ? 'text-green-400' : 'text-yellow-400'} font-mono font-bold text-xl">
                                    MAIN: ${mainCount} / 60
                                </div>
                                <div class="text-purple-400 font-mono text-sm">EXTRA: ${extraCount} / 15</div>
                            </div>
                            <button onclick="saveAndExit()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold font-mono text-sm border-2 border-green-300 shadow-[0_0_10px_rgba(74,222,128,0.5)]">SAVE & EXIT</button>
                        </div>

                        <!-- Main Deck Grid -->
                        <div class="flex-grow overflow-y-auto bg-black/40 p-2 border-2 border-gray-700 shadow-inner">
                            <h3 class="text-gray-500 text-xs font-bold mb-1 uppercase tracking-widest border-b border-gray-700 pb-1">Main Deck Cards</h3>
                            <div class="flex flex-wrap gap-1 content-start min-h-[50%]">
                                ${gameState.mainDeck.map((id, idx) => `
                                    <div oncontextmenu="event.preventDefault(); removeFromDeck(${idx}, false)" class="cursor-pointer hover:brightness-110 transition-all">
                                        ${renderSmallCard(id)}
                                    </div>
                                `).join('')}
                                ${gameState.mainDeck.length === 0 ? '<div class="w-full text-center text-gray-600 mt-10 italic">Drag cards here or click from trunk</div>' : ''}
                            </div>
                        </div>

                        <!-- Extra Deck Grid -->
                        <div class="h-1/4 overflow-y-auto bg-purple-900/20 p-2 border-2 border-purple-900/50 mt-2 shadow-inner">
                            <h3 class="text-purple-400 text-xs font-bold mb-1 uppercase tracking-widest border-b border-purple-800 pb-1">Extra Deck</h3>
                            <div class="flex flex-wrap gap-1">
                                ${gameState.extraDeck.map((id, idx) => `
                                    <div oncontextmenu="event.preventDefault(); removeFromDeck(${idx}, true)" class="cursor-pointer hover:brightness-110 transition-all">
                                        ${renderSmallCard(id)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Right: Trunk (Inventory) -->
                    <div class="w-1/2 flex flex-col pl-2">
                        <div class="flex justify-between items-center bg-gray-800 p-3 rounded-t-lg border-b-2 border-pink-500">
                            <h2 class="text-2xl font-[Bangers] text-pink-400 tracking-wider">CARD TRUNK</h2>
                            <div class="text-xs text-gray-400">Click to Add</div>
                        </div>
                        
                        <div class="flex-grow overflow-y-auto bg-gray-800/50 p-4 grid grid-cols-3 lg:grid-cols-4 gap-2 content-start custom-scrollbar">
                            ${sortedInventory.map(id => {
                                const card = getCardById(parseInt(id));
                                const count = gameState.inventory[id];
                                const usedMain = gameState.mainDeck.filter(c => c == id).length;
                                const usedExtra = gameState.extraDeck.filter(c => c == id).length;
                                const available = count - (usedMain + usedExtra);
                                
                                return `
                                <div onclick="addToDeck(${id})" 
                                     onmouseenter="showCardPreview(${id}, event)" 
                                     onmousemove="positionCardPreview(event)"
                                     onmouseleave="hideCardPreview()"
                                     class="relative group cursor-pointer transform hover:scale-105 transition-transform duration-100">
                                    ${renderCardHTML(card, "w-full", "h-48")}
                                    <div class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-white shadow-lg z-10">
                                        x${available}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSmallCard(id) {
            const card = getCardById(id);
            const styles = CARD_TYPES[card.type] || CARD_TYPES.NORMAL;
            // A mini representation
            return `
                <div class="${styles.color} w-12 h-16 rounded border border-black/50 shadow-sm relative overflow-hidden" title="${card.name}">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent pointer-events-none"></div>
                    <div class="w-full h-full flex flex-col items-center justify-center">
                        <div class="scale-50 opacity-75">${card.artIcon || ICONS.STAR}</div>
                    </div>
                </div>
            `;
        }

        function saveAndExit() {
            if(gameState.mainDeck.length < 40) {
                showToast("Deck under 40 cards! (Allowed for Prototype)", "info");
                // We allow exit now for testing purposes
            }
            gameState.view = 'MENU';
            renderApp();
        }

        // --- VIEW: SHOP ---
        function setShopTab(tab) { gameState.shopTab = tab; renderShop(); }

        function renderShop() {
            const tab = gameState.shopTab || 'PACKS';
            const _wFree   = !gameState.wheelLastSpin || (new Date().toDateString() !== new Date(gameState.wheelLastSpin).toDateString());
            const _wLocked = gameState.level < 2;

            //  Wheel mini-widget 
            const _wheelWidget = `
            <div onclick="${_wLocked ? "showToast('Reach Level 2 to unlock the Fortune Wheel!','error')" : 'openWheelModal()'}"
                 style="cursor:pointer;display:flex;align-items:center;gap:10px;padding:6px 12px;
                        border-radius:10px;border:2px solid ${_wLocked ? '#334155' : '#ffd700'};
                        background:${_wLocked ? 'rgba(0,0,0,0.3)' : 'rgba(255,215,0,0.07)'};
                        transition:transform 0.15s;${_wLocked ? 'opacity:0.55;' : 'box-shadow:0 0 14px rgba(255,215,0,0.25);'}"
                 onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                <div style="width:46px;height:46px;border-radius:50%;flex-shrink:0;position:relative;
                            background:conic-gradient(#22c55e 0deg 30deg,#3b82f6 30deg 60deg,#ca8a04 60deg 90deg,#f97316 90deg 120deg,#475569 120deg 150deg,#dc2626 150deg 180deg,#059669 180deg 210deg,#0891b2 210deg 240deg,#7c3aed 240deg 270deg,#9333ea 270deg 300deg,#92400e 300deg 330deg,#be185d 330deg 360deg);
                            border:2.5px solid ${_wLocked ? '#374151' : '#ffd700'};
                            ${_wLocked ? '' : 'animation:mini-wheel-spin 5s linear infinite;'}">
                    ${_wLocked
                        ? `<div style="position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,0.72);display:flex;align-items:center;justify-content:center;font-size:17px"></div>`
                        : `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:11px;height:11px;border-radius:50%;background:#000;border:2px solid #ffd700"></div>`
                    }
                </div>
                <div>
                    <div style="font-family:'Bangers',cursive;font-size:16px;letter-spacing:.1em;line-height:1;color:${_wLocked ? '#6b7280' : '#ffd700'}">FORTUNE WHEEL</div>
                    <div style="font-family:monospace;font-size:9px;color:${_wLocked ? '#4b5563' : (_wFree ? '#22c55e' : '#9ca3af')}">
                        ${_wLocked ? ' Unlock at Level 2' : (_wFree ? ' FREE SPIN READY!' : 'Extra spin  $250')}
                    </div>
                </div>
            </div>`;

            root.innerHTML = `
                <div class="flex flex-col h-full bg-gray-900 text-white relative" style="overflow:hidden">
                    <!--  HEADER  -->
                    <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 border-b-4 border-yellow-500 z-10 shadow-xl flex-shrink-0">
                        <div class="flex flex-col gap-2">
                            <button onclick="gameState.view='MENU'; renderApp()" class="text-gray-400 hover:text-white flex items-center gap-2 font-bold uppercase text-sm tracking-widest">
                                ${ICONS.BACK} Back to Menu
                            </button>
                            ${_wheelWidget}
                        </div>
                        <h2 class="text-5xl font-[Bangers] text-yellow-400 tracking-wider" style="text-shadow:0 0 20px rgba(255,215,0,0.4)">DUEL SHOP</h2>
                        <div class="flex flex-col items-end gap-2">
                            <div class="bg-gray-800 px-6 py-2 rounded-full border-2 border-green-500 flex items-center gap-2 shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                                <span class="text-green-400">${ICONS.MONEY}</span>
                                <span class="text-2xl font-mono font-bold text-white">$${gameState.money.toLocaleString()}</span>
                            </div>
                            ${(() => {
                                const locked = gameState.level < 5;
                                return `<div onclick="${locked ? "showToast('Reach Level 5 to unlock Scratch Tickets!','error')" : 'openScratchShop()'}"
                                     style="cursor:pointer;display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:10px;border:2px solid ${locked?'#334155':'#10b981'};background:${locked?'rgba(0,0,0,0.3)':'rgba(16,185,129,0.08)'};transition:transform 0.15s;${locked?'opacity:0.5;':'box-shadow:0 0 12px rgba(16,185,129,0.3);'}"
                                     onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:22px">${locked?'':''}</span>
                                    <div><div style="font-family:'Bangers',cursive;font-size:15px;letter-spacing:.1em;color:${locked?'#6b7280':'#10b981'};line-height:1">SCRATCH TICKETS</div>
                                    <div style="font-family:monospace;font-size:8px;color:${locked?'#4b5563':'#6ee7b7'}">${locked?' Unlock at Level 5':'Match 3 to Win!'}</div></div>
                                </div>`;
                            })()}
                            ${(() => {
                                const locked = gameState.level < 8;
                                return `<div onclick="${locked ? "showToast('Reach Level 8 to unlock Slots!','error')" : 'openSlotsModal()'}"
                                     style="cursor:pointer;display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:10px;border:2px solid ${locked?'#334155':'#fbbf24'};background:${locked?'rgba(0,0,0,0.3)':'rgba(251,191,36,0.08)'};transition:transform 0.15s;${locked?'opacity:0.5;':'box-shadow:0 0 12px rgba(251,191,36,0.3);'}"
                                     onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                                    <span style="font-size:22px">${locked?'':''}</span>
                                    <div><div style="font-family:'Bangers',cursive;font-size:15px;letter-spacing:.1em;color:${locked?'#6b7280':'#fbbf24'};line-height:1">SLOTS</div>
                                    <div style="font-family:monospace;font-size:8px;color:${locked?'#4b5563':'#fde68a'}">${locked?' Unlock at Level 8':'Match 3-4-5 to Win!'}</div></div>
                                </div>`;
                            })()}
                        </div>
                    </div>

                    <!--  TAB BAR  -->
                    <div class="flex flex-shrink-0 border-b-2 border-gray-700 bg-gray-900 z-10">
                        ${[
                            { id:'PACKS',       label:' PACKS',       sub:'Single Card Packs' },
                            { id:'ACCESSORIES', label:' ACCESSORIES',  sub:'Sleeves & Playmats' },
                            { id:'BOXES',       label:' BOXES',        sub:'Bulk Boxes & Decks' },
                        ].map(t => `
                        <button onclick="setShopTab('${t.id}')" style="
                            flex:1;padding:12px 8px;border:none;cursor:pointer;transition:all 0.2s;
                            background:${tab===t.id ? 'rgba(255,215,0,0.10)' : 'transparent'};
                            border-bottom:3px solid ${tab===t.id ? '#ffd700' : 'transparent'};
                            text-align:center;">
                            <div style="font-family:'Bangers',cursive;font-size:20px;letter-spacing:.08em;color:${tab===t.id ? '#ffd700' : '#6b7280'}">${t.label}</div>
                            <div style="font-family:monospace;font-size:9px;color:${tab===t.id ? '#fde68a' : '#374151'}">${t.sub}</div>
                        </button>`).join('')}
                    </div>

                    <!--  TAB CONTENT  -->
                    <div class="flex-grow overflow-y-auto overflow-x-hidden" style="scrollbar-color:#334155 #111827">
                        ${tab === 'PACKS'       ? _renderShopPacks()       : ''}
                        ${tab === 'ACCESSORIES' ? _renderShopAccessories() : ''}
                        ${tab === 'BOXES'       ? _renderShopBoxes()       : ''}
                    </div>
                </div>

                <!-- Pack opening overlay (always present in DOM) -->
                <div id="pack-overlay" class="hidden fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center">
                    <div id="pack-title" class="text-white text-3xl font-[Orbitron] mb-8 animate-bounce">CLICK CARDS TO REVEAL!</div>
                    <div id="pack-cards-container" class="flex flex-wrap justify-center gap-4 max-w-6xl p-4 perspective-1000"></div>
                    <button id="overlay-action-btn" onclick="closePackOverlay()" class="mt-10 px-8 py-3 bg-white text-black font-bold text-xl rounded hover:bg-gray-200 anime-skew">DONE</button>
                </div>
            `;
        }

        //  PACKS TAB 
        function _renderShopPacks() {
            return `
            <style>
              @property --vault-angle { syntax:'<angle>'; initial-value:0deg; inherits:false; }
              @keyframes vault-spin { to { --vault-angle:360deg; } }
              .vault-ring { position:absolute;inset:-4px;border-radius:18px;background:linear-gradient(var(--vault-angle),#ffd700,#ff00cc,#00e5ff,#ff8800,#aa00ff,#ffd700);animation:vault-spin 3s linear infinite;z-index:0; }
              .vault-ring-blur { position:absolute;inset:-4px;border-radius:18px;background:linear-gradient(var(--vault-angle),#ffd700,#ff00cc,#00e5ff,#ff8800,#aa00ff,#ffd700);animation:vault-spin 3s linear infinite;z-index:0;filter:blur(10px);opacity:0.75; }
            </style>
            <div style="display:flex;align-items:center;justify-content:center;gap:32px;padding:40px;flex-wrap:wrap;">
                ${PACKS.filter(p=>!p.internal).map(pack => {
                    const isFree = gameState.shopFirstPulls[pack.id];
                    const isVault = !!pack.singleCard;
                    const isLocked = !!(pack.levelReq) && gameState.level < pack.levelReq;
                    if (isVault) {
                        return `
                        <div class="relative" style="flex-shrink:0;width:288px;height:384px">
                            <div class="vault-ring-blur"></div><div class="vault-ring"></div>
                            <div style="position:relative;width:100%;height:100%;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:16px;background:linear-gradient(135deg,#0a0010,#1a0040,#000820);z-index:1;transform:translateZ(0)">
                                ${isLocked ? `<div style="position:absolute;inset:0;background:rgba(0,0,0,0.75);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;border-radius:14px"><div style="font-size:52px"></div><p style="font-family:'Bangers',cursive;font-size:22px;color:#ffd700;letter-spacing:.12em;margin-top:8px">LOCKED</p><p style="font-family:monospace;font-size:11px;color:#6b7280;margin-top:6px">Reach Level ${pack.levelReq} to unlock</p><p style="font-family:monospace;font-size:10px;color:#4b5563;margin-top:2px">Current Level: ${gameState.level}</p></div>` : ''}
                                <div style="font-family:'Bangers',cursive;font-size:38px;line-height:1;letter-spacing:.06em;text-align:center;margin-top:12px;background:linear-gradient(135deg,#ffd700,#ff88cc,#00e5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 10px rgba(255,215,0,0.7));position:relative;z-index:10">APEX<br>VAULT</div>
                                <div style="position:absolute;top:36%;left:50%;transform:translate(-50%,-50%);font-size:110px;opacity:0.07;pointer-events:none"></div>
                                <div style="font-family:monospace;font-size:9px;color:#a855f7;text-align:center;letter-spacing:.14em;position:relative;z-index:10;line-height:1.6"> EXCLUSIVE VAULT CARDS <br><span style="color:#6b7280;font-size:8px">1 CARD PER DRAW  RAREST POOL</span></div>
                                <div style="margin-bottom:12px;width:100%;display:flex;flex-direction:column;gap:8px;position:relative;z-index:20">
                                    <button onclick="buyPack('p5',1)" ${isLocked?'disabled':''} style="width:100%;padding:9px 16px;border-radius:8px;font-family:'Bangers',cursive;font-size:17px;letter-spacing:.07em;cursor:${isLocked?'not-allowed':'pointer'};display:flex;justify-content:space-between;align-items:center;background:${isLocked?'#1f2937':'linear-gradient(135deg,#7c3aed,#a855f7)'};border:2px solid ${isLocked?'#374151':'#d8b4fe'};color:${isLocked?'#6b7280':'#fff'};box-shadow:${isLocked?'none':'0 0 16px rgba(168,85,247,0.45)'}"><span> DRAW 1</span><span style="color:#ffd700">$500</span></button>
                                    <button onclick="buyPack('p5',5)" ${isLocked?'disabled':''} style="width:100%;padding:9px 16px;border-radius:8px;font-family:'Bangers',cursive;font-size:17px;letter-spacing:.07em;cursor:${isLocked?'not-allowed':'pointer'};display:flex;justify-content:space-between;align-items:center;background:${isLocked?'#1f2937':'linear-gradient(135deg,#ca8a04,#f59e0b)'};border:2px solid ${isLocked?'#374151':'#fcd34d'};color:${isLocked?'#6b7280':'#000'};box-shadow:${isLocked?'none':'0 0 16px rgba(255,215,0,0.5)'}"><span> DRAW 5</span><span>$2,500</span></button>
                                </div>
                            </div>
                        </div>`;
                    }
                    return `
                    <div style="position:relative;width:288px;height:384px;flex-shrink:0">
                        <div class="bg-gradient-to-br ${pack.color} rounded-xl shadow-2xl border-4 border-white/10 relative overflow-hidden flex flex-col items-center justify-between p-4 shine-effect" style="width:100%;height:100%;${isLocked?'filter:saturate(0.3) brightness(0.55);':''}">
                            ${isLocked?`<div style="position:absolute;inset:0;background:rgba(0,0,0,0.70);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;border-radius:10px;"><div style="font-size:48px"></div><p style="font-family:'Bangers',cursive;font-size:22px;color:#ffd700;letter-spacing:.12em;margin-top:8px">LOCKED</p><p style="font-family:monospace;font-size:11px;color:#9ca3af;margin-top:6px">Reach Level ${pack.levelReq} to unlock</p></div>`:''}
                            <div style="margin-top:32px;font-family:'Bangers',cursive;font-size:36px;text-align:center;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.5);line-height:1.1;transform:skewX(-6deg)">${pack.name.split(' ').join('<br>')}</div>
                            <div style="position:absolute;top:25%;left:50%;transform:translate(-50%,-50%);width:128px;height:128px;background:rgba(0,0,0,0.2);border-radius:50%;filter:blur(20px)"></div>
                            <div style="margin-bottom:16px;width:100%;display:flex;flex-direction:column;gap:8px;position:relative;z-index:20">
                                <button onclick="buyPack('${pack.id}',1)" ${isLocked?'disabled':''} style="width:100%;background:#111827;color:#fff;padding:8px 16px;border-radius:6px;font-weight:bold;border:1px solid #4b5563;display:flex;justify-content:space-between;${isLocked?'cursor:not-allowed;opacity:0.4;':'cursor:pointer;'}">
                                    <span>DRAW 1</span><span style="color:${isFree?'#4ade80':'#fbbf24'}">${isFree?'FREE!':'$'+pack.cost}</span>
                                </button>
                                <button onclick="buyPack('${pack.id}',5)" ${isLocked?'disabled':''} style="width:100%;background:linear-gradient(to right,#ca8a04,#ea580c);color:#fff;padding:8px 16px;border-radius:6px;font-weight:bold;border:1px solid #fbbf24;display:flex;justify-content:space-between;${isLocked?'cursor:not-allowed;opacity:0.4;':'cursor:pointer;'}">
                                    <span>DRAW 5</span><span>$${pack.cost*5}</span>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        //  ACCESSORIES TAB 
        function _renderShopAccessories() {
            const sleeveHTML = CARD_SLEEVES.map(s => {
                const owned = !!gameState.ownedAccessories[s.id];
                const equipped = gameState.equippedSleeve === s.id;
                return `
                <div style="background:rgba(0,0,0,0.5);border:2px solid ${equipped?'#ffd700':owned?'#374151':'#1f2937'};border-radius:14px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;width:180px;flex-shrink:0;
                            box-shadow:${equipped?'0 0 20px rgba(255,215,0,0.4)':'none'};transition:all 0.2s;">
                    <!-- Card back preview with SVG artwork -->
                    <div style="width:72px;height:98px;border-radius:8px;border:2.5px solid ${s.border};box-shadow:0 0 14px ${s.border}55,0 0 4px ${s.border}44 inset;overflow:hidden;position:relative;flex-shrink:0;">
                        ${s.svgPreview}
                        ${equipped?`<div style="position:absolute;inset:0;border:2px solid #ffd700;border-radius:6px;box-shadow:0 0 10px rgba(255,215,0,0.6) inset"></div>`:''}
                    </div>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:16px;color:${equipped?'#ffd700':'#fff'};letter-spacing:.06em">${s.name}</div>
                        <div style="font-family:monospace;font-size:9px;color:#6b7280;margin-top:2px">${s.desc}</div>
                    </div>
                    ${equipped
                        ? `<div style="font-family:'Bangers',cursive;font-size:14px;color:#ffd700;padding:6px 16px;background:rgba(255,215,0,0.12);border:1.5px solid #ffd700;border-radius:8px;letter-spacing:.06em"> EQUIPPED</div>`
                        : owned
                            ? `<button onclick="equipSleeve('${s.id}')" style="font-family:'Bangers',cursive;font-size:14px;color:#fff;padding:6px 16px;background:linear-gradient(135deg,#1e3a5f,#0f172a);border:1.5px solid #334155;border-radius:8px;cursor:pointer;letter-spacing:.06em">EQUIP</button>`
                            : `<button onclick="buySleeve('${s.id}')" style="font-family:'Bangers',cursive;font-size:14px;color:#000;padding:6px 16px;background:linear-gradient(135deg,#ca8a04,#f59e0b);border:1.5px solid #fcd34d;border-radius:8px;cursor:pointer;letter-spacing:.06em">$${s.cost}</button>`
                    }
                </div>`;
            }).join('');

            const matHTML = PLAYMATS.map(m => {
                const owned = !!gameState.ownedAccessories[m.id];
                const equipped = gameState.equippedPlaymat === m.id;
                return `
                <div style="background:rgba(0,0,0,0.5);border:2px solid ${equipped?'#ffd700':owned?'#374151':'#1f2937'};border-radius:14px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;width:200px;flex-shrink:0;
                            box-shadow:${equipped?'0 0 20px rgba(255,215,0,0.4)':'none'};transition:all 0.2s;">
                    <!-- Playmat preview with SVG artwork -->
                    <div style="width:140px;height:70px;border-radius:8px;border:2px solid ${m.accent}66;box-shadow:0 0 12px ${m.accent}44;overflow:hidden;position:relative;flex-shrink:0;">
                        ${m.svgPreview}
                        ${equipped?`<div style="position:absolute;inset:0;border:2px solid #ffd700;border-radius:6px;box-shadow:0 0 8px rgba(255,215,0,0.5) inset"></div>`:''}
                    </div>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:16px;color:${equipped?'#ffd700':'#fff'};letter-spacing:.06em">${m.name}</div>
                        <div style="font-family:monospace;font-size:9px;color:#6b7280;margin-top:2px">${m.desc}</div>
                    </div>
                    ${equipped
                        ? `<div style="font-family:'Bangers',cursive;font-size:14px;color:#ffd700;padding:6px 16px;background:rgba(255,215,0,0.12);border:1.5px solid #ffd700;border-radius:8px;letter-spacing:.06em"> EQUIPPED</div>`
                        : owned
                            ? `<button onclick="equipPlaymat('${m.id}')" style="font-family:'Bangers',cursive;font-size:14px;color:#fff;padding:6px 16px;background:linear-gradient(135deg,#1e3a5f,#0f172a);border:1.5px solid #334155;border-radius:8px;cursor:pointer;letter-spacing:.06em">EQUIP</button>`
                            : `<button onclick="buyPlaymat('${m.id}')" style="font-family:'Bangers',cursive;font-size:14px;color:#000;padding:6px 16px;background:linear-gradient(135deg,#ca8a04,#f59e0b);border:1.5px solid #fcd34d;border-radius:8px;cursor:pointer;letter-spacing:.06em">$${m.cost}</button>`
                    }
                </div>`;
            }).join('');

            const iconHTML = PLAYER_ICONS.map(icon => {
                const owned   = !!gameState.ownedSymbols[icon.id] || icon.cost === 0;
                const equipped = gameState.equippedSymbol === icon.id;
                return `
                <div style="background:rgba(0,0,0,0.5);border:2px solid ${equipped?'#00e5ff':owned?'#374151':'#1f2937'};border-radius:14px;padding:14px 10px;display:flex;flex-direction:column;align-items:center;gap:8px;width:130px;flex-shrink:0;
                            box-shadow:${equipped?'0 0 18px rgba(0,229,255,0.35)':'none'};transition:all 0.2s;">
                    <div style="font-size:40px;line-height:1;filter:${equipped?'drop-shadow(0 0 10px rgba(0,229,255,0.7))':'none'}">${icon.emoji}</div>
                    <div style="text-align:center">
                        <div style="font-family:'Bangers',cursive;font-size:15px;color:${equipped?'#00e5ff':'#fff'};letter-spacing:.06em">${icon.name}</div>
                        <div style="font-family:monospace;font-size:8px;color:#6b7280;margin-top:2px">${icon.desc}</div>
                    </div>
                    ${equipped
                        ? `<div style="font-family:'Bangers',cursive;font-size:12px;color:#00e5ff;padding:4px 12px;background:rgba(0,229,255,0.1);border:1px solid #00e5ff;border-radius:8px"> EQUIPPED</div>`
                        : owned
                            ? `<button onclick="equipSymbol('${icon.id}')" style="font-family:'Bangers',cursive;font-size:13px;color:#fff;padding:5px 14px;background:linear-gradient(135deg,#1e3a5f,#0f172a);border:1.5px solid #334155;border-radius:8px;cursor:pointer">EQUIP</button>`
                            : `<button onclick="buySymbol('${icon.id}')" style="font-family:'Bangers',cursive;font-size:13px;color:#000;padding:5px 14px;background:linear-gradient(135deg,#ca8a04,#f59e0b);border:1.5px solid #fcd34d;border-radius:8px;cursor:pointer">$${icon.cost}</button>`
                    }
                </div>`;
            }).join('');

            return `
            <div style="padding:32px;max-width:1200px;margin:0 auto">
                <!--  PLAYER ICONS  -->
                <div style="margin-bottom:32px">
                    <div style="font-family:'Bangers',cursive;font-size:30px;color:#00e5ff;letter-spacing:.1em;margin-bottom:6px"> PLAYER ICON</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:16px">The symbol displayed beside your duelist name on your profile.</div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">${iconHTML}</div>
                </div>
                <div style="border-top:2px solid #1f2937;padding-top:28px;margin-bottom:32px">
                    <div style="font-family:'Bangers',cursive;font-size:30px;color:#f472b6;letter-spacing:.1em;margin-bottom:6px"> CARD SLEEVES</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:16px">Customize the back design of all your cards in duels.</div>
                    <div style="display:flex;gap:14px;flex-wrap:wrap;">${sleeveHTML}</div>
                </div>
                <div style="border-top:2px solid #1f2937;padding-top:28px;margin-top:0">
                    <div style="font-family:'Bangers',cursive;font-size:30px;color:#60a5fa;letter-spacing:.1em;margin-bottom:6px"> PLAYMATS</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:16px">Change the look of your side of the field during duels.</div>
                    <div style="display:flex;gap:14px;flex-wrap:wrap;">${matHTML}</div>
                </div>
            </div>`;
        }

        //  BOXES TAB 
        function _renderShopBoxes() {
            //  Standard Boxes 
            const standardBoxHTML = PACKS.filter(p=>!p.singleCard&&!p.internal).map(pack => {
                const isLocked = !!(pack.levelReq) && gameState.level < pack.levelReq;
                const boxCost = pack.cost * 10;
                const fiveBoxCost = boxCost * 5;
                return `
                <div style="background:rgba(0,0,0,0.5);border:2px solid ${isLocked?'#1f2937':'#334155'};border-radius:16px;padding:18px;width:220px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:10px;${isLocked?'filter:saturate(0.3) brightness(0.6);':''};position:relative">
                    ${isLocked?`<div style="position:absolute;inset:0;background:rgba(0,0,0,0.65);border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10"><div style="font-size:40px"></div><div style="font-family:'Bangers',cursive;font-size:16px;color:#ffd700;letter-spacing:.1em">Level ${pack.levelReq}</div></div>`:''}
                    <!-- Box visual: stacked packs -->
                    <div style="position:relative;width:100px;height:80px;margin-top:4px;">
                        ${[2,1,0].map(i=>`<div style="position:absolute;left:${i*6}px;top:${i*4}px;width:80px;height:56px;background:linear-gradient(135deg,${pack.color.includes('blue')?'#1e3a8a,#2563eb':pack.color.includes('red')?'#7f1d1d,#dc2626':pack.color.includes('purple')?'#581c87,#9333ea':'#713f12,#ca8a04'});border-radius:8px;border:2px solid rgba(255,255,255,0.2);box-shadow:2px 2px 4px rgba(0,0,0,0.5)"></div>`).join('')}
                        <div style="position:absolute;top:4px;left:4px;font-family:'Bangers',cursive;font-size:10px;color:rgba(255,255,255,0.8);letter-spacing:.06em;line-height:1.2;padding:4px">10<br>PACKS</div>
                    </div>
                    <div style="font-family:'Bangers',cursive;font-size:18px;color:#fff;letter-spacing:.06em;text-align:center">${pack.name}<br><span style="font-size:13px;color:#9ca3af">Box</span></div>
                    <div style="font-family:monospace;font-size:9px;color:#6b7280;text-align:center">10 packs  5 cards each = 50 cards</div>
                    <button onclick="buyBox('${pack.id}',1)" ${isLocked?'disabled':''} style="width:100%;font-family:'Bangers',cursive;font-size:16px;padding:7px;border-radius:8px;background:linear-gradient(135deg,#1e3a5f,#1d4ed8);border:1.5px solid #3b82f6;color:#fff;cursor:${isLocked?'not-allowed':'pointer'};display:flex;justify-content:space-between">
                        <span>1 BOX</span><span style="color:#fbbf24">$${boxCost.toLocaleString()}</span>
                    </button>
                    <button onclick="buyBox('${pack.id}',5)" ${isLocked?'disabled':''} style="width:100%;font-family:'Bangers',cursive;font-size:16px;padding:7px;border-radius:8px;background:linear-gradient(135deg,#713f12,#f59e0b);border:1.5px solid #fcd34d;color:#000;cursor:${isLocked?'not-allowed':'pointer'};display:flex;justify-content:space-between">
                        <span>5 BOXES</span><span>$${Math.round(fiveBoxCost*0.9).toLocaleString()} <span style="font-size:11px;opacity:0.7">10% off</span></span>
                    </button>
                </div>`;
            }).join('');

            //  Structure Decks 
            const sdHTML = STRUCTURE_DECKS.map(sd => {
                const bought = gameState.structureDecksBought[sd.id] || 0;
                const maxed = bought >= sd.maxBuy;
                const linkedPack = PACKS.find(p=>p.id===sd.linkedPack);
                return `
                <div style="background:rgba(0,0,0,0.6);border:2px solid ${maxed?'#374151':'#6b7280'};border-radius:16px;overflow:hidden;width:250px;flex-shrink:0">
                    <div class="bg-gradient-to-br ${sd.color}" style="padding:14px;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative">
                        <div style="font-size:40px">${sd.icon}</div>
                        <div style="font-family:'Bangers',cursive;font-size:22px;color:#fff;letter-spacing:.08em;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,0.5)">${sd.name}</div>
                        <div style="font-family:monospace;font-size:8px;color:rgba(255,255,255,0.6);letter-spacing:.08em">STRUCTURE DECK  40 CARDS</div>
                    </div>
                    <div style="padding:14px;display:flex;flex-direction:column;gap:8px">
                        <div style="font-family:monospace;font-size:10px;color:#9ca3af;line-height:1.5">${sd.desc}</div>
                        <div style="font-family:monospace;font-size:9px;color:#475569"> Supplemented by: <span style="color:#6b7280">${linkedPack?.name||''}</span></div>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-family:monospace;font-size:9px;color:${maxed?'#ef4444':'#22c55e'}">
                                ${maxed?'MAX COPIES OWNED':bought===0?'Not yet purchased':`Owned: ${bought}/${sd.maxBuy}`}
                            </div>
                            <div style="display:flex;gap:2px">${Array.from({length:sd.maxBuy},(_,i)=>`<div style="width:16px;height:16px;border-radius:3px;background:${i<bought?'#22c55e':'#1f2937'};border:1px solid ${i<bought?'#4ade80':'#374151'}"></div>`).join('')}</div>
                        </div>
                        <button onclick="previewStructureDeck('${sd.id}')" style="width:100%;font-family:'Bangers',cursive;font-size:16px;padding:8px;border-radius:10px;
                            background:linear-gradient(135deg,#1e3a5f,#1d4ed8);
                            border:2px solid #3b82f6;color:#fff;cursor:pointer;
                            display:flex;justify-content:center;align-items:center;gap:6px;margin-bottom:4px">
                             PREVIEW DECK
                        </button>
                        <button onclick="buyStructureDeck('${sd.id}')" ${maxed?'disabled':''} style="width:100%;font-family:'Bangers',cursive;font-size:18px;padding:10px;border-radius:10px;
                            background:${maxed?'#1f2937':'linear-gradient(135deg,#15803d,#22c55e)'};
                            border:2px solid ${maxed?'#374151':'#4ade80'};
                            color:${maxed?'#4b5563':'#fff'};cursor:${maxed?'not-allowed':'pointer'};
                            display:flex;justify-content:space-between;align-items:center">
                            <span>${maxed?'MAXED OUT':'BUY DECK'}</span>
                            <span style="color:${maxed?'#4b5563':'#fbbf24'}">$${sd.cost.toLocaleString()}</span>
                        </button>
                    </div>
                </div>`;
            }).join('');

            //  Collector Boxes 
            const cbHTML = COLLECTOR_BOXES.map(cb => {
                return `
                <div style="position:relative;flex-shrink:0;width:340px;">
                    <!-- Animated border glow -->
                    <div style="position:absolute;inset:-4px;border-radius:20px;
                                background:conic-gradient(${cb.borderColor},transparent 40%,${cb.borderColor} 60%,transparent 80%,${cb.borderColor});
                                animation:vault-spin 3s linear infinite;z-index:0;filter:blur(8px);opacity:0.7"></div>
                    <div style="position:absolute;inset:-2px;border-radius:18px;border:2px solid ${cb.borderColor};z-index:0;opacity:0.5"></div>
                    <div class="bg-gradient-to-br ${cb.color}" style="position:relative;z-index:1;border-radius:16px;overflow:hidden;border:2px solid ${cb.borderColor}44">
                        <!-- Header -->
                        <div style="padding:20px;text-align:center;background:rgba(0,0,0,0.4);border-bottom:1px solid ${cb.borderColor}33">
                            <div style="font-size:48px">${cb.icon}</div>
                            <div style="font-family:'Bangers',cursive;font-size:28px;letter-spacing:.1em;color:${cb.borderColor};text-shadow:0 0 12px ${cb.glowColor};line-height:1">${cb.name}</div>
                            <div style="font-family:monospace;font-size:8px;color:rgba(255,255,255,0.5);letter-spacing:.16em;margin-top:4px">RARE COLLECTOR BOX ${cb.icon2}</div>
                        </div>
                        <!-- Content -->
                        <div style="padding:16px;display:flex;flex-direction:column;gap:12px">
                            <div style="font-family:monospace;font-size:10px;color:rgba(255,255,255,0.7);line-height:1.6">${cb.desc}</div>
                            <!-- What's inside -->
                            <div style="background:rgba(0,0,0,0.4);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:6px">
                                <div style="font-family:'Bangers',cursive;font-size:14px;color:${cb.borderColor};letter-spacing:.08em">WHAT'S INSIDE:</div>
                                ${cb.openSequence.map(seq => {
                                    const p = PACKS.find(pk => pk.id === seq.packId);
                                    const isCollection = seq.packId.startsWith('p') && (seq.packId==='pNem'||seq.packId==='pOmg');
                                    return `<div style="font-family:monospace;font-size:9px;color:${isCollection?cb.borderColor:'rgba(255,255,255,0.7)'}">
                                        ${isCollection?'':''} ${seq.count > 1 ? seq.count + ' ' : ''}${seq.label}
                                    </div>`;
                                }).join('')}
                                <div style="font-family:monospace;font-size:9px;color:${cb.borderColor};margin-top:2px">${cb.guaranteedLabel}</div>
                                <div style="font-family:monospace;font-size:9px;color:rgba(255,255,255,0.4);border-top:1px solid rgba(255,255,255,0.1);padding-top:4px;margin-top:2px">${cb.guaranteedPool.length} cards in the guaranteed vault pool</div>
                            </div>
                            <!-- Price -->
                            <div style="text-align:center">
                                <div style="font-family:'Bangers',cursive;font-size:36px;color:${cb.borderColor};text-shadow:0 0 16px ${cb.glowColor};letter-spacing:.08em">$${cb.cost.toLocaleString()}</div>
                                <div style="font-family:monospace;font-size:8px;color:rgba(255,255,255,0.4)">per box  extremely rare contents</div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button onclick="buyCollectorBox('${cb.id}',1)" style="flex:1;font-family:'Bangers',cursive;font-size:18px;padding:12px 8px;border-radius:10px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(0,0,0,0.3));border:2px solid ${cb.borderColor};color:${cb.borderColor};cursor:pointer;box-shadow:0 0 16px ${cb.glowColor};letter-spacing:.06em">
                                    1 BOX
                                </button>
                                <button onclick="buyCollectorBox('${cb.id}',3)" style="flex:1;font-family:'Bangers',cursive;font-size:18px;padding:12px 8px;border-radius:10px;background:linear-gradient(135deg,${cb.borderColor}33,${cb.borderColor}22);border:2px solid ${cb.borderColor};color:#fff;cursor:pointer;box-shadow:0 0 20px ${cb.glowColor};letter-spacing:.06em">
                                    3 BOXES<br><span style="font-size:11px;opacity:0.8">$${(cb.cost*3*0.85).toLocaleString().split('.')[0]} <span style="font-size:9px">15% off</span></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            return `
            <div style="padding:32px;max-width:1400px;margin:0 auto">
                <!-- Standard Boxes -->
                <div style="margin-bottom:40px">
                    <div style="font-family:'Bangers',cursive;font-size:28px;color:#fbbf24;letter-spacing:.1em;margin-bottom:4px"> PACK BOXES</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:18px">Buy 10 packs at once. 5-box orders get a 10% discount.</div>
                    <div style="display:flex;gap:16px;flex-wrap:wrap">${standardBoxHTML}</div>
                </div>

                <!-- Structure Decks -->
                <div style="border-top:2px solid #1f2937;padding-top:32px;margin-bottom:40px">
                    <div style="font-family:'Bangers',cursive;font-size:28px;color:#4ade80;letter-spacing:.1em;margin-bottom:4px"> STRUCTURE DECKS</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:18px">Pre-built 40-card theme decks. Max 3 copies per deck. Some exclusive cards also appear in supplementary packs.</div>
                    <div style="display:flex;gap:16px;flex-wrap:wrap">${sdHTML}</div>
                </div>

                <!-- Collector Boxes -->
                <div style="border-top:2px solid #1f2937;padding-top:32px">
                    <div style="font-family:'Bangers',cursive;font-size:28px;color:#f0abfc;letter-spacing:.1em;margin-bottom:4px"> RARE COLLECTOR BOXES</div>
                    <div style="font-family:monospace;font-size:11px;color:#6b7280;margin-bottom:18px">The ultimate collector's item. Guaranteed exclusive UR card + 10 randomized packs. Extremely rare. Extremely expensive.</div>
                    <div style="display:flex;gap:24px;flex-wrap:wrap;justify-content:center">${cbHTML}</div>
                </div>
            </div>`;
        }

        function closePackOverlay() {
            document.getElementById('pack-overlay').classList.add('hidden');
        }

        //  STRUCTURE DECK PREVIEW MODAL 
        function previewStructureDeck(sdId) {
            const sd = STRUCTURE_DECKS.find(s => s.id === sdId);
            if (!sd) return;

            // Build deduplicated list with counts
            const countMap = {};
            sd.list.forEach(id => { countMap[id] = (countMap[id] || 0) + 1; });
            const unique = Object.keys(countMap).map(id => ({ card: CARD_DB.find(c => c.id == id), count: countMap[id] })).filter(e => e.card);

            const monsters = unique.filter(e => !['SPELL','TRAP'].includes(e.card.type)).sort((a,b) => (b.card.level||0) - (a.card.level||0) || (b.card.atk||0) - (a.card.atk||0));
            const spells   = unique.filter(e => e.card.type === 'SPELL').sort((a,b) => a.card.name.localeCompare(b.card.name));
            const traps    = unique.filter(e => e.card.type === 'TRAP').sort((a,b) => a.card.name.localeCompare(b.card.name));

            const rarityColor = { 'UR':'#ffd700', 'SR':'#c084fc', 'R':'#60a5fa', 'C':'#9ca3af' };

            function renderSection(label, entries, icon) {
                if (!entries.length) return '';
                const cards = entries.map(({ card, count }) => `
                    <div onmouseenter="showCardPreview(${card.id},this)" onmouseleave="hideCardPreview()"
                         style="background:rgba(0,0,0,0.55);border:1.5px solid ${rarityColor[card.rarity]||'#374151'};border-radius:10px;padding:10px 8px;display:flex;flex-direction:column;align-items:center;gap:5px;width:100px;flex-shrink:0;cursor:default;position:relative">
                        ${count>1?`<div style="position:absolute;top:5px;right:7px;font-family:'Bangers',cursive;font-size:13px;color:${rarityColor[card.rarity]||'#9ca3af'}">${count}</div>`:''}
                        <div style="width:58px;height:58px;display:flex;align-items:center;justify-content:center">${card.artIcon}</div>
                        <div style="font-family:monospace;font-size:8px;color:${rarityColor[card.rarity]||'#9ca3af'};text-align:center;line-height:1.3;word-break:break-word">${card.name}</div>
                        ${card.type==='MONSTER'?`<div style="font-family:monospace;font-size:8px;color:#6b7280">ATK ${card.atk} / DEF ${card.def}</div>`:''}
                    </div>`).join('');
                return `
                    <div style="margin-bottom:20px">
                        <div style="font-family:'Bangers',cursive;font-size:18px;color:#94a3b8;letter-spacing:.08em;margin-bottom:10px">${icon} ${label} (${entries.reduce((s,e)=>s+e.count,0)})</div>
                        <div style="display:flex;flex-wrap:wrap;gap:8px">${cards}</div>
                    </div>`;
            }

            const bought = gameState.structureDecksBought[sd.id] || 0;
            const maxed  = bought >= sd.maxBuy;

            const html = `
            <div id="sd-preview-overlay" onclick="if(event.target===this)closeSDPreview()" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:24px 16px">
                <div style="background:#0f172a;border:2px solid #334155;border-radius:20px;width:100%;max-width:900px;overflow:hidden;position:relative">
                    <!-- Header -->
                    <div class="bg-gradient-to-br ${sd.color}" style="padding:20px 24px;display:flex;align-items:center;gap:16px;border-bottom:2px solid rgba(255,255,255,0.1)">
                        <div style="font-size:44px">${sd.icon}</div>
                        <div style="flex:1">
                            <div style="font-family:'Bangers',cursive;font-size:28px;color:#fff;letter-spacing:.08em;line-height:1">${sd.name}</div>
                            <div style="font-family:monospace;font-size:10px;color:rgba(255,255,255,0.6);margin-top:3px">STRUCTURE DECK  ${sd.list.length} CARDS TOTAL</div>
                            <div style="font-family:monospace;font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">${sd.desc}</div>
                        </div>
                        <button onclick="closeSDPreview()" style="background:rgba(0,0,0,0.4);border:1.5px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:20px;width:36px;height:36px;cursor:pointer;flex-shrink:0"></button>
                    </div>
                    <!-- Card Grid -->
                    <div style="padding:24px">
                        ${renderSection('Monsters', monsters, '')}
                        ${renderSection('Spells',   spells,   '')}
                        ${renderSection('Traps',    traps,    '')}
                    </div>
                    <!-- Footer: Buy button -->
                    <div style="border-top:2px solid #1e293b;padding:16px 24px;display:flex;justify-content:flex-end;align-items:center;gap:14px;background:rgba(0,0,0,0.3)">
                        <div style="font-family:monospace;font-size:10px;color:${maxed?'#ef4444':'#22c55e'}">
                            ${maxed ? 'MAX COPIES OWNED' : bought===0 ? 'Not yet purchased' : `Owned: ${bought}/${sd.maxBuy}`}
                        </div>
                        <button onclick="closeSDPreview();buyStructureDeck('${sd.id}')" ${maxed?'disabled':''} style="font-family:'Bangers',cursive;font-size:20px;padding:10px 28px;border-radius:10px;
                            background:${maxed?'#1f2937':'linear-gradient(135deg,#15803d,#22c55e)'};
                            border:2px solid ${maxed?'#374151':'#4ade80'};
                            color:${maxed?'#4b5563':'#fff'};cursor:${maxed?'not-allowed':'pointer'}">
                            ${maxed?'MAXED OUT':'BUY DECK'} &nbsp;<span style="color:${maxed?'#4b5563':'#fbbf24'}">$${sd.cost.toLocaleString()}</span>
                        </button>
                    </div>
                </div>
            </div>`;

            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeSDPreview() {
            const el = document.getElementById('sd-preview-overlay');
            if (el) el.remove();
        }

        //  PROFILE FUNCTIONS 
        function openRenameModal() {
            const m = document.getElementById('rename-modal');
            if (!m) return;
            document.getElementById('rename-input').value = gameState.duelistName;
            m.style.display = 'flex';
            setTimeout(() => document.getElementById('rename-input').focus(), 50);
        }

        function saveRename() {
            const input = document.getElementById('rename-input');
            const val = (input ? input.value : '').trim();
            if (!val) { showToast('Name cannot be empty!', 'error'); return; }
            gameState.duelistName = val;
            saveGame();
            document.getElementById('rename-modal').style.display = 'none';
            showToast(`Duelist name set to "${val}"!`, 'success');
        }

        function confirmResetGame() {
            if (confirm('ERASE ALL DATA?\n\nThis will permanently delete your save  all cards, credits, and progress.\n\nThis cannot be undone.')) {
                resetGame();
            }
        }

        function buySymbol(iconId) {
            const icon = PLAYER_ICONS.find(i=>i.id===iconId);
            if (!icon) return;
            if (icon.cost === 0 || gameState.ownedSymbols[iconId]) { equipSymbol(iconId); return; }
            if (gameState.money < icon.cost) { showToast('Not enough credits!', 'error'); return; }
            gameState.money -= icon.cost;
            gameState.ownedSymbols[iconId] = true;
            equipSymbol(iconId);
            showToast(`"${icon.name}" icon purchased & equipped!`, 'success');
        }

        function equipSymbol(iconId) {
            gameState.equippedSymbol = iconId;
            const icon = PLAYER_ICONS.find(i=>i.id===iconId);
            showToast(`Symbol changed to ${icon?.emoji} ${icon?.name}!`, 'success');
            renderShop();
        }

        //  ACCESSORY PURCHASE / EQUIP 
        function buySleeve(slvId) {
            const slv = CARD_SLEEVES.find(s=>s.id===slvId);
            if (!slv || slv.cost === 0) return;
            if (gameState.money < slv.cost) { showToast('Not enough credits!','error'); return; }
            gameState.money -= slv.cost;
            gameState.ownedAccessories[slvId] = true;
            equipSleeve(slvId);
            showToast(`"${slv.name}" sleeve purchased & equipped!`, 'success');
        }

        function equipSleeve(slvId) {
            gameState.equippedSleeve = slvId;
            const slv = CARD_SLEEVES.find(s=>s.id===slvId);
            if (slv) {
                document.documentElement.style.setProperty('--card-back-gradient', slv.gradient);
                document.documentElement.style.setProperty('--card-back-border', slv.border);
            }
            showToast(`"${slv?.name}" sleeve equipped! Card backs updated.`, 'success');
            renderShop();
        }

        function buyPlaymat(matId) {
            const mat = PLAYMATS.find(m=>m.id===matId);
            if (!mat || mat.cost === 0) return;
            if (gameState.money < mat.cost) { showToast('Not enough credits!','error'); return; }
            gameState.money -= mat.cost;
            gameState.ownedAccessories[matId] = true;
            equipPlaymat(matId);
            showToast(`"${mat.name}" playmat purchased & equipped!`, 'success');
        }

        function equipPlaymat(matId) {
            gameState.equippedPlaymat = matId;
            const mat = PLAYMATS.find(m=>m.id===matId);
            if (mat) {
                document.documentElement.style.setProperty('--player-mat-bg', mat.bg);
                document.documentElement.style.setProperty('--mat-accent', mat.accent);
            }
            showToast(`"${mat?.name}" playmat equipped!`, 'success');
            renderShop();
        }

        //  BOX PURCHASE 
        function buyBox(packId, numBoxes) {
            const pack = PACKS.find(p=>p.id===packId);
            if (!pack) return;
            if (pack.levelReq && gameState.level < pack.levelReq) { showToast(`Requires Level ${pack.levelReq}!`,'error'); return; }
            const boxCost = pack.cost * 10;
            const totalCost = numBoxes === 1 ? boxCost : Math.round(boxCost * numBoxes * 0.9);
            if (gameState.money < totalCost) { showToast('Not enough credits!','error'); return; }
            gameState.money -= totalCost;

            const cardsPerPack = pack.singleCard ? 1 : 5;
            const batches = [];
            for (let box=0; box<numBoxes; box++) {
                for (let pk=0; pk<10; pk++) {
                    const batch = [];
                    for (let c=0; c<cardsPerPack; c++) {
                        const id = pack.list[Math.floor(Math.random()*pack.list.length)];
                        batch.push(id);
                        gameState.inventory[id] = (gameState.inventory[id]||0)+1;
                    }
                    batches.push(batch);
                }
            }
            showToast(`Opened ${numBoxes} ${pack.name} box${numBoxes>1?'es':''}! (${batches.length} packs)`, 'success');
            renderShop();
            startPackOpeningSession(batches);
        }

        //  STRUCTURE DECK PURCHASE 
        function buyStructureDeck(sdId) {
            const sd = STRUCTURE_DECKS.find(s=>s.id===sdId);
            if (!sd) return;
            const bought = gameState.structureDecksBought[sdId] || 0;
            if (bought >= sd.maxBuy) { showToast('You already own the maximum copies!','error'); return; }
            if (gameState.money < sd.cost) { showToast('Not enough credits!','error'); return; }
            gameState.money -= sd.cost;
            gameState.structureDecksBought[sdId] = bought + 1;

            // Add all cards in the structure deck list to inventory
            const batch = [];
            sd.list.forEach(id => {
                gameState.inventory[id] = (gameState.inventory[id]||0)+1;
                batch.push(id);
            });
            showToast(`${sd.name} Structure Deck acquired! ${batch.length} cards added.`, 'success');
            renderShop();
            // Show all cards in 8-card batches
            const batches = [];
            for (let i=0; i<batch.length; i+=8) batches.push(batch.slice(i,i+8));
            startPackOpeningSession(batches);
        }

        //  COLLECTOR BOX PURCHASE 
        function buyCollectorBox(cbId, qty) {
            const cb = COLLECTOR_BOXES.find(c=>c.id===cbId);
            if (!cb) return;
            const totalCost = qty === 1 ? cb.cost : Math.round(cb.cost * qty * 0.85);
            if (gameState.money < totalCost) { showToast(`Need $${totalCost.toLocaleString()} credits!`,'error'); return; }
            gameState.money -= totalCost;

            const allBatches = [];

            for (let q=0; q<qty; q++) {
                // Work through each sequence step in order
                for (const seq of cb.openSequence) {
                    const pack = PACKS.find(p => p.id === seq.packId);
                    if (!pack) continue;
                    const cardsPerPack = pack.singleCard ? 1 : 5;
                    for (let pk=0; pk<seq.count; pk++) {
                        const batch = [];
                        for (let c=0; c<cardsPerPack; c++) {
                            const id = pack.list[Math.floor(Math.random()*pack.list.length)];
                            batch.push(id);
                            gameState.inventory[id] = (gameState.inventory[id]||0)+1;
                        }
                        allBatches.push(batch);
                    }
                }
                // Finale: guaranteed exclusive UR pull
                const exclusiveId = cb.guaranteedPool[Math.floor(Math.random()*cb.guaranteedPool.length)];
                gameState.inventory[exclusiveId] = (gameState.inventory[exclusiveId]||0)+1;
                // Show guaranteed card as a solo reveal
                allBatches.push([exclusiveId]);
            }

            const totalPacks = cb.openSequence.reduce((s, seq) => s + seq.count, 0) + 1; // +1 for guaranteed
            showToast(`${qty} ${cb.name} Box${qty>1?'es':''} opened! ${totalPacks * qty} reveals total  check your vault pull!`, 'success');
            renderShop();
            startPackOpeningSession(allBatches);
        }

        // 
        // === FORTUNE WHEEL ====================================
        // 

        const WHEEL_PRIZES = [
            { label: '+$50',         sub: 'Credits',         type:'money', value:50,   color:'#16a34a', textColor:'#fff',     emoji:'' },
            { label: 'Starter Pack', sub: '5 Free Cards',    type:'pack',  value:'p1', color:'#2563eb', textColor:'#fff',     emoji:'' },
            { label: '+$150',        sub: 'Credits',         type:'money', value:150,  color:'#ca8a04', textColor:'#fff',     emoji:'' },
            { label: 'Common Card',  sub: 'Added to Trunk',  type:'card',  value:'C',  color:'#ea580c', textColor:'#fff',     emoji:'' },
            { label: '+$25',         sub: 'Credits',         type:'money', value:25,   color:'#475569', textColor:'#cbd5e1',  emoji:'' },
            { label: 'Magma Pack',   sub: '5 Free Cards',    type:'pack',  value:'p2', color:'#b91c1c', textColor:'#fff',     emoji:'' },
            { label: '+$300',        sub: 'Credits',         type:'money', value:300,  color:'#059669', textColor:'#fff',     emoji:'' },
            { label: 'Rare Card',    sub: 'Rarity: R',       type:'card',  value:'R',  color:'#0e7490', textColor:'#fff',     emoji:'' },
            { label: '+$75',         sub: 'Credits',         type:'money', value:75,   color:'#6d28d9', textColor:'#fff',     emoji:'' },
            { label: 'Cyber Pack',   sub: '5 Free Cards',    type:'pack',  value:'p3', color:'#7e22ce', textColor:'#fff',     emoji:'' },
            { label: 'SUPER RARE!',  sub: 'Rarity: SR',      type:'card',  value:'SR', color:'#92400e', textColor:'#fde68a', emoji:'' },
            { label: '+$500',        sub: 'Credits',         type:'money', value:500,  color:'#be185d', textColor:'#fff',     emoji:'' },
        ];

        let wheelState = { spinning: false, pendingPackId: null };

        function wheelCanFreeSpin() {
            if (!gameState.wheelLastSpin) return true;
            return new Date().toDateString() !== new Date(gameState.wheelLastSpin).toDateString();
        }

        function openWheelModal() {
            if (gameState.level < 2) { showToast('Reach Level 2 to unlock the Fortune Wheel!', 'error'); return; }
            const free = wheelCanFreeSpin();
            const modal = document.createElement('div');
            modal.id = 'wheel-modal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(2,6,23,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(8px)';
            modal.innerHTML = `
                <div style="position:relative;text-align:center;max-width:520px;width:100%;padding:0 16px">
                    <div style="font-family:'Bangers',cursive;font-size:46px;letter-spacing:.12em;
                                background:linear-gradient(135deg,#ffd700,#ff8c00,#ffd700);
                                -webkit-background-clip:text;-webkit-text-fill-color:transparent;
                                filter:drop-shadow(0 0 12px rgba(255,215,0,0.5));margin-bottom:4px"> FORTUNE WHEEL </div>
                    <div style="font-family:monospace;font-size:10px;letter-spacing:.1em;margin-bottom:20px;
                                color:${free ? '#22c55e':'#6b7280'}">
                        ${free ? ' YOUR FREE DAILY SPIN IS READY! ' : 'Free spin resets tomorrow  Extra spin costs $250'}
                    </div>

                    <!-- Wheel area -->
                    <div style="position:relative;display:inline-block;margin-bottom:20px">
                        <div style="position:absolute;inset:-8px;border-radius:50%;
                                    background:conic-gradient(#ffd700,#ff00cc,#00e5ff,#ff8800,#aa00ff,#ffd700);
                                    animation:vault-spin 3s linear infinite;filter:blur(10px);opacity:0.7;z-index:0"></div>
                        <div style="position:absolute;inset:-4px;border-radius:50%;border:4px solid #ffd700;z-index:2;pointer-events:none"></div>
                        <!-- Pointer triangle -->
                        <div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);z-index:10">
                            <svg width="30" height="24" viewBox="0 0 30 24"><polygon points="15,24 0,0 30,0" fill="#ffd700" stroke="#fff" stroke-width="1.5"/></svg>
                        </div>
                        <!-- Rotating wrapper -->
                        <div id="wheel-canvas-wrapper" style="position:relative;z-index:1;border-radius:50%;overflow:hidden">
                            <canvas id="wheel-canvas" width="380" height="380" style="display:block"></canvas>
                        </div>
                        <!-- Hub -->
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                                    width:52px;height:52px;border-radius:50%;background:radial-gradient(circle,#1a0040,#000);
                                    border:4px solid #ffd700;z-index:5;display:flex;align-items:center;justify-content:center;font-size:20px"></div>
                    </div>

                    <!-- Result (hidden until spin ends) -->
                    <div id="wheel-result" style="display:none;margin-bottom:16px;padding:14px 20px;
                            background:rgba(255,215,0,0.08);border:2px solid #ffd700;border-radius:14px">
                        <div id="wheel-result-emoji" style="font-size:52px;margin-bottom:6px"></div>
                        <div id="wheel-result-title" style="font-family:'Bangers',cursive;font-size:32px;letter-spacing:.08em"></div>
                        <div id="wheel-result-sub" style="font-family:monospace;font-size:11px;color:#9ca3af;margin-top:4px"></div>
                        <div id="wheel-result-card" style="margin-top:10px;display:flex;justify-content:center"></div>
                    </div>

                    <!-- Buttons -->
                    <div id="wheel-buttons" style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                        ${free
                            ? `<button id="wheel-spin-btn" onclick="spinWheel(true)"
                                style="font-family:'Bangers',cursive;font-size:22px;letter-spacing:.1em;
                                       padding:12px 36px;background:linear-gradient(135deg,#15803d,#22c55e);
                                       border:3px solid #86efac;border-radius:12px;color:#fff;cursor:pointer;
                                       box-shadow:0 0 24px rgba(34,197,94,0.5)"> FREE SPIN!</button>`
                            : `<button id="wheel-spin-btn" onclick="spinWheel(false)"
                                style="font-family:'Bangers',cursive;font-size:22px;letter-spacing:.1em;
                                       padding:12px 36px;background:linear-gradient(135deg,#b45309,#f59e0b);
                                       border:3px solid #fcd34d;border-radius:12px;color:#fff;cursor:pointer;
                                       box-shadow:0 0 24px rgba(245,158,11,0.5)"> SPIN  $250</button>`
                        }
                        <button onclick="closeWheelModal()"
                            style="font-family:'Bangers',cursive;font-size:22px;letter-spacing:.1em;
                                   padding:12px 28px;background:#0f172a;border:2px solid #334155;
                                   border-radius:12px;color:#64748b;cursor:pointer"> Close</button>
                    </div>
                    <div style="margin-top:14px;font-family:monospace;font-size:8px;color:#1e293b;letter-spacing:.06em">
                        PRIZES: $25  $50  $75  $150  $300  $500  Common Card  Rare Card  SUPER RARE  Starter Pack  Magma Pack  Cyber Pack
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(drawWheelCanvas, 60);
        }

        function drawWheelCanvas() {
            const canvas = document.getElementById('wheel-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const cx = canvas.width / 2, cy = canvas.height / 2, r = cx - 4;
            const num = WHEEL_PRIZES.length;
            const segRad = (Math.PI * 2) / num;

            for (let i = 0; i < num; i++) {
                const p = WHEEL_PRIZES[i];
                const start = i * segRad - Math.PI / 2; // start from top (12 o'clock)
                const end   = start + segRad;
                const mid   = start + segRad / 2;

                // Sector fill
                ctx.beginPath(); ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, start, end); ctx.closePath();
                ctx.fillStyle = p.color; ctx.fill();
                // Zebra shading
                ctx.fillStyle = i % 2 === 0 ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.14)';
                ctx.fill();
                // Border
                ctx.strokeStyle = 'rgba(0,0,0,0.45)'; ctx.lineWidth = 1.5; ctx.stroke();

                // Text
                ctx.save();
                ctx.translate(cx, cy); ctx.rotate(mid);
                ctx.textAlign = 'right';
                ctx.shadowColor = 'rgba(0,0,0,0.9)'; ctx.shadowBlur = 5;

                ctx.font = 'bold 17px serif';
                ctx.fillStyle = p.textColor || '#fff';
                ctx.fillText(p.emoji, r - 10, 5);

                ctx.font = "bold 10.5px 'Roboto Condensed', sans-serif";
                ctx.fillStyle = p.textColor || '#fff';
                ctx.fillText(p.label, r - 34, -4);

                ctx.font = '8.5px monospace';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fillText(p.sub, r - 34, 9);
                ctx.restore();
            }

            // Gold outer ring
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 5; ctx.stroke();
            // Hub circle
            ctx.beginPath(); ctx.arc(cx, cy, 28, 0, Math.PI * 2);
            ctx.fillStyle = '#000'; ctx.fill();
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 3; ctx.stroke();
        }

        function spinWheel(isFree) {
            if (wheelState.spinning) return;
            if (!isFree && gameState.money < 250) { showToast('Not enough credits! Need $250 to spin.', 'error'); return; }
            if (!isFree) { gameState.money -= 250; }
            else { gameState.wheelLastSpin = new Date().toISOString(); }
            wheelState.spinning = true;
            SoundEngine.wheelSpin();
            const resultEl = document.getElementById('wheel-result');
            const spinBtn  = document.getElementById('wheel-spin-btn');
            if (resultEl) resultEl.style.display = 'none';
            if (spinBtn)  { spinBtn.disabled = true; spinBtn.style.opacity = '0.4'; spinBtn.style.cursor = 'not-allowed'; }

            // Weighted prize selection
            const rnd = Math.random();
            let prizeIdx;
            if      (rnd < 0.45) { const m=[0,2,4,6,8,11]; prizeIdx=m[Math.floor(Math.random()*m.length)]; } // money  45%
            else if (rnd < 0.75) { const k=[1,5,9]; prizeIdx=k[Math.floor(Math.random()*k.length)]; }         // packs  30%
            else if (rnd < 0.95) { prizeIdx = Math.random() < 0.65 ? 3 : 7; }                                 // C/R   20%
            else                 { prizeIdx = 10; }                                                             // SR     5%

            // Rotation math:
            // Wheel is drawn with sector 0 starting at the top (12 o'clock, -/2).
            // Rotating the wrapper clockwise by R degrees brings the point that was R clockwise
            // from the top to the pointer. Sector i center sits at (i+0.5)*(360/num) clockwise from top.
            // So to land sector prizeIdx at the pointer: R = (prizeIdx+0.5)*segDeg + jitter
            const segDeg = 360 / WHEEL_PRIZES.length;
            const jitter = (Math.random() - 0.5) * segDeg * 0.22;
            // Correct rotation formula:
            // CSS rotate(R deg) clockwise brings the content that was at (360-R) to the 12 o'clock pointer.
            // Sector i's center is drawn at (i+0.5)*segDeg clockwise from the top.
            // So to land sector prizeIdx: (360 - R) = (prizeIdx+0.5)*segDeg    R = 360 - (prizeIdx+0.5)*segDeg
            const landAngle = (360 - (prizeIdx + 0.5) * segDeg + jitter + 36000) % 360;
            const fullSpins = 6 + Math.floor(Math.random() * 3);
            const finalRotation = fullSpins * 360 + landAngle;

            const wrapper = document.getElementById('wheel-canvas-wrapper');
            if (!wrapper) return;

            const duration = 4800, startTime = performance.now();
            (function frame(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const eased = 1 - Math.pow(1 - t, 5); // ease-out quint
                wrapper.style.transform = `rotate(${finalRotation * eased}deg)`;
                if (t < 1) requestAnimationFrame(frame);
                else { wrapper.style.transform = `rotate(${finalRotation}deg)`; wheelState.spinning = false; showWheelResult(prizeIdx); }
            })(performance.now());
        }

        function showWheelResult(prizeIdx) {
            SoundEngine.wheelResult(true);
            const prize    = WHEEL_PRIZES[prizeIdx];
            const resultEl = document.getElementById('wheel-result');
            const emojiEl  = document.getElementById('wheel-result-emoji');
            const titleEl  = document.getElementById('wheel-result-title');
            const subEl    = document.getElementById('wheel-result-sub');
            const cardEl   = document.getElementById('wheel-result-card');
            if (!resultEl) return;

            emojiEl.textContent = prize.emoji;
            titleEl.textContent = prize.label;
            titleEl.style.color = prize.color;
            cardEl.innerHTML = '';

            if (prize.type === 'money') {
                gameState.money += prize.value;
                subEl.textContent = `+$${prize.value} credits added to your wallet!`;
            } else if (prize.type === 'card') {
                const card = grantRandomCard(prize.value);
                subEl.textContent = card ? `"${card.name}" added to your Card Trunk!` : 'Card added to your Trunk!';
                if (card) cardEl.innerHTML = renderCardHTML(card, 'w-28', 'h-40');
            } else if (prize.type === 'pack') {
                wheelState.pendingPackId = prize.value;
                const pk = PACKS.find(p => p.id === prize.value);
                subEl.textContent = `A free "${pk ? pk.name : 'Pack'}" will open when you claim!`;
            }
            resultEl.style.display = 'block';

            // Swap spin button  claim button
            const spinBtn = document.getElementById('wheel-spin-btn');
            if (spinBtn) {
                const claim = document.createElement('button');
                claim.className = 'wheel-claim-pulse';
                claim.textContent = ' CLAIM PRIZE! ';
                claim.style.cssText = "font-family:'Bangers',cursive;font-size:22px;letter-spacing:.1em;padding:12px 36px;background:linear-gradient(135deg,#6d28d9,#a855f7);border:3px solid #e879f9;border-radius:12px;color:#fff;cursor:pointer";
                claim.onclick = claimWheelPrize;
                spinBtn.replaceWith(claim);
            }
        }

        function claimWheelPrize() {
            const pendingPack = wheelState.pendingPackId;
            wheelState.pendingPackId = null;
            closeWheelModal();
            if (pendingPack) {
                const pack = PACKS.find(p => p.id === pendingPack);
                if (pack) {
                    const count = pack.singleCard ? 1 : 5;
                    const batch = [];
                    for (let j = 0; j < count; j++) {
                        const cardId = pack.list[Math.floor(Math.random() * pack.list.length)];
                        batch.push(cardId);
                        gameState.inventory[cardId] = (gameState.inventory[cardId] || 0) + 1;
                    }
                    renderShop(); // re-render shop so pack overlay exists in the DOM
                    startPackOpeningSession([batch]);
                }
            } else {
                renderShop(); // refresh credit display
            }
        }

        function closeWheelModal() {
            const m = document.getElementById('wheel-modal');
            if (m) m.remove();
        }

        // 
        // === SCRATCH TICKETS ==================================
        // 

        const SCRATCH_TICKETS = [
            {
                id:'st1', name:'Lucky Zap!', cost:25,
                artColors:{ bg1:'#172554', bg2:'#1d4ed8', accent:'#fbbf24', headerBg:'#0f172a' },
                artTagline:'SHOCKINGLY GOOD DEALS!',
                gridCols:3, gridRows:3,
                prizeTable:[
                    { id:'bust', label:'BUST!',  icon:'', color:'#1f2937', type:'lose',  winValue:0 },
                    { id:'m30',  label:'$30',    icon:'', color:'#166534', type:'money', winValue:30,  weight:22 },
                    { id:'m75',  label:'$75',    icon:'', color:'#0e7490', type:'money', winValue:75,  weight:12 },
                    { id:'m150', label:'$150',   icon:'', color:'#854d0e', type:'money', winValue:150, weight:6 },
                    { id:'crd',  label:'CARD!',  icon:'', color:'#5b21b6', type:'card',  winValue:'C', weight:5 },
                ],
                winChance:0.35, matchNeeded:3,
            },
            {
                id:'st2', name:'Neon Clash!', cost:75,
                artColors:{ bg1:'#2e1065', bg2:'#6b21a8', accent:'#e879f9', headerBg:'#1a0040' },
                artTagline:'YOUR DESTINY AWAITS!',
                gridCols:3, gridRows:4,
                prizeTable:[
                    { id:'bust', label:'NOPE!',  icon:'', color:'#111827', type:'lose',  winValue:0 },
                    { id:'m60',  label:'$60',    icon:'', color:'#1e3a5f', type:'money', winValue:60,  weight:18 },
                    { id:'m175', label:'$175',   icon:'', color:'#134e4a', type:'money', winValue:175, weight:9 },
                    { id:'m350', label:'$350',   icon:'', color:'#3b0764', type:'money', winValue:350, weight:4 },
                    { id:'rcd',  label:'R CARD', icon:'', color:'#7c2d12', type:'card',  winValue:'R', weight:3 },
                ],
                winChance:0.28, matchNeeded:3,
            },
            {
                id:'st3', name:'CYBER JACKPOT!', cost:200,
                artColors:{ bg1:'#0c0a09', bg2:'#292524', accent:'#ffd700', headerBg:'#000000' },
                artTagline:'GO BIG OR GO HOME!',
                gridCols:4, gridRows:4,
                prizeTable:[
                    { id:'bust', label:'BUST',    icon:'', color:'#111827', type:'lose',  winValue:0 },
                    { id:'m120', label:'$120',    icon:'', color:'#14532d', type:'money', winValue:120,  weight:14 },
                    { id:'m450', label:'$450',    icon:'', color:'#0c4a6e', type:'money', winValue:450,  weight:5 },
                    { id:'m999', label:'$999',    icon:'', color:'#713f12', type:'money', winValue:999,  weight:2 },
                    { id:'sr',   label:'SR CARD', icon:'', color:'#7e1d1d', type:'card',  winValue:'SR', weight:2 },
                    { id:'ur',   label:'UR CARD', icon:'', color:'#1e1b4b', type:'card',  winValue:'UR', weight:1 },
                ],
                winChance:0.22, matchNeeded:3,
            },
        ];

        let scratchState = null;
        let _scratchCheckTs = 0;

        function openScratchShop() {
            if (gameState.level < 5) { showToast('Reach Level 5 to unlock Scratch Tickets!','error'); return; }
            const modal = document.createElement('div');
            modal.id = 'scratch-shop-modal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:400;background:rgba(2,6,23,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(8px)';
            modal.innerHTML = `
                <div style="text-align:center;max-width:980px;width:100%;padding:0 20px">
                    <div style="font-family:'Bangers',cursive;font-size:50px;letter-spacing:.1em;color:#10b981;filter:drop-shadow(0 0 16px rgba(16,185,129,0.6));margin-bottom:4px"> SCRATCH TICKETS</div>
                    <div style="font-family:monospace;font-size:10px;color:#6b7280;letter-spacing:.1em;margin-bottom:28px">SCRATCH TO REVEAL  MATCH 3 TO WIN!</div>
                    <div style="display:flex;gap:22px;justify-content:center;flex-wrap:nowrap;align-items:flex-start">
                        ${SCRATCH_TICKETS.map((t,ti) => buildScratchPreviewCard(t,ti)).join('')}
                    </div>
                    <button onclick="document.getElementById('scratch-shop-modal').remove()"
                        style="margin-top:28px;font-family:'Bangers',cursive;font-size:20px;letter-spacing:.1em;
                               padding:10px 36px;background:#0f172a;border:2px solid #334155;border-radius:10px;color:#64748b;cursor:pointer">
                         Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function buildScratchPreviewCard(t, ti) {
            const canAfford = gameState.money >= t.cost;
            const tilt = [-1.8, 0.6, 1.4][ti] || 0;
            return `
            <div style="flex:1;min-width:235px;max-width:275px">
                <div onclick="buyScratchTicket('${t.id}')"
                     style="cursor:${canAfford?'pointer':'not-allowed'};opacity:${canAfford?1:0.55};
                            border-radius:14px;overflow:hidden;border:3px solid ${t.artColors.accent};
                            box-shadow:0 0 22px ${t.artColors.accent}44;
                            transform:rotate(${tilt}deg);transition:transform 0.2s,box-shadow 0.2s"
                     ${canAfford?`onmouseenter="this.style.transform='rotate(0deg) scale(1.05)';this.style.boxShadow='0 0 44px ${t.artColors.accent}99'" onmouseleave="this.style.transform='rotate(${tilt}deg)';this.style.boxShadow='0 0 22px ${t.artColors.accent}44'"`:''}>
                    <div style="background:${t.artColors.headerBg};padding:7px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid ${t.artColors.accent}55">
                        <span style="font-family:'Bangers',cursive;font-size:20px;letter-spacing:.1em;color:${t.artColors.accent}">${t.name}</span>
                        <span style="font-family:monospace;font-size:12px;font-weight:bold;background:${t.artColors.accent};color:#000;padding:2px 8px;border-radius:4px">$${t.cost}</span>
                    </div>
                    <div style="background:linear-gradient(135deg,${t.artColors.bg1},${t.artColors.bg2});padding:14px;display:flex;align-items:center;justify-content:space-between;gap:10px;min-height:150px;position:relative;overflow:hidden">
                        <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,0.018) 0px,rgba(255,255,255,0.018) 1px,transparent 1px,transparent 8px)"></div>
                        <div style="flex-shrink:0;position:relative;z-index:1">${buildScratchArtSVG(t)}</div>
                        <div style="display:grid;grid-template-columns:repeat(${t.gridCols},1fr);gap:3px;flex:1;position:relative;z-index:1">
                            ${Array(t.gridCols * Math.min(t.gridRows,3)).fill(0).map(()=>`
                            <div style="height:24px;border-radius:4px;background:rgba(150,150,150,0.4);border:1.5px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center">
                                <div style="width:12px;height:2px;border-radius:2px;background:rgba(255,255,255,0.3)"></div>
                            </div>`).join('')}
                        </div>
                    </div>
                    <div style="background:${t.artColors.headerBg};padding:6px 12px;text-align:center;border-top:1px solid ${t.artColors.accent}33">
                        <span style="font-family:monospace;font-size:8px;letter-spacing:.08em;color:${t.artColors.accent}99">${t.artTagline}</span>
                    </div>
                </div>
                <div style="margin-top:10px;text-align:center">
                    <button onclick="buyScratchTicket('${t.id}')" ${canAfford?'':'disabled'}
                        style="font-family:'Bangers',cursive;font-size:19px;letter-spacing:.08em;padding:9px 30px;border-radius:9px;
                               cursor:${canAfford?'pointer':'not-allowed'};
                               background:${canAfford?`linear-gradient(135deg,${t.artColors.bg1},${t.artColors.bg2})`:'#1f2937'};
                               border:2.5px solid ${canAfford?t.artColors.accent:'#374151'};
                               color:${canAfford?t.artColors.accent:'#6b7280'};
                               box-shadow:${canAfford?`0 0 14px ${t.artColors.accent}55`:'none'}">
                        ${canAfford ? ` BUY  $${t.cost}` : 'Not enough credits'}
                    </button>
                </div>
            </div>`;
        }

        function buildScratchArtSVG(t) {
            if (t.id === 'st1') return `
            <svg width="105" height="118" viewBox="0 0 105 118">
                <line x1="12" y1="8" x2="20" y2="24" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="93" y1="12" x2="83" y2="28" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="4" y1="68" x2="17" y2="66" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                <line x1="98" y1="72" x2="86" y2="70" stroke="#fbbf24" stroke-width="2" stroke-linecap="round"/>
                <rect x="30" y="58" width="45" height="46" rx="7" fill="#1e40af" stroke="#fbbf24" stroke-width="2"/>
                <rect x="34" y="26" width="37" height="36" rx="5" fill="#2563eb" stroke="#fbbf24" stroke-width="2"/>
                <ellipse cx="45" cy="42" rx="7" ry="8" fill="#fff"/>
                <ellipse cx="61" cy="42" rx="7" ry="8" fill="#fff"/>
                <circle cx="46" cy="43" r="4" fill="#000"/><circle cx="62" cy="43" r="4" fill="#000"/>
                <circle cx="47" cy="41" r="1.5" fill="#fff"/><circle cx="63" cy="41" r="1.5" fill="#fff"/>
                <ellipse cx="53" cy="57" rx="5" ry="5" fill="#000"/>
                <rect x="6" y="65" width="24" height="9" rx="4" fill="#2563eb" stroke="#fbbf24" stroke-width="1.5" transform="rotate(30 18 69)"/>
                <rect x="75" y="62" width="24" height="9" rx="4" fill="#2563eb" stroke="#fbbf24" stroke-width="1.5" transform="rotate(-25 87 66)"/>
                <rect x="36" y="100" width="13" height="16" rx="4" fill="#1d4ed8" stroke="#fbbf24" stroke-width="1.5"/>
                <rect x="56" y="100" width="13" height="16" rx="4" fill="#1d4ed8" stroke="#fbbf24" stroke-width="1.5"/>
                <polygon points="70,2 50,38 59,38 42,72 72,28 60,28 70,2" fill="#fbbf24" stroke="#fff" stroke-width="1"/>
                <text x="2" y="50" font-size="12" fill="#fbbf24"></text>
                <text x="86" y="55" font-size="11" fill="#93c5fd"></text>
                <text x="12" y="112" font-size="10" fill="#fbbf24"></text>
                <text x="85" y="115" font-size="10" fill="#fbbf24"></text>
            </svg>`;
            if (t.id === 'st2') return `
            <svg width="105" height="118" viewBox="0 0 105 118">
                <text x="4" y="20" font-size="11" fill="#e879f9" opacity="0.7"></text>
                <text x="88" y="26" font-size="10" fill="#c4b5fd" opacity="0.6"></text>
                <text x="6" y="110" font-size="9" fill="#e879f9" opacity="0.5"></text>
                <text x="90" y="114" font-size="9" fill="#c4b5fd" opacity="0.5"></text>
                <polygon points="52,38 28,116 76,116" fill="#7c3aed" stroke="#e879f9" stroke-width="1.5"/>
                <text x="40" y="86" font-size="12" fill="#f0abfc" opacity="0.85"></text>
                <circle cx="52" cy="30" r="18" fill="#fde68a" stroke="#e879f9" stroke-width="2"/>
                <polygon points="52,2 34,22 70,22" fill="#4c1d95" stroke="#e879f9" stroke-width="1.5"/>
                <rect x="31" y="20" width="42" height="7" rx="3" fill="#6d28d9" stroke="#e879f9" stroke-width="1"/>
                <ellipse cx="45" cy="29" rx="4" ry="4.5" fill="#fff"/><ellipse cx="59" cy="29" rx="4" ry="4.5" fill="#fff"/>
                <circle cx="45" cy="29" r="2.2" fill="#000"/><circle cx="59" cy="29" r="2.2" fill="#000"/>
                <path d="M46,40 Q52,47 58,40" fill="none" stroke="#92400e" stroke-width="1.8"/>
                <line x1="28" y1="70" x2="6" y2="50" stroke="#fde68a" stroke-width="7" stroke-linecap="round"/>
                <rect x="-2" y="32" width="26" height="34" rx="3" fill="#fff" stroke="#e879f9" stroke-width="2"/>
                <text x="11" y="54" font-size="20" text-anchor="middle" fill="#7c3aed"></text>
                <line x1="78" y1="68" x2="102" y2="86" stroke="#e879f9" stroke-width="3" stroke-linecap="round"/>
                <circle cx="103" cy="88" r="5" fill="#fbbf24"/>
                <text x="86" y="63" font-size="11" fill="#fbbf24"></text>
                <path d="M78,50 Q96,34 88,16 Q80,3 68,14" fill="none" stroke="#c4b5fd" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.7"/>
            </svg>`;
            return `
            <svg width="105" height="118" viewBox="0 0 105 118">
                <ellipse cx="16" cy="13" rx="9" ry="6" fill="#ffd700" stroke="#92400e" stroke-width="1.5" transform="rotate(-20 16 13)"/>
                <text x="10" y="17" font-size="8" fill="#78350f" font-weight="bold">$</text>
                <ellipse cx="88" cy="19" rx="9" ry="6" fill="#ffd700" stroke="#92400e" stroke-width="1.5" transform="rotate(15 88 19)"/>
                <text x="82" y="23" font-size="8" fill="#78350f" font-weight="bold">$</text>
                <ellipse cx="98" cy="58" rx="9" ry="6" fill="#ffd700" stroke="#92400e" stroke-width="1.5" transform="rotate(30 98 58)"/>
                <rect x="16" y="44" width="65" height="60" rx="6" fill="#1c1917" stroke="#ffd700" stroke-width="2.5"/>
                <rect x="24" y="52" width="49" height="30" rx="3" fill="#0c0a09" stroke="#ffd700" stroke-width="1.5"/>
                <text x="36" y="73" font-size="17" text-anchor="middle" fill="#ffd700">7</text>
                <text x="50" y="73" font-size="17" text-anchor="middle" fill="#f87171"></text>
                <text x="64" y="73" font-size="17" text-anchor="middle" fill="#ffd700">7</text>
                <rect x="74" y="28" width="10" height="42" rx="5" fill="#374151" stroke="#9ca3af" stroke-width="1.5"/>
                <circle cx="79" cy="26" r="7" fill="#4b5563" stroke="#9ca3af" stroke-width="1.5"/>
                <rect x="82" y="21" width="17" height="7" rx="3.5" fill="#ef4444" stroke="#fca5a5" stroke-width="1"/>
                <ellipse cx="79" cy="72" rx="10" ry="7" fill="#374151" stroke="#9ca3af" stroke-width="1.5"/>
                <line x1="70" y1="70" x2="62" y2="80" stroke="#9ca3af" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="79" y1="79" x2="79" y2="89" stroke="#9ca3af" stroke-width="2.5" stroke-linecap="round"/>
                <line x1="88" y1="70" x2="96" y2="80" stroke="#9ca3af" stroke-width="2.5" stroke-linecap="round"/>
                <rect x="43" y="100" width="16" height="5" rx="2.5" fill="#ffd700"/>
                <rect x="27" y="93" width="46" height="10" rx="2" fill="#292524"/>
                <text x="50" y="101" font-size="7" text-anchor="middle" fill="#ffd700" font-family="monospace" letter-spacing="1">JACKPOT</text>
                <text x="3" y="72" font-size="13" fill="#ffd700"></text>
                <text x="1" y="40" font-size="10" fill="#ffd700"></text>
                <text x="90" y="110" font-size="10" fill="#ffd700"></text>
            </svg>`;
        }

        function buyScratchTicket(ticketId) {
            const ticket = SCRATCH_TICKETS.find(t => t.id === ticketId);
            if (!ticket) return;
            if (gameState.money < ticket.cost) { showToast('Not enough credits!','error'); return; }
            gameState.money -= ticket.cost;
            const symbols = generateScratchSymbols(ticket);
            const shopModal = document.getElementById('scratch-shop-modal');
            if (shopModal) shopModal.remove();
            openScratchGame(ticket, symbols);
        }

        function generateScratchSymbols(ticket) {
            const { prizeTable, gridCols, gridRows, winChance, matchNeeded } = ticket;
            const total = gridCols * gridRows;
            const won = Math.random() < winChance;
            const losePrize = prizeTable.find(p => p.type === 'lose');
            const winPrizes = prizeTable.filter(p => p.type !== 'lose');
            let symbols = [];

            if (won) {
                const totalW = winPrizes.reduce((s,p)=>s+(p.weight||1),0);
                let r = Math.random() * totalW;
                let winPrize = winPrizes[winPrizes.length-1];
                for (const p of winPrizes) { r-=(p.weight||1); if(r<=0){winPrize=p;break;} }
                for (let i=0;i<matchNeeded;i++) symbols.push({...winPrize});
                while (symbols.length < total) {
                    const pool = prizeTable.filter(p=>p.id===losePrize.id||symbols.filter(s=>s.id===p.id).length<matchNeeded-1);
                    symbols.push({...(pool[Math.floor(Math.random()*pool.length)]||losePrize)});
                }
            } else {
                while (symbols.length < total) {
                    const pick = prizeTable[Math.floor(Math.random()*prizeTable.length)];
                    const count = symbols.filter(s=>s.id===pick.id).length;
                    if (pick.id===losePrize.id||count<matchNeeded-1) symbols.push({...pick});
                }
            }
            return symbols.sort(()=>Math.random()-0.5);
        }

        function openScratchGame(ticket, symbols) {
            const { gridCols, artColors } = ticket;
            scratchState = { ticket, symbols, done:false, painting:false, lastX:0, lastY:0 };
            _scratchCheckTs = 0;

            const modal = document.createElement('div');
            modal.id = 'scratch-modal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:400;background:rgba(2,6,23,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(8px);overflow-y:auto;padding:16px 0';
            modal.innerHTML = `
                <div style="font-family:'Bangers',cursive;font-size:38px;letter-spacing:.1em;color:${artColors.accent};margin-bottom:14px;filter:drop-shadow(0 0 10px ${artColors.accent}88)"> ${ticket.name}</div>

                <div id="scratch-ticket-wrap" style="position:relative;border-radius:16px;overflow:hidden;
                        box-shadow:0 0 50px ${artColors.accent}66;border:4px solid ${artColors.accent};display:inline-block">

                    <!-- ART + PRIZE LAYER -->
                    <div style="display:flex;background:linear-gradient(135deg,${artColors.bg1} 0%,${artColors.bg2} 100%)">

                        <!-- LEFT: Artwork panel -->
                        <div style="width:178px;flex-shrink:0;padding:14px 10px;display:flex;flex-direction:column;
                                    align-items:center;justify-content:center;gap:6px;
                                    border-right:3px dashed ${artColors.accent}55;position:relative;overflow:hidden">
                            <div style="position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,0.016) 0px,rgba(255,255,255,0.016) 1px,transparent 1px,transparent 9px)"></div>
                            <div style="position:relative;z-index:1">${buildScratchArtSVG(ticket)}</div>
                            <div style="font-family:'Bangers',cursive;font-size:10px;letter-spacing:.1em;color:${artColors.accent};text-align:center;line-height:1.3;position:relative;z-index:1;opacity:0.75">${ticket.artTagline}</div>
                        </div>

                        <!-- RIGHT: Prize grid -->
                        <div style="flex:1;padding:14px 12px;display:flex;flex-direction:column;gap:4px">
                            <div style="font-family:'Bangers',cursive;font-size:11px;letter-spacing:.1em;color:${artColors.accent};text-align:center;margin-bottom:4px;opacity:0.9">
                                 SCRATCH TO REVEAL  MATCH ${ticket.matchNeeded} TO WIN 
                            </div>
                            <div id="scratch-grid" style="display:grid;grid-template-columns:repeat(${gridCols},1fr);gap:4px">
                                ${symbols.map((sym,i)=>`
                                <div id="scratch-cell-${i}"
                                     style="height:52px;border-radius:6px;background:${sym.color||'#374151'};
                                            border:2px solid rgba(255,255,255,0.14);
                                            display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
                                            font-family:'Bangers',cursive;font-size:13px;letter-spacing:.04em;color:#fff;transition:all 0.35s">
                                    <span style="font-size:19px;line-height:1">${sym.icon}</span>
                                    <span>${sym.label}</span>
                                </div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- SCRATCH CANVAS (sits over entire ticket) -->
                    <canvas id="scratch-canvas"
                        style="position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;touch-action:none"
                        onmousedown="scratchStart(event)" onmousemove="scratchMove(event)"
                        onmouseup="scratchEnd()" onmouseleave="scratchEnd()">
                    </canvas>
                </div>

                <!-- RESULT (shown after reveal) -->
                <div id="scratch-result" style="display:none;margin-top:14px;padding:12px 36px;border-radius:12px;text-align:center;min-width:300px;border:2px solid ${artColors.accent};background:rgba(0,0,0,0.65)"></div>

                <!-- BUTTONS -->
                <div style="display:flex;gap:12px;margin-top:16px">
                    <button id="scratch-reveal-btn" onclick="revealAllScratch()"
                        style="font-family:'Bangers',cursive;font-size:20px;letter-spacing:.08em;padding:10px 28px;
                               background:#0f172a;border:2px solid #475569;border-radius:10px;color:#94a3b8;cursor:pointer"
                        onmouseenter="this.style.background='#1e293b'" onmouseleave="this.style.background='#0f172a'">
                         Reveal All
                    </button>
                    <button id="scratch-close-btn" onclick="closeScratchModal()"
                        style="font-family:'Bangers',cursive;font-size:20px;letter-spacing:.08em;padding:10px 28px;
                               background:#0f172a;border:2px solid #334155;border-radius:10px;color:#64748b;cursor:pointer">
                         Close
                    </button>
                </div>
                <div style="margin-top:10px;font-family:monospace;font-size:8px;color:#1e293b">
                    TIP: Click and drag over the ticket to scratch off the coating!
                </div>
            `;
            document.body.appendChild(modal);
            requestAnimationFrame(() => initScratchCanvas(ticket));
        }

        function initScratchCanvas(ticket) {
            const canvas = document.getElementById('scratch-canvas'); if(!canvas) return;
            const wrap   = document.getElementById('scratch-ticket-wrap');
            canvas.width  = wrap.offsetWidth;
            canvas.height = wrap.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Metallic gradient base
            const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
            grad.addColorStop(0,   '#9ca3af');
            grad.addColorStop(0.4, '#d1d5db');
            grad.addColorStop(0.7, '#9ca3af');
            grad.addColorStop(1,   '#6b7280');
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Noise texture for authenticity
            const img = ctx.getImageData(0,0,canvas.width,canvas.height);
            for (let i=0;i<img.data.length;i+=4) {
                const n=(Math.random()-0.5)*36;
                img.data[i]  =Math.max(0,Math.min(255,img.data[i]+n));
                img.data[i+1]=Math.max(0,Math.min(255,img.data[i+1]+n));
                img.data[i+2]=Math.max(0,Math.min(255,img.data[i+2]+n));
            }
            ctx.putImageData(img,0,0);

            // Repeating "SCRATCH HERE" watermark stamps
            ctx.save(); ctx.globalAlpha=0.17; ctx.fillStyle='#000';
            ctx.font="bold 12px 'Roboto Condensed',sans-serif"; ctx.textAlign='center';
            for (let x=80;x<canvas.width;x+=155) {
                for (let y=24;y<canvas.height;y+=48) {
                    ctx.save(); ctx.translate(x,y); ctx.rotate(-0.24);
                    ctx.fillText(' SCRATCH HERE ',0,0); ctx.restore();
                }
            }
            ctx.restore();

            // Big centred label (guides the player)
            ctx.save(); ctx.textAlign='center';
            ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=5;
            ctx.font=`bold 26px 'Bangers',cursive`; ctx.fillStyle=ticket.artColors.accent;
            ctx.fillText(ticket.name, canvas.width/2, canvas.height/2-14);
            ctx.font='13px monospace'; ctx.fillStyle='rgba(255,255,255,0.45)';
            ctx.fillText(' SCRATCH TO REVEAL PRIZES ', canvas.width/2, canvas.height/2+12);
            ctx.restore();

            // Touch support
            canvas.addEventListener('touchstart',e=>{e.preventDefault();scratchStart(e.touches[0]);},{passive:false});
            canvas.addEventListener('touchmove', e=>{e.preventDefault();scratchMove(e.touches[0]);}, {passive:false});
            canvas.addEventListener('touchend',  ()=>scratchEnd(), {passive:false});
        }

        function scratchStart(e) {
            if (!scratchState||scratchState.done) return;
            scratchState.painting=true;
            const p=getScratchPos(e); scratchState.lastX=p.x; scratchState.lastY=p.y;
            doScratchErase(p.x,p.y,p.x+0.1,p.y+0.1);
        }
        function scratchMove(e) {
            if (!scratchState||!scratchState.painting||scratchState.done) return;
            const p=getScratchPos(e);
            doScratchErase(scratchState.lastX,scratchState.lastY,p.x,p.y);
            scratchState.lastX=p.x; scratchState.lastY=p.y;
            const now=Date.now();
            if(now-_scratchCheckTs>350){_scratchCheckTs=now;checkScratchCompletion();}
        }
        function scratchEnd() { if(scratchState) scratchState.painting=false; }

        function getScratchPos(e) {
            const c=document.getElementById('scratch-canvas'), r=c.getBoundingClientRect();
            return { x:((e.clientX||0)-r.left)*(c.width/r.width), y:((e.clientY||0)-r.top)*(c.height/r.height) };
        }

        function doScratchErase(x1,y1,x2,y2) {
            SoundEngine.scratch();
            const c=document.getElementById('scratch-canvas'); if(!c) return;
            const ctx=c.getContext('2d');
            ctx.globalCompositeOperation='destination-out';
            ctx.strokeStyle='rgba(0,0,0,1)'; ctx.lineWidth=46; ctx.lineCap='round'; ctx.lineJoin='round';
            ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        }

        function checkScratchCompletion() {
            const c=document.getElementById('scratch-canvas'); if(!c) return;
            const d=c.getContext('2d').getImageData(0,0,c.width,c.height).data;
            let trans=0; const step=16;
            for(let i=3;i<d.length;i+=step){if(d[i]<128)trans++;}
            if((trans/(d.length/step))>0.62&&!scratchState.done) revealAllScratch();
        }

        function revealAllScratch() {
            if(!scratchState||scratchState.done) return;
            scratchState.done=true;
            SoundEngine.scratchReveal();
            const c=document.getElementById('scratch-canvas');
            if(c){
                const ctx=c.getContext('2d'); let a=1;
                (function fade(){
                    ctx.globalCompositeOperation='destination-out';
                    ctx.fillStyle='rgba(0,0,0,0.14)'; ctx.fillRect(0,0,c.width,c.height);
                    a-=0.14;
                    if(a>0) requestAnimationFrame(fade);
                    else { ctx.clearRect(0,0,c.width,c.height); c.style.pointerEvents='none'; }
                })();
            }
            setTimeout(evaluateScratchResult, 380);
        }

        function evaluateScratchResult() {
            if(!scratchState) return;
            const { symbols, ticket } = scratchState;
            const counts={};
            symbols.forEach(s=>{ counts[s.id]=(counts[s.id]||0)+1; });
            const rScore={'C':1,'R':2,'SR':3,'UR':4};
            const symScore=s=>s.type==='money'?s.winValue:(rScore[s.winValue]||0)*1000;

            let winPrize=null;
            for(const sym of symbols){
                if(sym.type!=='lose'&&(counts[sym.id]||0)>=ticket.matchNeeded){
                    if(!winPrize||symScore(sym)>symScore(winPrize)) winPrize=sym;
                }
            }

            // Highlight cells
            symbols.forEach((sym,i)=>{
                const cell=document.getElementById(`scratch-cell-${i}`); if(!cell) return;
                if(winPrize&&sym.id===winPrize.id){
                    cell.style.outline='3px solid #ffd700'; cell.style.transform='scale(1.07)';
                    cell.style.boxShadow='0 0 20px rgba(255,215,0,0.9)';
                    cell.style.position='relative'; cell.style.zIndex='2';
                } else { cell.style.opacity='0.4'; }
            });

            // Grant + show result
            const r=document.getElementById('scratch-result'); if(!r) return;
            let html='';
            if(winPrize){
                let desc='';
                if(winPrize.type==='money'){ gameState.money+=winPrize.winValue; desc=`+$${winPrize.winValue} added to your wallet!`; }
                else if(winPrize.type==='card'){
                    const card=grantRandomCard(winPrize.winValue);
                    desc=card?`"${card.name}" (${winPrize.winValue}) added to your Card Trunk!`:'Card added to Trunk!';
                }
                r.style.borderColor='#ffd700'; r.style.background='rgba(100,65,0,0.42)';
                html=`<div style="font-family:'Bangers',cursive;font-size:40px;color:#ffd700;filter:drop-shadow(0 0 14px #ffd700)"> WINNER!</div>
                      <div style="font-family:'Bangers',cursive;font-size:24px;color:#fff;margin-top:4px">${winPrize.icon} ${winPrize.label} ${counts[winPrize.id]}</div>
                      <div style="font-family:monospace;font-size:11px;color:#a3e635;margin-top:6px">${desc}</div>`;
            } else {
                r.style.borderColor='#374151'; r.style.background='rgba(0,0,0,0.65)';
                html=`<div style="font-family:'Bangers',cursive;font-size:30px;color:#6b7280"> NO MATCH</div>
                      <div style="font-family:monospace;font-size:10px;color:#4b5563;margin-top:4px">Better luck next time! Ticket window stays open to try again.</div>`;
            }
            r.innerHTML=html; r.style.display='block';
            const rb=document.getElementById('scratch-reveal-btn'); if(rb){rb.disabled=true;rb.style.opacity='0.3';}

            // Add "Buy Another" alongside Close
            const cb=document.getElementById('scratch-close-btn');
            if(cb&&!document.getElementById('scratch-buy-again')){
                const b=document.createElement('button');
                b.id='scratch-buy-again';
                b.textContent=' Buy Another';
                b.style.cssText=`font-family:'Bangers',cursive;font-size:20px;letter-spacing:.08em;padding:10px 28px;
                    background:linear-gradient(135deg,#14532d,#15803d);border:2.5px solid #4ade80;border-radius:10px;color:#fff;cursor:pointer`;
                b.onclick=()=>{closeScratchModal();openScratchShop();};
                cb.parentNode.insertBefore(b,cb);
            }
        }

        function closeScratchModal() {
            const m=document.getElementById('scratch-modal'); if(m) m.remove();
            scratchState=null;
            renderShop();
        }

        // === SLOT MACHINE ==================================
        const SLOT_SYMBOLS = [
            { id:'cherry',  emoji:'', label:'Cherry',   weight:32, rare:false, color:'#f87171' },
            { id:'lemon',   emoji:'', label:'Lemon',    weight:28, rare:false, color:'#fde047' },
            { id:'grape',   emoji:'', label:'Grape',    weight:22, rare:false, color:'#c084fc' },
            { id:'thunder', emoji:'', label:'Thunder',  weight:12, rare:false, color:'#fbbf24' },
            { id:'diamond', emoji:'', label:'Diamond',  weight:8,  rare:false, color:'#67e8f9' },
            { id:'star',    emoji:'', label:'Star',     weight:4,  rare:true,  color:'#ffd700' },
            { id:'dragon',  emoji:'', label:'Dragon',   weight:2,  rare:true,  color:'#4ade80' },
        ];

        const SLOT_PRIZES = {
            25: {
                3:{ common:{ money:50,  card:null, label:'+$50 Win!',                      cardRarity:null },
                    rare:  { money:100, card:'C',  label:' Star Match! +$100 + Common Card!', cardRarity:'C'  }},
                4:{ common:{ money:175, card:null, label:'4 in a Row! +$175!',              cardRarity:null },
                    rare:  { money:325, card:'R',  label:' Rare 4-Match! +$325 + Rare Card!', cardRarity:'R'  }},
                5:{ common:{ money:600, card:'R',  label:'5 in a Row! +$600 + Rare Card!',  cardRarity:'R'  },
                    rare:  { money:1200,card:'SR', label:' JACKPOT! +$1200 + Super Rare!', cardRarity:'SR' }},
            },
            50: {
                3:{ common:{ money:100, card:null, label:'+$100 Win!',                       cardRarity:null },
                    rare:  { money:225, card:'R',  label:' Star Match! +$225 + Rare Card!',  cardRarity:'R'  }},
                4:{ common:{ money:375, card:'R',  label:'4 in a Row! +$375 + Rare Card!',    cardRarity:'R'  },
                    rare:  { money:700, card:'SR', label:' Rare 4-Match! +$700 + SR Card!',  cardRarity:'SR' }},
                5:{ common:{ money:1000,card:'SR', label:'5 in a Row! +$1000 + SR Card!',     cardRarity:'SR' },
                    rare:  { money:2500,card:'SR', label:' EPIC JACKPOT! +$2500 + SR Card!',cardRarity:'SR'}},
            },
            100: {
                3:{ common:{ money:200, card:'R',  label:'+$200 + Rare Card Win!',               cardRarity:'R'  },
                    rare:  { money:500, card:'SR', label:' Star Match! +$500 + SR Card!',       cardRarity:'SR' }},
                4:{ common:{ money:800, card:'SR', label:'4 in a Row! +$800 + SR Card!',         cardRarity:'SR' },
                    rare:  { money:1800,card:'SR', label:' Rare 4-Match! +$1800 + SR Card!',    cardRarity:'SR' }},
                5:{ common:{ money:3000,card:'SR', label:'5 in a Row! +$3000 + SR Card!',        cardRarity:'SR' },
                    rare:  { money:7500,card:'UR', label:' MEGA JACKPOT! +$7500 + UR CARD!!!', cardRarity:'UR' }},
            },
        };

        let slotState = { spinning:false, bet:25, grid:[], winCells:new Set(), prize:null };

        function _pickSlotSym() {
            const total = SLOT_SYMBOLS.reduce((s,x)=>s+x.weight,0);
            let r = Math.random()*total;
            for(const sym of SLOT_SYMBOLS){ r-=sym.weight; if(r<=0) return sym; }
            return SLOT_SYMBOLS[0];
        }

        function openSlotsModal() {
            if(gameState.level < 8){ showToast('Reach Level 8 to unlock Slots!','error'); return; }
            slotState = { spinning:false, bet:25, grid:[], winCells:new Set(), prize:null };
            slotState.grid = Array.from({length:5},()=>Array.from({length:5},()=>_pickSlotSym()));
            _renderSlotsModal();
        }

        function _renderSlotsModal() {
            document.getElementById('slots-modal')?.remove();
            const m = document.createElement('div');
            m.id = 'slots-modal';
            m.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.93);';

            const gridHTML = slotState.grid.map((row,ri)=>
                `<tr>${row.map((sym,ci)=>{
                    const key=`${ri}-${ci}`;
                    const isWin = slotState.winCells.has(key);
                    return `<td id="sc2-${ri}-${ci}" style="
                        width:72px;height:72px;text-align:center;vertical-align:middle;
                        border:2.5px solid ${isWin?'#ffd700':'#1e3a5f'};
                        border-radius:12px;
                        background:${isWin?'radial-gradient(circle at 50% 40%,rgba(255,215,0,0.22),rgba(0,0,0,0.75))':'linear-gradient(160deg,rgba(15,23,42,0.95),rgba(0,0,0,0.85))'};
                        box-shadow:${isWin?'0 0 22px rgba(255,215,0,0.7),inset 0 0 10px rgba(255,215,0,0.15)':'inset 0 2px 4px rgba(0,0,0,0.5)'};
                        position:relative;overflow:hidden;transition:all 0.35s;">
                        <span class="slotcell" style="font-size:32px;display:block;line-height:1;filter:${isWin?'drop-shadow(0 0 6px '+sym.color+'80)':'none'};">${sym.emoji}</span>
                        ${isWin?`<div style="position:absolute;inset:0;border-radius:10px;border:2px solid #ffd700;animation:slotWinPulse 0.65s ease-in-out infinite alternate;pointer-events:none"></div>`:''}
                    </td>`;
                }).join('')}</tr>`
            ).join('');

            const betHTML = [25,50,100].map(b=>`
                <button onclick="slotSetBet(${b})" style="
                    padding:9px 20px;border-radius:10px;font-family:'Bangers',cursive;font-size:20px;letter-spacing:.06em;
                    border:2.5px solid ${slotState.bet===b?'#ffd700':'#334155'};
                    background:${slotState.bet===b?'linear-gradient(135deg,rgba(255,215,0,0.2),rgba(180,140,0,0.1))':'rgba(0,0,0,0.45)'};
                    color:${slotState.bet===b?'#ffd700':'#6b7280'};cursor:pointer;
                    box-shadow:${slotState.bet===b?'0 0 16px rgba(255,215,0,0.45)':'none'};transition:all 0.18s;">
                    $${b}
                </button>`).join('');

            const prizeAreaHTML = slotState.prize
                ? (() => {
                    const p = slotState.prize;
                    const breakdownLines = (p.isCombo && p.allWins)
                        ? p.allWins.map(w => {
                            const base = w.prize.money || 0;
                            const scaled = Math.round(base * p.comboMult);
                            const cardStr = w.prize.cardRarity ? ` + ${w.prize.cardRarity} Card` : '';
                            return `<div style="font-size:10px;color:#fde68a;font-family:monospace;line-height:1.6;">
                                ${w.sym.emoji} ${w.matchLen}-match ${w.isRare?'<span style="color:#fbbf24">RARE</span> ':''}  +$${scaled}${cardStr}
                            </div>`;
                        }).join('')
                        : '';
                    return `<div style="text-align:center;">
                        <div style="font-family:'Bangers',cursive;font-size:${p.isCombo?'21':'26'}px;color:#ffd700;
                            text-shadow:0 0 14px rgba(255,215,0,0.8);letter-spacing:.06em;
                            animation:slotWinPulse 0.8s ease-in-out infinite alternate;">
                             ${p.label}
                        </div>
                        ${breakdownLines}
                    </div>`;
                })()
                : slotState.prize === false
                    ? `<div style="font-family:'Bangers',cursive;font-size:20px;color:#ef4444;text-align:center;letter-spacing:.05em;">No Match  Try Again!</div>`
                    : `<div style="font-family:monospace;font-size:11px;color:#475569;text-align:center;letter-spacing:.08em;">Match 3  4  5 in any direction to win!</div>`;

            const legendHTML = SLOT_SYMBOLS.map(s=>`
                <span style="font-size:11px;font-family:monospace;padding:3px 8px;border-radius:5px;
                    background:rgba(0,0,0,0.45);border:1px solid ${s.rare?'#fbbf24':'#1e293b'};
                    color:${s.rare?'#fbbf24':'#94a3b8'};">
                    ${s.emoji} ${s.label}${s.rare?' ':''}
                </span>`).join('');

            m.innerHTML = `
            <style>
            @keyframes slotWinPulse { from{opacity:0.7;box-shadow:0 0 8px #ffd700} to{opacity:1;box-shadow:0 0 30px #ffd700,0 0 60px rgba(255,215,0,0.4)} }
            @keyframes slotBlur { 0%{filter:blur(5px) brightness(2);transform:scaleY(0.85)} 100%{filter:blur(0);transform:scaleY(1)} }
            @keyframes slotHandlePull { 0%{transform:translateY(0) rotate(0deg)} 45%{transform:translateY(48px) rotate(18deg)} 100%{transform:translateY(0) rotate(0deg)} }
            @keyframes slotMarquee { 0%,100%{text-shadow:0 0 8px #ffd700,0 0 20px #ffd700} 50%{text-shadow:0 0 20px #ff9500,0 0 60px #ff9500} }
            .slot-cell-spin { animation: slotBlur 0.12s ease-out infinite alternate !important; }
            .slot-handle-pull { animation: slotHandlePull 0.65s ease-in-out !important; }
            </style>
            <div style="position:relative;display:flex;align-items:stretch;gap:0;width:min(700px,96vw);">

              <!-- === MACHINE BODY === -->
              <div style="flex:1;background:linear-gradient(175deg,#111827,#0a0f1a);
                           border:4px solid #1e3a5f;border-right:none;border-radius:22px 0 0 22px;
                           box-shadow:0 0 80px rgba(0,0,0,0.9),inset 0 2px 0 rgba(255,255,255,0.04);
                           padding:20px 20px 18px 20px;">

                <!-- Marquee -->
                <div style="text-align:center;margin-bottom:12px;">
                  <div style="font-family:'Bangers',cursive;font-size:44px;letter-spacing:.12em;line-height:1;
                               background:linear-gradient(90deg,#ffd700,#ff9500,#ffd700);
                               -webkit-background-clip:text;-webkit-text-fill-color:transparent;
                               animation:slotMarquee 2s ease-in-out infinite;"> DUEL SLOTS </div>
                  <div style="font-family:monospace;font-size:10px;color:#334155;letter-spacing:.18em;">MATCH 3  4  5 IN ANY DIRECTION</div>
                </div>

                <!-- Reel Window -->
                <div style="background:#070c14;border:5px solid #1e3a5f;border-radius:16px;
                             box-shadow:inset 0 0 40px rgba(0,50,200,0.18),0 0 24px rgba(0,80,255,0.15);
                             padding:8px;margin-bottom:12px;">
                  <table style="border-collapse:separate;border-spacing:5px;margin:auto;">${gridHTML}</table>
                </div>

                <!-- Prize Display -->
                <div style="min-height:44px;background:rgba(0,0,0,0.55);border:1.5px solid #1e293b;
                             border-radius:10px;padding:8px 14px;margin-bottom:12px;
                             display:flex;align-items:center;justify-content:center;">
                  ${prizeAreaHTML}
                </div>

                <!-- Bet Selector -->
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;justify-content:center;flex-wrap:wrap;">
                  <span style="font-family:'Bangers',cursive;font-size:20px;color:#475569;letter-spacing:.06em;">BET:</span>
                  ${betHTML}
                  <span style="font-family:monospace;font-size:11px;color:#334155;padding:4px 10px;background:rgba(0,0,0,0.4);border-radius:6px;">Balance: $${gameState.money}</span>
                </div>

                <!-- Action Row -->
                <div style="display:flex;gap:10px;justify-content:center;align-items:center;">
                  <button id="slot-spin-btn" onclick="doSlotSpin()" ${slotState.spinning?'disabled':''} style="
                      font-family:'Bangers',cursive;font-size:30px;letter-spacing:.1em;
                      padding:12px 44px;border-radius:14px;
                      background:${slotState.spinning?'#1f2937':'linear-gradient(135deg,#dc2626,#7f1d1d)'};
                      border:3px solid ${slotState.spinning?'#374151':'#ef4444'};
                      color:${slotState.spinning?'#4b5563':'#fff'};
                      cursor:${slotState.spinning?'not-allowed':'pointer'};
                      box-shadow:${slotState.spinning?'none':'0 0 24px rgba(220,38,38,0.5)'};transition:all 0.2s;">
                    ${slotState.spinning?'Spinning':' SPIN!'}
                  </button>
                  <button onclick="closeSlotsModal()" style="
                      font-family:'Bangers',cursive;font-size:18px;padding:10px 18px;border-radius:10px;
                      background:rgba(0,0,0,0.5);border:2px solid #374151;color:#6b7280;cursor:pointer;">
                     Close
                  </button>
                </div>

                <!-- Symbol Legend -->
                <div style="display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin-top:12px;">
                  ${legendHTML}
                </div>
              </div>

              <!-- === HANDLE SIDE === -->
              <div style="width:68px;background:linear-gradient(170deg,#111827,#0a0f1a);
                           border:4px solid #1e3a5f;border-left:3px solid #0f172a;
                           border-radius:0 22px 22px 0;
                           display:flex;flex-direction:column;align-items:center;
                           justify-content:center;padding:10px 0;min-height:460px;">
                <div id="slot-handle" onclick="doSlotSpin()"
                     style="display:flex;flex-direction:column;align-items:center;cursor:pointer;user-select:none;"
                     onmouseenter="this.style.filter='brightness(1.4)'" onmouseleave="this.style.filter='brightness(1)'">
                  <!-- Ball -->
                  <div style="width:38px;height:38px;border-radius:50%;
                               background:radial-gradient(circle at 35% 30%,#f87171,#991b1b);
                               border:3px solid #fca5a5;
                               box-shadow:0 0 18px rgba(239,68,68,0.7);"></div>
                  <!-- Arm shaft -->
                  <div style="width:14px;height:170px;
                               background:linear-gradient(to right,#374151,#9ca3af,#e5e7eb,#9ca3af,#374151);
                               border-radius:7px;border:1.5px solid #1f2937;
                               box-shadow:3px 0 8px rgba(0,0,0,0.6);"></div>
                  <!-- Base knob -->
                  <div style="width:30px;height:16px;background:linear-gradient(to bottom,#1e3a5f,#0f172a);
                               border-radius:7px;border:2.5px solid #1e3a5f;"></div>
                </div>
                <div style="font-family:'Bangers',cursive;font-size:10px;color:#334155;
                             margin-top:10px;letter-spacing:.05em;text-align:center;line-height:1.3;">PULL<br>HANDLE</div>
              </div>

            </div>`;

            document.body.appendChild(m);
        }

        function slotSetBet(amt) {
            if(slotState.spinning) return;
            slotState.bet = amt;
            slotState.prize = null;
            slotState.winCells = new Set();
            _renderSlotsModal();
        }

        function doSlotSpin() {
            if(slotState.spinning) return;
            if(gameState.money < slotState.bet){
                showToast(`Need $${slotState.bet} to spin!`,'error'); return;
            }
            gameState.money -= slotState.bet;
            slotState.spinning = true;
            SoundEngine.slotSpin();
            slotState.winCells = new Set();
            slotState.prize = null;
            _renderSlotsModal();

            // Animate handle pull
            const handle = document.getElementById('slot-handle');
            if(handle){ handle.classList.add('slot-handle-pull'); setTimeout(()=>handle.classList.remove('slot-handle-pull'),700); }

            // Rapid-cycle symbols on cells while spinning
            const spinEmojis=['','','','','','','',''];
            const ticker = setInterval(()=>{
                for(let r=0;r<5;r++) for(let c=0;c<5;c++){
                    const el=document.getElementById(`sc2-${r}-${c}`);
                    if(el){
                        const sp=el.querySelector('.slotcell');
                        if(sp) sp.textContent = spinEmojis[Math.floor(Math.random()*spinEmojis.length)];
                        el.style.filter='brightness(1.7)';
                    }
                }
            }, 65);

            // Generate final grid
            const newGrid = Array.from({length:5},()=>Array.from({length:5},()=>_pickSlotSym()));

            // Stagger column reveals leftright
            for(let col=0;col<5;col++){
                const c=col;
                setTimeout(()=>{
                    SoundEngine.slotCol();
                    for(let r=0;r<5;r++){
                        slotState.grid[r][c] = newGrid[r][c];
                        const el=document.getElementById(`sc2-${r}-${c}`);
                        if(el){
                            el.style.filter='';
                            el.classList.add('slot-cell-spin');
                            const sp=el.querySelector('.slotcell');
                            if(sp) sp.textContent = newGrid[r][c].emoji;
                            setTimeout(()=>el.classList.remove('slot-cell-spin'),220);
                        }
                    }
                }, 350 + c*195);
            }

            // Evaluate after all columns settle
            setTimeout(()=>{
                clearInterval(ticker);
                slotState.grid = newGrid;
                slotState.spinning = false;
                _evalSlots();
            }, 350 + 4*195 + 380);
        }

        function _evalSlots() {
            const grid = slotState.grid;
            const size = 5;

            const lines = [];
            for(let r=0;r<size;r++) lines.push(Array.from({length:size},(_,c)=>[r,c]));
            for(let c=0;c<size;c++) lines.push(Array.from({length:size},(_,r)=>[r,c]));
            lines.push(Array.from({length:size},(_,i)=>[i,i]));
            lines.push(Array.from({length:size},(_,i)=>[i,size-1-i]));

            const allWins = [];
            const allWinCells = new Set();
            const seenCellKeys = new Set(); // prevent duplicate combos

            for(const line of lines){
                const syms = line.map(([r,c])=>grid[r][c]);
                let i = 0;
                while(i < size){
                    if(i > size - 3){ i++; continue; }
                    const baseId = syms[i].id;
                    let runLen = 1;
                    while(i + runLen < size && syms[i + runLen].id === baseId) runLen++;
                    if(runLen >= 3){
                        const sym = syms[i];
                        const isRare = sym.rare;
                        const prizeGroup = SLOT_PRIZES[slotState.bet]?.[Math.min(runLen, 5)];
                        if(prizeGroup){
                            const prize = isRare ? prizeGroup.rare : prizeGroup.common;
                            const winCells = line.slice(i, i + runLen).map(([r,c])=>`${r}-${c}`);
                            const cellKey = [...winCells].sort().join('|');
                            if(!seenCellKeys.has(cellKey)){
                                seenCellKeys.add(cellKey);
                                allWins.push({ prize, matchLen: Math.min(runLen, 5), isRare, sym, winCells });
                                winCells.forEach(k => allWinCells.add(k));
                            }
                        }
                    }
                    i += runLen;
                }
            }

            slotState.winCells = allWinCells;

            if(allWins.length > 0){
                SoundEngine.slotWin(allWins.some(w => w.isRare));
                // Combo multiplier: each extra win line stacks 50% more
                const comboMult = allWins.length === 1 ? 1
                                : allWins.length === 2 ? 1.5
                                : allWins.length === 3 ? 2
                                : allWins.length === 4 ? 2.75
                                : 4; // 5+ lines

                let totalMoney = 0;
                const cardsToGrant = [];
                let bestScore = -1, bestLabel = '';

                for(const win of allWins){
                    totalMoney += win.prize.money || 0;
                    if(win.prize.cardRarity) cardsToGrant.push(win.prize.cardRarity);
                    const sc = win.matchLen * 10 + (win.isRare ? 5 : 0);
                    if(sc > bestScore){ bestScore = sc; bestLabel = win.prize.label; }
                }

                totalMoney = Math.round(totalMoney * comboMult);
                gameState.money += totalMoney;
                cardsToGrant.forEach(r => grantRandomCard(r));

                const isCombo = allWins.length > 1;
                const mainLabel = isCombo
                    ? `${allWins.length} COMBO! +$${totalMoney} (${comboMult})`
                    : `${bestLabel}`;

                slotState.prize = { label: mainLabel, money: totalMoney, allWins, comboMult, isCombo };
                showToast(mainLabel, 'success');
            } else {
                slotState.prize = false;
            }

            _renderSlotsModal();
        }

        function closeSlotsModal() {
            document.getElementById('slots-modal')?.remove();
            slotState = { spinning:false, bet:25, grid:[], winCells:new Set(), prize:null };
            renderShop();
        }

        // --- VIEW: DUEL SCREEN ---
        function renderDuel() {
            currentDuelMap = generateDuelMap();
            root.innerHTML = `
                <div class="flex flex-col h-full world-grid-bg text-white relative overflow-hidden" id="duel-screen">
                    <div class="world-scan-line"></div>

                    <!--  HUD  -->
                    <div class="shrink-0 flex items-center gap-3 px-4 py-2 bg-[#050f1e]/90 border-b-2 border-cyan-700/60 z-20 shadow-[0_2px_20px_rgba(0,229,255,0.15)]" style="backdrop-filter:blur(6px)">
                        <!-- Back -->
                        <button onclick="gameState.view='MENU'; renderApp()" class="flex items-center gap-1 text-cyan-400 hover:text-white font-bold text-sm uppercase tracking-widest transition-colors border border-cyan-700/50 px-2 py-1 rounded">
                            ${ICONS.BACK} Menu
                        </button>

                        <div class="w-px h-8 bg-cyan-800/50 mx-1"></div>

                        <!-- Credits -->
                        <div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-green-700/50">
                            <span class="text-green-400 text-xs">${ICONS.MONEY.replace('width="24" height="24"','width="14" height="14"')}</span>
                            <span class="font-mono font-bold text-green-300 text-sm">$${gameState.money}</span>
                        </div>

                        <!-- Level -->
                        <div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-yellow-700/50">
                            <span class="text-yellow-400 font-mono text-xs font-bold">LVL</span>
                            <span class="text-yellow-300 font-mono font-bold text-sm">${gameState.level}</span>
                        </div>

                        <!-- Deck Size -->
                        <div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-blue-700/50">
                            <span class="text-blue-400 font-mono text-xs font-bold">DECK</span>
                            <span class="text-blue-300 font-mono font-bold text-sm">${gameState.mainDeck.length} / 60</span>
                        </div>

                        <!-- Win/Loss live stats -->
                        <div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-cyan-700/50">
                            <span class="text-cyan-400 font-mono text-xs font-bold">W</span>
                            <span class="text-cyan-300 font-mono font-bold text-sm">${gameState.wins}</span>
                            <span class="text-gray-500 mx-1">|</span>
                            <span class="text-red-400 font-mono text-xs font-bold">L</span>
                            <span class="text-red-300 font-mono font-bold text-sm">${gameState.losses}</span>
                        </div>

                        <!-- XP Progress Bar -->
                        ${gameState.level < 100 ? (() => {
                            const needed = xpToNextLevel(gameState.level);
                            const pct = Math.floor((gameState.xp / needed) * 100);
                            return `<div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-purple-700/50" title="XP: ${gameState.xp} / ${needed}">
                                <span class="text-purple-400 font-mono text-xs font-bold">XP</span>
                                <div style="width:60px;height:6px;background:#1a0030;border-radius:4px;border:1px solid #6b21a8;overflow:hidden">
                                    <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#a855f7,#e879f9);border-radius:4px;transition:width 0.4s"></div>
                                </div>
                                <span class="text-purple-300 font-mono text-xs">${pct}%</span>
                            </div>`;
                        })() : `<div class="flex items-center gap-1 bg-black/30 px-3 py-1 rounded border border-yellow-600/50">
                            <span class="text-yellow-400 font-mono text-xs font-bold">MAX LEVEL</span>
                        </div>`}

                        <div class="flex-grow"></div>

                        <!-- Daily Reward Button -->
                        ${renderDailyRewardButton()}

                        <!-- Online badge -->
                        <div id="mp-online-badge" class="text-xs text-purple-400 font-mono ml-2 border border-purple-800/50 px-2 py-1 rounded bg-black/30">  ONLINE</div>

                        <!-- Duelist count -->
                        <div class="text-xs text-cyan-600 font-mono ml-2">
                            ${currentDuelMap.length} OPPONENT${currentDuelMap.length !== 1 ? 'S' : ''} ONLINE${currentStorySpots.length > 0 ? `  <span style="color:#ffe040">${currentStorySpots.length} EVENT${currentStorySpots.length !== 1 ? 'S' : ''}</span>` : ''}
                        </div>
                    </div>

                    <!--  WORLD MAP AREA  -->
                    <div class="flex-grow relative overflow-hidden" id="world-map-area" onclick="hideDuelistPopup(event); hideStoryPopup(event)">

                        <!-- World Map SVG -->
                        ${buildWorldMapSVG()}

                        <!-- Duelist Markers -->
                        ${currentDuelMap.map(d => buildDuelistMarker(d)).join('')}

                        <!-- Story Event Markers -->
                        ${currentStorySpots.map(s => buildStoryMarker(s)).join('')}

                        <!-- Legend -->
                        <div class="absolute bottom-3 left-3 text-[10px] text-cyan-700 font-mono z-10 select-none">
                            <div class="flex items-center gap-1 mb-1"><span class="inline-block w-2 h-2 rounded-full bg-cyan-400 opacity-80"></span> DUELIST</div>
                            <div class="flex items-center gap-1 mb-1"><span class="inline-block w-2 h-2 rounded-full bg-yellow-400 opacity-80"></span> RARE ELITE</div>
                            <div class="flex items-center gap-1 mb-1"><span style="display:inline-block;width:8px;height:8px;transform:rotate(45deg);background:#ffe040;opacity:0.85;"></span> STORY EVENT</div>
                            <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-purple-400 opacity-80"></span> ONLINE PLAYER</div>
                        </div>

                        <!-- MP Online Players -->
                        <div id="mp-markers" class="absolute inset-0 pointer-events-none z-20"></div>

                        <!-- Duelist Popup -->
                        <div id="duelist-popup" class="hidden absolute z-30 pointer-events-none" style="min-width:180px"></div>

                        <!-- Story Event Popup -->
                        <div id="story-popup" class="hidden absolute z-30 pointer-events-none" style="min-width:225px"></div>
                    </div>
                </div>

                <!--  DAILY REWARD MODAL  -->
                <div id="daily-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80" onclick="closeDailyModal(event)">
                    <div class="daily-pop bg-[#050f1e] border-2 border-cyan-500 rounded-xl p-6 shadow-[0_0_40px_rgba(0,229,255,0.3)] max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                        <h2 class="text-3xl font-[Bangers] text-cyan-300 text-center tracking-wider mb-1">DAILY REWARD</h2>
                        <p class="text-center text-xs text-cyan-700 mb-5 font-mono">CLAIM ONCE EVERY 24 HOURS  INCREASING REWARDS EACH DAY</p>
                        <div class="grid grid-cols-7 gap-1 mb-5">
                            ${buildDailyRewardDays()}
                        </div>
                        ${buildDailyClaimButton()}
                        <button onclick="closeDailyModal()" class="mt-3 w-full text-center text-cyan-700 hover:text-cyan-400 text-xs font-mono uppercase tracking-widest transition-colors">Close</button>
                    </div>
                </div>
            `;
        }

        //  World map SVG builder 
        function buildWorldMapSVG() {
            const gridH = []; // horizontal lat lines
            for (let y = 60; y < 600; y += 60) gridH.push(`<line x1="0" y1="${y}" x2="1000" y2="${y}" stroke="#00e5ff" stroke-width="0.4" opacity="0.18"/>`);
            const gridV = []; // vertical lon lines
            for (let x = 100; x <= 900; x += 100) gridV.push(`<line x1="${x}" y1="0" x2="${x}" y2="600" stroke="#00e5ff" stroke-width="0.4" opacity="0.18"/>`);

            return `
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="globe-glow" cx="50%" cy="50%" r="55%">
                        <stop offset="0%"   stop-color="#0a2040" stop-opacity="0.7"/>
                        <stop offset="100%" stop-color="#020810" stop-opacity="1"/>
                    </radialGradient>
                    <filter id="neon-blur"><feGaussianBlur stdDeviation="2.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>

                <!-- Background -->
                <rect width="1000" height="600" fill="url(#globe-glow)"/>

                <!-- Grid -->
                ${gridH.join('')}
                ${gridV.join('')}

                <!-- Continent fills + outlines -->
                <!-- North America -->
                <polygon points="120,80 200,68 270,85 305,130 295,175 260,215 218,228 175,218 138,190 110,158 105,120" fill="#041828" stroke="#00e5ff" stroke-width="1.2" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- Greenland -->
                <polygon points="255,18 315,12 338,42 308,68 265,72 240,48" fill="#041828" stroke="#00e5ff" stroke-width="0.9" opacity="0.7"/>
                <!-- South America -->
                <polygon points="188,258 238,248 275,278 285,338 265,395 232,435 198,432 170,402 158,342 168,290" fill="#041828" stroke="#00e5ff" stroke-width="1.2" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- Europe -->
                <polygon points="408,58 475,48 515,72 512,112 480,132 448,132 420,102 398,80" fill="#041828" stroke="#00e5ff" stroke-width="1.1" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- Africa -->
                <polygon points="418,148 480,138 535,168 548,242 532,332 502,392 462,412 422,393 392,335 388,252 408,182" fill="#041828" stroke="#00e5ff" stroke-width="1.2" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- Arabia / Middle East -->
                <polygon points="530,152 592,148 618,178 598,222 552,235 522,205 515,168" fill="#041828" stroke="#00e5ff" stroke-width="1" opacity="0.8"/>
                <!-- Russia / N. Asia -->
                <polygon points="482,28 655,12 808,28 875,68 832,100 752,112 655,98 562,88 492,72" fill="#041828" stroke="#00e5ff" stroke-width="1.2" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- South / SE Asia -->
                <polygon points="562,158 645,148 715,165 732,225 702,275 660,288 612,272 572,235 555,185" fill="#041828" stroke="#00e5ff" stroke-width="1.1" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- East Asia -->
                <polygon points="702,98 818,92 855,122 842,168 792,188 732,178 696,148" fill="#041828" stroke="#00e5ff" stroke-width="1.1" opacity="0.85" filter="url(#neon-blur)"/>
                <!-- SE Asia islands -->
                <polygon points="762,218 805,212 822,242 802,268 772,262 756,242" fill="#041828" stroke="#00e5ff" stroke-width="0.9" opacity="0.75"/>
                <!-- Japan -->
                <polygon points="872,128 894,122 905,145 888,165 872,158" fill="#041828" stroke="#00e5ff" stroke-width="0.9" opacity="0.75"/>
                <!-- Australia -->
                <polygon points="802,348 905,338 962,372 958,440 912,482 852,482 792,448 778,396 788,358" fill="#041828" stroke="#00e5ff" stroke-width="1.2" opacity="0.85" filter="url(#neon-blur)"/>

                <!-- Equator highlight -->
                <line x1="0" y1="300" x2="1000" y2="300" stroke="#00e5ff" stroke-width="0.7" opacity="0.3" stroke-dasharray="8,6"/>
                <!-- Prime meridian -->
                <line x1="458" y1="0" x2="458" y2="600" stroke="#00e5ff" stroke-width="0.7" opacity="0.2" stroke-dasharray="8,6"/>

                <!-- Corner compass glyphs -->
                <text x="12" y="22" font-family="monospace" font-size="10" fill="#00e5ff" opacity="0.3">N</text>
                <text x="983" y="22" font-family="monospace" font-size="10" fill="#00e5ff" opacity="0.3">E</text>
                <text x="12" y="595" font-family="monospace" font-size="10" fill="#00e5ff" opacity="0.3">W</text>
                <text x="979" y="595" font-family="monospace" font-size="10" fill="#00e5ff" opacity="0.3">S</text>
            </svg>`;
        }

        //  Duelist marker HTML 
        function buildDuelistMarker(d) {
            const ringColor = d.rare ? '#ffdd00' : d.color;
            const glowClass = d.rare ? ' rare-glow' : '';
            const diffStars = ''.repeat(d.diff) + ''.repeat(5 - d.diff);
            return `
            <div class="duelist-marker${glowClass}" style="left:${d.mapX}%;top:${d.mapY}%;color:${ringColor}"
                 onclick="event.stopPropagation(); showDuelistPopup(${d.uid}, this)"
                 title="${d.name}">
                <!-- Ping ring -->
                <div class="duelist-ping absolute w-10 h-10 rounded-full border-2" style="top:50%;left:50%;transform:translate(-50%,-50%);border-color:${ringColor};opacity:0.5;pointer-events:none;"></div>
                <!-- Avatar circle -->
                <svg width="40" height="40" viewBox="-20 -20 40 40" style="display:block;">
                    <!-- Outer ring -->
                    <circle r="19" fill="none" stroke="${ringColor}" stroke-width="${d.rare ? 2.5 : 1.8}" ${d.rare ? '' : 'stroke-dasharray="4,2"'}/>
                    <!-- Face -->
                    ${d.face}
                </svg>
                <!-- Name label -->
                <div class="text-center font-mono font-bold leading-tight" style="font-size:9px;color:${ringColor};text-shadow:0 0 6px ${ringColor};margin-top:1px;white-space:nowrap;">
                    ${d.rare ? ' ' : ''}${d.name}
                </div>
            </div>`;
        }

        //  Story Event Marker HTML 
        function buildStoryMarker(s) {
            return `
            <div class="story-marker story-pulse" data-suid="${s.uid}" style="left:${s.mapX}%;top:${s.mapY}%;color:${s.color}"
                 onclick="event.stopPropagation(); showStoryPopup('${s.uid}', this)"
                 title="${s.title}">
                <svg width="42" height="42" viewBox="-21 -21 42 42" style="display:block;">
                    <polygon points="0,-19 19,0 0,19 -19,0" fill="#040d1cbb" stroke="${s.color}" stroke-width="2.2"/>
                    <polygon points="0,-12 12,0 0,12 -12,0" fill="${s.color}30" stroke="${s.color}" stroke-width="1" opacity="0.7"/>
                    <text x="0" y="5" text-anchor="middle" font-size="12" fill="${s.color}" font-family="sans-serif" font-weight="bold">${s.symbol}</text>
                </svg>
                <div class="text-center font-mono font-bold leading-tight" style="font-size:9px;color:${s.color};text-shadow:0 0 6px ${s.color};margin-top:1px;white-space:nowrap;">
                    ${s.title}
                </div>
            </div>`;
        }

        //  Show duelist popup near the clicked marker 
        function showDuelistPopup(uid, markerEl) {
            const d = currentDuelMap.find(x => x.uid === uid);
            if (!d) return;

            const popup = document.getElementById('duelist-popup');
            const area  = document.getElementById('world-map-area');
            const areaBounds   = area.getBoundingClientRect();
            const markerBounds = markerEl.getBoundingClientRect();

            const diffStars = ''.repeat(d.diff) + ''.repeat(5 - d.diff);
            popup.innerHTML = `
                <div class="pointer-events-auto bg-[#040d1c] border-2 rounded-lg p-3 shadow-[0_0_25px_rgba(0,229,255,0.4)]" style="border-color:${d.color};min-width:175px;">
                    <div class="font-[Bangers] text-xl tracking-widest mb-1" style="color:${d.color};">${d.rare ? ' ' : ''}${d.name}</div>
                    <div class="text-xs text-gray-400 font-mono mb-1">Deck: <span class="text-white">${d.deck}</span></div>
                    <div class="text-xs font-mono mb-1" style="color:${d.color};">${diffStars}</div>
                    <div class="text-xs text-green-400 font-mono mb-3">Reward: <span class="font-bold">$${d.reward}</span>${d.rare ? ' <span class="text-yellow-400">+ RARE CARD</span>' : ''}</div>
                    <button onclick="startDuelWithAI(${uid})"
                            class="w-full font-[Bangers] tracking-widest text-lg py-1 rounded border-2 transition-all hover:brightness-125 active:scale-95"
                            style="background:linear-gradient(90deg,#040d1c,${d.color}22);border-color:${d.color};color:${d.color};">
                         START DUEL
                    </button>
                </div>`;

            popup.classList.remove('hidden');
            popup.style.pointerEvents = 'auto';

            // Position popup above/beside marker
            let left = markerBounds.left - areaBounds.left + 24;
            let top  = markerBounds.top  - areaBounds.top  - 160;
            if (left + 185 > areaBounds.width)  left = markerBounds.left - areaBounds.left - 185;
            if (top < 10) top = markerBounds.bottom - areaBounds.top + 10;
            popup.style.left = left + 'px';
            popup.style.top  = top  + 'px';
        }

        function hideDuelistPopup(e) {
            const popup = document.getElementById('duelist-popup');
            if (popup && !popup.contains(e.target)) {
                popup.classList.add('hidden');
                popup.style.pointerEvents = 'none';
            }
        }

        //  Story Event Popup 
        function showStoryPopup(sUid, markerEl) {
            const spot = currentStorySpots.find(s => s.uid === sUid);
            if (!spot) return;
            const popup = document.getElementById('story-popup');
            const area  = document.getElementById('world-map-area');
            const areaBounds   = area.getBoundingClientRect();
            const markerBounds = markerEl.getBoundingClientRect();

            const typeLabels = {
                explore: ' EXPLORE', search: ' SEARCH', rest: ' REST',
                talk: ' TALK', merchant: ' MERCHANT', ambush: ' DANGER', find: ' DISCOVERY'
            };
            const typeLabel = typeLabels[spot.type] || ' EVENT';

            popup.innerHTML = `
                <div class="pointer-events-auto bg-[#040d1c] border-2 rounded-lg p-4 shadow-[0_0_30px_rgba(255,200,0,0.25)]" style="border-color:${spot.color};min-width:225px;max-width:285px;">
                    <div class="text-xs font-mono tracking-widest mb-1 opacity-70" style="color:${spot.color};">${typeLabel}</div>
                    <div class="font-[Bangers] text-xl tracking-widest mb-2" style="color:${spot.color};">${spot.title}</div>
                    <p class="text-gray-300 text-xs font-mono mb-4 leading-relaxed italic">"${spot.intro}"</p>
                    <div class="flex flex-col gap-2">
                        ${spot.options.map(opt => `
                            <button onclick="resolveStoryEvent('${spot.uid}', '${opt.key}')"
                                    class="w-full font-[Bangers] tracking-wide text-base py-1.5 px-3 rounded border-2 transition-all hover:brightness-125 active:scale-95 text-left"
                                    style="background:linear-gradient(90deg,#040d1c,${spot.color}15);border-color:${spot.color}55;color:${spot.color};">
                                ${opt.label}
                            </button>
                        `).join('')}
                        <button onclick="hideStoryPopup()"
                                class="w-full font-mono text-xs py-1 rounded border border-gray-700 text-gray-500 hover:text-gray-300 transition-colors mt-1">
                            [Ignore for now]
                        </button>
                    </div>
                </div>`;
            popup.classList.remove('hidden');
            popup.style.pointerEvents = 'auto';

            let left = markerBounds.left - areaBounds.left + 28;
            let top  = markerBounds.top  - areaBounds.top  - 200;
            if (left + 295 > areaBounds.width)  left = markerBounds.left - areaBounds.left - 295;
            if (top < 10) top = markerBounds.bottom - areaBounds.top + 10;
            popup.style.left = left + 'px';
            popup.style.top  = top  + 'px';
        }

        function resolveStoryEvent(sUid, choiceKey) {
            const spot = currentStorySpots.find(s => s.uid === sUid);
            if (!spot) return;
            const option = spot.options.find(o => o.key === choiceKey);
            if (!option) return;

            // Always remove the story marker from the map immediately when any option is chosen
            currentStorySpots = currentStorySpots.filter(s => s.uid !== sUid);
            const markerEl = document.querySelector(`.story-marker[data-suid="${sUid}"]`);
            if (markerEl) markerEl.remove();
            hideStoryPopup();

            // Weighted random outcome pick
            const outcomes = option.outcomes;
            const total = outcomes.reduce((sum, o) => sum + o.w, 0);
            let r = Math.random() * total;
            let picked = outcomes[outcomes.length - 1];
            for (const o of outcomes) { r -= o.w; if (r <= 0) { picked = o; break; } }

            const g = picked.give;
            const headerColor = spot.color;

            //  AMBUSH: show announcement overlay then launch duel 
            if (g && g.type === 'ambush') {
                const robberFace = `<circle r="16" fill="#1a0000" stroke="#ff3300" stroke-width="2.5"/><circle cx="-4" cy="-2" r="3.5" fill="#cc2200"/><circle cx="4" cy="-2" r="3.5" fill="#cc2200"/><line x1="-6" y1="-10" x2="6" y2="-14" stroke="#ff6600" stroke-width="1.5"/><path d="M-5,6 Q0,10 5,6" fill="none" stroke="#ff3300" stroke-width="2"/>`;
                const robberNPC = {
                    name: g.robberName || 'Street Robber', deck: 'Street Hustle',
                    diff: g.diff || 2, reward: g.reward || 50, rare: false,
                    color: '#ff3322', isAmbush: true, ambushPenalty: g.penalty || 40,
                    face: robberFace, mapX: spot.mapX, mapY: spot.mapY,
                    uid: 9000 + Math.floor(Math.random() * 999)
                };
                currentDuelMap.push(robberNPC);
                const ambushOv = document.createElement('div');
                ambushOv.id = 'story-result-overlay';
                ambushOv.className = 'fixed inset-0 z-[9998] flex items-center justify-center';
                ambushOv.style.background = 'radial-gradient(ellipse at 50% 50%, #3a0000 0%, #0a0000 80%)';
                ambushOv.innerHTML = `
                    <div class="text-center px-8 py-10 max-w-lg w-full mx-4">
                        <div class="text-8xl mb-4 animate-bounce"></div>
                        <div class="font-[Bangers] text-6xl tracking-widest text-red-500 mb-2" style="text-shadow:0 0 30px #ff0000;">AMBUSH!</div>
                        <div class="font-[Bangers] text-3xl text-white tracking-wider mb-4">${spot.title}</div>
                        <p class="text-red-300 font-mono text-sm mb-6 italic leading-relaxed">"${picked.text}"</p>
                        <div class="bg-red-900/30 border border-red-600 rounded-xl px-6 py-4 mb-6 font-mono">
                            <div class="text-red-400 font-bold text-xl">${g.robberName || 'Street Robber'} demands a DUEL</div>
                            <div class="text-gray-400 text-xs mt-1">Difficulty: ${''.repeat(g.diff || 2)}${''.repeat(5 - (g.diff || 2))}</div>
                            <div class="text-yellow-400 text-xs mt-1">Win Reward: <span class="text-green-400 font-bold">+$${g.reward || 50}</span> &nbsp;&nbsp; Lose Penalty: <span class="text-red-400 font-bold">$${g.penalty || 40}</span></div>
                        </div>
                        <button onclick="closeStoryOverlay(); startDuelWithAI(${robberNPC.uid})"
                                class="font-[Bangers] text-2xl px-10 py-3 rounded-xl border-2 border-red-500 text-red-300 hover:bg-red-900/40 tracking-widest transition-all">
                             FIGHT!
                        </button>
                    </div>`;
                document.body.appendChild(ambushOv);
                return;
            }

            //  ALL OTHER OUTCOMES: fullscreen result overlay 
            let rewardHTML = '';
            let bgGrad = `radial-gradient(ellipse at 50% 50%, #0a1a0a 0%, #040d1c 80%)`;

            if (!g) {
                bgGrad = `radial-gradient(ellipse at 50% 50%, #111320 0%, #040d1c 80%)`;
                rewardHTML = `
                    <div class="bg-gray-800/40 border border-gray-600 rounded-2xl px-8 py-8 text-center max-w-sm mx-auto">
                        <div class="text-7xl mb-4"></div>
                        <div class="font-[Bangers] text-3xl text-gray-400 tracking-widest mb-2">Nothing of Note</div>
                        <div class="text-gray-500 font-mono text-sm italic">Sometimes the world offers nothing at all.</div>
                    </div>`;

            } else if (g.type === 'money') {
                const gained = g.amount > 0;
                gameState.money = Math.max(0, gameState.money + g.amount);
                bgGrad = gained
                    ? `radial-gradient(ellipse at 50% 50%, #0a2200 0%, #040d1c 80%)`
                    : `radial-gradient(ellipse at 50% 50%, #220000 0%, #040d1c 80%)`;
                rewardHTML = `
                    <div class="text-center max-w-sm mx-auto">
                        <div class="text-9xl mb-4">${gained ? '' : ''}</div>
                        <div class="font-[Bangers] tracking-widest mb-3 ${gained ? 'text-green-400' : 'text-red-400'}" style="font-size:5rem;text-shadow:0 0 30px currentColor;">
                            ${gained ? '+' : ''}$${Math.abs(g.amount)}
                        </div>
                        <div class="font-mono text-xl ${gained ? 'text-green-300' : 'text-red-300'} mb-4">${gained ? 'Credits Gained' : 'Credits Lost'}</div>
                        <div class="bg-black/30 border border-gray-700 rounded-xl px-6 py-3 font-mono text-sm inline-block">
                            <span class="text-gray-400">New Balance: </span>
                            <span class="text-green-300 font-bold text-lg">$${gameState.money}</span>
                        </div>
                    </div>`;

            } else if (g.type === 'xp') {
                gameState.xp += g.amount;
                let levelsUp = 0;
                while (gameState.level < 100 && gameState.xp >= xpToNextLevel(gameState.level)) {
                    gameState.xp -= xpToNextLevel(gameState.level);
                    gameState.level++;
                    levelsUp++;
                }
                const needed = xpToNextLevel(gameState.level);
                const pct = Math.min(100, Math.floor((gameState.xp / needed) * 100));
                bgGrad = `radial-gradient(ellipse at 50% 50%, #1a0a2a 0%, #040d1c 80%)`;
                rewardHTML = `
                    <div class="text-center max-w-sm mx-auto">
                        <div class="text-9xl mb-4"></div>
                        <div class="font-[Bangers] tracking-widest mb-2 text-purple-400" style="font-size:4.5rem;text-shadow:0 0 25px #a855f7;">+${g.amount} XP</div>
                        ${levelsUp > 0
                            ? `<div class="font-[Bangers] text-4xl text-yellow-400 mb-4 animate-pulse" style="text-shadow:0 0 20px #facc15;"> LEVEL UP! &nbsp;Now Level ${gameState.level}!</div>`
                            : `<div class="font-mono text-purple-300 text-sm mb-4">Level ${gameState.level}</div>`}
                        <div class="mx-auto" style="max-width:280px">
                            <div class="flex justify-between text-xs font-mono text-purple-400 mb-1"><span>XP Progress</span><span>${gameState.xp} / ${needed}</span></div>
                            <div style="height:14px;background:#1a0030;border-radius:8px;border:1px solid #6b21a8;overflow:hidden;">
                                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#a855f7,#e879f9);border-radius:8px;"></div>
                            </div>
                        </div>
                    </div>`;

            } else if (g.type === 'card') {
                const card = grantRandomCard(g.rarity || 'C') || grantRandomCard('C');
                bgGrad = `radial-gradient(ellipse at 50% 50%, #1a1200 0%, #040d1c 80%)`;
                if (card) {
                    rewardHTML = `
                        <div class="text-center max-w-xs mx-auto">
                            <div class="font-[Bangers] text-4xl tracking-widest mb-5" style="color:${headerColor};text-shadow:0 0 25px ${headerColor};"> CARD ACQUIRED </div>
                            <div class="flex justify-center mb-5" style="filter:drop-shadow(0 0 30px ${headerColor}88);">
                                ${renderCardHTML(card, 'w-40', 'h-56')}
                            </div>
                            <div class="font-[Bangers] text-2xl text-yellow-300 tracking-wide mb-1">${card.name}</div>
                            <div class="font-mono text-xs text-gray-400 uppercase tracking-widest mb-2">${card.type}  ${card.rarity}${card.attribute ? '  ' + card.attribute : ''}</div>
                            <div class="text-gray-400 text-xs italic max-w-[240px] mx-auto leading-relaxed mb-3">${card.desc}</div>
                            <div class="text-green-400 font-mono text-xs font-bold"> Added to your Card Trunk</div>
                        </div>`;
                } else {
                    rewardHTML = `<div class="text-gray-400 font-mono text-sm italic text-center">The card faded before you could hold it.</div>`;
                }

            } else if (g.type === 'pack') {
                const rarList = ['C','C','R'];
                const cards = rarList.map(rar => grantRandomCard(rar)).filter(Boolean);
                bgGrad = `radial-gradient(ellipse at 50% 50%, #001a2a 0%, #040d1c 80%)`;
                rewardHTML = `
                    <div class="text-center">
                        <div class="font-[Bangers] text-4xl text-cyan-300 tracking-widest mb-6" style="text-shadow:0 0 25px #00e5ff;"> MINI PACK OPENED </div>
                        <div class="flex justify-center gap-4 flex-wrap mb-5">
                            ${cards.map(c => `<div style="filter:drop-shadow(0 0 12px rgba(0,229,255,0.5));">${renderCardHTML(c, 'w-28', 'h-40')}</div>`).join('')}
                        </div>
                        <div class="text-xs font-mono text-gray-400 mb-3">${cards.map(c => `<span class="text-cyan-300">${c.name}</span> <span class="text-gray-600">[${c.rarity}]</span>`).join(' &nbsp;&nbsp; ')}</div>
                        <div class="text-green-400 font-mono text-xs font-bold"> All cards added to your Trunk</div>
                    </div>`;
            }

            // Build and inject the full screen overlay
            const ov = document.createElement('div');
            ov.id = 'story-result-overlay';
            ov.className = 'fixed inset-0 z-[9998] flex flex-col items-center justify-center overflow-y-auto py-8';
            ov.style.background = bgGrad;
            ov.innerHTML = `
                <div class="text-center px-6 max-w-2xl w-full mx-auto">
                    <div class="mb-1">
                        <span class="font-mono text-xs tracking-widest opacity-50 uppercase" style="color:${headerColor};">${spot.title}</span>
                    </div>
                    <p class="font-mono text-sm text-gray-400 italic mb-8 max-w-md mx-auto leading-relaxed">"${picked.text}"</p>
                    <div class="mb-10">
                        ${rewardHTML}
                    </div>
                    <button onclick="closeStoryOverlay()"
                            class="font-[Bangers] text-2xl px-12 py-3 rounded-xl border-2 tracking-widest transition-all hover:brightness-125 active:scale-95"
                            style="background:linear-gradient(90deg,#040d1c,${headerColor}22);border-color:${headerColor};color:${headerColor};">
                        Continue 
                    </button>
                </div>`;
            document.body.appendChild(ov);
        }

        function closeStoryOverlay() {
            const ov = document.getElementById('story-result-overlay');
            if (ov) ov.remove();
        }

        function closeStoryPopup(sUid) {
            currentStorySpots = currentStorySpots.filter(s => s.uid !== sUid);
            const el = document.querySelector(`.story-marker[data-suid="${sUid}"]`);
            if (el) el.remove();
            hideStoryPopup();
        }

        function hideStoryPopup(e) {
            const popup = document.getElementById('story-popup');
            if (!popup) return;
            if (e) {
                const inner = popup.querySelector('.pointer-events-auto');
                if (inner && inner.contains(e.target)) return;
            }
            popup.classList.add('hidden');
            popup.style.pointerEvents = 'none';
        }

        // 
        //  FULL DUEL SYSTEM
        // 

        let duelState = null;
        let rpsState  = {};
        const PHASE_ORDER  = ['DRAW','STANDBY','MAIN1','BATTLE','MAIN2','END'];
        const PHASE_LABELS = { DRAW:'Draw Phase', STANDBY:'Standby Phase', MAIN1:'Main Phase 1', BATTLE:'Battle Phase', MAIN2:'Main Phase 2', END:'End Phase' };
        let duelZoom = 1.0; let duelPanX = 0; let duelPanY = 0;
        let duelDragging = false, duelDragLastX = 0, duelDragLastY = 0;

        //  RPS 
        function startDuelWithAI(uid) {
            if (gameState.mainDeck.length < 40) {
                showToast(`Deck too small! You need at least 40 cards to duel. (Current: ${gameState.mainDeck.length})`, 'error');
                return;
            }
            const d = currentDuelMap.find(x => x.uid === uid);
            rpsState = { playerWins:0, aiWins:0, round:1, done:false, opponentData:d };
            showRPSOverlay();
        }

        function showRPSOverlay() {
            const existing = document.getElementById('rps-overlay');
            if (existing) existing.remove();
            const o = rpsState;
            const ov = document.createElement('div');
            ov.id = 'rps-overlay';
            ov.className = 'fixed inset-0 z-[999] bg-black/92 flex flex-col items-center justify-center';
            ov.innerHTML = `
                <div class="bg-[#060d1c] border-2 border-cyan-500 rounded-2xl p-8 max-w-lg w-full mx-4 text-center shadow-[0_0_60px_rgba(0,229,255,0.2)]">
                    <h2 class="text-4xl font-[Bangers] text-cyan-300 tracking-wider mb-1">PRE-DUEL COIN TOSS</h2>
                    <p class="text-cyan-700 font-mono text-sm mb-4">vs. <span class="text-white font-bold">${o.opponentData.name}</span>  Best of 3</p>
                    <div class="flex justify-center gap-8 mb-4 text-3xl font-[Bangers] tracking-widest">
                        <div class="text-cyan-300">YOU: ${o.playerWins}</div>
                        <div class="text-gray-500"></div>
                        <div class="text-red-400">THEM: ${o.aiWins}</div>
                    </div>
                    <div id="rps-result" class="min-h-[50px] mb-3 font-[Bangers] text-2xl tracking-wider"></div>
                    <div class="text-gray-400 font-mono text-sm mb-4">Round ${Math.min(o.round,3)} / 3  Pick your hand:</div>
                    <div id="rps-btns" class="flex justify-center gap-6">
                        ${!o.done && o.round <= 3 ? `
                        <button onclick="rpsChoose('rock')"     class="rps-btn text-5xl hover:scale-125 transition-transform bg-gray-800 border-2 border-cyan-700 rounded-xl p-4 hover:border-cyan-400"></button>
                        <button onclick="rpsChoose('paper')"    class="rps-btn text-5xl hover:scale-125 transition-transform bg-gray-800 border-2 border-cyan-700 rounded-xl p-4 hover:border-cyan-400"></button>
                        <button onclick="rpsChoose('scissors')" class="rps-btn text-5xl hover:scale-125 transition-transform bg-gray-800 border-2 border-cyan-700 rounded-xl p-4 hover:border-cyan-400"></button>
                        ` : ''}
                    </div>
                </div>`;
            document.body.appendChild(ov);
        }

        function rpsChoose(playerPick) {
            const options = ['rock','paper','scissors'];
            const aiPick  = options[Math.floor(Math.random() * 3)];
            const EMOJI   = { rock:'', paper:'', scissors:'' };
            document.querySelectorAll('.rps-btn').forEach(b => b.disabled = true);
            let resultText, roundWinner = null;
            if (playerPick === aiPick) {
                resultText = `${EMOJI[playerPick]} vs ${EMOJI[aiPick]}  Draw!`;
            } else if ((playerPick==='rock'&&aiPick==='scissors')||(playerPick==='paper'&&aiPick==='rock')||(playerPick==='scissors'&&aiPick==='paper')) {
                resultText = `${EMOJI[playerPick]} vs ${EMOJI[aiPick]}  You WIN the round!`;
                rpsState.playerWins++; roundWinner = 'player';
            } else {
                resultText = `${EMOJI[playerPick]} vs ${EMOJI[aiPick]}  They WIN the round!`;
                rpsState.aiWins++; roundWinner = 'ai';
            }
            const col = roundWinner==='player' ? 'text-green-400' : roundWinner==='ai' ? 'text-red-400' : 'text-yellow-400';
            document.getElementById('rps-result').innerHTML = `<span class="${col}">${resultText}</span>`;
            const pW = rpsState.playerWins, aW = rpsState.aiWins;
            const done = pW >= 2 || aW >= 2 || rpsState.round >= 3;
            rpsState.round++;
            setTimeout(() => { if (done) { rpsState.done = true; showRPSOutcome(); } else showRPSOverlay(); }, 1300);
        }

        function showRPSOutcome() {
            const pW = rpsState.playerWins, aW = rpsState.aiWins;
            const playerWon = pW >= aW;
            document.getElementById('rps-overlay').innerHTML = `
                <div class="bg-[#060d1c] border-2 border-cyan-500 rounded-2xl p-8 max-w-lg w-full mx-4 text-center shadow-[0_0_60px_rgba(0,229,255,0.2)]">
                    <h2 class="text-4xl font-[Bangers] text-cyan-300 tracking-wider mb-4">RESULT: ${pW}  ${aW}</h2>
                    ${playerWon
                        ? `<p class="text-green-400 text-3xl font-[Bangers] mb-4">YOU WIN THE COIN TOSS!</p>
                           <p class="text-gray-300 font-mono text-sm mb-6">Choose who goes first:</p>
                           <div class="flex gap-4 justify-center">
                               <button onclick="beginDuel(true)"  class="font-[Bangers] text-xl px-6 py-2 bg-green-800 hover:bg-green-600 border-2 border-green-400 rounded-lg text-white tracking-widest"> I GO FIRST</button>
                               <button onclick="beginDuel(false)" class="font-[Bangers] text-xl px-6 py-2 bg-gray-700 hover:bg-gray-600 border-2 border-gray-400 rounded-lg text-white tracking-widest"> THEY GO FIRST</button>
                           </div>`
                        : `<p class="text-red-400 text-3xl font-[Bangers] mb-4">THEY WIN THE COIN TOSS!</p>
                           <p class="text-gray-400 font-mono text-sm mb-6">${rpsState.opponentData.name} chose to go first.</p>
                           <button onclick="beginDuel(false)" class="font-[Bangers] text-xl px-8 py-2 bg-cyan-800 hover:bg-cyan-700 border-2 border-cyan-400 rounded-lg text-white tracking-widest mt-4">BEGIN DUEL </button>`
                    }
                </div>`;
        }

        function beginDuel(playerFirst) {
            const ov = document.getElementById('rps-overlay');
            if (ov) ov.remove();
            initDuel(rpsState.opponentData, playerFirst);
        }

        //  INIT 
        function initDuel(opponentData, playerFirst) {
            SoundEngine.playDuelBGM();
            const aiDeck = buildAIDeck(opponentData);
            duelState = {
                phase: 'DRAW',
                turnPlayer: playerFirst ? 'PLAYER' : 'AI',
                turnCount: 1,
                firstTurnPlayer: playerFirst ? 'PLAYER' : 'AI',
                opponentData,
                player: {
                    lp: 5000, hand: [],
                    deck: [...gameState.mainDeck].sort(() => Math.random() - 0.5),
                    extraDeck: [...gameState.extraDeck],
                    graveyard: [], banished: [],
                    monsterZones:   [null,null,null,null,null],
                    spellTrapZones: [null,null,null,null,null],
                    normalSummonUsed: false,
                },
                ai: {
                    lp: 5000, hand: [],
                    deck: aiDeck.filter(id => { const c=getCardById(id); return c && c.type!=='FUSION'; }).sort(() => Math.random() - 0.5),
                    extraDeck: aiDeck.filter(id => { const c=getCardById(id); return c && c.type==='FUSION'; }),
                    graveyard: [], banished: [],
                    monsterZones:   [null,null,null,null,null],
                    spellTrapZones: [null,null,null,null,null],
                    normalSummonUsed: false,
                },
                selectedHandCard: null, selectedZone: null,
                alreadyAttacked: [], aiAlreadyAttacked: [],
                log: [],
            };
            duelZoom=1.0; duelPanX=0; duelPanY=0;
            renderDuelField();
            showShuffleAnimation(() => {
                for (let i=0;i<5;i++) duelDraw('player');
                for (let i=0;i<5;i++) duelDraw('ai');
                logDuel('Duel begins! Both players draw 5 cards.');
                renderDuelField();
                if (duelState.turnPlayer === 'PLAYER') {
                    duelState.phase = 'DRAW';
                    // handlePhaseStart runs draw logic (skips drawing on turn 1, animates on later turns)
                    setTimeout(() => handlePhaseStart('DRAW', 'PLAYER'), 200);
                } else setTimeout(doAITurn, 800);
            });
        }

        function buildAIDeck(opp) {
            const diff = opp.diff;
            let pool;
            if (diff >= 5) {
                // Boss duelists: pull from ALL UR and SR cards in the full card database
                const eliteIds = CARD_DB.filter(c => c.rarity === 'UR' || c.rarity === 'SR').map(c => c.id);
                const fallback = [...PACKS[3].list, ...PACKS[2].list];
                pool = [...eliteIds, ...eliteIds, ...eliteIds, ...fallback]; // triple weight so elite cards fill the deck
            } else {
                pool = diff<=2 ? [...PACKS[0].list,...PACKS[1].list] : diff<=3 ? [...PACKS[1].list,...PACKS[2].list] : [...PACKS[2].list,...PACKS[3].list];
            }
            const counts={}, deck=[], shuffled=[...pool].sort(()=>Math.random()-0.5);
            for (const id of shuffled) {
                if (deck.length>=40) break;
                counts[id]=counts[id]||0;
                if (counts[id]<3) { deck.push(id); counts[id]++; }
            }
            while (deck.length<20) {
                const id=shuffled[Math.floor(Math.random()*shuffled.length)];
                counts[id]=counts[id]||0;
                if (counts[id]<3) { deck.push(id); counts[id]++; }
            }
            return deck;
        }

        function showShuffleAnimation(callback) {
            const style = document.createElement('style');
            style.id='shuffle-style';
            style.textContent='@keyframes shuffleCard{from{transform:rotate(-8deg) translateY(-6px)}to{transform:rotate(8deg) translateY(6px)}}';
            document.head.appendChild(style);
            const ov = document.createElement('div');
            ov.id='shuffle-overlay';
            ov.className='fixed inset-0 z-[900] bg-black/75 flex flex-col items-center justify-center pointer-events-none';
            ov.innerHTML=`<div class="text-center">
                <div class="flex justify-center gap-1 mb-4">${Array.from({length:7},(_,i)=>`<div style="width:40px;height:58px;border-radius:5px;background:#1e1b4b;border:2px solid #00e5ff;box-shadow:0 0 10px rgba(0,229,255,0.4);animation:shuffleCard 0.38s ease-in-out ${i*0.055}s infinite alternate;transform:rotate(${(i-3)*4}deg)"></div>`).join('')}</div>
                <p style="font-family:'Bangers',cursive;font-size:2rem;letter-spacing:.15em;color:#00e5ff" class="animate-pulse">SHUFFLING DECKS</p>
            </div>`;
            document.body.appendChild(ov);
            setTimeout(() => { ov.remove(); const s=document.getElementById('shuffle-style'); if(s)s.remove(); callback(); }, 1900);
        }

        //  DRAW 
        function duelDraw(owner) {
            const side = duelState[owner];
            if (side.deck.length===0) { endDuel(owner==='player'?'ai':'player','deck-out'); return false; }
            side.hand.push(side.deck.shift());
            if (owner==='player') SoundEngine.cardDraw();
            return true;
        }

        //  PHASES 
        function advancePhasePlayer() {
            if (!duelState || duelState.turnPlayer!=='PLAYER') return;
            const idx = PHASE_ORDER.indexOf(duelState.phase);
            const next = PHASE_ORDER[idx+1];
            if (!next) { endPlayerTurn(); return; }
            duelState.phase = next;
            handlePhaseStart(next, 'PLAYER');
            renderDuelField();
        }

        function handlePhaseStart(phase, who) {
            const side = duelState[who.toLowerCase()];
            if (phase==='DRAW') {
                const skip = duelState.turnCount===1 && duelState.firstTurnPlayer===who;
                if (!skip && who==='PLAYER') {
                    // Show draw animation, then actually draw
                    showDrawAnimation(() => {
                        if (duelDraw('player')) { logDuel('You draw 1 card.'); renderDuelField(); }
                        setTimeout(advancePhasePlayer, 320);
                    });
                    return;
                }
                if (!skip) { if(duelDraw(who.toLowerCase())) logDuel(`Opponent draws 1 card.`); }
                if (who==='PLAYER') setTimeout(advancePhasePlayer, 400);
            } else if (phase==='STANDBY') {
                logDuel('Standby Phase.');
                // Shadow Leech (148): at opponent's Standby Phase, drain 300 LP
                if (who==='PLAYER' && duelState) {
                    const hasLeech=duelState.ai.monsterZones.some(s=>s&&s.id===148);
                    if(hasLeech){duelState.player.lp=Math.max(0,duelState.player.lp-300);logDuel(`Shadow Leech siphons 300 LP from you! (Your LP:${duelState.player.lp})`);if(duelState.player.lp<=0){endDuel('ai','lp');return;}}
                }
                if (who==='AI' && duelState) {
                    const hasLeech=duelState.player.monsterZones.some(s=>s&&s.id===148);
                    if(hasLeech){duelState.ai.lp=Math.max(0,duelState.ai.lp-300);logDuel(`Shadow Leech siphons 300 LP from the opponent! (Opp LP:${duelState.ai.lp})`);if(duelState.ai.lp<=0){endDuel('player','lp');return;}}
                }
                if (who==='PLAYER') setTimeout(advancePhasePlayer, 500);
            } else if (phase==='BATTLE') {
                duelState.alreadyAttacked=[];
                logDuel('Battle Phase! Select a monster to attack with.');
            } else if (phase==='END') {
                while (side.hand.length>8) {
                    const id=side.hand.pop(); side.graveyard.push(id);
                    logDuel(`${who==='PLAYER'?'You discard':'Opp discards'} ${getCardById(id)?.name||'card'} (hand limit 8).`);
                }
                                side.normalSummonUsed=false;
                // Destroy monsters flagged by Overclock Burst
                side.monsterZones.forEach((s,i)=>{
                    if(s&&s.destroyAtEndPhase){logDuel(`${getCardById(s.id).name} is destroyed by Overclock Burst's effect!`);side.graveyard.push(s.id);side.monsterZones[i]=null;}
                });
                side.monsterZones.forEach(s=>{ if(s){ s.summonedThisTurn=false; s.positionChangedThisTurn=false; s.effectUsedThisTurn=false; s.cannotAttack=false; s.atkBuff=0; s.defBuff=0; s.atkHalve=false; s.attacksUsed=0; s.destroyAtEndPhase=false; } });
                // Apex Fusion Dragon (196): inflict 500 damage to opponent each of controller's End Phases
                ['player','ai'].forEach(who=>{
                    duelState[who].monsterZones.forEach(s=>{
                        if(s&&s.id===196){
                            const enemy196=who==='player'?'ai':'player';
                            duelState[enemy196].lp=Math.max(0,duelState[enemy196].lp-500);
                            logDuel(`Apex Fusion Dragon: End Phase burn  ${enemy196==='ai'?'Opp':'You'} take 500 damage! (LP:${duelState[enemy196].lp})`);
                        }
                    });
                });
                // Celestial Phoenix (20): revive at End Phase if destroyed this turn
                if (side.pendingPhoenixRevival) {
                    side.pendingPhoenixRevival=false;
                    const _phIdx=side.graveyard.indexOf(20), _freeZ=side.monsterZones.findIndex(z=>z===null);
                    if(_phIdx!==-1&&_freeZ!==-1){side.monsterZones[_freeZ]={id:20,position:'ATK',summonedThisTurn:false,faceDown:false};side.graveyard.splice(_phIdx,1);logDuel(`Celestial Phoenix rises from the ashes and returns to ${who==='PLAYER'?'your':"opponent's"} field!`);}
                }
            }
        }

        function endPlayerTurn() {
            handlePhaseStart('END','PLAYER');
            duelState.phase='DRAW'; duelState.turnPlayer='AI'; duelState.turnCount++;
            duelState.alreadyAttacked=[]; duelState.aiAlreadyAttacked=[];
            duelState.selectedHandCard=null; duelState.selectedZone=null;
            logDuel("Your turn ends. Opponent's turn begins.");
            renderDuelField();
            if (mpState.inPvP && socket) {
                _pvpEmitStateSync(); // sync full board state before handing turn over
                setTimeout(() => socket.emit('pvpAction', { type: 'endTurn' }), 80);
                return;
            }
            setTimeout(doAITurn, 900);
        }

        //  AI TURN 
        function doAITurn() {
            if (!duelState || duelState.turnPlayer!=='AI') return;
            duelState.phase='DRAW';
            const skipDraw = duelState.turnCount===1 && duelState.firstTurnPlayer==='AI';
            if (!skipDraw) { if (!duelDraw('ai')) return; logDuel('Opponent draws a card.'); }
            renderDuelField();
            const diff = duelState.opponentData?.diff || 1;
            // Smarter duelists think longer between phases
            const thinkTime = 700 + diff * 120; // range: 820ms (diff1)  1540ms (diff5+)
            setTimeout(()=>{
                duelState.phase='STANDBY';
                logDuel('Standby Phase  Opponent is considering their next move...');
                renderDuelField();
                setTimeout(()=>{
                    duelState.phase='MAIN1'; logDuel('Main Phase 1.'); renderDuelField();
                    aiMainPhase(()=>{
                        if (!duelState) return;
                        const canAtk = !(duelState.turnCount===1 && duelState.firstTurnPlayer==='AI');
                        if (canAtk) {
                            duelState.phase='BATTLE'; logDuel('Battle Phase  Opponent surveys the field.');
                            renderDuelField();
                            setTimeout(()=>{ aiBattlePhase(()=>{ if(!duelState)return; duelState.phase='MAIN2'; renderDuelField(); setTimeout(aiEndTurn, 800 + diff*80); }); }, 700 + diff*100);
                        } else { logDuel('Opponent cannot attack on first turn.'); setTimeout(aiEndTurn, 800); }
                    });
                }, thinkTime + 300);
            }, thinkTime);
        }

        async function aiMainPhase(callback) {
            if (!duelState) { callback(); return; }
            const ai=duelState.ai, pl=duelState.player;
            const diff = duelState.opponentData?.diff || 1;
            const baseDelay = 850 + diff * 110; // smarter = slower/more deliberate

            const playerTotalATK = pl.monsterZones.filter(Boolean).reduce((m,s)=>Math.max(m,getEffectiveATK(s)),0);
            const aiTotalATK     = ai.monsterZones.filter(Boolean).reduce((m,s)=>Math.max(m,getEffectiveATK(s)),0);
            const aiMonCount     = ai.monsterZones.filter(Boolean).length;
            const plMonCount     = pl.monsterZones.filter(Boolean).length;

            //  AI Normal Summon 
            if (!ai.normalSummonUsed) {
                const opts = ai.hand.map((id,i)=>({id,i,card:getCardById(id)}))
                    .filter(x=>x.card && x.card.type!=='SPELL' && x.card.type!=='TRAP' && x.card.type!=='FUSION' && (x.card.level||1)<=4);

                // Difficulty affects card selection: lower diff picks more randomly
                opts.sort((a,b)=>{
                    const rndFactor = diff <= 2 ? (Math.random()-0.5)*600 : diff===3 ? (Math.random()-0.5)*200 : 0;
                    return (b.card.atk||0) - (a.card.atk||0) + rndFactor;
                });

                const emptyMon = ai.monsterZones.findIndex(z=>z===null);
                if (opts.length && emptyMon !== -1) {
                    await new Promise(r=>setTimeout(r, baseDelay));
                    if (!duelState){callback();return;}
                    const best = opts[0];
                    const zi = ai.monsterZones.findIndex(z=>z===null);
                    if (zi !== -1 && !ai.normalSummonUsed) {
                        // Decide ATK vs DEF: weaker/outnumbered AI prefers DEF, unless high diff choses to blitz
                        const monsterATK = best.card.atk || 0;
                        let pos;
                        if (diff >= 4) {
                            // Smart: ATK if can beat something, DEF if would lose all battles
                            pos = monsterATK >= playerTotalATK || aiMonCount < plMonCount ? 'DEF' : 'ATK';
                            if (playerTotalATK === 0) pos = 'ATK'; // no threats  ATK
                        } else if (diff === 3) {
                            pos = monsterATK >= playerTotalATK ? 'ATK' : (Math.random() < 0.4 ? 'DEF' : 'ATK');
                        } else {
                            // Low diff: mostly ATK, sometimes recklessly
                            pos = Math.random() < 0.2 ? 'DEF' : 'ATK';
                        }
                        ai.monsterZones[zi] = {id:best.id, position:pos, summonedThisTurn:true, faceDown:pos==='DEF'};
                        ai.hand.splice(ai.hand.indexOf(best.id), 1);
                        ai.normalSummonUsed = true;
                        logDuel(`Opponent summons ${best.card.name} in ${pos} position!`);
                        triggerOnSummonEffect(best.id,'ai',zi);
                        renderDuelField();
                        const ctx_s = {summonedId:best.id, zoneIdx:zi};
                        const cp_s = await askPlayerChain('SUMMON', ctx_s);
                        if (!duelState){callback();return;}
                        await new Promise(r=>resolveChainPick(cp_s,'SUMMON',ctx_s,r));
                        if (!duelState){callback();return;}
                        renderDuelField();
                    }
                }
            }

            //  AI Spell/Trap placement 
            // Spells first (immediate effect), then set traps face-down
            const handSTs = ai.hand.map((id,i)=>({id,i,card:getCardById(id)}))
                .filter(x=>x.card && (x.card.type==='SPELL' || x.card.type==='TRAP'));

            // Play spells immediately, set traps face-down; smarter AI plays the best spell first
            for (const stCard of handSTs) {
                if (!duelState) { callback(); return; }
                if (!ai.spellTrapZones.some(z=>z===null)) break;
                await new Promise(r=>setTimeout(r, baseDelay - 150));
                if (!duelState){callback();return;}
                const zi = ai.spellTrapZones.findIndex(z=>z===null);
                if (zi === -1) break;
                const isTrap = stCard.card.type === 'TRAP';
                ai.spellTrapZones[zi] = {id:stCard.id, faceDown:isTrap, activatedThisTurn:!isTrap};
                ai.hand.splice(ai.hand.indexOf(stCard.id), 1);
                if (isTrap) {
                    logDuel('Opponent sets a card face-down.');
                    renderDuelField();
                } else {
                    logDuel(`Opponent activates ${stCard.card.name}!`);
                    renderDuelField();
                    const ctx_sp = {spellCardId:stCard.id, zoneIdx:zi};
                    const cp_sp = await askPlayerChain('SPELL', ctx_sp);
                    if (!duelState){callback();return;}
                    await new Promise(r=>resolveChainPick(cp_sp,'SPELL',ctx_sp,r));
                    if (!duelState){callback();return;}
                    if (!ctx_sp.spellNegated) {
                        applySpellEffect(stCard.id,'ai');
                        const _czi=zi, _cid=stCard.id;
                        setTimeout(()=>{if(!duelState)return;ai.graveyard.push(_cid);ai.spellTrapZones[_czi]=null;renderDuelField();},700);
                    } else {
                        logDuel(`${stCard.card.name} was negated!`);
                        ai.graveyard.push(stCard.id); ai.spellTrapZones[zi]=null;
                        renderDuelField();
                    }
                }
                // Only play one spell/trap per main phase for lower diff; higher diff plays more
                if (diff <= 2) break;
            }

            await new Promise(r=>setTimeout(r, 600));
            if (duelState) callback();
        }

        async function aiBattlePhase(callback) {
            if (!duelState) { callback(); return; }
            const ai=duelState.ai, pl=duelState.player;
            const diff = duelState.opponentData?.diff || 1;
            const attackDelay = 1100 + diff * 130; // higher diff = more deliberate between attacks

            const attackerQueue = ai.monsterZones
                .map((s,i)=>(s && s.position==='ATK' && !s.summonedThisTurn && !s.cannotAttack && !duelState.aiAlreadyAttacked.includes(i)) ? i : -1)
                .filter(i=>i!==-1);

            if (!attackerQueue.length) { callback(); return; }

            for (let qi=0; qi<attackerQueue.length; qi++) {
                const attackerIdx = attackerQueue[qi];
                await new Promise(r=>setTimeout(r, attackDelay));
                if (!duelState) { callback(); return; }
                const attSlot = ai.monsterZones[attackerIdx];
                if (!attSlot || attSlot.cannotAttack || duelState.aiAlreadyAttacked.includes(attackerIdx)) continue;
                const attCard   = getCardById(attSlot.id);
                const attATK    = getEffectiveATK(attSlot);
                const isVoidPhantom = (attSlot.id === 19);
                const plMons = pl.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);

                if (!plMons.length) {
                    //  Direct attack 
                    const ctx={attackerOwner:'ai',attackerIdx,isDirectAttack:true};
                    logDuel(`${attCard.name} declares a direct attack!`);
                    renderDuelField();
                    const pick=await askPlayerChain('ATTACK',ctx);
                    if (!duelState){callback();return;}
                    await new Promise(r=>resolveChainPick(pick,'ATTACK',ctx,r));
                    if (!duelState){callback();return;}
                    if (!ctx.attackNegated) {
                        const halveDirect_ai=[170,176,179].includes(attSlot.id);
                        const finalDmg_ai=halveDirect_ai?Math.floor(attATK/2):attATK;
                        pl.lp = Math.max(0, pl.lp - finalDmg_ai);
                        duelState.aiAlreadyAttacked.push(attackerIdx);
                        logDuel(`${attCard.name} strikes directly! You take ${finalDmg_ai} DMG${halveDirect_ai?' (halved)':''}! (Your LP: ${pl.lp})`);
                        // Static Phantom (176): opp discards 1 random from player hand
                        if (attSlot.id===176 && duelState.player.hand.length) {
                            const ri=Math.floor(Math.random()*duelState.player.hand.length);
                            const did=duelState.player.hand.splice(ri,1)[0];
                            duelState.player.graveyard.push(did);
                            logDuel(`Static Phantom: You discard ${getCardById(did)?.name||'a card'} from hand!`);
                        }
                        renderDuelField();
                        if (pl.lp <= 0){ endDuel('ai','lp'); return; }
                    }
                } else {
                    //  Monster attack  intelligent target selection 
                    // Separate face-up and face-down defenders:
                    const faceUpMons   = plMons.filter(i=>!pl.monsterZones[i].faceDown);
                    const faceDownMons = plMons.filter(i=>pl.monsterZones[i].faceDown);

                    // Targets the AI can calculate win against (face-up only  AI doesn't know face-down DEF):
                    const atkBeat = faceUpMons.filter(i=>pl.monsterZones[i].position==='ATK' && attATK > getEffectiveATK(pl.monsterZones[i]));
                    const defBeat = faceUpMons.filter(i=>pl.monsterZones[i].position==='DEF' && attATK > getEffectiveDEF(pl.monsterZones[i]));
                    // Face-up monsters with higher ATK (must avoid or accept risk by diff):
                    const atkLose = faceUpMons.filter(i=>pl.monsterZones[i].position==='ATK' && attATK <= getEffectiveATK(pl.monsterZones[i]));

                    let target = null;

                    // 1. Preferred: destroy a face-up ATK monster we can beat (highest ATK first = most threatening gone)
                    if (atkBeat.length) {
                        // Higher diff picks the strongest target it can beat (highest threat removal)
                        // Lower diff picks randomly from beatable targets
                        if (diff >= 4) {
                            target = atkBeat.sort((a,b)=>getEffectiveATK(pl.monsterZones[b])-getEffectiveATK(pl.monsterZones[a]))[0];
                        } else {
                            target = atkBeat[Math.floor(Math.random()*atkBeat.length)];
                        }
                    }
                    // 2. Next: destroy a face-up DEF monster we can beat
                    else if (defBeat.length) {
                        target = defBeat[0];
                    }
                    // 3. Consider attacking a face-down card (AI can't see DEF  risk assessment by diff):
                    else if (faceDownMons.length) {
                        //  diff 1-2: reckless  55% chance attack blind
                        //  diff 3:   cautious  25% chance if our ATK is large
                        //  diff 4-5: smart     only if very high ATK (2000) and 15% gamble
                        const blindChance = diff <= 2 ? 0.55 : diff === 3 ? 0.25 : 0.15;
                        const atkThreshold = diff >= 4 ? 2000 : 0;
                        if (attATK >= atkThreshold && Math.random() < blindChance) {
                            target = faceDownMons[Math.floor(Math.random()*faceDownMons.length)];
                            logDuel(`${attCard.name} attacks into a face-down card${diff <= 2 ? ' recklessly' : ''}!`);
                        }
                    }
                    // 4. Last resort: attack a stronger face-up ATK monster (mistake rate by diff):
                    //    diff 1: 40% chance (reckless)  diff 2: 25%  diff 3: 10%  diff 4+: 0% (won't suicide)
                    if (target === null && atkLose.length) {
                        const suicideChance = diff === 1 ? 0.40 : diff === 2 ? 0.25 : diff === 3 ? 0.10 : 0;
                        if (Math.random() < suicideChance) {
                            // Lower diff attacks the strongest by "accident" (no strategy)
                            target = atkLose.sort((a,b)=>getEffectiveATK(pl.monsterZones[b])-getEffectiveATK(pl.monsterZones[a]))[0];
                            logDuel(`${attCard.name} attacks recklessly into a stronger monster!`);
                        }
                    }

                    if (target === null) {
                        logDuel(`${attCard.name} holds back  no favorable attack available.`);
                        continue;
                    }

                    const targetSlot = pl.monsterZones[target];
                    const targetName = targetSlot.faceDown ? 'a face-down card' : getCardById(targetSlot.id)?.name || 'unknown';
                    const ctx={attackerOwner:'ai',attackerIdx,defenderOwner:'player',defenderIdx:target};
                    logDuel(`${attCard.name} attacks ${targetName}!`);
                    renderDuelField();
                    const pick=await askPlayerChain('ATTACK',ctx);
                    if (!duelState){callback();return;}
                    await new Promise(r=>resolveChainPick(pick,'ATTACK',ctx,r));
                    if (!duelState){callback();return;}
                    if (!ctx.attackNegated) {
                        if (!isVoidPhantom) duelState.aiAlreadyAttacked.push(attackerIdx);
                        resolveAttack('ai',attackerIdx,'player',target);
                    }
                    renderDuelField();
                    if (duelState&&(duelState.player.lp<=0||duelState.ai.lp<=0)){endDuel(duelState.player.lp<=0?'ai':'player','lp');return;}
                    // Void Phantom re-queue
                    if (duelState&&isVoidPhantom&&ai.monsterZones[attackerIdx]===attSlot) {
                        const rem=pl.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                        if (rem.length) attackerQueue.push(attackerIdx);
                        else duelState.aiAlreadyAttacked.push(attackerIdx);
                    }
                }
            }
            if (duelState) callback();
        }

        function aiEndTurn() {
            if (!duelState) return;
            handlePhaseStart('END','AI');
            duelState.phase='DRAW'; duelState.turnPlayer='PLAYER'; duelState.turnCount++;
            duelState.alreadyAttacked=[]; duelState.aiAlreadyAttacked=[];
            duelState.ai.normalSummonUsed=false;
            duelState.ai.monsterZones.forEach(s=>{ if(s){ s.summonedThisTurn=false; s.positionChangedThisTurn=false; s.effectUsedThisTurn=false; s.cannotAttack=false; s.atkBuff=0; s.defBuff=0; s.atkHalve=false; } });
            logDuel("Opponent's turn ends. Your turn begins!");
            renderDuelField();
            // Trigger the player's Draw Phase (draw animation  draw 1 card  auto-advance to Standby)
            setTimeout(() => { if (duelState && duelState.turnPlayer==='PLAYER') handlePhaseStart('DRAW','PLAYER'); }, 700);
        }

        //  COMBAT HELPERS 
        function getEffectiveATK(slot) {
            if (!slot) return 0;
            const card=getCardById(slot.id);
            let atk=card.atk||0;
            if (slot.atkBuff) atk+=slot.atkBuff;
            if (slot.atkHalve) atk=Math.floor(atk/2);
            // Binary Sorcerer (14): +200 per Spell in GY
            if (slot.id===14 && duelState) {
                const own=duelState.player.monsterZones.includes(slot)?'player':'ai';
                atk+=duelState[own].graveyard.filter(id=>{const c=getCardById(id);return c&&c.type==='SPELL';}).length*200;
            }
            // Omega Eternal Titan (163): +400 ATK per monster currently on field
            if (slot.id===163 && duelState) {
                const total=duelState.player.monsterZones.filter(Boolean).length+duelState.ai.monsterZones.filter(Boolean).length;
                atk+=total*400;
            }
            return Math.max(0,atk);
        }
        function getEffectiveDEF(slot) {
            if (!slot) return 0;
            const card=getCardById(slot.id);
            let def=card.def||0;
            if (slot.defBuff) def+=slot.defBuff;
            return Math.max(0,def);
        }

        //  COMBAT 
        function resolveAttack(attackerOwner, attackerIdx, defenderOwner, defenderIdx) {
            if (!duelState) return;
            SoundEngine.attack();
            const attSide=duelState[attackerOwner], defSide=duelState[defenderOwner];
            const attSlot=attSide.monsterZones[attackerIdx], defSlot=defSide.monsterZones[defenderIdx];
            if (!attSlot||!defSlot) return;
            const attCard=getCardById(attSlot.id), defCard=getCardById(defSlot.id);
            // Flip face-down defenders first
            if (defSlot.faceDown) {
                defSlot.faceDown=false;
                logDuel(`${defCard.name} is flipped face-up!`);
                // Firewall Guard (11) flip effect
                if (defSlot.id===11 && defenderOwner==='player') {
                    const si=duelState.player.deck.findIndex(id=>{const c=getCardById(id);return c&&c.type==='SPELL';});
                    if (si!==-1){duelState.player.hand.push(duelState.player.deck.splice(si,1)[0]);logDuel('Firewall Guard Flip: Add 1 Spell to hand!');}
                }
            }
            const attATK=getEffectiveATK(attSlot);
            let destroyedId=null;
            if (defSlot.position==='ATK') {
                const defATK=getEffectiveATK(defSlot);
                if (attATK>defATK) {
                    if (defSlot.id===31||defSlot.id===159) { // Ultimate Firewall / Omega Prime Colossus: cannot be destroyed by battle
                        defSide.lp=Math.max(0,defSide.lp-(attATK-defATK));
                        logDuel(`${attCard.name}(${attATK}) cannot destroy ${defCard.name}! ${defenderOwner==='player'?'You':'Opp'} still take ${attATK-defATK} DMG!`);
                    } else {
                        destroyedId=defSlot.id; defSide.graveyard.push(defSlot.id); defSide.monsterZones[defenderIdx]=null;
                        const _dmgD=attATK-defATK, _spD=defenderOwner==='player'?(duelState.player.damageSponge||0):0;
                        if(defenderOwner==='player')duelState.player.damageSponge=0;
                        const _finalD=Math.max(0,_dmgD-_spD);
                        defSide.lp=Math.max(0,defSide.lp-_finalD);
                        logDuel(`${attCard.name}(${attATK}) destroys ${defCard.name}(${defATK})! ${defenderOwner==='player'?'You':'Opp'} take ${_finalD} DMG!${_spD>0?' ('+_spD+' absorbed by Nano Shield!)':''}`);
                    }
                } else if (attATK<defATK) {
                    if (attSlot.id===31||attSlot.id===159) { // Ultimate Firewall / Omega Prime Colossus: cannot be destroyed by battle
                        attSide.lp=Math.max(0,attSide.lp-(defATK-attATK));
                        logDuel(`${attCard.name} survives! ${attackerOwner==='player'?'You':'Opp'} take ${defATK-attATK} DMG!`);
                    } else {
                        attSide.graveyard.push(attSlot.id); attSide.monsterZones[attackerIdx]=null;
                        const _dmgA=defATK-attATK, _spA=attackerOwner==='player'?(duelState.player.damageSponge||0):0;
                        if(attackerOwner==='player')duelState.player.damageSponge=0;
                        const _finalA=Math.max(0,_dmgA-_spA);
                        attSide.lp=Math.max(0,attSide.lp-_finalA);
                        logDuel(`${defCard.name}(${defATK}) is stronger! ${attackerOwner==='player'?'You':'Opp'} take ${_finalA} DMG!${_spA>0?' ('+_spA+' absorbed by Nano Shield!)':''}`);
                    }
                } else {
                    if(defSlot.id!==31){destroyedId=defSlot.id;defSide.graveyard.push(defSlot.id);defSide.monsterZones[defenderIdx]=null;}
                    if(attSlot.id!==31){attSide.graveyard.push(attSlot.id);attSide.monsterZones[attackerIdx]=null;}
                    logDuel(`${attCard.name} & ${defCard.name} clash! (Tie)`);
                }
            } else {
                const defDEF=getEffectiveDEF(defSlot);
                if (attATK>defDEF) {
                    if (defSlot.id===31) { // Ultimate Firewall: cannot be destroyed by battle
                        logDuel(`${attCard.name}(${attATK}) cannot destroy Ultimate Firewall in battle!`);
                    } else {
                        destroyedId=defSlot.id; defSide.graveyard.push(defSlot.id); defSide.monsterZones[defenderIdx]=null;
                        const pierceDmg=attATK-defDEF;
                        if ((attSlot.id===30||attSlot.id===33)&&pierceDmg>0) {
                            defSide.lp=Math.max(0,defSide.lp-pierceDmg);
                            logDuel(`${attCard.name}(${attATK}) PIERCES ${defCard.name} DEF(${defDEF})! ${defenderOwner==='player'?'You':'Opp'} take ${pierceDmg} DMG!`);
                        } else {
                            logDuel(`${attCard.name}(${attATK}) breaks through ${defCard.name} in DEF!`);
                        }
                    }
                } else {
                    const dmg=defDEF-attATK;
                    if (dmg>0){
                        const _spR=attackerOwner==='player'?(duelState.player.damageSponge||0):0;
                        if(attackerOwner==='player')duelState.player.damageSponge=0;
                        const _finalR=Math.max(0,dmg-_spR);
                        attSide.lp=Math.max(0,attSide.lp-_finalR);
                        logDuel(`${defCard.name} DEF(${defDEF}) repels! ${attackerOwner==='player'?'You':'Opp'} take ${_finalR} DMG!${_spR>0?' ('+_spR+' absorbed by Nano Shield!)':''}`);}
                    else logDuel(`${attCard.name} attacks ${defCard.name} in DEF  no damage.`);
                }
            }
            // Virus Carrier (13): on-destroy, take attacker with it
            if (destroyedId===13) {
                const remAtt=attSide.monsterZones[attackerIdx];
                if(remAtt){logDuel(`Virus Carrier: Drags ${getCardById(remAtt.id).name} down with it!`);attSide.graveyard.push(remAtt.id);attSide.monsterZones[attackerIdx]=null;}
            }
            // Chaos Dragon (32): Banish 1 card from defender's area on attack
            const _atkNow=attSide.monsterZones[attackerIdx];
            if (_atkNow&&_atkNow.id===32) {
                const tgt=defSide.deck.length>0?defSide.deck:defSide.hand;
                if(tgt.length){const bid=tgt.shift();defSide.banished.push(bid);logDuel(`Chaos Dragon: Banishes ${getCardById(bid)?.name||'a card'} from ${defenderOwner==='player'?'your':"opponent's"} area!`);}
            }
            // Celestial Phoenix (20): flag for End Phase revival
            if (destroyedId===20) duelState[defenderOwner].pendingPhoenixRevival=true;
            // Static Fox (88): when destroyed, deal 300 damage to attacker's owner
            if (destroyedId===88) {
                duelState[attackerOwner].lp=Math.max(0,duelState[attackerOwner].lp-300);
                logDuel(`Static Fox's effect: ${attackerOwner==='player'?'You':'Opp'} take 300 damage! (LP:${duelState[attackerOwner].lp})`);
            }
            // Glitch Gremlin (86): FLIP  opponent discards 1 random card
            if (destroyedId===86 && defenderOwner!==attackerOwner) {
                const hand=duelState[attackerOwner].hand;
                if(hand.length){const ri=Math.floor(Math.random()*hand.length);const did=hand.splice(ri,1)[0];duelState[attackerOwner].graveyard.push(did);logDuel(`Glitch Gremlin FLIP: ${attackerOwner==='player'?'You':'Opp'} discard ${getCardById(did)?.name||'a card'}!`);}
            }
            // Glitch Specter (174): when destroyed by battle, inflict 500 to attacker's controller
            if (destroyedId===174) {
                duelState[attackerOwner].lp=Math.max(0,duelState[attackerOwner].lp-500);
                logDuel(`Glitch Specter: Glitch Feedback! ${attackerOwner==='player'?'You':'Opp'} take 500 damage! (LP:${duelState[attackerOwner].lp})`);
            }
            // Tri-Burst Dragon (107): burn 500 on kill
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===107&&destroyedId!==null) {
                defSide.lp=Math.max(0,defSide.lp-500);
                logDuel(`Tri-Burst Dragon: Inflicts 500 burn damage! (${defenderOwner==='player'?'Your':'Opp'} LP:${defSide.lp})`);
            }
            // Phantom Dominion (147): destroys a monster  draw 1 card
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===147&&destroyedId!==null) {
                if(duelDraw(attackerOwner)) logDuel(`Phantom Dominion: Draw 1 card from the kill!`);
            }
            // Nemesis Eclipse Dragon (145): destroys a monster  also destroy 1 more enemy monster + 300 dmg
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===145&&destroyedId!==null) {
                const rem145=defSide.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(rem145.length){const ti=rem145[0];logDuel(`Nemesis Eclipse Dragon: Obliterates ${getCardById(defSide.monsterZones[ti].id).name} as well!`);defSide.graveyard.push(defSide.monsterZones[ti].id);defSide.monsterZones[ti]=null;defSide.lp=Math.max(0,defSide.lp-300);}
            }
            // Sovereign Light Blade (164): destroys a monster  inflicts 500 LP
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===164&&destroyedId!==null) {
                defSide.lp=Math.max(0,defSide.lp-500);
                logDuel(`Sovereign Light Blade: 500 LP pierced! (${defenderOwner==='player'?'Your':'Opp'} LP:${defSide.lp})`);
            }
            // Pyroclast Wyvern (169): destroys a monster  inflicts 500 burn damage
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===169&&destroyedId!==null) {
                defSide.lp=Math.max(0,defSide.lp-500);
                logDuel(`Pyroclast Wyvern: Eruption deals 500 burn! (${defenderOwner==='player'?'Your':'Opp'} LP:${defSide.lp})`);
            }
            // Metal Shredder (171): destroys a monster  draw 1 card
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===171&&destroyedId!==null) {
                if(duelDraw(attackerOwner)) logDuel(`Metal Shredder: Scrap yields intel  draw 1 card!`);
            }
            // Rift Eater (186): destroys a monster  add 1 DARK monster from GY to hand
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===186&&destroyedId!==null) {
                const darkGY186=attSide.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION'&&c.attribute==='DARK';});
                if(darkGY186.length){const id186=darkGY186[darkGY186.length-1];attSide.graveyard=attSide.graveyard.filter(g=>g!==id186);attSide.hand.push(id186);logDuel(`Rift Eater: ${getCardById(id186).name} consumed from GY into ${attackerOwner==='player'?'your':"opponent's"} hand!`);}
                else logDuel('Rift Eater: No DARK monster in GY to retrieve.');
            }
            // Fury Lancer (198): destroys a monster  inflict 400 damage
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===198&&destroyedId!==null) {
                defSide.lp=Math.max(0,defSide.lp-400);
                logDuel(`Fury Lancer: Lance pierces for 400 extra damage! (${defenderOwner==='player'?'Your':'Opp'} LP:${defSide.lp})`);
            }
            // Fury Ascendant (201): destroys a monster  inflict 600 damage
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===201&&destroyedId!==null) {
                defSide.lp=Math.max(0,defSide.lp-600);
                logDuel(`Fury Ascendant: Inferno Burst! ${defenderOwner==='player'?'You':'Opp'} take 600 damage! (LP:${defSide.lp})`);
            }
            // Abyss Knight (216): destroys a monster  banish it instead of GY
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===216&&destroyedId!==null) {
                // Remove from GY and banish instead
                const gIdx=defSide.graveyard.lastIndexOf(destroyedId);
                if(gIdx!==-1){ defSide.graveyard.splice(gIdx,1); defSide.banished.push(destroyedId); logDuel(`Abyss Knight: ${getCardById(destroyedId)?.name||'Monster'} is banished from existence!`); }
            }
            // Abyssal Sovereign (219): destroys a monster  opponent discards 1
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===219&&destroyedId!==null) {
                if(defSide.hand.length){ const ri=Math.floor(Math.random()*defSide.hand.length); const did=defSide.hand.splice(ri,1)[0]; defSide.graveyard.push(did); logDuel(`Abyssal Sovereign: ${defenderOwner==='player'?'You':'Opp'} discard ${getCardById(did)?.name||'a card'}!`); }
            }
            // Grid Soldier (225): destroys a monster  gain 500 LP
            if (attSide.monsterZones[attackerIdx]&&attSide.monsterZones[attackerIdx].id===225&&destroyedId!==null) {
                attSide.lp=Math.min(8000,attSide.lp+500);
                logDuel(`Grid Soldier: Combat bonus! ${attackerOwner==='player'?'You':'Opp'} gain 500 LP! (LP:${attSide.lp})`);
            }
            // Void Sentinel (154): when destroyed by battle, add 1 DARK Spell/Trap from GY to hand
            if (destroyedId===154) {
                const owner154=defenderOwner;
                const darkST=duelState[owner154].graveyard.filter(id=>{const c=getCardById(id);return c&&(c.type==='SPELL'||c.type==='TRAP')&&c.attribute==='DARK';});
                if(darkST.length){const id=darkST[darkST.length-1];duelState[owner154].graveyard=duelState[owner154].graveyard.filter(g=>g!==id);duelState[owner154].hand.push(id);logDuel(`Void Sentinel: ${getCardById(id).name} retrieved from GY to ${owner154==='player'?'your':"opponent's"} hand!`);}
            }
            // Twin-Core Golem (33) / Sovereign Light Blade (164): can attack twice per turn
            const _curAtt=attSide.monsterZones[attackerIdx];
            if (_curAtt) {
                _curAtt.attacksUsed=(_curAtt.attacksUsed||0)+1;
                if (attackerOwner==='player'&&_curAtt.attacksUsed>=(_curAtt.id===33||_curAtt.id===164||_curAtt.id===191?2:1)) duelState.alreadyAttacked.push(attackerIdx);
            } else if (attackerOwner==='player') duelState.alreadyAttacked.push(attackerIdx);
            duelState.selectedZone=null;
            if (duelState.player.lp<=0||duelState.ai.lp<=0) endDuel(duelState.player.lp<=0?'ai':'player','lp');
        }

        //  PLAYER ACTIONS 
        function duelSelectHandCard(index) {
            if (duelState.turnPlayer!=='PLAYER') return;
            if (!['MAIN1','MAIN2','BATTLE'].includes(duelState.phase)) return;
            duelState.selectedHandCard=(duelState.selectedHandCard===index)?null:index;
            duelState.selectedZone=null;
            renderDuelField();
        }

        //  FUSION MATERIALS MAP 
        const FUSION_MATERIALS = {
            30:  [1,  12],      // Mecha-Lord Alpha:   Neon Knight + Speed Router
            31:  [11, 11],      // Ultimate Firewall:  Firewall Guard  2
            32:  [3,  4],       // Chaos Dragon:       Plasma Dragon + Glitch Wolf
            33:  [6,  6],       // Twin-Core Golem:    Server Golem  2
            34:  [10, 32],      // Arcane Titan:       Cyber Magician + Chaos Dragon
            107: [7,  8,  4],   // Tri-Burst Dragon:   Volt Bat + Flame Sprite + Glitch Wolf
            201: [199, 198],    // Fury Ascendant:     Fury Tyrant + Fury Lancer
            210: [209, 208],    // Tidal Sovereign:    Tide Emperor + Tide Marshal
            219: [218, 217],    // Abyssal Sovereign:  Abyss Tyrant + Abyss Sorcerer
            228: [227, 226],    // Grid Titan:         Grid Overlord + Grid Commander
            237: [236, 235],    // Aurora Divinity:    Aurora Guardian + Aurora Sage
        };

        //  GENERIC PLAYER CHOICE PICKER (returns Promise) 
        function pickDuelChoice(title, items, labelFn, cancelable=true) {
            return new Promise(resolve => {
                let ex=document.getElementById('duel-pick-dialog'); if(ex) ex.remove();
                const dlg=document.createElement('div');
                dlg.id='duel-pick-dialog';
                dlg.className='fixed inset-0 z-[900] flex items-center justify-center';
                dlg.style.cssText='background:rgba(0,0,0,0.88)';
                const btns=items.map((item,i)=>`<button onclick="window._duelPickCb(${i})" style="font-family:'Bangers',cursive;font-size:15px;letter-spacing:.06em;padding:10px 14px;background:#0f172a;border:2px solid #7c3aed;border-radius:8px;color:#c4b5fd;cursor:pointer;text-align:left;width:100%;transition:background .15s" onmouseenter="this.style.background='#1e1b4b'" onmouseleave="this.style.background='#0f172a'">${labelFn(item,i)}</button>`).join('');
                const cancelBtn=cancelable?`<button onclick="window._duelPickCb(-1)" style="font-family:'Bangers',cursive;font-size:15px;letter-spacing:.06em;padding:8px 14px;background:#1f2937;border:2px solid #374151;border-radius:8px;color:#6b7280;cursor:pointer;width:100%"> Cancel</button>`:'';
                dlg.innerHTML=`<div style="background:#060d1c;border:2px solid #7c3aed;border-radius:14px;padding:22px;text-align:center;min-width:280px;max-width:440px;max-height:75vh;overflow-y:auto;box-shadow:0 0 40px rgba(124,58,237,0.5)"><p style="font-family:'Bangers',cursive;font-size:20px;color:#c4b5fd;margin-bottom:14px;letter-spacing:.06em">${title}</p><div style="display:flex;flex-direction:column;gap:8px">${btns}${cancelBtn}</div></div>`;
                window._duelPickCb=idx=>{ dlg.remove(); delete window._duelPickCb; resolve(idx===-1?null:items[idx]); };
                document.body.appendChild(dlg);
            });
        }

        //  FUSION SUMMON FLOW (used by Polymerization + Fusion Catalyst) 
        function canDoFusionSummon(owner, useDeck=false) {
            const side = duelState[owner];
            if (!side.extraDeck.length) return false;
            const handPool = side.hand.map(id => id);
            const fieldPool = side.monsterZones.filter(Boolean).map(s => s.id);
            const deckPool = useDeck ? side.deck.filter(id => { const c=getCardById(id); return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION'; }) : [];
            return side.extraDeck.some(fid => {
                const mats = FUSION_MATERIALS[fid]; if (!mats) return false;
                const pool = [...handPool, ...fieldPool, ...deckPool];
                const needed = [...mats];
                for (const m of needed) { const i = pool.indexOf(m); if (i === -1) return false; pool.splice(i, 1); }
                return true;
            });
        }
        async function doFusionSummon(owner, spellName, useDeck=false) {
            const side=duelState[owner];
            if(!side.extraDeck.length){ showToast(`${spellName}: No Fusion monsters in Extra Deck!`,'error'); return; }
            const handPool=side.hand.map(id=>({src:'hand',id}));
            const fieldPool=side.monsterZones.map((s,i)=>s?{src:'field',idx:i,id:s.id}:null).filter(Boolean);
            const deckPool=useDeck?side.deck.map(id=>({src:'deck',id})).filter(x=>{ const c=getCardById(x.id); return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION'; }):[];
            // Find valid fusions
            const validFusions=side.extraDeck.filter(fid=>{
                const mats=FUSION_MATERIALS[fid]; if(!mats) return false;
                const pool=[...handPool,...fieldPool,...deckPool].map(x=>x.id);
                const needed=[...mats];
                for(const m of needed){ const i=pool.indexOf(m); if(i===-1) return false; pool.splice(i,1); }
                return true;
            });
            if(!validFusions.length){ showToast(`${spellName}: Can't Fusion Summon  missing required materials!`,'error'); return; }
            // Pick fusion monster
            let chosenFusion;
            if(validFusions.length===1){ chosenFusion=validFusions[0]; }
            else {
                const pick=await pickDuelChoice('Choose Fusion Monster to Summon', validFusions, id=>{
                    const c=getCardById(id); return `${c.name}  ATK:${c.atk} / DEF:${c.def}`;
                });
                if(pick===null){ logDuel(`${spellName}: Fusion cancelled.`); return; }
                chosenFusion=pick;
            }
            const fusionCard=getCardById(chosenFusion);
            const mats=FUSION_MATERIALS[chosenFusion];
            // Pick each material
            const allPool=[
                ...handPool.map(x=>({...x,label:` Hand: ${getCardById(x.id).name}`})),
                ...fieldPool.map(x=>({...x,label:` Field: ${getCardById(x.id).name}`})),
                ...deckPool.map(x=>({...x,label:` Deck: ${getCardById(x.id).name}`})),
            ];
            const used=[];
            const chosenMats=[];
            for(let i=0;i<mats.length;i++){
                const needed=mats[i];
                const options=allPool.filter((x,xi)=>x.id===needed&&!used.includes(xi));
                if(!options.length){ showToast(`${spellName}: Can't find ${getCardById(needed).name}!`,'error'); return; }
                let chosen;
                if(options.length===1){ chosen=options[0]; }
                else {
                    chosen=await pickDuelChoice(`Material ${i+1}/${mats.length}: ${getCardById(needed).name}`, options, x=>x.label);
                    if(chosen===null){ logDuel(`${spellName}: Fusion cancelled.`); return; }
                }
                used.push(allPool.indexOf(chosen));
                chosenMats.push(chosen);
            }
            // Remove materials and send to GY
            for(const mat of chosenMats){
                if(mat.src==='hand'){ const hi=side.hand.indexOf(mat.id); if(hi!==-1) side.hand.splice(hi,1); }
                else if(mat.src==='field'){ side.monsterZones[mat.idx]=null; }
                else if(mat.src==='deck'){ const di=side.deck.indexOf(mat.id); if(di!==-1) side.deck.splice(di,1); }
                side.graveyard.push(mat.id);
            }
            // Place fusion
            const ezi=side.monsterZones.findIndex(z=>z===null);
            if(ezi===-1){ showToast('No monster zone available!','error'); return; }
            side.monsterZones[ezi]={id:chosenFusion,position:'ATK',summonedThisTurn:true,faceDown:false};
            side.extraDeck=side.extraDeck.filter(id=>id!==chosenFusion);
            logDuel(`${spellName}: Fusion Summon ${fusionCard.name}!`);
            renderDuelField();
        }

        async function duelPlaceMonster(zoneIndex) {
            if (duelState.turnPlayer!=='PLAYER'||!['MAIN1','MAIN2'].includes(duelState.phase)) { showToast('Can only summon in Main Phase!','error'); return; }
            if (duelState.selectedHandCard===null) return;
            const handCardId=duelState.player.hand[duelState.selectedHandCard];
            const card=getCardById(handCardId);
            if (!card||card.type==='SPELL'||card.type==='TRAP') { showToast('Select a Monster card!','error'); return; }
            if (card.type==='FUSION') { showToast('Fusion needs Polymerization!','error'); return; }
            if (duelState.player.monsterZones[zoneIndex]!==null) { showToast('Zone is occupied!','error'); return; }
            if (duelState.player.normalSummonUsed) { showToast('Already used Normal Summon!','error'); return; }
            const lvl=card.level||1, occupied=duelState.player.monsterZones.filter(Boolean).length;
            if (lvl>=7&&occupied<2) { showToast('Need 2 tributes!','error'); return; }
            if (lvl>=5&&lvl<7&&occupied<1) { showToast('Need 1 tribute!','error'); return; }
            if (lvl>=7) {
                const tribOpts=duelState.player.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(tribOpts.length<2){showToast('Need 2 monsters to tribute!','error');return;}
                const t1=await pickDuelChoice('Tribute 1st monster',tribOpts,i=>{const c=getCardById(duelState.player.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.player.monsterZones[i])}/DEF:${getEffectiveDEF(duelState.player.monsterZones[i])}`;},false);
                if(t1===null){duelState.selectedHandCard=null;renderDuelField();return;}
                const tribOpts2=tribOpts.filter(i=>i!==t1);
                const t2=await pickDuelChoice('Tribute 2nd monster',tribOpts2,i=>{const c=getCardById(duelState.player.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.player.monsterZones[i])}/DEF:${getEffectiveDEF(duelState.player.monsterZones[i])}`;},false);
                if(t2===null){duelState.selectedHandCard=null;renderDuelField();return;}
                duelState.player.graveyard.push(duelState.player.monsterZones[t1].id); duelState.player.monsterZones[t1]=null;
                duelState.player.graveyard.push(duelState.player.monsterZones[t2].id); duelState.player.monsterZones[t2]=null;
                logDuel(`Tribute 2 monsters to summon ${getCardById(handCardId).name}!`);
            } else if (lvl>=5) {
                const tribOpts=duelState.player.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(!tribOpts.length){showToast('Need 1 monster to tribute!','error');return;}
                const t1=tribOpts.length===1?tribOpts[0]:await pickDuelChoice('Tribute 1 monster',tribOpts,i=>{const c=getCardById(duelState.player.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.player.monsterZones[i])}/DEF:${getEffectiveDEF(duelState.player.monsterZones[i])}`;},false);
                if(t1===null){duelState.selectedHandCard=null;renderDuelField();return;}
                duelState.player.graveyard.push(duelState.player.monsterZones[t1].id); duelState.player.monsterZones[t1]=null;
                logDuel(`Tribute 1 monster to summon ${getCardById(handCardId).name}!`);
            }
            showSummonDialog(handCardId, zoneIndex);
        }

        function duelSummonMonster(handCardId, zoneIndex, position) {
            const zi=parseInt(zoneIndex);
            if (duelState.player.monsterZones[zi]!==null) { showToast('Zone occupied!','error'); return; }
            duelState.player.monsterZones[zi]={id:handCardId,position,summonedThisTurn:true,faceDown:position==='DEF'};
            const hi=duelState.player.hand.indexOf(handCardId);
            if (hi!==-1) duelState.player.hand.splice(hi,1);
            duelState.player.normalSummonUsed=true;
            duelState.selectedHandCard=null;
            SoundEngine.summon();
            logDuel(`You summon ${getCardById(handCardId).name} in ${position}${position==='DEF'?' (face-down)':''} position!`);
            if (mpState.inPvP && socket) {
                socket.emit('pvpAction', { type:'summon', handCardId, zoneIndex:zi, position });
                setTimeout(_pvpEmitStateSync, 120); // delay so summon effects run first
            }
            triggerOnSummonEffect(handCardId,'player',zi);
            renderDuelField();
        }

        function showSummonDialog(cardId, zoneIndex) {
            const card=getCardById(cardId);
            let ex=document.getElementById('summon-dialog'); if(ex) ex.remove();
            const dlg=document.createElement('div');
            dlg.id='summon-dialog';
            dlg.className='fixed inset-0 z-[800] bg-black/80 flex items-center justify-center';
            dlg.innerHTML=`<div class="bg-[#060d1c] border-2 border-cyan-500 rounded-xl p-6 text-center">
                <p class="text-cyan-300 font-[Bangers] text-2xl tracking-wider mb-4">Summon ${card.name}</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="document.getElementById('summon-dialog').remove();duelSummonMonster(${cardId},${zoneIndex},'ATK')" class="font-[Bangers] text-xl px-6 py-2 bg-red-900 hover:bg-red-700 border-2 border-red-400 rounded-lg text-white tracking-widest"> ATTACK</button>
                    <button onclick="document.getElementById('summon-dialog').remove();duelSummonMonster(${cardId},${zoneIndex},'DEF')" class="font-[Bangers] text-xl px-6 py-2 bg-blue-900 hover:bg-blue-700 border-2 border-blue-400 rounded-lg text-white tracking-widest"> DEFENSE</button>
                    <button onclick="document.getElementById('summon-dialog').remove();duelState.selectedHandCard=null;renderDuelField()" class="font-[Bangers] text-xl px-6 py-2 bg-gray-700 hover:bg-gray-600 border-2 border-gray-500 rounded-lg text-gray-300 tracking-widest"> Cancel</button>
                </div>
            </div>`;
            document.body.appendChild(dlg);
        }

        function duelPlaceSpellTrap(zoneIndex) {
            if (duelState.turnPlayer!=='PLAYER'||!['MAIN1','MAIN2'].includes(duelState.phase)) { showToast('Can only set cards in Main Phase!','error'); return; }
            if (duelState.selectedHandCard===null) return;
            const handCardId=duelState.player.hand[duelState.selectedHandCard];
            const card=getCardById(handCardId);
            if (!card||(card.type!=='SPELL'&&card.type!=='TRAP')) { showToast('Select a Spell or Trap!','error'); return; }
            if (duelState.player.spellTrapZones[zoneIndex]!==null) { showToast('Zone occupied!','error'); return; }
            const isTrap=card.type==='TRAP';
            // Block fusion spells if no valid materials available
            if (!isTrap && (handCardId===55||handCardId===102)) {
                const useDeck = handCardId===102;
                if (!canDoFusionSummon('player', useDeck)) {
                    showToast(`Can't activate ${card.name}  you don't have the required Fusion materials!`, 'error');
                    return;
                }
            }
            const hi=duelState.player.hand.indexOf(handCardId);
            if (hi!==-1) duelState.player.hand.splice(hi,1);
            duelState.selectedHandCard=null;
            if (mpState.inPvP && socket) {
                socket.emit('pvpAction', { type:'setSpellTrap', handCardId, zoneIndex, isTrap });
                setTimeout(_pvpEmitStateSync, 800); // delay so spell effects fully resolve first
            }
            if (isTrap) {
                duelState.player.spellTrapZones[zoneIndex]={id:handCardId,faceDown:true,activatedThisTurn:false};
                logDuel('You set a Trap face-down.');
                renderDuelField();
            } else {
                duelState.player.spellTrapZones[zoneIndex]={id:handCardId,faceDown:false,activatedThisTurn:true};
                logDuel(`You activate ${card.name}!`);
                renderDuelField();
                const _sid=handCardId, _zi=zoneIndex;
                applySpellEffect(handCardId,'player').then(()=>{
                    if (!duelState) return;
                    const fi=duelState.player.spellTrapZones.findIndex(s=>s&&s.id===_sid);
                    if (fi!==-1){ duelState.player.graveyard.push(_sid); duelState.player.spellTrapZones[fi]=null; }
                    renderDuelField();
                });
            }
        }

        async function applySpellEffect(cardId, owner) {
            const card=getCardById(cardId), side=duelState[owner], enemy=owner==='player'?'ai':'player';
            SoundEngine.spell();
            switch(cardId) {
                case 50: { // System Reboot  SS monster from GY (player picks)
                    if(owner!=='player'){ // AI keeps auto-select
                        const m=side.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                        if(m.length&&side.monsterZones.some(z=>z===null)){const id=m[m.length-1],zi=side.monsterZones.findIndex(z=>z===null);side.monsterZones[zi]={id,position:'ATK',summonedThisTurn:false,faceDown:false};side.graveyard=side.graveyard.filter(g=>g!==id);logDuel(`${card.name}: SS ${getCardById(id).name} from GY!`);}
                        else logDuel(`${card.name}: No valid target in GY!`); break;
                    }
                    const m50=side.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                    if(!m50.length||!side.monsterZones.some(z=>z===null)){logDuel(`${card.name}: No valid target in GY!`);break;}
                    const pick50=await pickDuelChoice('Special Summon from GY',m50,id=>{const c=getCardById(id);return `${c.name}  ATK:${c.atk}/DEF:${c.def}`;});
                    if(pick50===null){logDuel(`${card.name}: Cancelled.`);break;}
                    const zi50=side.monsterZones.findIndex(z=>z===null);
                    side.monsterZones[zi50]={id:pick50,position:'ATK',summonedThisTurn:false,faceDown:false};
                    side.graveyard=side.graveyard.filter(g=>g!==pick50);
                    logDuel(`${card.name}: SS ${getCardById(pick50).name} from GY!`); break; }
                case 51: { // Overclock  chosen ally +700 ATK this turn
                    const mons51=side.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!mons51.length){logDuel(`${card.name}: No ally monster to boost!`);break;}
                    if(owner!=='player'||mons51.length===1){
                        const ti=mons51.sort((a,b)=>getEffectiveATK(side.monsterZones[b])-getEffectiveATK(side.monsterZones[a]))[0];
                        side.monsterZones[ti].atkBuff=(side.monsterZones[ti].atkBuff||0)+700; logDuel(`${card.name}: ${getCardById(side.monsterZones[ti].id).name} gains +700 ATK!`); break;
                    }
                    const pick51=await pickDuelChoice('Choose monster to boost +700 ATK', mons51, i=>{const c=getCardById(side.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(side.monsterZones[i])}/DEF:${getEffectiveDEF(side.monsterZones[i])}`;});
                    if(pick51===null){logDuel(`${card.name}: Cancelled.`);break;}
                    side.monsterZones[pick51].atkBuff=(side.monsterZones[pick51].atkBuff||0)+700;
                    logDuel(`${card.name}: ${getCardById(side.monsterZones[pick51].id).name} gains +700 ATK!`); break; }
                case 52: side.lp=Math.min(side.lp+1000,8000); logDuel(`${card.name}: Gain 1000 LP! (LP:${side.lp})`); break;
                case 53: { // Dark Web Deal  draw 2, player picks discard
                    duelDraw(owner); duelDraw(owner);
                    if(!side.hand.length){logDuel(`${card.name}: Drew 2!`);break;}
                    if(owner!=='player'){const d=side.hand.splice(Math.floor(Math.random()*side.hand.length),1)[0];side.graveyard.push(d);logDuel(`${card.name}: Draw 2, discard ${getCardById(d)?.name||'a card'}.`);break;}
                    const pick53=await pickDuelChoice('Discard 1 card', side.hand.map(id=>id), id=>{const c=getCardById(id);return `${c.name} [${c.type}]${c.atk!==undefined?' ATK:'+c.atk:''}`;}, false);
                    if(pick53!==null){const hi=side.hand.indexOf(pick53);if(hi!==-1)side.hand.splice(hi,1);side.graveyard.push(pick53);logDuel(`${card.name}: Draw 2, discard ${getCardById(pick53).name}.`);}
                    else{const d=side.hand.splice(0,1)[0];side.graveyard.push(d);logDuel(`${card.name}: Draw 2, discard ${getCardById(d)?.name||'a card'}.`);}
                    break; }
                case 54: { // Thunder Strike  destroy chosen enemy monster
                    const ts54=duelState[enemy].monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!ts54.length){logDuel(`${card.name}: No monsters to destroy!`);break;}
                    if(owner!=='player'||ts54.length===1){
                        const ti=ts54.sort((a,b)=>getEffectiveATK(duelState[enemy].monsterZones[b])-getEffectiveATK(duelState[enemy].monsterZones[a]))[0];
                        logDuel(`${card.name}: Destroy ${getCardById(duelState[enemy].monsterZones[ti].id).name}!`);
                        duelState[enemy].graveyard.push(duelState[enemy].monsterZones[ti].id); duelState[enemy].monsterZones[ti]=null; break;
                    }
                    const pick54=await pickDuelChoice('Choose monster to destroy', ts54, i=>{const c=getCardById(duelState[enemy].monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState[enemy].monsterZones[i])}/DEF:${getEffectiveDEF(duelState[enemy].monsterZones[i])}`;}, false);
                    if(pick54===null){logDuel(`${card.name}: Cancelled.`);break;}
                    logDuel(`${card.name}: Destroy ${getCardById(duelState[enemy].monsterZones[pick54].id).name}!`);
                    duelState[enemy].graveyard.push(duelState[enemy].monsterZones[pick54].id); duelState[enemy].monsterZones[pick54]=null; break; }
                case 55: { // Polymerization  Fusion Summon (hand/field materials, player picks)
                    if(owner==='player'){ await doFusionSummon(owner, card.name, false); }
                    else { // AI auto-pick first valid
                        const ex=side.extraDeck; if(!ex.length){logDuel(`${card.name}: No Fusion in Extra Deck!`);break;}
                        const fid=ex[0],fc=getCardById(fid),ezi=side.monsterZones.findIndex(z=>z===null);
                        if(ezi!==-1){side.monsterZones[ezi]={id:fid,position:'ATK',summonedThisTurn:true,faceDown:false};side.extraDeck=side.extraDeck.filter(id=>id!==fid);logDuel(`${card.name}: Fusion Summon ${fc.name}!`);}
                        else logDuel(`${card.name}: No space for Fusion!`);
                    }
                    break; }
                case 56: { // Field Shield  all monsters +500 DEF
                    side.monsterZones.forEach(s=>{if(s)s.defBuff=(s.defBuff||0)+500;});
                    logDuel(`${card.name}: Your monsters gain +500 DEF this turn!`); break; }
                case 57: { // Data Corruption  destroy chosen enemy S/T
                    const ts57=duelState[enemy].spellTrapZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!ts57.length){logDuel(`${card.name}: No enemy Spell/Trap!`);break;}
                    if(owner!=='player'||ts57.length===1){
                        const ti=ts57[0]; logDuel(`${card.name}: Destroy ${getCardById(duelState[enemy].spellTrapZones[ti].id)?.name||'card'}!`);
                        duelState[enemy].graveyard.push(duelState[enemy].spellTrapZones[ti].id); duelState[enemy].spellTrapZones[ti]=null; break;
                    }
                    const pick57=await pickDuelChoice('Choose Spell/Trap to destroy', ts57, i=>{const s=duelState[enemy].spellTrapZones[i];const c=getCardById(s.id);return s.faceDown?'Face-down card':`${c.name} [${c.type}]`;}, false);
                    if(pick57===null){logDuel(`${card.name}: Cancelled.`);break;}
                    logDuel(`${card.name}: Destroy ${getCardById(duelState[enemy].spellTrapZones[pick57].id)?.name||'card'}!`);
                    duelState[enemy].graveyard.push(duelState[enemy].spellTrapZones[pick57].id); duelState[enemy].spellTrapZones[pick57]=null; break; }
                case 58: { duelDraw(owner);duelDraw(owner);duelDraw(owner); logDuel(`${card.name}: Draw 3 cards!`); break; }
                case 59: { // Cyber Awakening  SS up to 2 Effect Monsters from hand (can't attack)
                    const effM=side.hand.map((id,i)=>({id,i,card:getCardById(id)})).filter(x=>x.card&&x.card.type==='EFFECT');
                    let ct=0;
                    for(const em of effM.slice(0,2)){const ezi=side.monsterZones.findIndex(z=>z===null);if(ezi===-1)break;side.monsterZones[ezi]={id:em.id,position:'ATK',summonedThisTurn:true,faceDown:false,cannotAttack:true};side.hand=side.hand.filter(id=>id!==em.id);logDuel(`${card.name}: SS ${em.card.name} (cannot attack this turn)!`);triggerOnSummonEffect(em.id,owner,ezi);ct++;}
                    if(!ct)logDuel(`${card.name}: No Effect Monsters in hand!`); break; }
                case 101: { // Emergency Reboot  SS up to 2 monsters from GY (player picks)
                    const eligible101=side.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                    if(!eligible101.length){logDuel(`${card.name}: No monsters in GY to revive!`);break;}
                    if(owner!=='player'){
                        let ct=0;
                        for(const eid of eligible101.slice(0,2)){const ezi=side.monsterZones.findIndex(z=>z===null);if(ezi===-1)break;side.monsterZones[ezi]={id:eid,position:'ATK',summonedThisTurn:true,faceDown:false};side.graveyard=side.graveyard.filter(g=>g!==eid);logDuel(`${card.name}: SS ${getCardById(eid).name} from GY!`);ct++;}
                        if(!ct)logDuel(`${card.name}: No monsters in GY to revive!`); break;
                    }
                    let gyPool101=[...eligible101], summoned101=0;
                    for(let r=0;r<2;r++){
                        if(!gyPool101.length||!side.monsterZones.some(z=>z===null))break;
                        const pick=await pickDuelChoice(`Special Summon from GY (${r+1}/2  Cancel to stop)`, gyPool101, id=>{const c=getCardById(id);return `${c.name}  ATK:${c.atk}/DEF:${c.def}`;});
                        if(pick===null) break;
                        const ezi=side.monsterZones.findIndex(z=>z===null); if(ezi===-1) break;
                        side.monsterZones[ezi]={id:pick,position:'ATK',summonedThisTurn:true,faceDown:false};
                        side.graveyard=side.graveyard.filter(g=>g!==pick);
                        gyPool101=gyPool101.filter(g=>g!==pick);
                        logDuel(`${card.name}: SS ${getCardById(pick).name} from GY!`); summoned101++;
                    }
                    if(!summoned101) logDuel(`${card.name}: No monsters summoned.`); break; }
                case 102: { // Fusion Catalyst  Fusion Summon using hand/deck/field
                    if(owner==='player'){ await doFusionSummon(owner, card.name, true); }
                    else { // AI auto-pick first valid
                        const ex2=side.extraDeck; if(!ex2.length){logDuel(`${card.name}: No Fusion in Extra Deck!`);break;}
                        const fid2=ex2[0],fc2=getCardById(fid2),ezi2=side.monsterZones.findIndex(z=>z===null);
                        if(ezi2!==-1){side.monsterZones[ezi2]={id:fid2,position:'ATK',summonedThisTurn:true,faceDown:false};side.extraDeck=side.extraDeck.filter(id=>id!==fid2);logDuel(`${card.name}: Fusion Summon ${fc2.name}!`);}
                        else logDuel(`${card.name}: No space for Fusion!`);
                    }
                    break; }
                case 103: { // Overclock Burst  chosen ally +1200 ATK, destroyed at End Phase
                    const mons103=side.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!mons103.length){logDuel(`${card.name}: No ally monster!`);break;}
                    if(owner!=='player'||mons103.length===1){
                        const ti103=mons103.sort((a,b)=>getEffectiveATK(side.monsterZones[b])-getEffectiveATK(side.monsterZones[a]))[0];
                        side.monsterZones[ti103].atkBuff=(side.monsterZones[ti103].atkBuff||0)+1200; side.monsterZones[ti103].destroyAtEndPhase=true;
                        logDuel(`${card.name}: ${getCardById(side.monsterZones[ti103].id).name} gains +1200 ATK! (Destroyed at End Phase)`); break;
                    }
                    const pick103=await pickDuelChoice('Choose monster to boost +1200 ATK (destroyed at End Phase)', mons103, i=>{const c=getCardById(side.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(side.monsterZones[i])}/DEF:${getEffectiveDEF(side.monsterZones[i])}`;}, false);
                    if(pick103===null){logDuel(`${card.name}: Cancelled.`);break;}
                    side.monsterZones[pick103].atkBuff=(side.monsterZones[pick103].atkBuff||0)+1200; side.monsterZones[pick103].destroyAtEndPhase=true;
                    logDuel(`${card.name}: ${getCardById(side.monsterZones[pick103].id).name} gains +1200 ATK! (Destroyed at End Phase)`); break; }
                case 104: { // Data Purge  banish opponent's entire GY
                    const eGY=duelState[enemy].graveyard.splice(0);
                    duelState[enemy].banished.push(...eGY);
                    logDuel(`${card.name}: Banished ${eGY.length} card(s) from opponent's GY!`); break; }
                case 60: { // Quantum Storm  halve all ATK + draw 1
                    [...duelState.player.monsterZones,...duelState.ai.monsterZones].forEach(s=>{if(s)s.atkHalve=true;});
                    if(duelDraw(owner))logDuel(`${card.name}: All monsters' ATK halved! You draw 1!`);
                    else logDuel(`${card.name}: All monsters' ATK halved!`); break; }
                case 149: { // Eclipse Strike  destroy all enemy monsters + 400 LP each
                    let ct149=0;
                    duelState[enemy].monsterZones.forEach((s,i)=>{ if(s){logDuel(`Eclipse Strike destroys ${getCardById(s.id).name}!`);duelState[enemy].graveyard.push(s.id);duelState[enemy].monsterZones[i]=null;ct149++;} });
                    if(ct149){duelState[enemy].lp=Math.max(0,duelState[enemy].lp-ct149*400);logDuel(`Eclipse Strike: ${ct149} monster(s) destroyed  ${ct149*400} damage! (${enemy==='ai'?'Opp':'Your'} LP:${duelState[enemy].lp})`);}
                    else logDuel('Eclipse Strike: No monsters to destroy.'); break; }
                case 152: { // Dark Convergence  SS up to 2 DARK monsters from hand in DEF
                    const darkHand=side.hand.map((id,i)=>({id,i,card:getCardById(id)})).filter(x=>x.card&&x.card.type!=='SPELL'&&x.card.type!=='TRAP'&&x.card.type!=='FUSION'&&x.card.attribute==='DARK');
                    let ct152=0;
                    for(const dm of darkHand.slice(0,2)){const ezi=side.monsterZones.findIndex(z=>z===null);if(ezi===-1)break;side.monsterZones[ezi]={id:dm.id,position:'DEF',summonedThisTurn:true,faceDown:false,cannotAttack:true};side.hand=side.hand.filter(id=>id!==dm.id);logDuel(`Dark Convergence: SS ${dm.card.name} in DEF (cannot attack)!`);triggerOnSummonEffect(dm.id,owner,ezi);ct152++;}
                    if(!ct152)logDuel('Dark Convergence: No DARK monsters in hand!'); break; }
                case 157: { // Omega Annihilator  destroy all other cards on field, draw 3, opp draws 1, 1000 dmg
                    let destroyed157=0;
                    ['player','ai'].forEach(who=>{
                        duelState[who].monsterZones.forEach((s,i)=>{if(s){logDuel(`Omega Annihilator destroys ${getCardById(s.id).name}!`);duelState[who].graveyard.push(s.id);duelState[who].monsterZones[i]=null;destroyed157++;}});
                        duelState[who].spellTrapZones.forEach((s,i)=>{if(s&&!(who===owner&&s.id===157)){logDuel(`Omega Annihilator destroys ${getCardById(s.id)?.name||'card'}!`);duelState[who].graveyard.push(s.id);duelState[who].spellTrapZones[i]=null;destroyed157++;}});
                    });
                    duelDraw(owner);duelDraw(owner);duelDraw(owner);
                    duelDraw(enemy);
                    duelState[enemy].lp=Math.max(0,duelState[enemy].lp-1000);
                    logDuel(`Omega Annihilator: ${destroyed157} card(s) destroyed. You draw 3, opp draws 1. 1000 damage! (${enemy==='ai'?'Opp':'Your'} LP:${duelState[enemy].lp})`); break; }
                case 160: { // Ascendant Throne  LIGHT monsters +800 ATK/DEF this turn
                    const lightMons160=side.monsterZones.filter(s=>s&&getCardById(s.id)?.attribute==='LIGHT');
                    if(!lightMons160.length){logDuel('Ascendant Throne: No LIGHT monsters on your field!');break;}
                    lightMons160.forEach(s=>{s.atkBuff=(s.atkBuff||0)+800;s.defBuff=(s.defBuff||0)+800;});
                    logDuel(`Ascendant Throne: ${lightMons160.length} LIGHT monster(s) gain +800 ATK/DEF!`); break; }
                case 172: { // Magma Surge  destroy all opp DEF position monsters
                    let ct172=0;
                    duelState[enemy].monsterZones.forEach((s,i)=>{ if(s&&s.position==='DEF'){logDuel(`Magma Surge melts ${getCardById(s.id).name}!`);duelState[enemy].graveyard.push(s.id);duelState[enemy].monsterZones[i]=null;ct172++;} });
                    if(ct172) logDuel(`Magma Surge: ${ct172} DEF monster(s) destroyed!`);
                    else logDuel('Magma Surge: No DEF position monsters to destroy.'); break; }
                case 173: { // Scorched Earth  inflict 500 damage to opponent
                    duelState[enemy].lp=Math.max(0,duelState[enemy].lp-500);
                    logDuel(`Scorched Earth: The land burns! 500 damage! (${enemy==='ai'?'Opp':'Your'} LP:${duelState[enemy].lp})`); break; }
                case 181: { // Entropy Null  send top 2 opp deck to GY, opp discards 1
                    const top181=duelState[enemy].deck.splice(0,2);
                    duelState[enemy].graveyard.push(...top181);
                    logDuel(`Entropy Null: Send top ${top181.length} card(s) from ${enemy==='ai'?'opp':'your'} deck to GY!`);
                    if(duelState[enemy].hand.length){const ri=Math.floor(Math.random()*duelState[enemy].hand.length);const did=duelState[enemy].hand.splice(ri,1)[0];duelState[enemy].graveyard.push(did);logDuel(`Entropy Null: ${enemy==='ai'?'Opp':'You'} also discard ${getCardById(did)?.name||'a card'}!`);}
                    break; }
                case 183: { // Data Hemorrhage  discard 1, draw 2
                    if(!side.hand.length&&owner==='player'){logDuel('Data Hemorrhage: No cards to discard!');break;}
                    if(owner==='player'){
                        const pick183=side.hand.length===1?side.hand[0]:await pickDuelChoice('Discard 1 card',side.hand.map(id=>id),id=>{const c=getCardById(id);return`${c.name} [${c.type}]${c.atk!==undefined?' ATK:'+c.atk:''}`;},false);
                        const d183=pick183!==null?pick183:side.hand[0];
                        const hi183=side.hand.indexOf(d183);if(hi183!==-1)side.hand.splice(hi183,1);
                        side.graveyard.push(d183);
                        logDuel(`Data Hemorrhage: Discard ${getCardById(d183).name}, draw 2!`);
                    } else {
                        const d183ai=side.hand.splice(Math.floor(Math.random()*side.hand.length),1)[0];
                        side.graveyard.push(d183ai);
                        logDuel(`Data Hemorrhage: Discard ${getCardById(d183ai)?.name||'a card'}, draw 2!`);
                    }
                    duelDraw(owner); duelDraw(owner); break; }
                case 192: { // Genesis Lance  add 1 monster from GY to hand
                    const mons192=side.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                    if(!mons192.length){logDuel('Genesis Lance: No monster in Graveyard!');break;}
                    if(owner!=='player'){const id192=mons192[mons192.length-1];side.graveyard=side.graveyard.filter(g=>g!==id192);side.hand.push(id192);logDuel(`Genesis Lance: ${getCardById(id192).name} retrieved from GY!`);break;}
                    const pick192=mons192.length===1?mons192[0]:await pickDuelChoice('Add which monster to hand?',mons192,id=>{const c=getCardById(id);return`${c.name}  ATK:${c.atk||0}/DEF:${c.def||0}`;},false);
                    if(pick192===null){logDuel('Genesis Lance: Cancelled.');break;}
                    side.graveyard=side.graveyard.filter(g=>g!==pick192);side.hand.push(pick192);
                    logDuel(`Genesis Lance: ${getCardById(pick192).name} retrieved from GY!`); break; }
                case 193: { // Apex Nova  all own monsters +600 ATK until end of turn
                    const mySide193=side.monsterZones.filter(s=>s);
                    if(!mySide193.length){logDuel('Apex Nova: No monsters on field!');break;}
                    mySide193.forEach(s=>{s.atkBuff=(s.atkBuff||0)+600;});
                    logDuel(`Apex Nova: ${mySide193.length} monster(s) gain +600 ATK this turn!`); break; }
                case 202: { // Fury Surge  all your FIRE monsters +600 ATK
                    let ct202=0;
                    duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='FIRE'){s.atkBuff=(s.atkBuff||0)+600;ct202++;} });
                    logDuel(`Fury Surge: ${ct202} FIRE monster(s) gain +600 ATK this turn!`); break; }
                case 203: { // Pyre of Fury  destroy all opponent monsters with ATK  1500
                    const enemy203=owner==='player'?'ai':'player'; let ct203=0;
                    duelState[enemy203].monsterZones.forEach((s,i)=>{ if(s&&getEffectiveATK(s)<=1500){logDuel(`Pyre of Fury: ${getCardById(s.id).name} (${getEffectiveATK(s)} ATK) is incinerated!`);duelState[enemy203].graveyard.push(s.id);duelState[enemy203].monsterZones[i]=null;ct203++;} });
                    if(!ct203) logDuel('Pyre of Fury: No valid targets (ATK 1500).'); break; }
                case 205: { // Fury Brand  draw 2, discard 1
                    duelDraw(owner); duelDraw(owner);
                    const side205=duelState[owner];
                    if(side205.hand.length){ const ri=Math.floor(Math.random()*side205.hand.length); const did=side205.hand.splice(ri,1)[0]; side205.graveyard.push(did); logDuel(`Fury Brand: Draw 2, discard ${getCardById(did)?.name||'a card'}!`); }
                    break; }
                case 211: { // Tidal Surge  all your WATER monsters +500 ATK
                    let ct211=0;
                    duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='WATER'){s.atkBuff=(s.atkBuff||0)+500;ct211++;} });
                    logDuel(`Tidal Surge: ${ct211} WATER monster(s) gain +500 ATK this turn!`); break; }
                case 212: { // Deep Current  draw 2, discard 1
                    duelDraw(owner); duelDraw(owner);
                    const side212=duelState[owner];
                    if(side212.hand.length){ const ri=Math.floor(Math.random()*side212.hand.length); const did=side212.hand.splice(ri,1)[0]; side212.graveyard.push(did); logDuel(`Deep Current: Draw 2, discard ${getCardById(did)?.name||'a card'}!`); }
                    break; }
                case 220: { // Abyss Rite  mill 5 from opponent deck
                    const enemy220=owner==='player'?'ai':'player'; let milled220=0;
                    for(let i=0;i<5;i++){ if(duelState[enemy220].deck.length){const id=duelState[enemy220].deck.shift();duelState[enemy220].graveyard.push(id);milled220++;} }
                    logDuel(`Abyss Rite: Sends ${milled220} card(s) from ${enemy220==='ai'?"opponent's":'your'} deck to GY!`); break; }
                case 221: { // Abyss Purge  destroy all ST on field
                    ['player','ai'].forEach(who=>{ duelState[who].spellTrapZones.forEach((s,i)=>{ if(s){logDuel(`Abyss Purge: ${getCardById(s.id)?.name||'card'} destroyed!`);duelState[who].graveyard.push(s.id);duelState[who].spellTrapZones[i]=null;} }); }); break; }
                case 222: { // Abyss Dominion  all opponent monsters 600 ATK
                    const enemy222=owner==='player'?'ai':'player'; let ct222=0;
                    duelState[enemy222].monsterZones.forEach(s=>{ if(s){s.atkBuff=(s.atkBuff||0)-600;ct222++;} });
                    logDuel(`Abyss Dominion: ${ct222} opponent monster(s) lose 600 ATK this turn!`); break; }
                case 229: { // Grid Protocol  all your EARTH monsters +500 ATK
                    let ct229=0;
                    duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='EARTH'){s.atkBuff=(s.atkBuff||0)+500;ct229++;} });
                    logDuel(`Grid Protocol: ${ct229} EARTH monster(s) gain +500 ATK this turn!`); break; }
                case 230: { // Grid Surge  draw 2, discard 1
                    duelDraw(owner); duelDraw(owner);
                    const side230=duelState[owner];
                    if(side230.hand.length){ const ri=Math.floor(Math.random()*side230.hand.length); const did=side230.hand.splice(ri,1)[0]; side230.graveyard.push(did); logDuel(`Grid Surge: Draw 2, discard ${getCardById(did)?.name||'a card'}!`); }
                    break; }
                case 238: { // Aurora Blessing  all your LIGHT monsters +600 ATK/DEF, draw 1
                    let ct238=0;
                    duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='LIGHT'){s.atkBuff=(s.atkBuff||0)+600;s.defBuff=(s.defBuff||0)+600;ct238++;} });
                    logDuel(`Aurora Blessing: ${ct238} LIGHT monster(s) gain +600 ATK/DEF!`);
                    if(duelDraw(owner)) logDuel('Aurora Blessing: Drew 1 card!'); break; }
                case 239: { // Heaven's Light  gain 1500 LP, draw 1
                    duelState[owner].lp=Math.min(8000,duelState[owner].lp+1500);
                    logDuel(`Heaven's Light: ${owner==='player'?'You gain':'Opponent gains'} 1500 LP! (LP:${duelState[owner].lp})`);
                    if(duelDraw(owner)) logDuel(`Heaven's Light: Drew 1 card!`); break; }
                default: logDuel(`${card.name} effect activates!`);
            }
            renderDuelField();
        }

        function duelPlayerAttack(attackerZoneIdx) {
            if (duelState.phase!=='BATTLE'||duelState.turnPlayer!=='PLAYER') return;
            if (duelState.alreadyAttacked.includes(attackerZoneIdx)) { showToast('Already attacked!','error'); return; }
            const slot=duelState.player.monsterZones[attackerZoneIdx];
            if (!slot||slot.position!=='ATK') { showToast('Only ATK monsters can attack!','error'); return; }
            if (slot.summonedThisTurn) { showToast('Cannot attack the turn it was summoned!','error'); return; }
            duelState.selectedZone={owner:'player',type:'monster',idx:attackerZoneIdx};
            renderDuelField();
        }

        function duelSelectAttackTarget(targetIdx) {
            if (!duelState.selectedZone) return;
            const attackerIdx=duelState.selectedZone.idx;
            duelState.selectedZone=null;
            if (mpState.inPvP && socket) {
                mpState.pendingAttack={type:'attack',attackerIdx,targetIdx};
                socket.emit('pvpAction', { type:'attackDeclare', attackerIdx, targetIdx });
                showToast('Attack declared  awaiting opponent response','info');
                renderDuelField();
                return;
            }
            resolveAttack('player',attackerIdx,'ai',targetIdx);
            renderDuelField();
        }

        function duelDirectAttack() {
            if (!duelState.selectedZone) return;
            const attackerIdx=duelState.selectedZone.idx;
            if (mpState.inPvP && socket) {
                mpState.pendingAttack={type:'directAttack',attackerIdx};
                socket.emit('pvpAction', { type:'directDeclare', attackerIdx });
                showToast('Direct attack declared  awaiting opponent response','info');
                duelState.selectedZone=null;
                renderDuelField();
                return;
            }
            const attSlot=duelState.player.monsterZones[attackerIdx];
            const attCard=getCardById(attSlot.id);
            const attATK=getEffectiveATK(attSlot);
            const halveDirect=[170,176,179].includes(attSlot.id);
            const finalDmg=halveDirect?Math.floor(attATK/2):attATK;
            duelState.ai.lp=Math.max(0,duelState.ai.lp-finalDmg);
            duelState.alreadyAttacked.push(attackerIdx);
            duelState.selectedZone=null;
            logDuel(`${attCard.name} attacks directly! Opp takes ${finalDmg} DMG${halveDirect?' (halved)':''}! (Opp LP: ${duelState.ai.lp})`);
            // Static Phantom (176): if attacks directly, opponent discards 1 random card
            if (attSlot.id===176 && duelState.ai.hand.length) {
                const ri=Math.floor(Math.random()*duelState.ai.hand.length);
                const did=duelState.ai.hand.splice(ri,1)[0];
                duelState.ai.graveyard.push(did);
                logDuel(`Static Phantom: Opp discards ${getCardById(did)?.name||'a card'} from hand!`);
            }
            renderDuelField();
            if (duelState.ai.lp<=0) endDuel('player','lp');
        }

        // Returns XP required to level up FROM the given level.
        // Early levels (1-7) are quick; curve steepens significantly at higher levels.
        function xpToNextLevel(level) {
            if (level >= 100) return Infinity; // Level 100 is the cap
            return Math.floor(100 + (level - 1) * 50 + Math.pow(level - 1, 2) * 10);
        }
        // Example thresholds:
        // Lv12:  100 XP   Lv23:  160    Lv34:  240    Lv56:  460
        // Lv78:  760 XP   Lv1011:1360   Lv2021:4660   Lv5051:~26k   Lv99100:~101k

        //  WIN/LOSS 
        function endDuel(winner, reason) {
            if (!duelState) return;
            // In PvP: tell the opponent the result before processing locally
            if (mpState.inPvP && socket) {
                socket.emit('pvpEnd', { won: winner !== 'player', reason });
                mpState.inPvP = false;
                socket.emit('setBattle', false);
                // Force re-entry into world on next renderApp so online badge refreshes correctly
                gameState._mpInWorld = false;
            }
            // Remove any floating overlays that live on document.body (not inside root)
            hideCardPreview();
            const _prev = document.getElementById('card-preview-overlay');
            if (_prev) _prev.remove();
            const _sdlg = document.getElementById('summon-dialog');
            if (_sdlg) _sdlg.remove();
            const opp=duelState.opponentData, playerWon=winner==='player';
            let xpGained = 0;
            let levelsGained = 0;
            let bonusCard = null;
            if (playerWon) {
                SoundEngine.win();
                gameState.wins++;
                gameState.money += opp.reward;
                xpGained = opp.diff * 50;
                gameState.xp += xpGained;
                // Level-up loop  keeps going if XP passes multiple thresholds
                while (gameState.level < 100 && gameState.xp >= xpToNextLevel(gameState.level)) {
                    gameState.xp -= xpToNextLevel(gameState.level);
                    gameState.level++;
                    levelsGained++;
                }
                if (opp.rare) bonusCard = grantRandomCard('SR');
            } else {
                SoundEngine.lose();
                gameState.losses++;
                if (opp.isAmbush) {
                    const penalty = opp.ambushPenalty || 40;
                    gameState.money = Math.max(0, gameState.money - penalty);
                }
            }
            const why=reason==='lp'?'LP reached 0':reason==='forfeit'?'Duel forfeited':'Deck ran out';
            duelState=null;
            SoundEngine.stopBGM(1.2);
            gameState._lastBGMView = null;
            setTimeout(() => SoundEngine.playMapBGM(), 900);
            root.innerHTML=`
                <div class="flex flex-col items-center justify-center h-full text-white text-center" style="background:radial-gradient(ellipse at 50% 50%,${playerWon?'#0a2200':'#220000'} 0%,#000 70%)">
                    <div class="text-9xl mb-4">${playerWon?'':''}</div>
                    <h1 class="text-7xl font-[Bangers] tracking-widest mb-2 ${playerWon?'text-yellow-400':'text-red-500'}" style="text-shadow:0 0 30px currentColor">${playerWon?'VICTORY!':'DEFEAT!'}</h1>
                    <p class="text-gray-400 font-mono mb-4">${why}</p>
                    ${playerWon?`<div class="bg-green-900/40 border border-green-500 rounded-lg px-6 py-3 mb-4 font-mono">
                        <div class="text-green-400 font-bold text-xl">+$${opp.reward} Credits</div>
                        <div class="text-cyan-400">XP Gained: +${xpGained}</div>
                        ${levelsGained>0?`<div class="text-yellow-300 font-bold animate-pulse"> LEVEL UP! Now Level ${gameState.level}!</div>`:''}
                        <div class="text-gray-300 text-sm mt-1">Level ${gameState.level}  ${gameState.xp} / ${xpToNextLevel(gameState.level)} XP to next level</div>
                        <div class="text-gray-500 text-xs mt-1">Record: ${gameState.wins}W / ${gameState.losses}L</div>
                    </div>
                    ${bonusCard ? `
                    <div class="mb-4 border-2 border-yellow-400 rounded-xl px-6 py-4 text-center" style="background:radial-gradient(ellipse at 50% 0%,#2d1a00 0%,#0a0800 80%);box-shadow:0 0 40px rgba(255,200,0,0.5)">
                        <div class="text-yellow-300 font-[Bangers] text-2xl tracking-widest mb-3"> RARE CARD ACQUIRED! </div>
                        <div class="flex justify-center mb-3">${renderCardHTML(bonusCard,'w-32','h-48')}</div>
                        <div class="text-yellow-200 font-bold text-lg">${bonusCard.name}</div>
                        <div class="text-yellow-600 text-xs font-mono uppercase tracking-widest mt-1">${bonusCard.type}  ${bonusCard.rarity}  ${bonusCard.attribute||''}</div>
                        <div class="text-gray-400 text-xs mt-2 italic max-w-xs mx-auto">${bonusCard.desc}</div>
                        <div class="text-green-400 text-xs mt-2 font-bold"> Added to your Card Trunk!</div>
                    </div>` : ''}`:`<div class="mb-6 bg-red-900/30 border border-red-700 rounded-lg px-6 py-3 font-mono">
                        <div class="text-gray-400 italic">Better luck next time!</div>
                        <div class="text-gray-500 text-xs mt-1">Record: ${gameState.wins}W / ${gameState.losses}L</div>
                    </div>`}
                    <div class="flex gap-4">
                        <button onclick="gameState.view='DUEL'; renderApp()" class="font-[Bangers] text-2xl px-8 py-3 bg-cyan-800 hover:bg-cyan-700 border-2 border-cyan-400 rounded-xl tracking-widest"> WORLD MAP</button>
                        <button onclick="gameState.view='MENU'; renderApp()" class="font-[Bangers] text-2xl px-8 py-3 bg-gray-800 hover:bg-gray-700 border-2 border-gray-500 rounded-xl tracking-widest"> MAIN MENU</button>
                    </div>
                </div>`;
        }

        function forfeitDuel() {
            if (!confirm('Forfeit this duel? You will lose.')) return;
            if (mpState.inPvP && socket) socket.emit('pvpAction', { type:'forfeit' });
            endDuel('ai','forfeit');
        }

        //  LOG 
        function logDuel(msg) {
            if (!duelState) return;
            duelState.log.unshift(msg);
            if (duelState.log.length>40) duelState.log.pop();
            const el=document.getElementById('duel-log-content');
            if (el) el.innerHTML=duelState.log.map(m=>`<div style="border-bottom:1px solid rgba(14,116,144,0.2);padding:2px 0;line-height:1.3">${m}</div>`).join('');
        }

        //  RENDER DUEL FIELD 
        function renderDuelField() {
            if (!duelState) return;
            // In PvP: after every render, debounce-sync so stat buffs always reach opponent
            if (mpState.inPvP && duelState.turnPlayer === 'PLAYER') _pvpScheduleSync(400);
            const D=duelState, isPlayerTurn=D.turnPlayer==='PLAYER', phase=D.phase;
            const phaseColors={DRAW:'#60a5fa',STANDBY:'#facc15',MAIN1:'#4ade80',BATTLE:'#f87171',MAIN2:'#4ade80',END:'#9ca3af'};

            // Resolve equipped accessories  inject SVG artwork directly as HTML (same as shop preview)
            const _slv = CARD_SLEEVES.find(s=>s.id===gameState.equippedSleeve) || CARD_SLEEVES[0];
            const _mat = PLAYMATS.find(m=>m.id===gameState.equippedPlaymat) || PLAYMATS[0];
            // In PvP, resolve opponent's accessories; fall back to defaults
            const _oppSlv = (mpState.inPvP && mpState.oppSleeve ? CARD_SLEEVES.find(s=>s.id===mpState.oppSleeve) : null) || CARD_SLEEVES[0];
            const _oppMat = (mpState.inPvP && mpState.oppPlaymat ? PLAYMATS.find(m=>m.id===mpState.oppPlaymat) : null) || PLAYMATS[0];
            // Scale SVGs to fill their containers via viewBox  no data URIs needed
            const _slvSVG = _slv.svgPreview.replace(/width="72" height="98"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');
            const _defSlvSVG = CARD_SLEEVES[0].svgPreview.replace(/width="72" height="98"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');
            const _oppSlvSVG = _oppSlv.svgPreview.replace(/width="72" height="98"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');
            const _matSVG = _mat.svgPreview.replace(/width="140" height="70"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');
            const _defMatSVG = PLAYMATS[0].svgPreview.replace(/width="140" height="70"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');
            const _oppMatSVG = _oppMat.svgPreview.replace(/width="140" height="70"/, 'width="100%" height="100%" preserveAspectRatio="xMidYMid slice"');

            function smallCardBack() {
                return `<div style="width:38px;height:54px;border-radius:4px;overflow:hidden;border:1.5px solid ${_slv.border};box-shadow:0 0 4px ${_slv.border}44;flex-shrink:0">${_slvSVG}</div>`;
            }
            function oppSmallCardBack() {
                return `<div style="width:38px;height:54px;border-radius:4px;overflow:hidden;border:1.5px solid ${_oppSlv.border};box-shadow:0 0 4px ${_oppSlv.border}44;flex-shrink:0">${_oppSlvSVG}</div>`;
            }
            function deckZone(count, label) {
                return `<div style="width:54px;height:76px;border-radius:5px;border:2px solid #134e4a;background:#040e18;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px">
                    ${count>0?smallCardBack():'<span style="color:#374151;font-size:8px;font-family:monospace">EMPTY</span>'}
                    <span style="color:#0e7490;font-size:7px;font-family:monospace">${label}:${count}</span>
                </div>`;
            }
            function gyZone(gy, label) {
                const topId=gy[gy.length-1], topCard=topId?getCardById(topId):null;
                return `<div style="width:54px;height:76px;border-radius:5px;border:2px solid #374151;background:#080808;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;cursor:default" ${topId?`onmouseenter="showFieldCardPreview(${topId},event)" onmouseleave="hideCardPreview()"`:''}>
                    ${topCard?`<div style="transform:scale(0.37);margin:-16px">${topCard.artIcon||''}</div>`:'<span style="color:#4b5563;font-size:8px">GY</span>'}
                    <span style="color:#6b7280;font-size:7px;font-family:monospace">${label}:${gy.length}</span>
                </div>`;
            }
            function banZone(ban) {
                return `<div style="width:54px;height:32px;border-radius:4px;border:1px solid #1f2937;background:#050505;display:flex;align-items:center;justify-content:center"><span style="color:#374151;font-size:7px;font-family:monospace">BAN:${ban.length}</span></div>`;
            }
            function lpBar(lp) {
                const pct=Math.max(0,Math.min(100,(lp/5000)*100)), col=pct>50?'#22c55e':pct>25?'#eab308':'#ef4444';
                return `<div style="display:flex;align-items:center;gap:6px">
                    <span style="color:${col};font-family:monospace;font-size:11px;font-weight:bold;min-width:52px">LP:${Math.max(0,lp)}</span>
                    <div style="width:90px;height:7px;border-radius:9px;background:#111;border:1px solid #333;overflow:hidden"><div style="width:${pct}%;height:100%;border-radius:9px;background:${col};box-shadow:0 0 6px ${col};transition:width 0.5s"></div></div>
                </div>`;
            }

            function monsterSlot(slot, owner, idx) {
                const canPlaceMon=owner==='player'&&isPlayerTurn&&['MAIN1','MAIN2'].includes(phase)&&D.selectedHandCard!==null;
                const selCard=D.selectedHandCard!==null?getCardById(D.player.hand[D.selectedHandCard]):null;
                const selIsMon=selCard&&selCard.type!=='SPELL'&&selCard.type!=='TRAP'&&selCard.type!=='FUSION';
                const canAtkSel=phase==='BATTLE'&&isPlayerTurn&&owner==='player'&&slot&&slot.position==='ATK'&&!slot.summonedThisTurn&&!slot.cannotAttack&&!D.alreadyAttacked.includes(idx);
                const isAttacking=D.selectedZone&&D.selectedZone.owner==='player'&&D.selectedZone.idx===idx&&owner==='player';
                const isTarget=owner==='ai'&&D.selectedZone&&D.selectedZone.owner==='player';
                const canOpenMenu=owner==='player'&&isPlayerTurn&&['MAIN1','MAIN2'].includes(phase)&&D.selectedHandCard===null&&!D.selectedZone&&slot;
                if (!slot) {
                    const hl=canPlaceMon&&selIsMon;
                    return `<div style="width:54px;height:76px;border-radius:5px;${hl?'border:2px dashed #facc15;background:#422006':'border:1px dashed #134e4a;background:#040e18'};display:flex;align-items:center;justify-content:center;cursor:${hl?'pointer':'default'}" ${hl?`onclick="duelPlaceMonster(${idx})"`:''}>
                        <span style="color:#134e4a;font-size:8px;font-family:monospace">MON</span></div>`;
                }
                const card=getCardById(slot.id);
                const effATK=getEffectiveATK(slot), effDEF=getEffectiveDEF(slot);
                const rot=slot.position==='DEF'?'transform:rotate(90deg);':'';
                // Face-down monster rendering
                if (slot.faceDown) {
                    const plOwn=owner==='player';
                    return `<div style="width:54px;height:76px;border-radius:5px;border:2px solid ${isTarget?'#ef4444':plOwn?_slv.border:'#1e3a4a'};background:#040e18;${rot}position:relative;overflow:hidden;cursor:${isTarget||(canOpenMenu&&plOwn)?'pointer':'default'};box-shadow:${plOwn?`0 0 8px ${_slv.border}55`:''}"
                         ${isTarget?`onclick="duelSelectAttackTarget(${idx})"`:canOpenMenu&&plOwn?`onclick="showMonsterMenu('player',${idx})"`:''} onmouseenter="${plOwn?`showFieldCardPreview(${slot.id},event)`:'showFaceDownBack(event)'}" onmouseleave="hideCardPreview()">
                        <div style="position:absolute;inset:0;border-radius:4px;overflow:hidden;pointer-events:none">${plOwn?_slvSVG:_oppSlvSVG}</div>
                        ${isTarget?'<div style="position:absolute;inset:0;border:2px solid #ef4444;border-radius:4px;pointer-events:none"></div>':''}
                    </div>`;
                }
                let border=isAttacking?'#facc15':isTarget?'#ef4444':canAtkSel?'#f97316':canOpenMenu?'#a855f7':'#155e75';
                const fn=canAtkSel?`duelPlayerAttack(${idx})`:isTarget?`duelSelectAttackTarget(${idx})`:canOpenMenu?`showMonsterMenu('player',${idx})`:'';
                return `<div style="width:54px;height:76px;border-radius:5px;border:2px solid ${border};background:#040e18;${rot}position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;cursor:${fn?'pointer':'default'};box-shadow:${isAttacking||isTarget?`0 0 10px ${border}80`:canOpenMenu?'0 0 5px rgba(168,85,247,0.25)':''}"
                     ${fn?`onclick="${fn}"`:''}  onmouseenter="showFieldCardPreview(${slot.id},event)" onmouseleave="hideCardPreview()">
                    <div style="transform:scale(0.37);margin:-18px;pointer-events:none">${card.artIcon||''}</div>
                    <span style="font-size:6px;font-family:monospace;color:#e5e7eb;text-align:center;padding:0 2px;pointer-events:none">${card.name.substring(0,9)}</span>
                    <span style="font-size:7px;font-family:monospace;font-weight:bold;color:${slot.position==='ATK'?'#fca5a5':'#93c5fd'};pointer-events:none">${slot.position==='ATK'?effATK:effDEF}</span>
                    ${slot.summonedThisTurn?'<div style="position:absolute;top:1px;left:1px;background:#ca8a04;color:#000;font-size:5px;padding:0 2px;border-radius:2px;font-weight:bold">NEW</div>':''}
                    ${(slot.atkBuff||slot.defBuff||slot.atkHalve)?'<div style="position:absolute;top:1px;right:1px;background:#14532d;color:#4ade80;font-size:4.5px;padding:0 2px;border-radius:2px;font-weight:bold">BUFF</div>':''}
                    ${D.alreadyAttacked.includes(idx)&&owner==='player'?'<div style="position:absolute;inset:0;background:rgba(0,0,0,0.55);border-radius:4px;display:flex;align-items:center;justify-content:center"><span style="color:#9ca3af;font-size:7px;font-family:monospace">USED</span></div>':''}
                </div>`;
            }

            function stSlot(slot, owner, idx) {
                const canPlaceST=owner==='player'&&isPlayerTurn&&['MAIN1','MAIN2'].includes(phase)&&D.selectedHandCard!==null;
                const selCard=D.selectedHandCard!==null?getCardById(D.player.hand[D.selectedHandCard]):null;
                const selIsST=selCard&&(selCard.type==='SPELL'||selCard.type==='TRAP');
                if (!slot) {
                    const hl=canPlaceST&&selIsST;
                    return `<div style="width:54px;height:76px;border-radius:5px;${hl?'border:2px dashed #4ade80;background:#052e16':'border:1px dashed #134e4a;background:#040e18'};display:flex;align-items:center;justify-content:center;cursor:${hl?'pointer':'default'}" ${hl?`onclick="duelPlaceSpellTrap(${idx})"`:''}>
                        <span style="color:#134e4a;font-size:8px;font-family:monospace">S/T</span></div>`;
                }
                const card=getCardById(slot.id);
                const isAiFaceDown = slot.faceDown && owner==='ai';
                const canActivateTrap = owner==='player' && slot.faceDown && card.type==='TRAP' && isPlayerTurn && ['MAIN1','MAIN2','BATTLE'].includes(phase) && !slot.activatedThisTurn;
                const hoverFn = isAiFaceDown ? 'showFaceDownBack(event)' : `showFieldCardPreview(${slot.id},event)`;
                return `<div style="width:54px;height:76px;border-radius:5px;border:2px solid ${canActivateTrap?'#7c3aed':isAiFaceDown?'#1e3a4a':'#166534'};background:#040e18;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;cursor:${canActivateTrap?'pointer':'default'};box-shadow:${canActivateTrap?'0 0 8px rgba(124,58,237,0.5)':'none'}"
                     onmouseenter="${hoverFn}" onmouseleave="hideCardPreview()" ${canActivateTrap?`onclick="activatePlayerTrap(${idx})"`:''} title="${canActivateTrap?'Click to activate trap':isAiFaceDown?'Face-down card':card.name}">
                    ${slot.faceDown
                        ?`<div style="position:absolute;inset:0;border-radius:4px;overflow:hidden;pointer-events:none">${owner==='player'?_slvSVG:_oppSlvSVG}</div>
                          ${canActivateTrap?'<div style="position:absolute;bottom:2px;left:0;right:0;text-align:center"><span style="font-size:5px;font-family:monospace;color:#c4b5fd;background:rgba(0,0,0,0.75);padding:0 3px;border-radius:1px">TRAP</span></div>':''}`
                        :`<div style="transform:scale(0.37);margin:-18px;pointer-events:none">${card.artIcon||''}</div><span style="font-size:6px;font-family:monospace;color:#e5e7eb;text-align:center;padding:0 2px">${card.name.substring(0,9)}</span>`
                    }
                </div>`;
            }

            const aiMonRow=D.ai.monsterZones.map((s,i)=>monsterSlot(s,'ai',i)).join('');
            const aiSTRow=D.ai.spellTrapZones.map((s,i)=>stSlot(s,'ai',i)).join('');
            const plMonRow=D.player.monsterZones.map((s,i)=>monsterSlot(s,'player',i)).join('');
            const plSTRow=D.player.spellTrapZones.map((s,i)=>stSlot(s,'player',i)).join('');
            const aiHandHTML=D.ai.hand.map(()=>oppSmallCardBack()).join('');

            const playerHandHTML=D.player.hand.map((id,i)=>{
                const card=getCardById(id), styles=CARD_TYPES[card.type]||CARD_TYPES.NORMAL;
                const isSel=D.selectedHandCard===i;
                const bgMap={'bg-yellow-200':'#fef08a','bg-orange-300':'#fdba74','bg-purple-300':'#d8b4fe','bg-emerald-300':'#6ee7b7','bg-pink-300':'#f9a8d4'};
                const bg=bgMap[styles.color]||'#fef08a';
                return `<div onclick="duelSelectHandCard(${i})" onmouseenter="showFieldCardPreview(${id},event)" onmouseleave="hideCardPreview()"
                     style="width:50px;height:72px;border-radius:5px;border:2px solid ${isSel?'#facc15':'#155e75'};background:${bg};flex-shrink:0;position:relative;overflow:hidden;cursor:pointer;transform:${isSel?'translateY(-12px)':'translateY(0)'};transition:transform 0.12s;box-shadow:${isSel?'0 0 14px rgba(250,204,21,0.7)':'none'}">
                    <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow:hidden;pointer-events:none">
                        <div style="transform:scale(0.38);margin:-14px">${card.artIcon||''}</div>
                        <div style="font-size:5.5px;font-family:monospace;font-weight:bold;color:#000;text-align:center;padding:0 2px;background:rgba(255,255,255,0.8);width:100%">${card.name.substring(0,11)}</div>
                        ${card.atk!==undefined?`<div style="font-size:6px;font-family:monospace;font-weight:bold;width:100%;display:flex;justify-content:space-between;padding:0 2px;background:rgba(0,0,0,0.6);color:#fff"><span>${card.atk}</span><span>${card.def}</span></div>`:''}
                    </div>
                </div>`;
            }).join('');

            const hasAIMon=D.ai.monsterZones.some(Boolean);
            const selAttMon=D.selectedZone&&D.selectedZone.owner==='player'?D.player.monsterZones[D.selectedZone.idx]:null;
            const showDirAtk=phase==='BATTLE'&&isPlayerTurn&&D.selectedZone&&(!hasAIMon||(selAttMon&&selAttMon.id===15));
            const phaseBtnLabel=PHASE_ORDER.indexOf(phase)>=PHASE_ORDER.length-1?' END TURN':' NEXT PHASE';

            root.innerHTML=`
            <div style="display:flex;height:100%;background:#040c18;user-select:none;position:relative">

                <!-- DUEL VIEWPORT (zoomable+pannable) -->
                <div id="duel-viewport" style="flex:1;overflow:hidden;cursor:grab;position:relative">
                <div id="duel-field-inner" style="position:absolute;inset:0;display:flex;flex-direction:column;transform-origin:center center;transform:scale(${duelZoom}) translate(${duelPanX}px,${duelPanY}px)">

                    <!-- Forfeit -->
                    <button onclick="forfeitDuel()" style="position:absolute;top:6px;left:8px;z-index:20;background:rgba(127,29,29,0.85);border:1px solid #991b1b;color:#fca5a5;font-size:10px;font-family:monospace;font-weight:bold;padding:3px 8px;border-radius:4px;cursor:pointer"> Forfeit</button>

                    <!-- AI Info -->
                    <div style="display:flex;align-items:center;gap:10px;padding:4px 14px;background:#06111e;border-bottom:1px solid #0f3050;flex-shrink:0">
                        <span style="font-family:'Bangers',cursive;font-size:17px;letter-spacing:.1em;color:${D.opponentData.color}">${D.opponentData.name}</span>
                        <span style="font-size:10px;font-family:monospace;color:#6b7280">${D.opponentData.deck}</span>
                        <div style="margin-left:auto">${lpBar(D.ai.lp)}</div>
                        <span style="font-size:9px;font-family:monospace;color:#4b5563">Hand:${D.ai.hand.length} Deck:${D.ai.deck.length}</span>
                    </div>

                    <!-- AI Hand (face-down) -->
                    <div style="display:flex;align-items:center;justify-content:center;gap:4px;padding:4px 8px;min-height:66px;background:#050b15;flex-shrink:0;overflow-x:auto">
                        ${aiHandHTML||'<span style="color:#374151;font-size:10px;font-family:monospace">No hand</span>'}
                    </div>

<!-- FIELD AREA -->
                    <div data-duel-field style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;background:radial-gradient(ellipse at 50% 50%,#071828 0%,#040c18 100%);position:relative">

                        <!-- AI Extra Deck -->
                        <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
                            ${deckZone(D.ai.extraDeck.length,'EX')}
                        </div>

                        <!-- Center rows -->
                        <div style="display:flex;flex-direction:column;gap:4px;flex:1;align-items:center;justify-content:center">
                            <div style="position:relative;padding:10px 52px 12px;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;gap:4px;align-items:center;border:1px solid ${_oppMat.accent}44">
                                <div style="position:absolute;inset:0;overflow:hidden;pointer-events:none;border-radius:10px">${_oppMatSVG}</div>
                                <div style="position:absolute;inset:0;background:rgba(0,0,0,0.3);pointer-events:none;border-radius:10px"></div>
                                <div style="display:flex;gap:4px;position:relative;z-index:1">${aiSTRow}</div>
                                <div style="display:flex;gap:4px;position:relative;z-index:1">${aiMonRow}</div>
                            </div>
                            <div style="height:1px;width:95%;background:linear-gradient(to right,transparent,rgba(0,229,255,0.12),transparent);margin:1px 0"></div>
                            <div style="position:relative;padding:10px 52px 12px;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;gap:4px;align-items:center;border:1px solid ${_mat.accent}66;box-shadow:0 0 24px ${_mat.accent}44">
                                <div style="position:absolute;inset:0;overflow:hidden;pointer-events:none;border-radius:10px">${_matSVG}</div>
                                <div style="position:absolute;inset:0;background:rgba(0,0,0,0.15);pointer-events:none;border-radius:10px"></div>
                                <div style="display:flex;gap:4px;position:relative;z-index:1">${plMonRow}</div>
                                <div style="display:flex;gap:4px;position:relative;z-index:1">${plSTRow}</div>
                            </div>
                        </div>

                        <!-- AI Deck / GY / Ban -->
                        <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
                            ${deckZone(D.ai.deck.length,'DK')}
                            ${gyZone(D.ai.graveyard,'GY')}
                            ${banZone(D.ai.banished)}
                        </div>

                        <!-- Player GY / Ban (bottom-left) -->
                        <div style="position:absolute;bottom:6px;left:6px;display:flex;flex-direction:column;gap:4px">
                            ${gyZone(D.player.graveyard,'GY')}
                            ${banZone(D.player.banished)}
                        </div>

                        <!-- Player Deck / Extra (bottom-right) -->
                        <div style="position:absolute;bottom:6px;right:6px;display:flex;flex-direction:column;gap:4px">
                            ${deckZone(D.player.deck.length,'DK')}
                            ${deckZone(D.player.extraDeck.length,'EX')}
                        </div>

                        <!-- Direct Attack button -->
                        ${showDirAtk?`<button onclick="duelDirectAttack()" style="position:absolute;inset:0;margin:auto;z-index:20;width:fit-content;height:fit-content;font-family:'Bangers',cursive;font-size:2rem;letter-spacing:.15em;padding:12px 40px;background:rgba(127,29,29,0.95);border:2px solid #ef4444;border-radius:12px;color:#fca5a5;cursor:pointer;box-shadow:0 0 30px rgba(239,68,68,0.6);animation:pulse 0.8s infinite"> DIRECT ATTACK!</button>`:''}
                    </div>

                    <!-- Player Hand -->
                    <div style="display:flex;align-items:flex-end;justify-content:center;gap:3px;padding:6px 8px;min-height:86px;background:#050b15;border-top:1px solid #0f3050;flex-shrink:0;overflow-x:auto">
                        ${playerHandHTML||'<span style="color:#374151;font-size:10px;font-family:monospace">No cards in hand</span>'}
                    </div>

                    <!-- Player Info -->
                    <div style="display:flex;align-items:center;gap:10px;padding:4px 14px;background:#06111e;border-top:1px solid #0f3050;flex-shrink:0">
                        <span style="font-family:'Bangers',cursive;font-size:17px;letter-spacing:.1em;color:#67e8f9">YOU</span>
                        ${lpBar(D.player.lp)}
                        <span style="margin-left:auto;font-size:9px;font-family:monospace;color:#4b5563">Hand:${D.player.hand.length} Deck:${D.player.deck.length}</span>
                    </div>
                </div><!-- /duel-field-inner -->
                <div id="duel-zoom-ind" style="position:absolute;bottom:4px;left:6px;pointer-events:none;font-family:monospace;font-size:9px;color:rgba(14,116,144,0.55);z-index:10">${Math.round(duelZoom*100)}%  scroll=zoom | drag=pan</div>
                </div><!-- /duel-viewport -->

                <!-- RIGHT PANEL -->
                <div style="width:152px;background:#030a14;border-left:1px solid #0f3050;display:flex;flex-direction:column;flex-shrink:0">
                    <div style="padding:8px;border-bottom:1px solid #0f3050">
                        <div style="font-size:8px;font-family:monospace;color:#155e75;margin-bottom:2px">TURN ${D.turnCount}</div>
                        <div style="font-family:'Bangers',cursive;font-size:14px;letter-spacing:.08em;color:${phaseColors[phase]||'#fff'}">${PHASE_LABELS[phase]||phase}</div>
                        <div style="font-size:8px;font-family:monospace;color:${isPlayerTurn?'#4ade80':'#f87171'}">${isPlayerTurn?' YOUR TURN':' OPP TURN'}</div>
                    </div>
                    ${isPlayerTurn
                        ?`<button onclick="advancePhasePlayer()" style="margin:8px;font-family:'Bangers',cursive;font-size:13px;letter-spacing:.08em;padding:8px;border-radius:6px;border:2px solid #0891b2;color:#67e8f9;background:rgba(8,145,178,0.15);cursor:pointer">${phaseBtnLabel}</button>`
                        :`<div style="margin:8px;font-family:'Bangers',cursive;font-size:11px;text-align:center;color:#374151;border:1px solid #111827;border-radius:6px;padding:8px">Opp's Turn</div>`
                    }
                    <div style="flex:1;overflow-y:auto;padding:6px;border-top:1px solid #0f3050" class="duel-log-scroll">
                        <div style="font-size:7px;font-family:monospace;color:#155e75;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Duel Log</div>
                        <div id="duel-log-content" style="font-size:8px;font-family:monospace;color:#0e7490">
                            ${D.log.map(m=>`<div style="border-bottom:1px solid rgba(14,116,144,0.2);padding:2px 0;line-height:1.3">${m}</div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
            setTimeout(attachDuelZoomHandlers, 0);
        }

        function showFieldCardPreview(cardId, event) { showCardPreview(cardId, event); }

        //  MONSTER MENU 
        const MONSTER_ACTIVATABLE=[10,15,16,17,18,86,89,92,93,97,99,100,166,175,177,178,188,189,199,207,209,217,226,234,235,236];

        function showMonsterMenu(owner, idx) {
            if (owner!=='player'||!duelState||duelState.turnPlayer!=='PLAYER') return;
            const slot=duelState.player.monsterZones[idx]; if(!slot) return;
            const card=getCardById(slot.id);
            let ex=document.getElementById('monster-menu'); if(ex) ex.remove();
            const canPos=!slot.summonedThisTurn&&!slot.positionChangedThisTurn;
            const hasEffect=MONSTER_ACTIVATABLE.includes(slot.id);
            const canEffect=hasEffect&&!slot.effectUsedThisTurn;
            const newPos=slot.position==='ATK'?'DEF':'ATK';
            const dlg=document.createElement('div');
            dlg.id='monster-menu';
            dlg.className='fixed inset-0 z-[820] bg-black/70 flex items-center justify-center';
            dlg.innerHTML=`<div style="background:#060d1c;border:2px solid #7c3aed;border-radius:14px;padding:20px;text-align:center;min-width:220px;box-shadow:0 0 30px rgba(124,58,237,0.3)">
                <p style="font-family:'Bangers',cursive;font-size:20px;letter-spacing:.1em;color:#c4b5fd;margin-bottom:2px">${card.name}</p>
                <p style="font-family:monospace;font-size:9px;color:#4b5563;margin-bottom:14px;padding:0 8px">${card.desc.substring(0,70)}${card.desc.length>70?'':''}</p>
                <div style="display:flex;flex-direction:column;gap:8px">
                    ${canPos
                        ?`<button onclick="document.getElementById('monster-menu').remove();changeMonsterPosition(${idx})" style="font-family:'Bangers',cursive;font-size:16px;letter-spacing:.08em;padding:8px 16px;background:#1e3a8a;border:2px solid #3b82f6;border-radius:8px;color:#fff;cursor:pointer">  ${newPos} Position</button>`
                        :`<div style="font-family:monospace;font-size:10px;color:#374151">Change Position: ${slot.summonedThisTurn?'(summoned this turn)':'(already changed)'}</div>`
                    }
                    ${canEffect
                        ?`<button onclick="document.getElementById('monster-menu').remove();activateMonsterEffect(${idx})" style="font-family:'Bangers',cursive;font-size:16px;letter-spacing:.08em;padding:8px 16px;background:#4c1d95;border:2px solid #a855f7;border-radius:8px;color:#fff;cursor:pointer"> Activate Effect</button>`
                        :(hasEffect?`<div style="font-family:monospace;font-size:10px;color:#374151">Effect used this turn</div>`:'')
                    }
                    <button onclick="document.getElementById('monster-menu').remove()" style="font-family:'Bangers',cursive;font-size:16px;letter-spacing:.08em;padding:8px 16px;background:#1f2937;border:2px solid #374151;border-radius:8px;color:#6b7280;cursor:pointer"> Cancel</button>
                </div>
            </div>`;
            document.body.appendChild(dlg);
        }

        function changeMonsterPosition(idx) {
            const slot=duelState.player.monsterZones[idx]; if(!slot) return;
            const newPos=slot.position==='ATK'?'DEF':'ATK';
            slot.position=newPos;
            // Manual position change always keeps the card face-up.
            // Only cards initially SET in defense start face-down.
            slot.faceDown=false;
            slot.positionChangedThisTurn=true;
            logDuel(`${getCardById(slot.id).name} changed to ${newPos} position.`);
            renderDuelField();
        }

        async function activateMonsterEffect(idx) {
            const slot=duelState.player.monsterZones[idx]; if(!slot) return;
            const card=getCardById(slot.id);
            switch(slot.id) {
                case 10: { // Cyber Magician: pick Spell to discard  pick enemy to destroy
                    const sp10=duelState.player.hand.map((id,i)=>({id,i,card:getCardById(id)})).filter(x=>x.card&&x.card.type==='SPELL');
                    if(!sp10.length){showToast('No Spell to discard!','error');return;}
                    const tgts10=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts10.length){showToast('No enemy monster!','error');return;}
                    const pickSpell=sp10.length===1?sp10[0]:await pickDuelChoice('Discard which Spell?',sp10,x=>`${x.card.name}`);
                    if(!pickSpell){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.player.hand.splice(pickSpell.i,1); duelState.player.graveyard.push(pickSpell.id);
                    const pickTgt10=tgts10.length===1?tgts10[0]:await pickDuelChoice('Destroy which enemy monster?',tgts10,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}/DEF:${getEffectiveDEF(duelState.ai.monsterZones[i])}`;},false);
                    if(pickTgt10===null){logDuel(`${card.name}: No target selected.`);return;}
                    logDuel(`${card.name}: Discard ${getCardById(pickSpell.id).name}  Destroy ${getCardById(duelState.ai.monsterZones[pickTgt10].id).name}!`);
                    duelState.ai.graveyard.push(duelState.ai.monsterZones[pickTgt10].id); duelState.ai.monsterZones[pickTgt10]=null;
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 15: showToast('Quantum Ninja attacks directly! Select it in Battle Phase.','info'); slot.effectUsedThisTurn=true; break;
                case 16: // Tech Healer: +500 LP
                    duelState.player.lp=Math.min(8000,duelState.player.lp+500);
                    logDuel(`${card.name}: Gain 500 LP! (LP:${duelState.player.lp})`); slot.effectUsedThisTurn=true; renderDuelField(); break;
                case 17: { // Scrap Mechanic: tribute self  pick+SS monster from GY
                    const gy17=duelState.player.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                    if(!gy17.length){showToast('No monster in GY!','error');return;}
                    const ezi17=duelState.player.monsterZones.findIndex((z,i)=>z===null&&i!==idx);
                    if(ezi17===-1){showToast('No empty zone!','error');return;}
                    const revPick=gy17.length===1?gy17[0]:await pickDuelChoice('Special Summon which monster from GY?',gy17,id=>{const c=getCardById(id);return `${c.name}  ATK:${c.atk}/DEF:${c.def}`;},false);
                    if(revPick===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.player.graveyard.push(slot.id); duelState.player.monsterZones[idx]=null;
                    duelState.player.monsterZones[ezi17]={id:revPick,position:'ATK',summonedThisTurn:true,faceDown:false};
                    duelState.player.graveyard=duelState.player.graveyard.filter(id=>id!==revPick);
                    logDuel(`${card.name}: SS ${getCardById(revPick).name} from GY!`);
                    renderDuelField(); break; }
                case 18: { // Omega Sentinel: pick any 1 enemy card to negate + destroy
                    const _aiSTs18=duelState.ai.spellTrapZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    const _aiMs18=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    const opts18=[
                        ..._aiMs18.map(i=>({zone:'monster',i,label:`Monster: ${getCardById(duelState.ai.monsterZones[i].id).name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`})),
                        ..._aiSTs18.map(i=>({zone:'st',i,label:`S/T: ${duelState.ai.spellTrapZones[i].faceDown?'Face-down card':getCardById(duelState.ai.spellTrapZones[i].id).name}`})),
                    ];
                    if(!opts18.length){showToast('No valid target for Omega Sentinel!','error');return;}
                    const pick18=opts18.length===1?opts18[0]:await pickDuelChoice('Negate & Destroy which card?',opts18,x=>x.label,false);
                    if(!pick18){logDuel(`${card.name}: Cancelled.`);return;}
                    if(pick18.zone==='monster'){logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick18.i].id).name} negated and destroyed!`);duelState.ai.graveyard.push(duelState.ai.monsterZones[pick18.i].id);duelState.ai.monsterZones[pick18.i]=null;}
                    else{logDuel(`${card.name}: ${getCardById(duelState.ai.spellTrapZones[pick18.i].id)?.name||'card'} negated and destroyed!`);duelState.ai.graveyard.push(duelState.ai.spellTrapZones[pick18.i].id);duelState.ai.spellTrapZones[pick18.i]=null;}
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 19: showToast('Void Phantom multi-attacks in Battle Phase  select it there!','info'); break;
                case 20: showToast('Celestial Phoenix auto-revives at End Phase when destroyed.','info'); break;
                case 21: showToast('Abyssal Leviathan effect triggers automatically on Summon.','info'); break;
                case 86: { // Glitch Gremlin  opponent discards 1 random card
                    if(duelState.ai.hand.length===0){showToast('Opponent has no cards in hand!','error');return;}
                    const ri=Math.floor(Math.random()*duelState.ai.hand.length);
                    const did=duelState.ai.hand.splice(ri,1)[0];
                    duelState.ai.graveyard.push(did);
                    logDuel(`${card.name}: Opponent discards ${getCardById(did)?.name||'a card'}!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 89: { // Nano Shield  reduce damage by 500 this turn
                    duelState.player.damageSponge=(duelState.player.damageSponge||0)+500;
                    logDuel(`${card.name}: Damage reduced by 500 until end of turn!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 92: { // Circuit Fairy  draw then pick card to discard
                    duelDraw('player');
                    if(duelState.player.hand.length>0){
                        const pick92=duelState.player.hand.length===1?duelState.player.hand[0]:await pickDuelChoice('Discard 1 card',duelState.player.hand.map(id=>id),id=>{const c=getCardById(id);return `${c.name} [${c.type}]${c.atk!==undefined?' ATK:'+c.atk:''}`;},false);
                        const did=pick92!==null?pick92:duelState.player.hand[0];
                        const hi=duelState.player.hand.indexOf(did); if(hi!==-1)duelState.player.hand.splice(hi,1);
                        duelState.player.graveyard.push(did);
                        logDuel(`${card.name}: Draw 1, discard ${getCardById(did)?.name||'a card'}!`);
                    } else { logDuel(`${card.name}: Drew 1 card!`); }
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 93: { // Rogue Process  pick enemy to lose 400 ATK
                    const tgts93=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts93.length){showToast('No enemy monster to target!','error');return;}
                    const pick93=tgts93.length===1?tgts93[0]:await pickDuelChoice('Target enemy monster (-400 ATK)',tgts93,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick93===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.ai.monsterZones[pick93].atkBuff=(duelState.ai.monsterZones[pick93].atkBuff||0)-400;
                    logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick93].id).name} loses 400 ATK!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 97: { // Storm Imp  coin flip +500 ATK for this battle
                    const heads=Math.random()<0.5;
                    if(heads){ slot.atkBuff=(slot.atkBuff||0)+500; logDuel(`${card.name}: Coin flip HEADS! +500 ATK this battle!`); }
                    else { logDuel(`${card.name}: Coin flip TAILS  no bonus.`); }
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 99: { // Crystal Turtle  switch to DEF and gain +800 DEF
                    slot.position='DEF'; slot.faceDown=false; slot.defBuff=(slot.defBuff||0)+800;
                    slot.positionChangedThisTurn=true;
                    logDuel(`${card.name}: Switches to DEF and gains +800 DEF until End Phase!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 100: { // Holo Phantom  set itself face-down
                    slot.position='DEF'; slot.faceDown=true; slot.positionChangedThisTurn=true;
                    logDuel(`${card.name}: Sets itself face-down  its identity is hidden!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 199: { // Fury Tyrant: discard 1  destroy 1 opponent monster
                    const sp199=duelState.player.hand.map((id,i)=>({id,i,card:getCardById(id)})).filter(x=>x.card);
                    if(!sp199.length){showToast('No cards to discard!','error');return;}
                    const tgts199=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts199.length){showToast('No enemy monster!','error');return;}
                    const pick199h=sp199.length===1?sp199[0]:await pickDuelChoice('Discard which card?',sp199,x=>`${x.card.name}`);
                    if(!pick199h){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.player.hand.splice(pick199h.i,1); duelState.player.graveyard.push(pick199h.id);
                    const pick199t=tgts199.length===1?tgts199[0]:await pickDuelChoice('Destroy which monster?',tgts199,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick199t===null){logDuel(`${card.name}: No target.`);return;}
                    logDuel(`${card.name}: Discard ${getCardById(pick199h.id).name}  Destroy ${getCardById(duelState.ai.monsterZones[pick199t].id).name}!`);
                    duelState.ai.graveyard.push(duelState.ai.monsterZones[pick199t].id); duelState.ai.monsterZones[pick199t]=null;
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 207: { // Tide Warden: draw 1 card
                    if(duelDraw('player')) logDuel(`${card.name}: Draws 1 card!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 209: { // Tide Emperor: gain 500 LP
                    duelState.player.lp=Math.min(8000,duelState.player.lp+500);
                    logDuel(`${card.name}: Gain 500 LP! (LP:${duelState.player.lp})`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 217: { // Abyss Sorcerer: opponent discards 1 random card
                    if(duelState.ai.hand.length===0){showToast('Opponent has no cards in hand!','error');return;}
                    const ri217=Math.floor(Math.random()*duelState.ai.hand.length);
                    const did217=duelState.ai.hand.splice(ri217,1)[0]; duelState.ai.graveyard.push(did217);
                    logDuel(`${card.name}: Opponent discards ${getCardById(did217)?.name||'a card'}!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 226: { // Grid Commander: target opponent monster 600 ATK
                    const tgts226=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts226.length){showToast('No enemy monster to target!','error');return;}
                    const pick226=tgts226.length===1?tgts226[0]:await pickDuelChoice('Target enemy monster (600 ATK)',tgts226,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick226===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.ai.monsterZones[pick226].atkBuff=(duelState.ai.monsterZones[pick226].atkBuff||0)-600;
                    logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick226].id).name} loses 600 ATK!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 234: { // Aurora Paladin: all your LIGHT monsters gain 400 ATK
                    let ct234=0;
                    duelState.player.monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='LIGHT'){s.atkBuff=(s.atkBuff||0)+400;ct234++;} });
                    logDuel(`${card.name}: ${ct234} LIGHT monster(s) gain +400 ATK!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 235: { // Aurora Sage: gain 300 LP
                    duelState.player.lp=Math.min(8000,duelState.player.lp+300);
                    logDuel(`${card.name}: Gain 300 LP! (LP:${duelState.player.lp})`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 236: { // Aurora Guardian: negate 1 opponent monster's effects
                    const tgts236=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts236.length){showToast('No enemy monster to target!','error');return;}
                    const pick236=tgts236.length===1?tgts236[0]:await pickDuelChoice('Negate which monster effect?',tgts236,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return `${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick236===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.ai.monsterZones[pick236].effectUsedThisTurn=true;
                    logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick236].id).name}'s effects are negated this turn!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 166: {
                    const tgts166=duelState.ai.monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(!tgts166.length){showToast('No enemy monster to target!','error');return;}
                    const pick166=tgts166.length===1?tgts166[0]:await pickDuelChoice('Target enemy monster (400 ATK)',tgts166,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return`${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick166===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.ai.monsterZones[pick166].atkBuff=(duelState.ai.monsterZones[pick166].atkBuff||0)-400;
                    logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick166].id).name} loses 400 ATK!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 175: { // Voidshard Crawler  discard 1, add 1 Trap from GY to hand
                    if(!duelState.player.hand.length){showToast('No cards to discard!','error');return;}
                    const traps175=duelState.player.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type==='TRAP';});
                    if(!traps175.length){showToast('No Trap in Graveyard!','error');return;}
                    const discPick=duelState.player.hand.length===1?duelState.player.hand[0]:await pickDuelChoice('Discard 1 card',duelState.player.hand.map(id=>id),id=>{const c=getCardById(id);return`${c.name} [${c.type}]`;},false);
                    if(discPick===null){logDuel(`${card.name}: Cancelled.`);return;}
                    const di=duelState.player.hand.indexOf(discPick);if(di!==-1)duelState.player.hand.splice(di,1);
                    duelState.player.graveyard.push(discPick);
                    const trapPick=traps175.length===1?traps175[0]:await pickDuelChoice('Add which Trap to hand?',traps175,id=>{const c=getCardById(id);return`${c.name}`;},false);
                    if(trapPick!==null){duelState.player.graveyard=duelState.player.graveyard.filter(g=>g!==trapPick);duelState.player.hand.push(trapPick);logDuel(`${card.name}: Discard ${getCardById(discPick).name}  retrieve ${getCardById(trapPick).name}!`);}
                    else logDuel(`${card.name}: Discarded  no Trap retrieved.`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 177: { // Null Cipher  draw 1, discard 1
                    duelDraw('player');
                    if(duelState.player.hand.length>0){
                        const pick177=duelState.player.hand.length===1?duelState.player.hand[0]:await pickDuelChoice('Discard 1 card',duelState.player.hand.map(id=>id),id=>{const c=getCardById(id);return`${c.name} [${c.type}]${c.atk!==undefined?' ATK:'+c.atk:''}`;},false);
                        const did177=pick177!==null?pick177:duelState.player.hand[0];
                        const hi=duelState.player.hand.indexOf(did177);if(hi!==-1)duelState.player.hand.splice(hi,1);
                        duelState.player.graveyard.push(did177);
                        logDuel(`${card.name}: Draw 1, discard ${getCardById(did177)?.name||'a card'}!`);
                    } else logDuel(`${card.name}: Drew 1 card!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 178: { // Chaos Revenant  negate 1 opp monster's effects (cannot attack this turn)
                    const tgts178=duelState.ai.monsterZones.map((s,i)=>s&&!s.faceDown?i:-1).filter(i=>i!==-1);
                    if(!tgts178.length){showToast('No face-up enemy monster!','error');return;}
                    const pick178=tgts178.length===1?tgts178[0]:await pickDuelChoice('Negate which monster?',tgts178,i=>{const c=getCardById(duelState.ai.monsterZones[i].id);return`${c.name}  ATK:${getEffectiveATK(duelState.ai.monsterZones[i])}`;},false);
                    if(pick178===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.ai.monsterZones[pick178].effectUsedThisTurn=true;
                    duelState.ai.monsterZones[pick178].cannotAttack=true;
                    logDuel(`${card.name}: ${getCardById(duelState.ai.monsterZones[pick178].id).name}'s effects negated and it cannot attack this turn!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 188: { // Aethon the Undying  SS 1 LIGHT from GY, destroyed at End Phase
                    const lights188=duelState.player.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION'&&c.attribute==='LIGHT';});
                    if(!lights188.length){showToast('No LIGHT monster in Graveyard!','error');return;}
                    const ezi188=duelState.player.monsterZones.findIndex((z,i)=>z===null&&i!==idx);
                    if(ezi188===-1){showToast('No empty zone!','error');return;}
                    const pick188=lights188.length===1?lights188[0]:await pickDuelChoice('Revive which LIGHT monster?',lights188,id=>{const c=getCardById(id);return`${c.name}  ATK:${c.atk}/DEF:${c.def}`;},false);
                    if(pick188===null){logDuel(`${card.name}: Cancelled.`);return;}
                    duelState.player.graveyard=duelState.player.graveyard.filter(g=>g!==pick188);
                    duelState.player.monsterZones[ezi188]={id:pick188,position:'ATK',summonedThisTurn:true,faceDown:false,cannotAttack:true,destroyAtEndPhase:true};
                    logDuel(`${card.name}: SS ${getCardById(pick188).name} from GY! (Destroyed at End Phase)`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                case 189: { // Apex Warden  draw 1, discard 1
                    duelDraw('player');
                    if(duelState.player.hand.length>0){
                        const pick189=duelState.player.hand.length===1?duelState.player.hand[0]:await pickDuelChoice('Discard 1 card',duelState.player.hand.map(id=>id),id=>{const c=getCardById(id);return`${c.name} [${c.type}]${c.atk!==undefined?' ATK:'+c.atk:''}`;},false);
                        const did189=pick189!==null?pick189:duelState.player.hand[0];
                        const hi189=duelState.player.hand.indexOf(did189);if(hi189!==-1)duelState.player.hand.splice(hi189,1);
                        duelState.player.graveyard.push(did189);
                        logDuel(`${card.name}: Draw 1, discard ${getCardById(did189)?.name||'a card'}!`);
                    } else logDuel(`${card.name}: Drew 1 card!`);
                    slot.effectUsedThisTurn=true; renderDuelField(); break; }
                default: logDuel(`${card.name} effect activates!`); break;
            }
        }

        function triggerOnSummonEffect(cardId, owner, zoneIdx) {
            if (cardId===21) { // Abyssal Leviathan: destroy all Spells/Traps, +500 ATK per card
                const side=duelState[owner]; let ct=0;
                ['player','ai'].forEach(who=>{
                    duelState[who].spellTrapZones.forEach((s,i)=>{if(s){logDuel(`Abyssal Leviathan: ${getCardById(s.id).name} destroyed!`);duelState[who].graveyard.push(s.id);duelState[who].spellTrapZones[i]=null;ct++;}});
                });
                const mSlot=side.monsterZones[zoneIdx];
                if(ct&&mSlot){mSlot.atkBuff=(mSlot.atkBuff||0)+ct*500;logDuel(`Abyssal Leviathan gains ${ct*500} ATK from ${ct} destroyed card(s)!`);}
                else logDuel('Abyssal Leviathan: No Spell/Trap cards to destroy.');
                return;
            }
            // Shadow Wisp (95): when SS from hand, deal 300 damage
            if (cardId===95 && owner==='player') {
                duelState.ai.lp=Math.max(0,duelState.ai.lp-300);
                logDuel(`Shadow Wisp: Inflicts 300 damage to opponent! (Opp LP:${duelState.ai.lp})`);
                return;
            }
            // Nemesis Void Reaper (146): on summon, send 1 random card from opponent's hand to GY
            if (cardId===146) {
                const enemy=owner==='player'?'ai':'player';
                const eHand=duelState[enemy].hand;
                if(eHand.length){const ri=Math.floor(Math.random()*eHand.length);const did=eHand.splice(ri,1)[0];duelState[enemy].graveyard.push(did);logDuel(`Nemesis Void Reaper: Sends ${getCardById(did)?.name||'a card'} from ${enemy==='ai'?"opponent's":'your'} hand to the GY!`);}
                else logDuel('Nemesis Void Reaper: Opponent has no cards in hand.');
                return;
            }
            // Omega Genesis Leviathan (155): on summon, destroy all opponent's monsters + 500 LP each
            if (cardId===155) {
                const enemy=owner==='player'?'ai':'player';
                let ct155=0;
                duelState[enemy].monsterZones.forEach((s,i)=>{if(s){logDuel(`Omega Genesis Leviathan obliterates ${getCardById(s.id).name}!`);duelState[enemy].graveyard.push(s.id);duelState[enemy].monsterZones[i]=null;ct155++;}});
                if(ct155){duelState[enemy].lp=Math.max(0,duelState[enemy].lp-ct155*500);logDuel(`Omega Genesis Leviathan: ${ct155} monster(s) obliterated  ${ct155*500} damage! (${enemy==='ai'?'Opp':'Your'} LP:${duelState[enemy].lp})`);}
                else logDuel('Omega Genesis Leviathan: No enemy monsters to destroy.');
                return;
            }
            // Omega Seraph Eternal (156): on summon, restore controller's LP to 8000
            if (cardId===156) {
                const prev=duelState[owner].lp;
                duelState[owner].lp=8000;
                logDuel(`Omega Seraph Eternal: ${owner==='player'?'Your':'Opponent'} LP restored to 8000! (was ${prev})`);
                return;
            }
            // Genesis Revenant (162): on summon, SS 1 LIGHT monster from GY with lower ATK
            if (cardId===162) {
                const side162=duelState[owner];
                const eligible162=side162.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION'&&c.attribute==='LIGHT'&&(c.atk||0)<2900;});
                const ezi162=side162.monsterZones.findIndex((z,i)=>z===null&&i!==zoneIdx);
                if(eligible162.length&&ezi162!==-1){const rid=eligible162[eligible162.length-1];side162.monsterZones[ezi162]={id:rid,position:'ATK',summonedThisTurn:true,faceDown:false};side162.graveyard=side162.graveyard.filter(g=>g!==rid);logDuel(`Genesis Revenant: Special Summons ${getCardById(rid).name} from GY!`);}
                else logDuel('Genesis Revenant: No eligible LIGHT monster in GY to revive.');
                return;
            }
            // Ironfang Drake (165): on summon, all FIRE monsters on field gain +400 ATK
            if (cardId===165) {
                let ct165=0;
                ['player','ai'].forEach(who=>{
                    duelState[who].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='FIRE'){s.atkBuff=(s.atkBuff||0)+400;ct165++;} });
                });
                logDuel(`Ironfang Drake: ${ct165} FIRE monster(s) gain +400 ATK this turn!`);
                return;
            }
            // Volcan Djinn (167): on Normal Summon, inflict 400 damage to opponent
            if (cardId===167) {
                const enemy167=owner==='player'?'ai':'player';
                duelState[enemy167].lp=Math.max(0,duelState[enemy167].lp-400);
                logDuel(`Volcan Djinn: Inflicts 400 damage! (${enemy167==='ai'?'Opp':'Your'} LP:${duelState[enemy167].lp})`);
                return;
            }
            // Ferroflux Beast (180): on Normal Summon, destroy 1 opp Spell/Trap
            if (cardId===180) {
                const enemy180=owner==='player'?'ai':'player';
                const eST180=duelState[enemy180].spellTrapZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(eST180.length){const ti=eST180[0];logDuel(`Ferroflux Beast: Destroys ${getCardById(duelState[enemy180].spellTrapZones[ti].id)?.name||'card'}!`);duelState[enemy180].graveyard.push(duelState[enemy180].spellTrapZones[ti].id);duelState[enemy180].spellTrapZones[ti]=null;}
                else logDuel('Ferroflux Beast: No opponent Spell/Trap to destroy.');
                return;
            }
            // Solaris Titan (187): on Normal Summon, gain 500 LP
            if (cardId===187) {
                duelState[owner].lp=Math.min(8000,duelState[owner].lp+500);
                logDuel(`Solaris Titan: ${owner==='player'?'You gain':'Opponent gains'} 500 LP! (LP:${duelState[owner].lp})`);
                return;
            }
            // Verdant Colossus (190): on Normal Summon, destroy all opp DEF position monsters
            if (cardId===190) {
                const enemy190=owner==='player'?'ai':'player';
                let ct190=0;
                duelState[enemy190].monsterZones.forEach((s,i)=>{ if(s&&s.position==='DEF'){logDuel(`Verdant Colossus crushes ${getCardById(s.id).name} in DEF!`);duelState[enemy190].graveyard.push(s.id);duelState[enemy190].monsterZones[i]=null;ct190++;} });
                if(!ct190) logDuel('Verdant Colossus: No DEF position monsters to destroy.');
                return;
            }
            // Fury Hatchling (197): on Normal Summon, gain 200 LP per FIRE monster you control
            if (cardId===197) {
                let ct197=0;
                duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='FIRE') ct197++; });
                if(ct197>0){ duelState[owner].lp=Math.min(8000,duelState[owner].lp+ct197*200); logDuel(`Fury Hatchling: ${ct197} FIRE monster(s)  Gain ${ct197*200} LP! (LP:${duelState[owner].lp})`); }
                return;
            }
            // Fury Ascendant (201): on Fusion Summon, destroy all opponent Spell/Traps
            if (cardId===201) {
                const enemy201=owner==='player'?'ai':'player'; let ct201=0;
                duelState[enemy201].spellTrapZones.forEach((s,i)=>{ if(s){logDuel(`Fury Ascendant: ${getCardById(s.id)?.name||'card'} incinerated!`);duelState[enemy201].graveyard.push(s.id);duelState[enemy201].spellTrapZones[i]=null;ct201++;} });
                if(!ct201) logDuel('Fury Ascendant: No opponent Spell/Traps to destroy.');
                return;
            }
            // Fury Warlord (200): on Summon, all your FIRE monsters gain 300 ATK
            if (cardId===200) {
                let ct200=0;
                duelState[owner].monsterZones.forEach(s=>{ if(s&&getCardById(s.id)?.attribute==='FIRE'){s.atkBuff=(s.atkBuff||0)+300;ct200++;} });
                logDuel(`Fury Warlord: ${ct200} FIRE monster(s) gain +300 ATK!`);
                return;
            }
            // Tide Sprite (206): on Normal Summon, draw 1 then discard 1
            if (cardId===206) {
                duelDraw(owner);
                const side206=duelState[owner];
                if(side206.hand.length>0){
                    const ri=Math.floor(Math.random()*side206.hand.length);
                    const did=side206.hand.splice(ri,1)[0]; side206.graveyard.push(did);
                    logDuel(`Tide Sprite: Draw 1, discard ${getCardById(did)?.name||'a card'}!`);
                }
                return;
            }
            // Tide Marshal (208): on Summon, return 1 opponent monster to hand
            if (cardId===208) {
                const enemy208=owner==='player'?'ai':'player';
                const mons208=duelState[enemy208].monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(mons208.length){
                    const ti=mons208[0]; const mid=duelState[enemy208].monsterZones[ti].id;
                    duelState[enemy208].hand.push(mid); duelState[enemy208].monsterZones[ti]=null;
                    logDuel(`Tide Marshal: Returns ${getCardById(mid).name} to ${enemy208==='ai'?"opponent's":'your'} hand!`);
                } else logDuel('Tide Marshal: No opponent monster to bounce.');
                return;
            }
            // Tide Emperor (209): on Summon, draw 2 then discard 1
            if (cardId===209) {
                duelDraw(owner); duelDraw(owner);
                const side209=duelState[owner];
                if(side209.hand.length>0){
                    const ri=Math.floor(Math.random()*side209.hand.length);
                    const did=side209.hand.splice(ri,1)[0]; side209.graveyard.push(did);
                    logDuel(`Tide Emperor: Draw 2, discard ${getCardById(did)?.name||'a card'}!`);
                }
                return;
            }
            // Tidal Sovereign (210): on Fusion Summon, mill 3 from opponent's deck
            if (cardId===210) {
                const enemy210=owner==='player'?'ai':'player';
                let milled=0;
                for(let i=0;i<3;i++){ if(duelState[enemy210].deck.length){const id=duelState[enemy210].deck.shift();duelState[enemy210].graveyard.push(id);milled++;} }
                logDuel(`Tidal Sovereign: Mills ${milled} card(s) from ${enemy210==='ai'?"opponent's":'your'} deck!`);
                return;
            }
            // Abyss Pawn (215): on Normal Summon, opponent discards 1 random card
            if (cardId===215) {
                const enemy215=owner==='player'?'ai':'player';
                if(duelState[enemy215].hand.length){
                    const ri=Math.floor(Math.random()*duelState[enemy215].hand.length);
                    const did=duelState[enemy215].hand.splice(ri,1)[0]; duelState[enemy215].graveyard.push(did);
                    logDuel(`Abyss Pawn: ${enemy215==='ai'?'Opponent':'You'} discard${enemy215==='ai'?'s':''} ${getCardById(did)?.name||'a card'}!`);
                } else logDuel('Abyss Pawn: No cards to discard.');
                return;
            }
            // Abyss Tyrant (218): on Summon, destroy all opponent ST cards
            if (cardId===218) {
                const enemy218=owner==='player'?'ai':'player';
                let ct218=0;
                duelState[enemy218].spellTrapZones.forEach((s,i)=>{ if(s){logDuel(`Abyss Tyrant: ${getCardById(s.id)?.name||'card'} is destroyed!`);duelState[enemy218].graveyard.push(s.id);duelState[enemy218].spellTrapZones[i]=null;ct218++;} });
                if(!ct218) logDuel('Abyss Tyrant: No opponent Spell/Traps to destroy.');
                return;
            }
            // Abyssal Sovereign (219): on Fusion Summon, opponent discards 2
            if (cardId===219) {
                const enemy219=owner==='player'?'ai':'player';
                let discarded=0;
                for(let i=0;i<2;i++){ if(duelState[enemy219].hand.length){const ri=Math.floor(Math.random()*duelState[enemy219].hand.length);const did=duelState[enemy219].hand.splice(ri,1)[0];duelState[enemy219].graveyard.push(did);logDuel(`Abyssal Sovereign: ${getCardById(did)?.name||'a card'} discarded!`);discarded++;} }
                if(!discarded) logDuel('Abyssal Sovereign: Opponent has no hand cards to discard.');
                return;
            }
            // Grid Drone (224): on Normal Summon, deal 300 damage
            if (cardId===224) {
                const enemy224=owner==='player'?'ai':'player';
                duelState[enemy224].lp=Math.max(0,duelState[enemy224].lp-300);
                logDuel(`Grid Drone: Pulse blast! ${enemy224==='ai'?'Opp':'Your'} LP 300 (LP:${duelState[enemy224].lp})`);
                return;
            }
            // Grid Overlord (227): on Summon, destroy 1 opponent monster
            if (cardId===227) {
                const enemy227=owner==='player'?'ai':'player';
                const mons227=duelState[enemy227].monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                if(mons227.length){
                    const ti=mons227[0]; logDuel(`Grid Overlord: Destroys ${getCardById(duelState[enemy227].monsterZones[ti].id).name}!`);
                    duelState[enemy227].graveyard.push(duelState[enemy227].monsterZones[ti].id); duelState[enemy227].monsterZones[ti]=null;
                } else logDuel('Grid Overlord: No opponent monster to destroy.');
                return;
            }
            // Grid Titan (228): on Fusion Summon, draw 2 cards
            if (cardId===228) {
                duelDraw(owner); duelDraw(owner);
                logDuel(`Grid Titan: Drew 2 cards!`);
                return;
            }
            // Aurora Acolyte (233): on Normal Summon, gain 500 LP
            if (cardId===233) {
                duelState[owner].lp=Math.min(8000,duelState[owner].lp+500);
                logDuel(`Aurora Acolyte: ${owner==='player'?'You gain':'Opponent gains'} 500 LP! (LP:${duelState[owner].lp})`);
                return;
            }
            // Aurora Sage (235): on Summon, draw 1 card
            if (cardId===235) {
                if(duelDraw(owner)) logDuel(`Aurora Sage: Draws 1 card upon blessing!`);
                return;
            }
            // Aurora Divinity (237): on Fusion Summon, gain 2000 LP and draw 1
            if (cardId===237) {
                duelState[owner].lp=Math.min(8000,duelState[owner].lp+2000);
                logDuel(`Aurora Divinity: ${owner==='player'?'You gain':'Opponent gains'} 2000 LP! (LP:${duelState[owner].lp})`);
                if(duelDraw(owner)) logDuel(`Aurora Divinity: Drew 1 card!`);
                return;
            }
            if (cardId!==12) return; // Speed Router only
            const side=duelState[owner];
            const lvl3=side.hand.map((id,i)=>({id,i,card:getCardById(id)})).find(x=>x.card&&x.card.type!=='SPELL'&&x.card.type!=='TRAP'&&x.card.type!=='FUSION'&&x.card.level===3&&x.id!==cardId);
            if(!lvl3)return;
            const zi=side.monsterZones.findIndex((z,i)=>z===null&&i!==zoneIdx);
            if(zi===-1)return;
            side.monsterZones[zi]={id:lvl3.id,position:'ATK',summonedThisTurn:true,faceDown:false};
            side.hand.splice(lvl3.i,1);
            logDuel(`${getCardById(cardId).name} effect: Special Summon ${lvl3.card.name}!`);
        }

        // Show card back for opponent face-down cards
        function showFaceDownBack(event) {
            let preview = document.getElementById('card-preview-overlay');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'card-preview-overlay';
                preview.className = 'fixed z-[200] pointer-events-none transition-opacity duration-150';
                document.body.appendChild(preview);
            }
            const defSlv = CARD_SLEEVES[0];
            const slvSVG = defSlv.svgPreview.replace(/width="72" height="98"/, 'width="224" height="320" preserveAspectRatio="xMidYMid slice"');
            preview.innerHTML = `<div style="width:224px;height:320px;border-radius:12px;overflow:hidden;border:2.5px solid ${defSlv.border};box-shadow:0 10px 30px rgba(0,0,0,0.85);position:relative">${slvSVG}</div>`;
            preview.style.opacity = '1';
            positionCardPreview(event);
        }

        // Fly-in card draw animation
        function showDrawAnimation(callback) {
            const vpEl = document.getElementById('duel-viewport');
            const rect = vpEl ? vpEl.getBoundingClientRect() : {left:window.innerWidth*0.55,top:window.innerHeight*0.35,width:300,height:400};
            const startX = rect.left + rect.width * 0.82 - 22;
            const startY = rect.top  + rect.height * 0.44 - 31;
            const endX   = rect.left + rect.width * 0.48 - 22;
            const endY   = rect.top  + rect.height * 0.88 - 31;
            const el = document.createElement('div');
            el.style.cssText = `position:fixed;z-index:850;pointer-events:none;width:44px;height:62px;border-radius:5px;background:#1e1b4b;border:2px solid #00e5ff;box-shadow:0 0 18px 3px rgba(0,229,255,0.8);left:${startX}px;top:${startY}px;opacity:0;display:flex;align-items:center;justify-content:center;transition:left 0.46s cubic-bezier(0.25,0.8,0.25,1),top 0.46s cubic-bezier(0.25,0.8,0.25,1),opacity 0.15s`;
            el.innerHTML = `<div style="width:24px;height:24px;background:repeating-linear-gradient(45deg,#1a1740 0,#1a1740 5px,#26237a 5px,#26237a 10px);border:1.5px solid #4338ca;border-radius:3px"></div>`;
            document.body.appendChild(el);
            requestAnimationFrame(()=>requestAnimationFrame(()=>{
                el.style.opacity = '1';
                setTimeout(()=>{
                    el.style.left = endX+'px';
                    el.style.top  = endY+'px';
                    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>{ el.remove(); callback(); },140); },470);
                }, 90);
            }));
        }

        // Zoom/pan helpers
        function applyDuelTransform() {
            const el = document.getElementById('duel-field-inner');
            if (el) el.style.transform = `scale(${duelZoom}) translate(${duelPanX}px,${duelPanY}px)`;
            const ind = document.getElementById('duel-zoom-ind');
            if (ind) ind.textContent = `${Math.round(duelZoom*100)}%  scroll=zoom | drag=pan`;
        }

        function attachDuelZoomHandlers() {
            const vp = document.getElementById('duel-viewport');
            if (!vp || vp._zoomAttached) return;
            vp._zoomAttached = true;
            vp.addEventListener('wheel', (e) => {
                e.preventDefault();
                duelZoom = Math.max(0.3, Math.min(2.4, duelZoom + (e.deltaY < 0 ? 0.09 : -0.09)));
                applyDuelTransform();
            }, {passive: false});
            vp.addEventListener('mousedown', e => {
                const clickedInteractive = e.target.closest('[onclick], button, input');
                if (e.button === 1 || (e.button === 0 && !clickedInteractive)) {
                    duelDragging=true; duelDragLastX=e.clientX; duelDragLastY=e.clientY;
                    vp.style.cursor='grabbing'; e.preventDefault();
                }
            });
            window.addEventListener('mousemove', e => {
                if (!duelDragging) return;
                duelPanX += (e.clientX - duelDragLastX) / duelZoom;
                duelPanY += (e.clientY - duelDragLastY) / duelZoom;
                duelDragLastX=e.clientX; duelDragLastY=e.clientY;
                applyDuelTransform();
            });
            window.addEventListener('mouseup', () => {
                if (duelDragging) { duelDragging=false; const v=document.getElementById('duel-viewport'); if(v) v.style.cursor='grab'; }
            });
        }

        // Player trap flip-activation (click own face-down trap)
        function activatePlayerTrap(zoneIdx) {
            if (!duelState || duelState.turnPlayer!=='PLAYER') return;
            const slot = duelState.player.spellTrapZones[zoneIdx];
            if (!slot || !slot.faceDown) return;
            const card = getCardById(slot.id);
            if (!card || card.type!=='TRAP') return;
            if (slot.activatedThisTurn) { showToast('Already activated!','error'); return; }
            slot.faceDown = false; slot.activatedThisTurn = true;
            logDuel(`You flip-activate: ${card.name}!`);
            applyTrapEffectWithContext(slot.id, 'player', 'PLAYER_ACTIVATE', null);
            setTimeout(()=>{
                if (!duelState) return;
                duelState.player.graveyard.push(slot.id);
                duelState.player.spellTrapZones[zoneIdx]=null;
                renderDuelField();
            }, 900);
            renderDuelField();
        }

                //  CHAIN SYSTEM 
        // Which trap IDs can respond to which triggers
        const CHAIN_ON_ATTACK =[70,71,72,73,105,158,161,184,195,204,213,231,240];   // negates/destroys attacker
        const CHAIN_ON_SPELL  =[75,106,150,158,182,223,232,241];              // negates spell
        const CHAIN_ON_SUMMON =[72,173,214];             // on-summon traps
        const CHAIN_MONSTER_IDS=[18];            // Omega Sentinel as chain

        function getPlayerChainOptions(trigger) {
            if (!duelState) return [];
            const opts=[];
            // Face-down traps
            duelState.player.spellTrapZones.forEach((slot,idx)=>{
                if (!slot||!slot.faceDown||slot.activatedThisTurn) return;
                const card=getCardById(slot.id);
                if (!card||card.type!=='TRAP') return;
                const ok=(trigger==='ATTACK'&&CHAIN_ON_ATTACK.includes(slot.id))||
                          (trigger==='SPELL' &&CHAIN_ON_SPELL .includes(slot.id))||
                          (trigger==='SUMMON'&&CHAIN_ON_SUMMON.includes(slot.id));
                if (ok) opts.push({type:'trap',zoneIdx:idx,cardId:slot.id,label:card.name,desc:card.desc});
            });
            // Monster effects usable as chain
            if (trigger==='ATTACK'||trigger==='SPELL') {
                duelState.player.monsterZones.forEach((slot,idx)=>{
                    if (!slot||slot.effectUsedThisTurn||slot.faceDown) return;
                    if (CHAIN_MONSTER_IDS.includes(slot.id)) {
                        const card=getCardById(slot.id);
                        opts.push({type:'monster',zoneIdx:idx,cardId:slot.id,label:card.name+' Effect',desc:card.desc});
                    }
                });
            }
            return opts;
        }

        function askPlayerChain(trigger, context) {
            const opts=getPlayerChainOptions(trigger);
            if (!opts.length) return Promise.resolve(null);
            return new Promise(resolve=>{
                let countdown=8, timer;
                const resolve_=choice=>{
                    clearInterval(timer);
                    const dlg=document.getElementById('chain-window');
                    if (dlg) dlg.remove();
                    resolve(choice);
                };
                const trigLabel=trigger==='ATTACK'?' Opponent declares an attack!':
                                 trigger==='SPELL' ?' Opponent activates a Spell!':
                                                    ' Opponent Summons a monster!';
                const dlg=document.createElement('div');
                dlg.id='chain-window';
                dlg.style.cssText='position:fixed;inset:0;z-index:910;display:flex;align-items:flex-end;justify-content:center;pointer-events:none';
                dlg.innerHTML=`<div style="pointer-events:auto;margin-bottom:96px;background:#060d1c;border:2px solid #7c3aed;border-radius:14px;padding:16px 20px;box-shadow:0 0 35px rgba(124,58,237,0.6);min-width:280px;max-width:500px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                        <span style="font-family:'Bangers',cursive;font-size:18px;letter-spacing:.12em;color:#c4b5fd"> CHAIN?</span>
                        <span style="font-family:monospace;font-size:9px;color:#6b7280;flex:1">${trigLabel}</span>
                        <span id="chain-countdown" style="font-family:'Bangers',cursive;font-size:22px;color:#f87171;min-width:20px;text-align:right">${countdown}</span>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
                        ${opts.map((o,i)=>`<button data-chain-idx="${i}" style="font-family:'Bangers',cursive;font-size:13px;letter-spacing:.06em;padding:7px 13px;background:${o.type==='trap'?'#4c1d95':'#1e3a8a'};border:2px solid ${o.type==='trap'?'#a855f7':'#3b82f6'};border-radius:8px;color:#fff;cursor:pointer" title="${o.desc}">${o.type==='trap'?'':''} ${o.label}</button>`).join('')}
                    </div>
                    <button data-chain-pass style="font-family:'Bangers',cursive;font-size:13px;padding:6px 16px;background:#1f2937;border:2px solid #374151;border-radius:8px;color:#6b7280;cursor:pointer;width:100%"> Pass (do nothing)</button>
                </div>`;
                dlg.addEventListener('click',e=>{
                    const btn=e.target.closest('[data-chain-idx]');
                    if (btn){resolve_(opts[parseInt(btn.dataset.chainIdx)]);return;}
                    if (e.target.closest('[data-chain-pass]')){resolve_(null);}
                });
                document.body.appendChild(dlg);
                timer=setInterval(()=>{
                    countdown--;
                    const el=document.getElementById('chain-countdown');
                    if (el) el.textContent=countdown;
                    if (countdown<=0) resolve_(null);
                },1000);
            });
        }

        function resolveChainPick(pick, trigger, context, done) {
            if (!pick||!duelState){done();return;}
            if (pick.type==='trap') {
                const slot=duelState.player.spellTrapZones[pick.zoneIdx];
                if (!slot){done();return;}
                slot.faceDown=false; slot.activatedThisTurn=true;
                logDuel(`You chain: ${getCardById(pick.cardId).name}!`);
                applyTrapEffectWithContext(pick.cardId,'player',trigger,context);
                renderDuelField();
                setTimeout(()=>{
                    if (!duelState){done();return;}
                    const fi=duelState.player.spellTrapZones.findIndex(s=>s&&s.id===pick.cardId);
                    if (fi!==-1){duelState.player.graveyard.push(pick.cardId);duelState.player.spellTrapZones[fi]=null;}
                    renderDuelField(); done();
                },800);
            } else if (pick.type==='monster') {
                applyTrapEffectWithContext(pick.cardId,'player',trigger,context);
                const ms=duelState.player.monsterZones[pick.zoneIdx];
                if (ms) ms.effectUsedThisTurn=true;
                renderDuelField();
                setTimeout(done,700);
            }
        }

        function applyTrapEffectWithContext(cardId, owner, trigger, context) {
            SoundEngine.trap();
            const side=duelState[owner], enemy=owner==='player'?'ai':'player';
            const card=getCardById(cardId);
            switch(cardId) {
                case 70: { // 404 Not Found  negate attack
                    logDuel(`${card.name}: The attack is negated!`);
                    if (context) context.attackNegated=true; break; }
                case 71: { // DDoS Attack  destroy attacking monster
                    if (trigger==='ATTACK'&&context&&context.attackerIdx!==undefined) {
                        const aS=duelState[context.attackerOwner];
                        const aSlot=aS.monsterZones[context.attackerIdx];
                        if (aSlot){logDuel(`${card.name}: ${getCardById(aSlot.id).name} is destroyed!`);aS.graveyard.push(aSlot.id);aS.monsterZones[context.attackerIdx]=null;}
                        if (context) context.attackNegated=true;
                    } else {
                        const ts=duelState[enemy].monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                        if (ts.length){const ti=ts[0];logDuel(`${card.name}: ${getCardById(duelState[enemy].monsterZones[ti].id).name} destroyed!`);duelState[enemy].graveyard.push(duelState[enemy].monsterZones[ti].id);duelState[enemy].monsterZones[ti]=null;}
                        else logDuel(`${card.name}: No valid target!`);
                    } break; }
                case 72: { // Lag Spike  opponent monsters can't attack this turn
                    duelState.ai.monsterZones.forEach(s=>{if(s)s.cannotAttack=true;});
                    logDuel(`${card.name}: Opponent's monsters cannot attack this turn!`);
                    if (context) context.attackNegated=true; break; }
                case 73: { // Mirror Forcefield  destroy all ATK-position opponent monsters
                    let ct=0;
                    duelState.ai.monsterZones.forEach((s,i)=>{if(s&&s.position==='ATK'){logDuel(`${card.name}: ${getCardById(s.id).name} destroyed!`);duelState.ai.graveyard.push(s.id);duelState.ai.monsterZones[i]=null;ct++;}});
                    if(!ct) logDuel(`${card.name}: No ATK-position monsters to destroy!`);
                    if (context&&ct) context.attackNegated=true; break; }
                case 74: { // Backup File  return last destroyed player monster to hand
                    const mons=side.graveyard.filter(id=>{const c=getCardById(id);return c&&c.type!=='SPELL'&&c.type!=='TRAP'&&c.type!=='FUSION';});
                    if (mons.length){const id=mons[mons.length-1];side.graveyard=side.graveyard.filter(g=>g!==id);side.hand.push(id);logDuel(`${card.name}: ${getCardById(id).name} returned to hand!`);}
                    else logDuel(`${card.name}: No monster in Graveyard!`); break; }
                case 75: { // Magic Jammer  negate Spell
                    logDuel(`${card.name}: Spell activation negated!`);
                    if (context) context.spellNegated=true; break; }
                case 18: { // Omega Sentinel  negate effect and optionally destroy a card
                    logDuel(`Omega Sentinel: Effect negated!`);
                    if (context){context.attackNegated=true;context.spellNegated=true;}
                    const aiSTs2=duelState.ai.spellTrapZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                    if(aiSTs2.length){const ti=aiSTs2[0];logDuel(`Omega Sentinel also destroys ${getCardById(duelState.ai.spellTrapZones[ti].id).name}!`);duelState.ai.graveyard.push(duelState.ai.spellTrapZones[ti].id);duelState.ai.spellTrapZones[ti]=null;}
                    break; }
                                    case 105: { // Reflect Shield  attacker takes DEF damage
                    const defMonsters=duelState[owner].monsterZones.filter(s=>s);
                    if(context&&context.attackingSlot&&defMonsters.length){
                        const tgt=defMonsters[0];
                        const def=getEffectiveDEF(tgt);
                        const enemy=owner==='player'?'ai':'player';
                        duelState[enemy].lp=Math.max(0,duelState[enemy].lp-def);
                        if(context)context.attackNegated=true;
                        logDuel(`Reflect Shield: ${enemy==='ai'?'Opp':'You'} take ${def} damage from reflected DEF!`);
                    } else {
                        // Used manually: reflect strongest DEF monster's value
                        const myMonsters=duelState[owner].monsterZones.filter(s=>s);
                        if(myMonsters.length){
                            const def=Math.max(...myMonsters.map(s=>getEffectiveDEF(s)));
                            const enemy=owner==='player'?'ai':'player';
                            duelState[enemy].lp=Math.max(0,duelState[enemy].lp-def);
                            logDuel(`Reflect Shield: Opponent takes ${def} reflective DEF damage!`);
                        }
                    }
                    break; }
                case 106: { // Chain Overload  negate spell + 500 damage  
                    if(context)context.spellNegated=true;
                    const enemy=owner==='player'?'ai':'player';
                    duelState[enemy].lp=Math.max(0,duelState[enemy].lp-500);
                    logDuel(`Chain Overload! Opponent's Spell is negated and takes 500 damage!`);
                    break; }
                case 150: { // Nemesis Lockdown  negate opponent's card effect and banish it
                    if(context){context.spellNegated=true;context.attackNegated=true;}
                    const eSTs150=duelState[enemy].spellTrapZones.map((s,i)=>s&&!s.faceDown?i:-1).filter(i=>i!==-1);
                    if(eSTs150.length){const ti=eSTs150[0];const bid=duelState[enemy].spellTrapZones[ti].id;duelState[enemy].banished.push(bid);duelState[enemy].spellTrapZones[ti]=null;logDuel(`Nemesis Lockdown: ${getCardById(bid)?.name||'card'} is banished!`);}
                    else logDuel('Nemesis Lockdown: Effect negated!'); break; }
                case 158: { // Source Protocol Zero  negate attack or spell
                    logDuel('Source Protocol Zero: NEGATED!');
                    if(context){context.attackNegated=true;context.spellNegated=true;} break; }
                case 161: { // Omega Sovereign Veil  negate attack + protect all your monsters this turn
                    logDuel('Omega Sovereign Veil: Attack negated! All your monsters are protected!');
                    if(context) context.attackNegated=true;
                    duelState[owner].monsterZones.forEach(s=>{if(s) s.sovereignVeil=true;}); break; }
                case 182: { // Signal Disrupt  negate opponent's Spell activation
                    logDuel('Signal Disrupt: Spell intercepted and destroyed!');
                    if(context) context.spellNegated=true; break; }
                case 184: { // Cascade Null  negate attack, attacker loses 800 ATK
                    logDuel('Cascade Null: Attack cascade collapsed!');
                    if(context) context.attackNegated=true;
                    if(context&&context.attackerIdx!==undefined){
                        const aSlot184=duelState[context.attackerOwner].monsterZones[context.attackerIdx];
                        if(aSlot184){ aSlot184.atkBuff=(aSlot184.atkBuff||0)-800; logDuel(`Cascade Null: ${getCardById(aSlot184.id).name} loses 800 ATK until end of turn!`); }
                    } break; }
                case 195: { // Nexus Collapse  destroy all opponent monsters (on attack)
                    const enemy195=owner==='player'?'ai':'player';
                    let ct195=0;
                    duelState[enemy195].monsterZones.forEach((s,i)=>{ if(s){logDuel(`Nexus Collapse obliterates ${getCardById(s.id).name}!`);duelState[enemy195].graveyard.push(s.id);duelState[enemy195].monsterZones[i]=null;ct195++;} });
                    if(ct195) logDuel(`Nexus Collapse: ${ct195} monster(s) destroyed!`);
                    else logDuel('Nexus Collapse: No enemy monsters.');
                    if(context) context.attackNegated=true; break; }
                case 204: { // Fury Claw  destroy attacker, inflict 500
                    if(trigger==='ATTACK'&&context&&context.attackerIdx!==undefined){
                        const aS204=duelState[context.attackerOwner]; const aSlot204=aS204.monsterZones[context.attackerIdx];
                        if(aSlot204){logDuel(`Fury Claw: ${getCardById(aSlot204.id).name} clawed to pieces!`);aS204.graveyard.push(aSlot204.id);aS204.monsterZones[context.attackerIdx]=null;}
                        const enemy204=owner==='player'?'ai':'player'; duelState[enemy204].lp=Math.max(0,duelState[enemy204].lp-500);
                        logDuel(`Fury Claw: 500 sear damage! (${enemy204==='ai'?'Opp':'Your'} LP:${duelState[enemy204].lp})`);
                    } else logDuel('Fury Claw: No valid attack to counter.');
                    if(context) context.attackNegated=true; break; }
                case 213: { // Tidal Lock  negate attack, gain 800 LP
                    logDuel('Tidal Lock: The tide holds! Attack negated!');
                    if(context) context.attackNegated=true;
                    duelState[owner].lp=Math.min(8000,duelState[owner].lp+800);
                    logDuel(`Tidal Lock: Gain 800 LP! (LP:${duelState[owner].lp})`); break; }
                case 214: { // Riptide  return summoned monster to hand (on summon)
                    if(trigger==='SUMMON'&&context&&context.summonedOwner!==undefined&&context.summonedIdx!==undefined){
                        const sOwner=context.summonedOwner; const sIdx=context.summonedIdx;
                        const sSlot=duelState[sOwner].monsterZones[sIdx];
                        if(sSlot){ const mid=sSlot.id; duelState[sOwner].hand.push(mid); duelState[sOwner].monsterZones[sIdx]=null; logDuel(`Riptide: ${getCardById(mid).name} swept back to hand!`); }
                    } else { const eMons=duelState[enemy].monsterZones.map((s,i)=>s?i:-1).filter(i=>i!==-1);
                        if(eMons.length){ const ti=eMons[0]; const mid=duelState[enemy].monsterZones[ti].id; duelState[enemy].hand.push(mid); duelState[enemy].monsterZones[ti]=null; logDuel(`Riptide: ${getCardById(mid).name} returned to hand!`); } }
                    if(context) context.attackNegated=true; break; }
                case 223: { // Abyss Snare  negate opponent's Spell
                    logDuel('Abyss Snare: Spell consumed by the abyss!');
                    if(context) context.spellNegated=true; break; }
                case 231: { // Grid Firewall  negate attack (ATK2000), halve ATK
                    logDuel('Grid Firewall: Firewall engaged! Attack blocked!');
                    if(context) context.attackNegated=true;
                    if(context&&context.attackerIdx!==undefined){
                        const aSlot231=duelState[context.attackerOwner].monsterZones[context.attackerIdx];
                        if(aSlot231&&getEffectiveATK(aSlot231)>=2000){ aSlot231.atkHalve=true; logDuel(`Grid Firewall: ${getCardById(aSlot231.id).name} ATK is halved!`); }
                    } break; }
                case 232: { // Grid Override  negate Spell, deal 600 damage
                    logDuel('Grid Override: Signal overridden! Spell negated!');
                    if(context) context.spellNegated=true;
                    duelState[enemy].lp=Math.max(0,duelState[enemy].lp-600);
                    logDuel(`Grid Override: 600 feedback damage! (${enemy==='ai'?'Opp':'Your'} LP:${duelState[enemy].lp})`); break; }
                case 240: { // Aurora Veil  negate attack, gain 1000 LP
                    logDuel('Aurora Veil: Divine veil shields the attack!');
                    if(context) context.attackNegated=true;
                    duelState[owner].lp=Math.min(8000,duelState[owner].lp+1000);
                    logDuel(`Aurora Veil: Gain 1000 LP! (LP:${duelState[owner].lp})`); break; }
                case 241: { // Holy Barrier  negate Spell, gain 800 LP
                    logDuel('Holy Barrier: Heavenly barrier blocks the Spell!');
                    if(context) context.spellNegated=true;
                    duelState[owner].lp=Math.min(8000,duelState[owner].lp+800);
                    logDuel(`Holy Barrier: Gain 800 LP! (LP:${duelState[owner].lp})`); break; }
                default: logDuel(`${card?card.name:'Card'} effect activates!`);
            }
        }

        //  Daily Reward Helpers 
        const DAILY_REWARDS = [
            { day: 1, label: '$50',              icon: '', desc: '50 Credits' },
            { day: 2, label: '$75',              icon: '', desc: '75 Credits' },
            { day: 3, label: 'Pack',             icon: '', desc: 'Starter Circuit Pack' },
            { day: 4, label: '$100 + R Card',    icon: '', desc: '100 Credits + Rare Card' },
            { day: 5, label: 'Pack',             icon: '', desc: 'Magma & Metal Pack' },
            { day: 6, label: '$150 + SR Card',   icon: '', desc: '150 Credits + SR Card' },
            { day: 7, label: 'APEX Pack',        icon: '', desc: 'Apex Genesis Pack or $200' },
        ];

        function canClaimDaily() {
            const { lastClaimed } = gameState.dailyReward;
            return !lastClaimed || (Date.now() - lastClaimed > 86400000);
        }

        function renderDailyRewardButton() {
            const canClaim = canClaimDaily();
            return `
                <button onclick="openDailyModal()"
                        class="relative flex items-center gap-2 px-3 py-1 rounded border-2 font-bold text-sm transition-all hover:brightness-110 ${canClaim ? 'border-yellow-400 text-yellow-300 bg-yellow-900/30 animate-pulse' : 'border-gray-600 text-gray-500 bg-gray-900/40'}">
                    ${canClaim ? ' DAILY REWARD!' : ' Daily Claimed'}
                </button>`;
        }

        function buildDailyRewardDays() {
            const { currentDay } = gameState.dailyReward;
            return DAILY_REWARDS.map((r, i) => {
                const dayNum = i + 1;
                const isCurrent = dayNum === currentDay;
                const isPast    = dayNum < currentDay;
                let cls = 'rounded-lg p-1.5 flex flex-col items-center border ';
                if (isCurrent && canClaimDaily()) cls += 'border-yellow-400 bg-yellow-900/30 shadow-[0_0_12px_rgba(255,220,0,0.4)]';
                else if (isPast)                  cls += 'border-gray-700 bg-gray-900/50 opacity-50';
                else                              cls += 'border-cyan-800/40 bg-cyan-900/10 opacity-70';
                return `
                <div class="${cls}">
                    <div class="text-lg leading-none">${isPast ? '' : r.icon}</div>
                    <div class="text-[8px] font-mono text-cyan-400 mt-0.5 text-center leading-tight font-bold">DAY ${dayNum}</div>
                    <div class="text-[8px] font-mono text-white text-center leading-tight mt-0.5">${r.label}</div>
                </div>`;
            }).join('');
        }

        function buildDailyClaimButton() {
            const can = canClaimDaily();
            const r   = DAILY_REWARDS[(gameState.dailyReward.currentDay - 1) % 7];
            if (!can) {
                const msLeft = 86400000 - (Date.now() - gameState.dailyReward.lastClaimed);
                const h = Math.floor(msLeft / 3600000);
                const m = Math.floor((msLeft % 3600000) / 60000);
                return `<div class="text-center text-gray-500 font-mono text-sm py-2">Next reward in <span class="text-cyan-400 font-bold">${h}h ${m}m</span></div>`;
            }
            return `
                <button onclick="claimDailyReward()"
                        class="w-full font-[Bangers] text-2xl tracking-widest py-2 rounded-lg border-2 border-yellow-400 bg-yellow-900/40 text-yellow-300 shadow-[0_0_20px_rgba(255,220,0,0.4)] hover:brightness-115 active:scale-[0.98] transition-all">
                     CLAIM: ${r.desc}
                </button>`;
        }

        function claimDailyReward() {
            const idx = (gameState.dailyReward.currentDay - 1) % 7;
            const r   = DAILY_REWARDS[idx];

            // Apply reward
            if (r.day === 3) {
                buyPackSilent('p1', 1);
                showToast('Daily Reward: 1 Starter Circuit Pack!', 'info');
            } else if (r.day === 4) {
                gameState.money += 100;
                grantRandomCard('R');
                showToast('Daily Reward: $100 + a Rare Card!', 'info');
            } else if (r.day === 5) {
                buyPackSilent('p2', 1);
                showToast('Daily Reward: 1 Magma & Metal Pack!', 'info');
            } else if (r.day === 6) {
                gameState.money += 150;
                grantRandomCard('SR');
                showToast('Daily Reward: $150 + a Super Rare Card!', 'info');
            } else if (r.day === 7) {
                buyPackSilent('p4', 1);
                gameState.money += 200;
                showToast('Daily Reward: Apex Genesis Pack + $200!', 'info');
            } else {
                const credits = r.day === 1 ? 50 : 75;
                gameState.money += credits;
                showToast(`Daily Reward: $${credits} Credits!`, 'info');
            }

            gameState.dailyReward.lastClaimed = Date.now();
            gameState.dailyReward.currentDay  = (gameState.dailyReward.currentDay % 7) + 1;
            closeDailyModal();
            renderDuel();
        }

        function buyPackSilent(packId, amount) {
            const pack = PACKS.find(p => p.id === packId);
            for (let i = 0; i < amount; i++) {
                for (let j = 0; j < 5; j++) {
                    const cardId = pack.list[Math.floor(Math.random() * pack.list.length)];
                    gameState.inventory[cardId] = (gameState.inventory[cardId] || 0) + 1;
                }
            }
        }

        function grantRandomCard(rarity) {
            const pool = CARD_DB.filter(c => c.rarity === rarity);
            if (!pool.length) return null;
            const card = pool[Math.floor(Math.random() * pool.length)];
            gameState.inventory[card.id] = (gameState.inventory[card.id] || 0) + 1;
            return card;
        }

        function openDailyModal() {
            document.getElementById('daily-modal').classList.remove('hidden');
        }

        function closeDailyModal(e) {
            if (e && e.target !== document.getElementById('daily-modal')) return;
            document.getElementById('daily-modal').classList.add('hidden');
        }

// --- UTILS ---

        // Card Preview Overlay
        function showCardPreview(cardId, event) {
            let preview = document.getElementById('card-preview-overlay');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'card-preview-overlay';
                preview.className = 'fixed z-[200] pointer-events-none transition-opacity duration-150';
                preview.style.filter = 'drop-shadow(0 0 20px rgba(0,229,255,0.6))';
                document.body.appendChild(preview);
            }

            const card = getCardById(cardId);
            preview.innerHTML = renderCardHTML(card, 'w-56', 'h-80');
            preview.style.opacity = '1';
            positionCardPreview(event);
        }

        function positionCardPreview(event) {
            const preview = document.getElementById('card-preview-overlay');
            if (!preview) return;
            const PAD = 16;
            const pw = 224, ph = 320; // w-56 = 224px, h-80 = 320px
            let x = event.clientX + PAD;
            let y = event.clientY - ph / 2;
            if (x + pw > window.innerWidth) x = event.clientX - pw - PAD;
            if (y < 0) y = PAD;
            if (y + ph > window.innerHeight) y = window.innerHeight - ph - PAD;
            preview.style.left = x + 'px';
            preview.style.top = y + 'px';
        }

        function hideCardPreview() {
            const preview = document.getElementById('card-preview-overlay');
            if (preview) preview.style.opacity = '0';
        }

        function showToast(msg, type='info') {
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 ${colors} text-white px-6 py-3 rounded shadow-xl font-bold z-[100] animate-bounce`;
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // 
        //  SOUND ENGINE  Procedural Web Audio API (no external files)
        // 
        const SoundEngine = (function () {
            let ctx = null, bgmGain, sfxGain, sharedNoiseBuf = null;
            let bgmStop = null, enabled = true;
            const BGM_VOL = 0.30, SFX_VOL = 0.68;

            function boot() {
                if (ctx) return;
                ctx = new (window.AudioContext || window.webkitAudioContext)();
                bgmGain = ctx.createGain(); bgmGain.gain.value = BGM_VOL; bgmGain.connect(ctx.destination);
                sfxGain = ctx.createGain(); sfxGain.gain.value = SFX_VOL; sfxGain.connect(ctx.destination);
            }
            function resume() { if (ctx && ctx.state === 'suspended') ctx.resume(); }
            function noiseBuf() {
                if (!sharedNoiseBuf) {
                    sharedNoiseBuf = ctx.createBuffer(1, ctx.sampleRate * 3, ctx.sampleRate);
                    const d = sharedNoiseBuf.getChannelData(0);
                    for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
                }
                return sharedNoiseBuf;
            }
            function tone(freq, type, at, dur, amp, dest) {
                boot(); resume();
                const now = ctx.currentTime + at;
                const o = ctx.createOscillator(), g = ctx.createGain();
                o.type = type; o.frequency.value = freq;
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(amp, now + 0.008);
                g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
                o.connect(g); g.connect(dest || sfxGain);
                o.start(now); o.stop(now + dur + 0.02);
            }
            function noise(at, dur, amp, freq, dest) {
                boot(); resume();
                const now = ctx.currentTime + at;
                const s = ctx.createBufferSource(); s.buffer = noiseBuf();
                const f = ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = freq;
                const g = ctx.createGain(); g.gain.setValueAtTime(amp, now); g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
                s.connect(f); f.connect(g); g.connect(dest || sfxGain);
                s.start(now); s.stop(now + dur + 0.05);
            }
            function stopBGM(fade = 1.2) { if (bgmStop) { bgmStop(fade); bgmStop = null; } }
            function makeBus() {
                const bus = ctx.createGain();
                bus.gain.setValueAtTime(0, ctx.currentTime);
                bus.gain.linearRampToValueAtTime(1, ctx.currentTime + 1.5);
                bus.connect(bgmGain); return bus;
            }
            function busStop(bus) {
                return (fade = 1.2) => {
                    bus.gain.setTargetAtTime(0, ctx.currentTime, fade / 5);
                    setTimeout(() => { try { bus.disconnect(); } catch (e) {} }, (fade + 1) * 1000);
                };
            }

            //  SFX 
            function sfxClick()    { boot(); resume(); tone(1100,'sine',0,0.05,0.12); }
            function sfxCardDraw() {
                boot(); resume();
                const o = ctx.createOscillator(), g = ctx.createGain(), now = ctx.currentTime;
                o.type = 'sawtooth'; o.frequency.setValueAtTime(280, now); o.frequency.exponentialRampToValueAtTime(1200, now + 0.16);
                g.gain.setValueAtTime(0.18, now); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);
                o.connect(g); g.connect(sfxGain); o.start(now); o.stop(now + 0.28);
            }
            function sfxCardFlip() { noise(0, 0.06, 0.28, 7000); tone(1000,'sine', 0.01, 0.07, 0.09); }
            function sfxSummon() {
                boot(); resume();
                const o = ctx.createOscillator(), g = ctx.createGain(), now = ctx.currentTime;
                o.type = 'sine'; o.frequency.setValueAtTime(130, now); o.frequency.exponentialRampToValueAtTime(40, now + 0.45);
                g.gain.setValueAtTime(0.55, now); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.55);
                o.connect(g); g.connect(sfxGain); o.start(now); o.stop(now + 0.62);
                [440, 554, 659, 880].forEach((f, i) => tone(f, 'sine', i * 0.04, 0.55, 0.11));
                noise(0, 0.14, 0.35, 2800);
            }
            function sfxAttack() {
                noise(0, 0.1, 0.45, 9000);
                boot(); resume();
                const o = ctx.createOscillator(), g = ctx.createGain(), now = ctx.currentTime;
                o.type = 'sawtooth'; o.frequency.setValueAtTime(900, now); o.frequency.exponentialRampToValueAtTime(180, now + 0.15);
                g.gain.setValueAtTime(0.28, now); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
                o.connect(g); g.connect(sfxGain); o.start(now); o.stop(now + 0.22);
            }
            function sfxDestroy()   { noise(0,0.06,0.65,7000); noise(0.06,0.5,0.45,1200); tone(190,'sawtooth',0,0.35,0.22); tone(110,'sine',0,0.45,0.28); }
            function sfxDirectHit() { noise(0,0.5,0.55,1000); tone(75,'sine',0,0.65,0.42); tone(48,'sine',0.08,0.5,0.32); }
            function sfxSpell()     { [880,1100,1320,1760].forEach((f,i) => tone(f,'sine',i*0.055,0.38,0.1)); noise(0,0.18,0.14,5500); }
            function sfxTrap()      { noise(0,0.07,0.52,4500); tone(210,'square',0,0.22,0.16); tone(105,'sine',0.06,0.32,0.22); }
            function sfxLPDamage()  { tone(140,'sine',0,0.22,0.32); noise(0,0.14,0.35,1800); }
            function sfxLPGain()    { [660,880,1047].forEach((f,i) => tone(f,'sine',i*0.07,0.32,0.14)); }
            function sfxPackOpen() {
                [261,329,392,523,659,784,1047].forEach((f,i) => tone(f,'triangle',i*0.08,0.65,0.18));
                noise(0,0.3,0.28,3200);
                setTimeout(() => { [1047,1319,1568].forEach((f,i) => tone(f,'sine',i*0.05,0.55,0.18)); }, 520);
            }
            function sfxPackCard(isUR) {
                if (isUR) { [440,554,659,880,1108,1319].forEach((f,i) => tone(f,'sine',i*0.06,0.9,0.22)); setTimeout(()=>noise(0,0.3,0.35,4500),320); }
                else { tone(660,'sine',0,0.28,0.15); tone(880,'sine',0.05,0.22,0.13); noise(0,0.1,0.18,3500); }
            }
            function sfxWin()  { [523,659,784,1047,784,1047,1319].forEach((f,i)=>tone(f,'triangle',0.11*i,0.32,0.28)); [261,329,392].forEach((f,i)=>tone(f,'sine',0,1.1,0.15)); }
            function sfxLose() { [392,349,294,261,220].forEach((f,i)=>tone(f,'sine',0.22*i,0.55,0.22)); }
            function sfxWheelSpin() {
                boot(); resume();
                for (let i = 0; i < 65; i++) {
                    const ratio = i / 65, speed = ratio < 0.4 ? ratio / 0.4 : 1;
                    const delay = i * (28 + speed * 115);
                    if (delay > 4900) break;
                    setTimeout(() => { noise(0,0.022,0.22,6000); tone(750+Math.random()*500,'sine',0,0.022,0.07); }, delay);
                }
            }
            function sfxWheelResult(good) {
                if (good) [523,659,784,1047].forEach((f,i) => tone(f,'sine',i*0.09,0.42,0.22));
                else      { tone(300,'sine',0,0.42,0.22); tone(210,'sine',0.18,0.55,0.22); }
            }
            let scratchBusy = false;
            function sfxScratch() {
                if (scratchBusy) return; boot(); resume(); scratchBusy = true;
                const now = ctx.currentTime, s = ctx.createBufferSource(); s.buffer = noiseBuf();
                const f = ctx.createBiquadFilter(); f.type = 'bandpass'; f.frequency.value = 3200; f.Q.value = 0.9;
                const g = ctx.createGain(); g.gain.value = 0.38;
                s.connect(f); f.connect(g); g.connect(sfxGain); s.start(now); s.stop(now + 0.11);
                s.onended = () => { scratchBusy = false; };
            }
            function sfxScratchReveal() { [523,622,784].forEach((f,i)=>tone(f,'sine',i*0.09,0.42,0.2)); noise(0,0.22,0.28,4500); }
            function sfxSlotSpin() {
                boot(); resume();
                for (let i = 0; i < 12; i++) setTimeout(() => { noise(0,0.028,0.22,7000); tone(380+Math.random()*320,'square',0,0.028,0.09); }, i * 72);
            }
            function sfxSlotCol()  { noise(0,0.04,0.38,8000); tone(520,'sine',0,0.07,0.14); }
            function sfxSlotWin(rare) {
                if (rare) [330,415,523,659,830,1047,1319].forEach((f,i)=>tone(f,'sine',i*0.07,0.55,0.24));
                else      [523,659,784].forEach((f,i)=>tone(f,'triangle',i*0.09,0.42,0.2));
            }

            //  BGM 
            function playMenuBGM() {
                if (!enabled) return; boot(); resume(); stopBGM(0.8);
                const bus = makeBus(); let active = true;
                [[55,0.20],[110,0.13],[165,0.07],[220,0.04]].forEach(([freq,amp]) => {
                    const o=ctx.createOscillator(), g=ctx.createGain(), lfo=ctx.createOscillator(), lg=ctx.createGain();
                    o.type='sine'; o.frequency.value=freq; lfo.type='sine'; lfo.frequency.value=0.07+Math.random()*0.04; lg.gain.value=1.8;
                    lfo.connect(lg); lg.connect(o.frequency);
                    g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(amp,ctx.currentTime+2);
                    o.connect(g); g.connect(bus); o.start(); lfo.start();
                });
                const padO=ctx.createOscillator(), padG=ctx.createGain(), padL=ctx.createOscillator(), padLG=ctx.createGain();
                padO.type='triangle'; padO.frequency.value=220; padL.frequency.value=0.025; padLG.gain.value=6;
                padL.connect(padLG); padLG.connect(padO.frequency);
                padG.gain.setValueAtTime(0,ctx.currentTime); padG.gain.linearRampToValueAtTime(0.07,ctx.currentTime+3);
                padO.connect(padG); padG.connect(bus); padO.start(); padL.start();
                const sparkF=[440,528,660,792,880,1056];
                let spT; function sparkle(){ if(!active)return; tone(sparkF[Math.floor(Math.random()*sparkF.length)],'sine',0,2.0,0.03,bus); spT=setTimeout(sparkle,3000+Math.random()*5000); } spT=setTimeout(sparkle,2000);
                const _bs = busStop(bus); bgmStop = (fade) => { active=false; clearTimeout(spT); _bs(fade); };
            }

            function playShopBGM() {
                if (!enabled) return; boot(); resume(); stopBGM(0.8);
                const bus=makeBus(); let active=true;
                const BPM=88, beat=60/BPM, bar=beat*4;
                let next=ctx.currentTime+0.12, barN=0;
                const bassNotes=[110,110,138.6,110,123.5,110,130.8,110];
                const bassR=[0,0.75,1,1.75,2,2.5,3,3.5];
                const chords=[[220,277.2,329.6],[246.9,311.1,370],[261.6,329.6,392],[293.7,370,440]];
                const mel=[[440,0],[523,1],[587,1.5],[523,2],[440,2.5],[392,3]];
                function bar_fn(t,b){
                    if(!active) return; const ch=chords[b%4];
                    [0,beat*2].forEach(off=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(90,t+off); o.frequency.exponentialRampToValueAtTime(44,t+off+0.09); g.gain.setValueAtTime(0.38,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.18); o.connect(g); g.connect(bus); o.start(t+off); o.stop(t+off+0.22); });
                    [beat,beat*3].forEach(off=>{ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=2300; f.Q.value=1; const g=ctx.createGain(); g.gain.setValueAtTime(0.16,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.11); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.13); });
                    for(let i=0;i<8;i++){ const off=i*beat*0.5; const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=8000; const g=ctx.createGain(); g.gain.setValueAtTime(0.055,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.035); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.045); }
                    bassR.forEach((rb,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=bassNotes[i]; const dur=beat*0.44; g.gain.setValueAtTime(0.2,t+rb*beat); g.gain.exponentialRampToValueAtTime(0.0001,t+rb*beat+dur); o.connect(g); g.connect(bus); o.start(t+rb*beat); o.stop(t+rb*beat+dur+0.04); });
                    ch.forEach(f=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.055,t+beat*0.4); g.gain.setValueAtTime(0.055,t+bar-beat*0.25); g.gain.linearRampToValueAtTime(0,t+bar); o.connect(g); g.connect(bus); o.start(t); o.stop(t+bar+0.04); });
                    mel.forEach(([f,off])=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=f; const d=beat*0.38; g.gain.setValueAtTime(0.065,t+off*beat); g.gain.exponentialRampToValueAtTime(0.0001,t+off*beat+d); o.connect(g); g.connect(bus); o.start(t+off*beat); o.stop(t+off*beat+d+0.04); });
                }
                function loop(){ if(!active)return; while(next<ctx.currentTime+0.5){ bar_fn(next,barN); next+=bar; barN++; } setTimeout(loop,100); } loop();
                const _bs=busStop(bus); bgmStop=(f)=>{active=false;_bs(f);};
            }

            function playMapBGM() {
                if (!enabled) return; boot(); resume(); stopBGM(0.8);
                const bus=makeBus(); let active=true;
                const chords=[[82.4,110,164.8],[87.3,130.8,174.6],[98,123.5,196],[87.3,116.5,174.6]];
                let ci=0;
                function chord_fn(){ if(!active)return; const ch=chords[ci%4]; ci++; ch.forEach(f=>{ [1,2,4].forEach(m=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f*m; const a=m===1?0.11:m===2?0.055:0.02; const now=ctx.currentTime; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(a,now+1.8); g.gain.setValueAtTime(a,now+3.2); g.gain.linearRampToValueAtTime(0,now+4.8); o.connect(g); g.connect(bus); o.start(now); o.stop(now+5.2); }); }); if(active) setTimeout(chord_fn,4200); } chord_fn();
                let arpT; function arp(){if(!active)return; const b=[220,246.9,261.6,293.7][Math.floor(Math.random()*4)]; [1,1.25,1.5,2,2.5,3,4].forEach((m,i)=>tone(b*m,'triangle',i*0.16,0.85,0.035,bus)); arpT=setTimeout(arp,6500+Math.random()*8000);} arpT=setTimeout(arp,3500);
                let hbT; function hb(){if(!active)return; tone(58,'sine',0,0.12,0.14,bus); tone(58,'sine',0.13,0.09,0.1,bus); hbT=setTimeout(hb,1900+Math.random()*700);} hbT=setTimeout(hb,800);
                const _bs=busStop(bus); bgmStop=(f)=>{active=false;clearTimeout(arpT);clearTimeout(hbT);_bs(f);};
            }

            //  Duel BGM Variant A: Original 130 BPM driving battle 
            function _duelBGM_A(bus) {
                let active=true;
                const BPM=130, beat=60/BPM, bar=beat*4;
                let next=ctx.currentTime+0.05, barN=0;
                const tensions=[[110,130.8,155.6],[123.5,146.8,174.6],[116.5,138.6,164.8],[103.8,123.5,155.6]];
                function bar_fn(t,b){
                    if(!active)return; const ch=tensions[b%4];
                    for(let i=0;i<8;i++){ const off=i*beat*0.5; const o=ctx.createOscillator(),g=ctx.createGain(); o.type='square'; o.frequency.value=ch[0]*(i%2===0?1:1.5); g.gain.setValueAtTime(0.065,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+beat*0.38); o.connect(g); g.connect(bus); o.start(t+off); o.stop(t+off+beat*0.5); }
                    ch.forEach(f=>{ const o=ctx.createOscillator(),filt=ctx.createBiquadFilter(),g=ctx.createGain(); o.type='sawtooth'; o.frequency.value=f; filt.type='lowpass'; filt.frequency.value=480; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.07,t+0.12); g.gain.setValueAtTime(0.07,t+bar-0.1); g.gain.linearRampToValueAtTime(0,t+bar); o.connect(filt); filt.connect(g); g.connect(bus); o.start(t); o.stop(t+bar+0.1); });
                    [0,beat*2].forEach(off=>{ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=280; const g=ctx.createGain(); g.gain.setValueAtTime(0.2,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.1); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.12); });
                    [beat,beat*3].forEach(off=>{ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=3200; const g=ctx.createGain(); g.gain.setValueAtTime(0.1,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.06); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.08); });
                    if(b%4===3){ [110,138.6,164.8,220].forEach((f,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f; const st=t+bar-beat+i*0.04; g.gain.setValueAtTime(0.065,st); g.gain.exponentialRampToValueAtTime(0.0001,st+0.55); o.connect(g); g.connect(bus); o.start(st); o.stop(st+0.58); }); }
                }
                function loop(){ if(!active)return; while(next<ctx.currentTime+0.5){ bar_fn(next,barN); next+=bar; barN++; } setTimeout(loop,100); } loop();
                const _bs=busStop(bus); bgmStop=(f)=>{active=false;_bs(f);};
            }

            //  Duel BGM Variant B: Dark ominous 108 BPM half-time 
            function _duelBGM_B(bus) {
                let active=true;
                const BPM=108, beat=60/BPM, bar=beat*4;
                let next=ctx.currentTime+0.05, barN=0;
                const chords=[[73.4,92.5,110],[82.4,98,123.5],[69.3,87.3,116.5],[77.8,92.5,130.8]];
                const bassSeq=[55,52,49,46,44,46,49,52];
                function bar_fn(t,b){
                    if(!active)return; const ch=chords[b%4];
                    // Heavy half-time kick
                    [{off:0,lp:220,vol:0.32,dur:0.22},{off:beat*2.5,lp:180,vol:0.14,dur:0.16}].forEach(({off,lp,vol,dur})=>{
                        const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=lp; const g=ctx.createGain();
                        g.gain.setValueAtTime(vol,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+dur); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+dur+0.04);
                    });
                    // Snare only on beat 3
                    { const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=2100; f.Q.value=0.8; const g=ctx.createGain();
                      g.gain.setValueAtTime(0.18,t+beat*2); g.gain.exponentialRampToValueAtTime(0.0001,t+beat*2+0.12); s.connect(f); f.connect(g); g.connect(bus); s.start(t+beat*2); s.stop(t+beat*2+0.16); }
                    // Ghost 16th hi-hats
                    for(let i=0;i<16;i++){ const off=i*beat*0.25; const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=9500; const g=ctx.createGain(); g.gain.setValueAtTime(i%2===0?0.018:0.009,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.025); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.035); }
                    // Dark filtered sawtooth pad
                    ch.forEach(f=>{ const o=ctx.createOscillator(),flt=ctx.createBiquadFilter(),g=ctx.createGain(); o.type='sawtooth'; o.frequency.value=f; flt.type='lowpass'; flt.frequency.value=340; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.055,t+beat*0.9); g.gain.setValueAtTime(0.055,t+bar-beat*0.5); g.gain.linearRampToValueAtTime(0,t+bar); o.connect(flt); flt.connect(g); g.connect(bus); o.start(t); o.stop(t+bar+0.1); });
                    // Descending chromatic bass
                    bassSeq.forEach((freq,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=freq; const off=i*beat*0.5,dur=beat*0.42; g.gain.setValueAtTime(0.22,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+dur); o.connect(g); g.connect(bus); o.start(t+off); o.stop(t+off+dur+0.04); });
                    // Accent stab on bar 1 of every 4-bar phrase
                    if(b%4===0){ [55,69.3,82.4].forEach((f,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='square'; o.frequency.value=f; const st=t+i*0.04; g.gain.setValueAtTime(0.055,st); g.gain.exponentialRampToValueAtTime(0.0001,st+bar*0.32); o.connect(g); g.connect(bus); o.start(st); o.stop(st+bar*0.36); }); }
                }
                function loop(){ if(!active)return; while(next<ctx.currentTime+0.5){ bar_fn(next,barN); next+=bar; barN++; } setTimeout(loop,100); } loop();
                const _bs=busStop(bus); bgmStop=(f)=>{active=false;_bs(f);};
            }

            //  Duel BGM Variant C: Aggressive fast 148 BPM assault 
            function _duelBGM_C(bus) {
                let active=true;
                const BPM=148, beat=60/BPM, bar=beat*4;
                let next=ctx.currentTime+0.04, barN=0;
                const chords=[[116.5,155.6,196],[130.8,164.8,207.7],[110,146.8,185],[123.5,174.6,220]];
                const arpPat=[55,82.4,69.3,103.8,55,77.8,65.4,98];
                function bar_fn(t,b){
                    if(!active)return; const ch=chords[b%4];
                    // Four-on-the-floor kick
                    [0,beat,beat*2,beat*3].forEach(off=>{ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=200; const g=ctx.createGain(); g.gain.setValueAtTime(0.28,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.14); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.18); });
                    // Punchy snare on 2 & 4
                    [beat,beat*3].forEach(off=>{ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=2600; f.Q.value=1.1; const g=ctx.createGain(); g.gain.setValueAtTime(0.22,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.1); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.14); });
                    // Open 8th hi-hats
                    for(let i=0;i<8;i++){ const off=i*beat*0.5; const s=ctx.createBufferSource(); s.buffer=noiseBuf(); const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=7800; const g=ctx.createGain(); g.gain.setValueAtTime(i===0?0.09:0.04,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+0.055); s.connect(f); f.connect(g); g.connect(bus); s.start(t+off); s.stop(t+off+0.07); }
                    // Dissonant power-chord pad
                    ch.forEach(f=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sawtooth'; o.frequency.value=f; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.06,t+0.07); g.gain.setValueAtTime(0.06,t+bar-0.07); g.gain.linearRampToValueAtTime(0,t+bar); o.connect(g); g.connect(bus); o.start(t); o.stop(t+bar+0.05); });
                    // Sub-octave doubler
                    ch.forEach(f=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='square'; o.frequency.value=f*0.5; g.gain.setValueAtTime(0.03,t); g.gain.setValueAtTime(0.03,t+bar-0.05); g.gain.linearRampToValueAtTime(0,t+bar); o.connect(g); g.connect(bus); o.start(t); o.stop(t+bar+0.05); });
                    // 16th-note arpeggiated bass drive
                    arpPat.forEach((freq,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='square'; o.frequency.value=freq; const off=i*beat*0.5,dur=beat*0.36; g.gain.setValueAtTime(0.18,t+off); g.gain.exponentialRampToValueAtTime(0.0001,t+off+dur); o.connect(g); g.connect(bus); o.start(t+off); o.stop(t+off+dur+0.02); });
                    // Rising fill at end of 4-bar phrase
                    if(b%4===3){ [82.4,103.8,130.8,164.8,207.7].forEach((f,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f; const st=t+beat*3+i*beat*0.18; g.gain.setValueAtTime(0.06,st); g.gain.exponentialRampToValueAtTime(0.0001,st+0.45); o.connect(g); g.connect(bus); o.start(st); o.stop(st+0.5); }); }
                }
                function loop(){ if(!active)return; while(next<ctx.currentTime+0.5){ bar_fn(next,barN); next+=bar; barN++; } setTimeout(loop,100); } loop();
                const _bs=busStop(bus); bgmStop=(f)=>{active=false;_bs(f);};
            }

            //  Random dispatcher  picks one of the 3 each new duel 
            function playDuelBGM() {
                if (!enabled) return; boot(); resume(); stopBGM(0.5);
                const bus=makeBus(); bus.gain.setValueAtTime(0,ctx.currentTime); bus.gain.linearRampToValueAtTime(1,ctx.currentTime+0.6);
                const pick=Math.floor(Math.random()*3);
                if      (pick===0) _duelBGM_A(bus);
                else if (pick===1) _duelBGM_B(bus);
                else               _duelBGM_C(bus);
            }

            document.addEventListener('click',     () => { boot(); resume(); }, { once: true });
            document.addEventListener('touchstart', () => { boot(); resume(); }, { once: true });

            return {
                boot, resume, stopBGM,
                playMenuBGM, playShopBGM, playMapBGM, playDuelBGM,
                click: sfxClick, cardDraw: sfxCardDraw, cardFlip: sfxCardFlip,
                summon: sfxSummon, attack: sfxAttack, destroy: sfxDestroy,
                directHit: sfxDirectHit, spell: sfxSpell, trap: sfxTrap,
                lpDamage: sfxLPDamage, lpGain: sfxLPGain,
                packOpen: sfxPackOpen, packCard: sfxPackCard,
                win: sfxWin, lose: sfxLose,
                wheelSpin: sfxWheelSpin, wheelResult: sfxWheelResult,
                scratch: sfxScratch, scratchReveal: sfxScratchReveal,
                slotSpin: sfxSlotSpin, slotCol: sfxSlotCol, slotWin: sfxSlotWin,
                setEnabled(v) { enabled = v; if (!v) stopBGM(0.3); },
                isEnabled() { return enabled; },
                setBGM(v) { if (bgmGain) bgmGain.gain.setTargetAtTime(v, ctx.currentTime, 0.3); },
            };
        })();

        //  Sound toggle button 
        (function () {
            const btn = document.createElement('button');
            btn.id = 'snd-toggle'; btn.title = 'Toggle Sound'; btn.innerHTML = '';
            btn.style.cssText = 'position:fixed;bottom:18px;right:18px;z-index:9999;width:42px;height:42px;border-radius:50%;font-size:20px;cursor:pointer;background:#05101f;border:2px solid #00e5ff;color:#00e5ff;transition:all .2s;box-shadow:0 0 12px rgba(0,229,255,0.25);';
            btn.onclick = () => {
                SoundEngine.boot(); SoundEngine.resume();
                const on = !SoundEngine.isEnabled();
                SoundEngine.setEnabled(on);
                btn.innerHTML = on ? '' : '';
                btn.style.borderColor = on ? '#00e5ff' : '#555';
                btn.style.color       = on ? '#00e5ff' : '#555';
                if (on) {
                    const v = gameState.view;
                    if (v === 'MENU') SoundEngine.playMenuBGM();
                    else if (v === 'SHOP' || v === 'BUILDER') SoundEngine.playShopBGM();
                    else if (v === 'DUEL') SoundEngine.playMapBGM();
                }
            };
            document.body.appendChild(btn);
        })();

        // --- INIT ---
        renderApp();
        document.addEventListener('click', () => { if (gameState.view === 'MENU') SoundEngine.playMenuBGM(); }, { once: true });

    </script>
</body>
</html>
